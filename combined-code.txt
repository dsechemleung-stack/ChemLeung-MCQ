

// ========== combine-code.js ==========

import fs from 'fs';
import path from 'path';

function getAllFiles(dirPath, arrayOfFiles = []) {
  try {
    const files = fs.readdirSync(dirPath);
    console.log(`Scanning: ${dirPath}`);

    files.forEach(file => {
      const filePath = path.join(dirPath, file);

      if (fs.statSync(filePath).isDirectory()) {
        if (!file.match(/node_modules|\.git|dist|build/)) {
          arrayOfFiles = getAllFiles(filePath, arrayOfFiles);
        }
      } else {
        if (file.match(/\.(js|ts|jsx|tsx)$/)) {
          console.log(`Found: ${filePath}`);
          arrayOfFiles.push(filePath);
        }
      }
    });
  } catch (error) {
    console.error(`Error: ${error.message}`);
  }
  return arrayOfFiles;
}

console.log('Starting...\n');

const allFiles = getAllFiles('./');

console.log(`\nFound ${allFiles.length} files\n`);

if (allFiles.length === 0) {
  console.log('No JS files found!');
  process.exit(1);
}

let combinedCode = '';

allFiles.forEach(file => {
  combinedCode += `\n\n// ========== ${file} ==========\n\n`;
  combinedCode += fs.readFileSync(file, 'utf8');
});

fs.writeFileSync('combined-code.txt', combinedCode);

console.log('\nSuccess!');
console.log(`Created: combined-code.txt`);
console.log(`Total files: ${allFiles.length}`);
console.log(`Total size: ${combinedCode.length} characters`);


// ========== eslint.config.js ==========

import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])


// ========== simple-test.js ==========

console.log('Script started!');
console.log('Current directory:', process.cwd());
console.log('Script finished!');

// ========== src/App_Final.jsx ==========

import React from 'react';
import ForumPage from './pages/ForumPage';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider } from './contexts/AuthContext';
import { LanguageProvider } from './contexts/LanguageContext';
import PrivateRoute from './components/PrivateRoute';
import Header from './components/Header';
import LoginPage from './pages/LoginPage';
import RegisterPage from './pages/RegisterPage';
import DashboardPage from './pages/DashboardPage_Fixed';
import TopicSelectionPage from './pages/TopicSelectionPage_Updated';
import PracticeModeSelection from './pages/PracticeModeSelection';
import QuizPage from './pages/QuizPage';
import ResultsPage from './pages/ResultsPage_Updated_Fixed';
import LeaderboardPage from './pages/LeaderboardPage';
import ProfilePage from './pages/ProfilePage';
import HistoryPage from './pages/HistoryPage_Fixed';
import MistakeNotebookPage from './pages/MistakeNotebookPage';
import FirebaseTestPage from './pages/FirebaseTestPage';
import DebugDashboard from './pages/DebugDashboard';
import { useQuizData } from './hooks/useQuizData';
import { Beaker } from 'lucide-react';
import ChemStore from './components/ChemStore';
import TokenLog from './components/TokenLog';

const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTK36yaUN-NMCkQNT-DAHgc6FMZPjUc0Yv3nYEK4TA9W2qE9V1TqVD10Tq98-wXQoAvKOZlwGWRSDkU/pub?gid=1182550140&single=true&output=csv';

function AppContent() {
  const { questions, loading, error } = useQuizData(SHEET_URL);

  if (loading) {
    return (
      <div className="flex h-screen items-center justify-center bg-gray-50">
        <div className="text-center">
          <Beaker className="animate-bounce text-academic-gold w-12 h-12 mx-auto mb-4" />
          <p className="text-academic-slate font-semibold">Loading questions...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex h-screen items-center justify-center bg-gray-50">
        <div className="text-center bg-white p-8 rounded-2xl shadow-xl border-2 border-red-200">
          <p className="text-red-500 font-bold mb-2">Error loading questions</p>
          <p className="text-academic-slate">{error}</p>
        </div>
      </div>
    );
  }

  return (
    <>
      <Header />
      <div className="container mx-auto px-4 py-6">
        <Routes>
          {/* Public Routes */}
          <Route path="/login" element={<LoginPage />} />
          <Route path="/register" element={<RegisterPage />} />

          {/* Protected Routes */}
          <Route
            path="/dashboard"
            element={
              <PrivateRoute>
                <DashboardPage />
              </PrivateRoute>
            }
          />
          
          {/* Practice Mode Selection - NEW */}
          <Route
            path="/"
            element={
              <PrivateRoute>
                <PracticeModeSelection questions={questions} />
              </PrivateRoute>
            }
          />
          
          {/* Legacy Topic Selection */}
          <Route
            path="/topics"
            element={
              <PrivateRoute>
                <TopicSelectionPage questions={questions} />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/quiz"
            element={
              <PrivateRoute>
                <QuizPage />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/results"
            element={
              <PrivateRoute>
                <ResultsPage />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/leaderboard"
            element={
              <PrivateRoute>
                <LeaderboardPage />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/profile"
            element={
              <PrivateRoute>
                <ProfilePage />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/history"
            element={
              <PrivateRoute>
                <HistoryPage />
              </PrivateRoute>
            }
          />
          
          {/* Mistake Notebook - NEW */}
          <Route
            path="/notebook"
            element={
              <PrivateRoute>
                <MistakeNotebookPage />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/forum"
            element={
              <PrivateRoute>
                <ForumPage />
              </PrivateRoute>
            }
          />

          {/* ChemStore - FIXED: Now inside Routes */}
          <Route
            path="/store"
            element={
              <PrivateRoute>
                <ChemStore />
              </PrivateRoute>
            }
          />

          {/* Token Log - FIXED: Now inside Routes */}
          <Route
            path="/token-log"
            element={
              <PrivateRoute>
                <TokenLog />
              </PrivateRoute>
            }
          />

          {/* Firebase Test Page - for debugging */}
          <Route
            path="/test-firebase"
            element={
              <PrivateRoute>
                <FirebaseTestPage />
              </PrivateRoute>
            }
          />
          
          {/* Debug Dashboard - comprehensive diagnostics */}
          <Route
            path="/debug"
            element={
              <PrivateRoute>
                <DebugDashboard />
              </PrivateRoute>
            }
          />

          {/* Catch all - redirect to dashboard */}
          <Route path="*" element={<Navigate to="/dashboard" replace />} />
        </Routes>
      </div>
    </>
  );
}

export default function App() {
  return (
    <LanguageProvider>
      <AuthProvider>
        <Router>
          <div className="min-h-screen bg-gray-50">
            <AppContent />
          </div>
        </Router>
      </AuthProvider>
    </LanguageProvider>
  );
}

// ========== src/components/AttemptDetailModal.jsx ==========

import React, { useState } from 'react';
import { X, CheckCircle2, XCircle, Clock, Info, Share2, BarChart3, MessageSquare } from 'lucide-react';
import ShareableReport from './ShareableReport';
import QuestionForum from './QuestionForum';

export default function AttemptDetailModal({ attempt, onClose }) {
  const [showShareReport, setShowShareReport] = useState(false);
  const [forumQuestion, setForumQuestion] = useState(null);

  const { questions, answers, questionTimes, correctAnswers, totalQuestions, percentage, topics, timestamp, timeSpent } = attempt;

  // If attempt doesn't have questions stored, show a limited view
  const hasFullData = questions && questions.length > 0 && answers;

  const formatTime = (ms) => {
    if (!ms) return 'N/A';
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hrs = Math.floor(minutes / 60);
    if (hrs > 0) return `${hrs}h ${minutes % 60}m ${seconds % 60}s`;
    if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
    return `${seconds}s`;
  };

  const formatDate = (iso) => {
    return new Date(iso).toLocaleDateString('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
  };

  // Topic analysis
  const analysis = hasFullData
    ? questions.reduce((acc, q) => {
        if (!acc[q.Topic]) acc[q.Topic] = { total: 0, correct: 0 };
        acc[q.Topic].total += 1;
        if (answers[q.ID] === q.CorrectOption) acc[q.Topic].correct += 1;
        return acc;
      }, {})
    : {};

  const topicResults = Object.entries(analysis).map(([topic, data]) => ({
    topic,
    percent: Math.round((data.correct / data.total) * 100),
    ...data,
  }));

  const strengths = topicResults.filter(t => t.percent >= 70);
  const weaknesses = topicResults.filter(t => t.percent < 70);

  const scoreColor =
    percentage >= 70 ? 'from-emerald-500 to-green-600'
    : percentage >= 50 ? 'from-amber-400 to-orange-500'
    : 'from-red-400 to-rose-600';

  return (
    <>
      <div className="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 p-4 overflow-y-auto">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl my-6">
          {/* Header */}
          <div className="sticky top-0 bg-white border-b-2 border-slate-200 p-5 rounded-t-2xl z-10 flex justify-between items-center">
            <div>
              <h2 className="text-2xl font-black text-slate-800">Attempt Detail</h2>
              <p className="text-sm text-slate-500 mt-0.5">{formatDate(timestamp)}</p>
            </div>
            <div className="flex items-center gap-2">
              {hasFullData && (
                <button
                  onClick={() => setShowShareReport(true)}
                  className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-all"
                >
                  <Share2 size={16} />
                  Share
                </button>
              )}
              <button
                onClick={onClose}
                className="p-2 hover:bg-slate-100 rounded-lg transition-all"
              >
                <X size={24} />
              </button>
            </div>
          </div>

          <div className="p-6 space-y-6">
            {/* Score Banner */}
            <div className={`bg-gradient-to-r ${scoreColor} rounded-2xl p-8 text-white text-center`}>
              <div className="text-6xl font-black mb-1">{percentage}%</div>
              <div className="text-xl opacity-90">{correctAnswers} / {totalQuestions} correct</div>
              {timeSpent && (
                <div className="mt-3 flex items-center justify-center gap-2 text-white/80 text-sm">
                  <Clock size={16} />
                  <span>Total time: {formatTime(timeSpent)}</span>
                  <span>¬∑</span>
                  <span>Avg: {formatTime(timeSpent / totalQuestions)} / question</span>
                </div>
              )}
              {topics && topics.length > 0 && (
                <div className="mt-3 flex flex-wrap justify-center gap-2">
                  {topics.map(t => (
                    <span key={t} className="px-2 py-1 bg-white/20 rounded-full text-xs font-bold">{t}</span>
                  ))}
                </div>
              )}
            </div>

            {/* Strengths / Weaknesses */}
            {hasFullData && topicResults.length > 0 && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-white p-4 rounded-xl border-2 border-slate-200">
                  <h3 className="flex items-center gap-2 font-bold text-emerald-600 mb-3">
                    <CheckCircle2 size={18} /> Strengths
                  </h3>
                  {strengths.length > 0
                    ? strengths.map(s => (
                        <div key={s.topic} className="text-sm mb-2 flex justify-between">
                          <span className="truncate mr-2">{s.topic}</span>
                          <span className="font-bold text-emerald-700">{s.percent}%</span>
                        </div>
                      ))
                    : <p className="text-sm text-slate-400 italic">Keep practicing!</p>}
                </div>
                <div className="bg-white p-4 rounded-xl border-2 border-slate-200">
                  <h3 className="flex items-center gap-2 font-bold text-amber-600 mb-3">
                    <BarChart3 size={18} /> Needs Focus
                  </h3>
                  {weaknesses.length > 0
                    ? weaknesses.map(w => (
                        <div key={w.topic} className="text-sm mb-2 flex justify-between">
                          <span className="truncate mr-2">{w.topic}</span>
                          <span className="font-bold text-amber-700">{w.percent}%</span>
                        </div>
                      ))
                    : <p className="text-sm text-slate-400 italic">No major weaknesses!</p>}
                </div>
              </div>
            )}

            {/* No full data notice */}
            {!hasFullData && (
              <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 text-amber-800 text-sm font-semibold">
                ‚ÑπÔ∏è Full question data is only available for attempts made after this feature was added.
              </div>
            )}

            {/* Detailed Q&A */}
            {hasFullData && (
              <div className="space-y-4">
                <h3 className="text-xl font-bold flex items-center gap-2">
                  <Info className="text-lab-blue" /> Detailed Review
                </h3>
                {questions.map((q, index) => {
                  const isCorrect = answers[q.ID] === q.CorrectOption;
                  const timeForQ = questionTimes ? questionTimes[q.ID] : null;
                  return (
                    <div
                      key={q.ID}
                      className={`p-5 rounded-xl border-l-4 bg-white shadow-sm ${isCorrect ? 'border-emerald-500' : 'border-red-500'}`}
                    >
                      <div className="flex justify-between items-start mb-3">
                        <div className="flex items-center gap-3">
                          <span className="text-xl font-black text-slate-700">Q{index + 1}</span>
                          {timeForQ && (
                            <div className="text-xs text-slate-500 flex items-center gap-1 bg-slate-100 px-2 py-1 rounded-full">
                              <Clock size={12} />
                              {formatTime(timeForQ)}
                            </div>
                          )}
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => setForumQuestion(q)}
                            className="flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-xs font-bold hover:bg-purple-200 transition-all"
                          >
                            <MessageSquare size={12} /> Discuss
                          </button>
                          {isCorrect
                            ? <CheckCircle2 className="text-emerald-500" size={22} />
                            : <XCircle className="text-red-500" size={22} />
                          }
                        </div>
                      </div>
                      <div
                        className="prose prose-slate max-w-none mb-3 text-base"
                        dangerouslySetInnerHTML={{ __html: q.Question }}
                      />
                      {q.Pictureurl && (
                        <div className="mb-3 flex justify-center">
                          <img src={q.Pictureurl} alt="Diagram" className="max-h-[180px] object-contain rounded-lg border border-slate-200" />
                        </div>
                      )}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3">
                        <div className={`p-3 rounded-lg text-sm border ${isCorrect ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                          <strong>Your Answer:</strong> {answers[q.ID] || 'None'}
                        </div>
                        <div className="p-3 rounded-lg bg-blue-50 border border-blue-200 text-blue-800 text-sm">
                          <strong>Correct:</strong> {q.CorrectOption}
                        </div>
                      </div>
                      {q.Explanation && (
                        <div className="p-3 bg-slate-50 rounded-lg text-sm border border-slate-200">
                          <strong className="block mb-1 text-slate-700 flex items-center gap-1">
                            <Info size={13} /> Explanation:
                          </strong>
                          <div dangerouslySetInnerHTML={{ __html: q.Explanation }} className="text-slate-600 leading-relaxed" />
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Share Report */}
      {showShareReport && hasFullData && (
        <ShareableReport
          questions={questions}
          userAnswers={answers}
          questionTimes={questionTimes}
          onClose={() => setShowShareReport(false)}
        />
      )}

      {/* Forum */}
      {forumQuestion && (
        <QuestionForum
          question={forumQuestion}
          onClose={() => setForumQuestion(null)}
        />
      )}
    </>
  );
}

// ========== src/components/ChemStore.jsx ==========

// ============================================================================
// CHEMSTORE - Token Economy Shop
// ============================================================================

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { purchaseItem, equipItem } from '../services/tokenService';
import { STORE_ITEMS, RARITY_COLORS, RARITY_BORDER, RARITY_LABELS } from '../utils/storeItems';
import { ArrowLeft, ShoppingBag, Sparkles, Check, Lock, Zap } from 'lucide-react';

export default function ChemStore() {
  const navigate = useNavigate();
  const { currentUser, userProfile } = useAuth();
  const { t } = useLanguage();
  const [selectedCategory, setSelectedCategory] = useState('profilePics');
  const [purchasing, setPurchasing] = useState(null);
  const [notification, setNotification] = useState(null);

  const tokens = userProfile?.tokens || 0;
  const inventory = userProfile?.inventory || [];
  const equipped = userProfile?.equipped || {};

  // Show notification
  const showNotification = (message, type = 'success') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 3000);
  };

  // Handle purchase
  const handlePurchase = async (item) => {
    if (purchasing) return;
    
    if (tokens < item.price) {
      showNotification(t('store.notEnoughTokens'), 'error');
      return;
    }

    setPurchasing(item.id);

    try {
      const result = await purchaseItem(currentUser.uid, item.id, item.price);
      
      if (result.success) {
        showNotification(t('store.purchased').replace('{name}', item.name), 'success');
      } else {
        showNotification(result.error || t('store.purchaseFailed'), 'error');
      }
    } catch (error) {
      showNotification(t('store.pleaseTryAgain'), 'error');
    }

    setPurchasing(null);
  };

  // Handle equip
  const handleEquip = async (item) => {
    try {
      const slot = item.category;
      const result = await equipItem(currentUser.uid, item.id, slot);
      
      if (result.success) {
        showNotification(t('store.equipped').replace('{name}', item.name), 'success');
      } else {
        showNotification(result.error || t('store.failedToEquip'), 'error');
      }
    } catch (error) {
      showNotification(t('store.failedToEquipItem'), 'error');
    }
  };

  const categories = [
    { key: 'profilePics', label: t('store.profilePics'), icon: 'üé≠' },
    { key: 'badges', label: t('store.badges'), icon: 'üèÖ' },
    { key: 'themes', label: t('store.themes'), icon: 'üé®' }
  ];

  const currentItems = STORE_ITEMS[selectedCategory] || [];

  return (
    <div className="max-w-7xl mx-auto space-y-6">
      {/* Notification */}
      {notification && (
        <div className={`fixed top-20 right-4 z-50 px-6 py-3 rounded-lg shadow-2xl animate-in slide-in-from-top-2 ${
          notification.type === 'success' 
            ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white' 
            : 'bg-gradient-to-r from-red-500 to-rose-600 text-white'
        }`}>
          <p className="font-bold">{notification.message}</p>
        </div>
      )}

      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={() => navigate('/dashboard')}
          className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all"
        >
          <ArrowLeft size={20} />
        </button>
        
        <div className="flex-1 bg-gradient-to-r from-purple-600 via-pink-600 to-orange-500 rounded-2xl shadow-2xl p-6 text-white relative overflow-hidden">
          {/* Animated background effect */}
          <div className="absolute inset-0 opacity-20">
            <div className="absolute top-0 left-0 w-40 h-40 bg-white rounded-full blur-3xl animate-pulse"></div>
            <div className="absolute bottom-0 right-0 w-60 h-60 bg-white rounded-full blur-3xl animate-pulse" style={{ animationDelay: '1s' }}></div>
          </div>
          
          <div className="relative z-10">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-black flex items-center gap-3 mb-2">
                  <ShoppingBag size={32} strokeWidth={3} />
                  {t('store.title')}
                </h1>
                <p className="text-white/90 font-semibold">
                  {t('store.subtitle')}
                </p>
              </div>
              
              {/* Token Balance */}
              <div className="bg-white/20 backdrop-blur-sm rounded-2xl px-6 py-4 border-2 border-white/40">
                <div className="text-sm font-bold text-white/80 mb-1">{t('store.yourBalance')}</div>
                <div className="text-4xl font-black flex items-center gap-2">
                  <Zap size={32} className="text-yellow-300" fill="currentColor" />
                  {tokens}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Category Tabs */}
      <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
        <div className="flex border-b-2 border-slate-200">
          {categories.map(cat => (
            <button
              key={cat.key}
              onClick={() => setSelectedCategory(cat.key)}
              className={`flex-1 px-6 py-4 font-bold text-base transition-all flex items-center justify-center gap-2 ${
                selectedCategory === cat.key
                  ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                  : 'text-slate-600 hover:bg-slate-50'
              }`}
            >
              <span className="text-2xl">{cat.icon}</span>
              {cat.label}
            </button>
          ))}
        </div>

        {/* Items Grid */}
        <div className="p-6">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {currentItems.map(item => {
              const owned = inventory.includes(item.id);
              const isEquipped = equipped[item.category] === item.id;
              const canAfford = tokens >= item.price;
              const isFree = item.price === 0;

              return (
                <div
                  key={item.id}
                  className={`relative bg-white rounded-2xl border-4 ${RARITY_BORDER[item.rarity]} overflow-hidden transition-all hover:scale-105 hover:shadow-2xl group`}
                >
                  {/* Rarity Badge */}
                  <div className={`absolute top-3 right-3 px-3 py-1 rounded-full text-xs font-black text-white bg-gradient-to-r ${RARITY_COLORS[item.rarity]} shadow-lg z-10 flex items-center gap-1`}>
                    <Sparkles size={12} />
                    {RARITY_LABELS[item.rarity]}
                  </div>

                  {/* Item Icon */}
                  <div className="p-8 bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center">
                    {item.category === 'theme' ? (
                      <div className="w-32 h-32 rounded-2xl shadow-2xl" style={{ background: item.preview }}></div>
                    ) : (
                      <div className="text-8xl group-hover:scale-110 transition-transform">
                        {item.icon}
                      </div>
                    )}
                  </div>

                  {/* Item Info */}
                  <div className="p-6">
                    <h3 className="text-xl font-black text-slate-800 mb-1">
                      {item.name}
                    </h3>
                    <p className="text-sm text-slate-600 mb-4">
                      {item.description}
                    </p>

                    {/* Price & Actions */}
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <Zap size={20} className="text-amber-500" fill="currentColor" />
                        <span className="text-2xl font-black text-slate-800">
                          {item.price === 0 ? 'FREE' : item.price}
                        </span>
                      </div>

                      {/* Action Buttons */}
                      {owned ? (
                        isEquipped ? (
                          <button
                            disabled
                            className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-bold cursor-default"
                          >
                            <Check size={16} />
                            {t('store.equipped')}
                          </button>
                        ) : (
                          <button
                            onClick={() => handleEquip(item)}
                            className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg font-bold hover:opacity-90 transition-all"
                          >
                            <Sparkles size={16} />
                            {t('store.equip')}
                          </button>
                        )
                      ) : (
                        <button
                          onClick={() => handlePurchase(item)}
                          disabled={!canAfford || purchasing === item.id}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${
                            canAfford
                              ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white hover:opacity-90'
                              : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                          }`}
                        >
                          {purchasing === item.id ? (
                            <>
                              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                              {t('store.buying')}
                            </>
                          ) : !canAfford && !isFree ? (
                            <>
                              <Lock size={16} />
                              {t('store.locked')}
                            </>
                          ) : (
                            <>
                              <ShoppingBag size={16} />
                              {isFree ? t('store.claim') : t('store.buy')}
                            </>
                          )}
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {currentItems.length === 0 && (
            <div className="text-center py-12">
              <p className="text-slate-400 text-lg">{t('store.comingSoon')}</p>
            </div>
          )}
        </div>
      </div>

      {/* Info Box */}
      <div className="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl p-6">
        <h3 className="font-bold text-blue-900 mb-3 flex items-center gap-2">
          <Sparkles size={18} />
          {t('store.howToEarnTokens')}
        </h3>
        <ul className="space-y-2 text-sm text-blue-800">
          <li className="flex items-start gap-2">
            <span className="text-lg">‚≠ê</span>
            <span><strong>{t('store.perfectScore')}</strong> {t('store.perfectScoreTokens')}</span>
          </li>
          <li className="flex items-start gap-2">
            <span className="text-lg">üéØ</span>
            <span><strong>{t('store.excellentScore')}</strong> {t('store.excellentScoreTokens')}</span>
          </li>
          <li className="flex items-start gap-2">
            <span className="text-lg">üëç</span>
            <span><strong>{t('store.goodScore')}</strong> {t('store.goodScoreTokens')}</span>
          </li>
          <li className="flex items-start gap-2">
            <span className="text-lg">üìö</span>
            <span><strong>{t('store.clearMistake')}</strong> {t('store.clearMistakeTokens')}</span>
          </li>
          <li className="flex items-start gap-2">
            <span className="text-lg">üèÜ</span>
            <span><strong>{t('store.leaderboardGold')}</strong> {t('store.leaderboardTokens')}</span>
          </li>
          <li className="flex items-start gap-2">
            <span className="text-lg">üî•</span>
            <span><strong>{t('store.studyStreaks')}</strong> {t('store.studyStreaksTokens')}</span>
          </li>
        </ul>
      </div>
    </div>
  );
}

// ========== src/components/FilterScreen.jsx ==========

import React, { useState, useMemo } from 'react';
import { Settings, Play, Check, Filter } from 'lucide-react';

export default function FilterScreen({ questions, onStart }) {
  const [selectedTopics, setSelectedTopics] = useState([]);
  const [selectedSubtopics, setSelectedSubtopics] = useState([]);
  const [count, setCount] = useState(10);

  // 1. Sort Topics numerically/alphabetically
  const topics = useMemo(() => {
    return [...new Set(questions.map(q => q.Topic))]
      .filter(t => t && t !== "Uncategorized")
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
  }, [questions]);

  // 2. Derive available subtopics based on ALL selected topics
  const availableSubtopics = useMemo(() => {
    if (selectedTopics.length === 0) return [];
    return [...new Set(questions
      .filter(q => selectedTopics.includes(q.Topic))
      .map(q => q.Subtopic))]
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
  }, [selectedTopics, questions]);

  const toggleTopic = (topic) => {
    setSelectedTopics(prev => 
      prev.includes(topic) ? prev.filter(t => t !== topic) : [...prev, topic]
    );
    // Reset subtopics that no longer belong to selected topics
    setSelectedSubtopics([]);
  };

  // NEW: Select all topics at once
  const selectAllTopics = () => {
    if (selectedTopics.length === topics.length) {
      // If all are selected, deselect all
      setSelectedTopics([]);
      setSelectedSubtopics([]);
    } else {
      // Select all topics
      setSelectedTopics([...topics]);
      setSelectedSubtopics([]);
    }
  };

  const toggleSubtopic = (sub) => {
    setSelectedSubtopics(prev => 
      prev.includes(sub) ? prev.filter(s => s !== sub) : [...prev, sub]
    );
  };

  const handleStart = () => {
    // Filter pool based on multiple selections
    let pool = questions.filter(q => selectedTopics.includes(q.Topic));
    
    if (selectedSubtopics.length > 0) {
      pool = pool.filter(q => selectedSubtopics.includes(q.Subtopic));
    }
    
    const shuffled = [...pool].sort(() => 0.5 - Math.random());
    const finalSelection = count === 'All' ? shuffled : shuffled.slice(0, parseInt(count));
    
    if (finalSelection.length === 0) {
      alert("No questions found for this selection. Try broader filters!");
      return;
    }
    onStart(finalSelection);
  };

  const allTopicsSelected = selectedTopics.length === topics.length;

  return (
    <div className="max-w-4xl mx-auto space-y-6 animate-in fade-in duration-500">
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-slate-50 p-6 border-b flex justify-between items-center">
          <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800">
            <Filter size={20} className="text-lab-blue" />
            Configure Custom Session
          </h2>
          <span className="text-xs font-bold text-slate-400 bg-slate-200 px-2 py-1 rounded">
            {questions.length} Questions Loaded
          </span>
        </div>

        <div className="p-8 space-y-8">
          {/* 1. Multi-Topic Selection */}
          <div>
            <div className="flex justify-between items-center mb-4">
              <label className="block text-sm font-black text-slate-500 uppercase tracking-widest">
                1. Select Topics (Multi-choice)
              </label>
              <button
                onClick={selectAllTopics}
                className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${
                  allTopicsSelected
                    ? 'bg-lab-blue text-white hover:bg-blue-800'
                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200 border border-slate-300'
                }`}
              >
                {allTopicsSelected ? '‚úì All Selected' : 'Select All Topics'}
              </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
              {topics.map(topic => (
                <button
                  key={topic}
                  onClick={() => toggleTopic(topic)}
                  className={`flex items-center justify-between p-3 rounded-xl border-2 transition-all ${
                    selectedTopics.includes(topic)
                    ? 'border-lab-blue bg-blue-50 text-lab-blue shadow-sm'
                    : 'border-slate-100 text-slate-600 hover:border-slate-200'
                  }`}
                >
                  <span className="text-sm font-semibold">{topic}</span>
                  {selectedTopics.includes(topic) && <Check size={16} />}
                </button>
              ))}
            </div>
          </div>

          {/* 2. Multi-Subtopic Selection */}
          {selectedTopics.length > 0 && availableSubtopics.length > 0 && (
            <div className="animate-in slide-in-from-top-4">
              <label className="block text-sm font-black text-slate-500 mb-4 uppercase tracking-widest">
                2. Focus on Subtopics
              </label>
              <div className="flex flex-wrap gap-2">
                {availableSubtopics.map(sub => (
                  <button
                    key={sub}
                    onClick={() => toggleSubtopic(sub)}
                    className={`px-4 py-2 rounded-full text-xs font-bold border-2 transition-all ${
                      selectedSubtopics.includes(sub)
                      ? 'bg-lab-blue border-lab-blue text-white'
                      : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'
                    }`}
                  >
                    {sub}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* 3. Question Count */}
          <div>
            <label className="block text-sm font-black text-slate-500 mb-4 uppercase tracking-widest">
              3. Session Length
            </label>
            <div className="grid grid-cols-3 md:grid-cols-6 gap-3">
              {['5', '10', '15', '20', '36', 'All'].map(num => (
                <button
                  key={num}
                  onClick={() => setCount(num)}
                  className={`py-3 rounded-xl border-2 font-bold transition-all ${
                    count === num ? 'border-lab-blue bg-blue-50 text-lab-blue' : 'border-slate-100 text-slate-400'
                  }`}
                >
                  {num}
                </button>
              ))}
            </div>
          </div>

          <button 
            disabled={selectedTopics.length === 0}
            onClick={handleStart}
            className="w-full py-5 bg-lab-blue text-white rounded-2xl font-black text-lg shadow-lg hover:bg-blue-800 disabled:bg-slate-200 transition-all flex items-center justify-center gap-2 active:scale-95"
          >
            <Play fill="currentColor" size={18} />
            GENERATE EXAM
          </button>
        </div>
      </div>
    </div>
  );
}

// ========== src/components/Header.jsx ==========

import React, { useState } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { Beaker, Home, Trophy, User, LogOut, History, ChevronDown, Menu, X, Languages, BookOpen, MessageSquare, Zap, ShoppingBag, Clock, AlertTriangle } from 'lucide-react';
import { quizStorage } from '../utils/quizStorage';

// Icon mapping
const iconMap = {
  flask_blue: 'üß™', atom_green: '‚öõÔ∏è', molecule: 'üî¨', fire: 'üî•',
  lightning: '‚ö°', crystal: 'üíé', explosion: 'üí•', star: '‚≠ê',
  crown: 'üëë', trophy: 'üèÜ'
};

export default function Header() {
    const { currentUser, logout, userProfile } = useAuth();
    const { language, toggleLanguage, isEnglish } = useLanguage();
    const navigate = useNavigate();
    const location = useLocation();
    const [showUserMenu, setShowUserMenu] = useState(false);
    const [showMobileNav, setShowMobileNav] = useState(false);
    const [showLogoutModal, setShowLogoutModal] = useState(false);

    // Get tokens from userProfile with real-time sync
    const tokens = userProfile?.tokens || 0;
    const equipped = userProfile?.equipped || {};
    const profileColor = userProfile?.profileColor || '#2563eb'; // Default blue

    if (location.pathname === '/login' || location.pathname === '/register') {
        return null;
    }

    const isInQuiz = location.pathname === '/quiz';

    async function handleLogoutConfirm() {
        try {
            await logout();
            navigate('/login');
        } catch (error) {
            console.error('Failed to log out:', error);
        }
    }

    const handleLogoutClick = () => {
        if (isInQuiz) {
            const confirmed = window.confirm(
                "Are you sure you want to logout?\n\n‚ö†Ô∏è You are in the middle of a quiz. Your progress will be lost!"
            );
            if (!confirmed) return;
            quizStorage.clearQuizData();
            handleLogoutConfirm();
        } else {
            setShowLogoutModal(true);
        }
    };

    const handleNavigation = (path) => {
        if (isInQuiz && path !== '/quiz') {
            const confirmed = window.confirm(
                "Are you sure you want to leave the quiz?\n\n‚ö†Ô∏è Your current progress will be lost!"
            );
            if (!confirmed) {
                return;
            }
            quizStorage.clearQuizData();
        }

        navigate(path);
        setShowUserMenu(false);
        setShowMobileNav(false);
    };

    const isActive = (path) => location.pathname === path;

    // Get equipped profile pic icon
    const profileIcon = equipped.profilePic || 'flask_blue';
    const displayIcon = iconMap[profileIcon] || 'üß™';

    return (
        <>
            <header className="bg-white border-b-2 border-slate-200 shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex justify-between items-center h-16">
                        {/* Logo and Brand */}
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => handleNavigation('/dashboard')}>
                            <div className="bg-lab-blue p-2 rounded-lg">
                                <Beaker className="text-white" size={24} />
                            </div>
                            <div>
                                <h1 className="text-xl font-black text-lab-blue leading-tight">
                                    ChemLeung
                                </h1>
                                <p className="text-[10px] text-slate-700 font-bold -mt-1 hidden sm:block">
                                    {isEnglish ? 'HKDSE MCQ Practice Platform' : 'HKDSE MCQ Á∑¥ÁøíÂπ≥Âè∞'}
                                </p>
                            </div>
                        </div>

                        {/* Desktop Navigation Links */}
                        {currentUser && (
                            <nav className="hidden md:flex items-center gap-2">
                                <button
                                    onClick={() => handleNavigation('/dashboard')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${isActive('/dashboard')
                                            ? 'bg-lab-blue text-white shadow-md'
                                            : 'text-slate-800 hover:bg-slate-100 border-2 border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <Home size={18} />
                                    <span>{isEnglish ? 'Dashboard' : 'Á∏ΩË¶ß'}</span>
                                </button>
                                <button
                                    onClick={() => handleNavigation('/')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${isActive('/') || isActive('/quiz')
                                            ? 'bg-chemistry-green text-white shadow-md'
                                            : 'text-slate-800 hover:bg-slate-100 border-2 border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <Beaker size={18} />
                                    <span>{isEnglish ? 'Practice' : 'Á∑¥Áøí'}</span>
                                </button>

                                <button
                                    onClick={() => handleNavigation('/notebook')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${isActive('/notebook')
                                            ? 'bg-orange-600 text-white shadow-md'
                                            : 'text-slate-800 hover:bg-slate-100 border-2 border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <BookOpen size={18} />
                                    <span>{isEnglish ? 'Mistakes' : 'ÈåØÈ°åÁ∞ø'}</span>
                                </button>

                                <button
                                    onClick={() => handleNavigation('/forum')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${isActive('/forum')
                                            ? 'bg-purple-600 text-white shadow-md'
                                            : 'text-slate-800 hover:bg-slate-100 border-2 border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <MessageSquare size={18} />
                                    <span>{isEnglish ? 'Forum' : 'Ë´ñÂ£á'}</span>
                                </button>

                                <button
                                    onClick={() => handleNavigation('/leaderboard')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${isActive('/leaderboard')
                                            ? 'bg-amber-500 text-white shadow-md'
                                            : 'text-slate-800 hover:bg-slate-100 border-2 border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <Trophy size={18} />
                                    <span>{isEnglish ? 'Leaderboard' : 'ÊéíË°åÊ¶ú'}</span>
                                </button>
                                
                                {/* TOKEN DISPLAY */}
                                <button
                                    onClick={() => handleNavigation('/store')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all shadow-md ${isActive('/store')
                                            ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                                            : 'bg-gradient-to-r from-amber-400 to-orange-500 text-white hover:from-amber-500 hover:to-orange-600'
                                        }`}
                                >
                                    <Zap size={18} fill="currentColor" />
                                    <span className="font-black">{tokens}</span>
                                </button>

                                <button
                                    onClick={toggleLanguage}
                                    className="flex items-center gap-2 px-4 py-2 rounded-lg font-black transition-all bg-gradient-to-r from-slate-600 to-slate-700 text-white hover:from-slate-700 hover:to-slate-800 shadow-md border-2 border-white ml-2"
                                    title={isEnglish ? 'Switch to Traditional Chinese' : 'ÂàáÊèõËá≥Ëã±Êñá'}
                                >
                                    <Languages size={18} strokeWidth={3} />
                                    <span className="text-sm">{isEnglish ? 'ÁπÅ' : 'EN'}</span>
                                </button>
                            </nav>
                        )}

                        {/* Mobile + Desktop User Menu */}
                        {currentUser && (
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => setShowMobileNav(!showMobileNav)}
                                    className="md:hidden p-2 rounded-lg hover:bg-slate-100 transition-all"
                                >
                                    {showMobileNav ? <X size={24} /> : <Menu size={24} />}
                                </button>

                                <div className="relative">
                                    <button
                                        onClick={() => setShowUserMenu(!showUserMenu)}
                                        className="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-slate-100 transition-all border-2 border-transparent hover:border-slate-200"
                                    >
                                        {/* Profile Icon - with equipped item and custom color */}
                                        <div 
                                            className="w-8 h-8 rounded-full flex items-center justify-center shadow-md text-lg"
                                            style={{ background: `linear-gradient(135deg, ${profileColor}, ${profileColor}dd)` }}
                                        >
                                            {displayIcon}
                                        </div>
                                        <div className="hidden sm:block text-left">
                                            <p className="text-sm font-bold text-slate-900">
                                                {currentUser.displayName || 'User'}
                                            </p>
                                            <p className="text-xs text-slate-600 truncate max-w-[150px]">
                                                {currentUser.email}
                                            </p>
                                        </div>
                                        <ChevronDown size={16} className="text-slate-600 hidden sm:block" />
                                    </button>

                                    {showUserMenu && (
                                        <>
                                            <div
                                                className="fixed inset-0 z-40"
                                                onClick={() => setShowUserMenu(false)}
                                            />
                                            <div className="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border-2 border-slate-200 z-50 overflow-hidden">
                                                <button
                                                    onClick={() => handleNavigation('/profile')}
                                                    className="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 transition-all text-left"
                                                >
                                                    <User size={18} className="text-slate-700" />
                                                    <span className="font-bold text-slate-900">
                                                        {isEnglish ? 'Profile Settings' : 'ÂÄã‰∫∫Ë®≠ÂÆö'}
                                                    </span>
                                                </button>
                                                <button
                                                    onClick={() => handleNavigation('/history')}
                                                    className="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 transition-all text-left border-t border-slate-100"
                                                >
                                                    <History size={18} className="text-slate-700" />
                                                    <span className="font-bold text-slate-900">
                                                        {isEnglish ? 'My History' : 'ÊàëÁöÑÊ≠∑Âè≤'}
                                                    </span>
                                                </button>
                                                <button
                                                    onClick={() => handleNavigation('/token-log')}
                                                    className="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 transition-all text-left border-t border-slate-100"
                                                >
                                                    <Clock size={18} className="text-amber-500" />
                                                    <span className="font-bold text-slate-900">
                                                        {isEnglish ? 'Token History' : '‰ª£Âπ£Ê≠∑Âè≤'}
                                                    </span>
                                                </button>
                                                <button
                                                    onClick={handleLogoutClick}
                                                    className="w-full flex items-center gap-3 px-4 py-3 hover:bg-red-50 transition-all text-left border-t border-slate-100"
                                                >
                                                    <LogOut size={18} className="text-red-600" />
                                                    <span className="font-bold text-red-600">
                                                        {isEnglish ? 'Logout' : 'ÁôªÂá∫'}
                                                    </span>
                                                </button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* Mobile Navigation Menu */}
                {showMobileNav && currentUser && (
                    <>
                        <div
                            className="fixed inset-0 bg-black bg-opacity-25 z-30"
                            onClick={() => setShowMobileNav(false)}
                        />
                        <div className="md:hidden fixed top-16 left-0 right-0 bg-white border-b-2 border-slate-200 shadow-xl z-40 animate-in slide-in-from-top duration-200">
                            <nav className="flex flex-col p-2">
                                {/* Token Display - Mobile */}
                                <div className="mb-2 p-3 bg-gradient-to-r from-amber-400 to-orange-500 rounded-lg">
                                    <div className="flex items-center justify-between text-white">
                                        <div className="flex items-center gap-2">
                                            <Zap size={20} fill="currentColor" />
                                            <span className="font-black text-lg">{tokens}</span>
                                            <span className="text-sm opacity-90">{isEnglish ? 'tokens' : '‰ª£Âπ£'}</span>
                                        </div>
                                        <button
                                            onClick={() => handleNavigation('/store')}
                                            className="px-3 py-1 bg-white/20 rounded-lg font-bold text-sm hover:bg-white/30"
                                        >
                                            <ShoppingBag size={16} className="inline mr-1" />
                                            {isEnglish ? 'Store' : 'ÂïÜÂ∫ó'}
                                        </button>
                                    </div>
                                </div>

                                <button
                                    onClick={() => handleNavigation('/dashboard')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/dashboard')
                                            ? 'bg-lab-blue text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <Home size={20} />
                                    <span>{isEnglish ? 'Dashboard' : 'Á∏ΩË¶ß'}</span>
                                </button>
                                <button
                                    onClick={() => handleNavigation('/')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/') || isActive('/quiz')
                                            ? 'bg-chemistry-green text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <Beaker size={20} />
                                    <span>{isEnglish ? 'Practice' : 'Á∑¥Áøí'}</span>
                                </button>
                                
                                <button
                                    onClick={() => handleNavigation('/notebook')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/notebook')
                                            ? 'bg-orange-600 text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <BookOpen size={20} />
                                    <span>{isEnglish ? 'Mistake Notebook' : 'ÈåØÈ°åÁ∞ø'}</span>
                                </button>

                                <button
                                    onClick={() => handleNavigation('/forum')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/forum')
                                            ? 'bg-purple-600 text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <MessageSquare size={20} />
                                    <span>{isEnglish ? 'Forum' : 'Ë´ñÂ£á'}</span>
                                </button>

                                <button
                                    onClick={() => handleNavigation('/leaderboard')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/leaderboard')
                                            ? 'bg-amber-500 text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <Trophy size={20} />
                                    <span>{isEnglish ? 'Leaderboard' : 'ÊéíË°åÊ¶ú'}</span>
                                </button>
                                <button
                                    onClick={() => handleNavigation('/history')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/history')
                                            ? 'bg-purple-600 text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <History size={20} />
                                    <span>{isEnglish ? 'History' : 'Ê≠∑Âè≤'}</span>
                                </button>

                                <button
                                    onClick={() => {
                                        toggleLanguage();
                                        setShowMobileNav(false);
                                    }}
                                    className="flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all bg-gradient-to-r from-amber-400 to-orange-500 text-white hover:from-amber-500 hover:to-orange-600 mt-2 shadow-md"
                                >
                                    <Languages size={20} strokeWidth={3} />
                                    <span>{isEnglish ? 'ÁπÅÈ´î‰∏≠Êñá' : 'English'}</span>
                                </button>
                            </nav>
                        </div>
                    </>
                )}
            </header>

            {/* Logout Confirmation Modal */}
            {showLogoutModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-in zoom-in duration-200">
                        <div className="p-6">
                            <div className="flex items-center gap-3 mb-4">
                                <div className="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                                    <AlertTriangle className="text-red-600" size={24} />
                                </div>
                                <div>
                                    <h3 className="text-xl font-black text-slate-800">
                                        {isEnglish ? 'Confirm Logout' : 'Á¢∫Ë™çÁôªÂá∫'}
                                    </h3>
                                    <p className="text-sm text-slate-500">
                                        {isEnglish ? 'Are you sure?' : 'ÊÇ®Á¢∫ÂÆöÂóéÔºü'}
                                    </p>
                                </div>
                            </div>
                            <p className="text-slate-600 mb-6">
                                {isEnglish 
                                    ? 'You will be logged out of your account. Any unsaved progress will be lost.' 
                                    : 'ÊÇ®Â∞áÁôªÂá∫Â∏≥Êà∂„ÄÇ‰ªª‰ΩïÊú™ÂÑ≤Â≠òÁöÑÈÄ≤Â∫¶Â∞áÊúÉÈÅ∫Â§±„ÄÇ'}
                            </p>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => setShowLogoutModal(false)}
                                    className="flex-1 px-6 py-3 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition-all"
                                >
                                    {isEnglish ? 'Cancel' : 'ÂèñÊ∂à'}
                                </button>
                                <button
                                    onClick={() => {
                                        setShowLogoutModal(false);
                                        handleLogoutConfirm();
                                    }}
                                    className="flex-1 px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-all flex items-center justify-center gap-2"
                                >
                                    <LogOut size={18} />
                                    {isEnglish ? 'Logout' : 'ÁôªÂá∫'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </>
    );
}

// ========== src/components/PrivateRoute.jsx ==========

import React from 'react';
import { Navigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';

export default function PrivateRoute({ children }) {
  const { currentUser } = useAuth();
  
  return currentUser ? children : <Navigate to="/login" />;
}

// ========== src/components/QuestionCard.jsx ==========

import React, { useState } from 'react';
import { HelpCircle, MessageSquare } from 'lucide-react';
import QuestionForum from './QuestionForum';

export default function QuestionCard({ question, selectedOption, onSelect, showDiscussButton = false }) {
  const [showForum, setShowForum] = useState(false);

  // If no question is passed, or if the question object is empty, show nothing.
  if (!question || !question.Question) {
    return (
      <div className="p-8 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200">
        <p className="text-slate-400 font-medium">Loading question content...</p>
      </div>
    );
  }

  // We use the keys defined in our useQuizData.js mapping
  const options = [
    { key: 'A', text: question.OptionA },
    { key: 'B', text: question.OptionB },
    { key: 'C', text: question.OptionC },
    { key: 'D', text: question.OptionD },
  ];

  // Toggle answer - if clicking the same answer again, deselect it
  const handleOptionClick = (optionKey) => {
    if (selectedOption === optionKey) {
      // Clicking the same answer again deselects it
      onSelect(null);
    } else {
      // Select the new answer
      onSelect(optionKey);
    }
  };

  return (
    <>
      <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden transition-all animate-in fade-in slide-in-from-bottom-4 duration-500">
        
        {/* Header Info Bar */}
        <div className="bg-slate-50 px-6 py-3 border-b border-slate-100 flex justify-between items-center">
          <div className="flex flex-col">
            <span className="text-[10px] font-black text-lab-blue uppercase tracking-tighter">
              {question.Topic || 'General Chemistry'}
            </span>
            <span className="text-xs text-slate-500 font-medium italic">
              {question.Subtopic}
            </span>
          </div>
          <div className="flex items-center gap-2">
            {question.DSEcode && (
              <span className="bg-blue-100 text-lab-blue px-2 py-1 rounded text-[10px] font-bold">
                {question.DSEcode}
              </span>
            )}
            {showDiscussButton && (
              <button
                onClick={() => setShowForum(true)}
                className="flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-bold hover:bg-purple-200 transition-all"
                title="Discuss this question"
              >
                <MessageSquare size={12} />
                <span>Discuss</span>
              </button>
            )}
          </div>
        </div>

        <div className="p-6 md:p-8">
          {/* Image Display Logic */}
          {question.Pictureurl && (
            <div className="mb-8 flex justify-center bg-white p-4 rounded-xl border border-slate-50 shadow-inner">
              <img 
                src={question.Pictureurl} 
                alt="Chemistry Diagram" 
                className="max-w-full h-auto max-h-[300px] object-contain rounded-md"
                onError={(e) => {
                  console.warn("Image load failed for URL:", question.Pictureurl);
                  e.target.parentElement.style.display = 'none';
                }}
              />
            </div>
          )}

          {/* Question Text - with whitespace-pre-wrap for line breaks */}
          <div className="mb-8">
            <div 
              className="text-lg md:text-xl font-semibold leading-relaxed text-slate-800 prose prose-slate max-w-none whitespace-pre-wrap"
              dangerouslySetInnerHTML={{ __html: question.Question }}
            />
          </div>

          {/* MCQ Options Grid */}
          <div className="grid grid-cols-1 gap-3">
            {options.map((opt) => (
              <button
                key={opt.key}
                onClick={() => handleOptionClick(opt.key)}
                className={`group flex items-center text-left p-4 rounded-xl border-2 transition-all duration-200 ${
                  selectedOption === opt.key
                    ? 'border-lab-blue bg-blue-50/50 ring-1 ring-lab-blue'
                    : 'border-slate-100 hover:border-slate-300 hover:bg-slate-50'
                }`}
              >
                {/* Option Letter Bubble */}
                <div className={`w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg font-bold mr-4 transition-colors ${
                  selectedOption === opt.key
                    ? 'bg-lab-blue text-white'
                    : 'bg-slate-100 text-slate-500 group-hover:bg-slate-200'
                }`}>
                  {opt.key}
                </div>

                {/* Option Text - with whitespace-pre-wrap for line breaks */}
                <div 
                  className={`text-base md:text-lg whitespace-pre-wrap ${
                    selectedOption === opt.key ? 'text-lab-blue font-medium' : 'text-slate-700'
                  }`}
                  dangerouslySetInnerHTML={{ __html: opt.text }}
                />
              </button>
            ))}
          </div>
        </div>

        {/* Footer Instruction */}
        <div className="px-6 py-4 bg-slate-50/50 border-t border-slate-100 flex items-center gap-2">
          <HelpCircle size={14} className="text-slate-400" />
          <span className="text-[11px] text-slate-400 font-medium italic">
            Select the most appropriate answer. Click again to deselect. All chemical equations should be assumed to occur at r.t.p. unless stated otherwise.
          </span>
        </div>
      </div>

      {/* Forum Modal */}
      {showForum && (
        <QuestionForum
          question={question}
          onClose={() => setShowForum(false)}
        />
      )}
    </>
  );
}

// ========== src/components/QuestionForum.jsx ==========

import React, { useState, useEffect, useCallback } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { forumService, canEditComment, editTimeRemaining, EDIT_WINDOW_MS } from '../services/forumService';
import { MessageSquare, Send, Edit2, Trash2, ThumbsUp, X, AlertCircle, Clock, Lock } from 'lucide-react';

function EditTimer({ createdAt, onExpire }) {
  const [remaining, setRemaining] = useState(() => editTimeRemaining(createdAt));

  useEffect(() => {
    const interval = setInterval(() => {
      const r = editTimeRemaining(createdAt);
      setRemaining(r);
      if (!r) { clearInterval(interval); onExpire && onExpire(); }
    }, 1000);
    return () => clearInterval(interval);
  }, [createdAt, onExpire]);

  if (!remaining) return (
    <span className="flex items-center gap-1 text-xs text-red-500 font-semibold">
      <Lock size={11} /> Edit locked
    </span>
  );
  return (
    <span className="flex items-center gap-1 text-xs text-amber-500 font-semibold">
      <Clock size={11} /> Edit in {remaining}
    </span>
  );
}

export default function QuestionForum({ question, onClose }) {
  const { currentUser } = useAuth();
  const { isEnglish } = useLanguage();
  const [comments, setComments] = useState([]);
  const [newComment, setNewComment] = useState('');
  const [editingId, setEditingId] = useState(null);
  const [editText, setEditText] = useState('');
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [, forceUpdate] = useState(0); // for timer re-render

  const loadComments = useCallback(async () => {
    setLoading(true);
    try {
      const fetched = await forumService.getQuestionComments(question.ID);
      setComments(fetched);
    } catch { /* ignore */ }
    setLoading(false);
  }, [question.ID]);

  useEffect(() => { loadComments(); }, [loadComments]);

  // Refresh edit-timers every 10 seconds
  useEffect(() => {
    const interval = setInterval(() => forceUpdate(n => n + 1), 10000);
    return () => clearInterval(interval);
  }, []);

  async function handleSubmitComment() {
    if (!newComment.trim() || !currentUser) return;
    setSubmitting(true);
    try {
      await forumService.addComment(question.ID, currentUser.uid, currentUser.displayName || 'Anonymous', newComment.trim());
      setNewComment('');
      await loadComments();
    } catch (error) {
      alert(isEnglish ? `Failed to add comment: ${error.message}` : `Êñ∞Â¢ûË©ïË´ñÂ§±Êïó: ${error.message}`);
    }
    setSubmitting(false);
  }

  async function handleEditComment(commentId) {
    if (!editText.trim()) return;
    try {
      await forumService.updateComment(commentId, editText.trim());
      setEditingId(null);
      setEditText('');
      await loadComments();
    } catch (error) {
      if (error.message === 'EDIT_EXPIRED') {
        alert(isEnglish ? 'Edit window has expired (15 minutes). You can no longer edit this comment.' : 'Á∑®ËºØÊôÇÈñìÂ∑≤ÈÅéÔºà15ÂàÜÈêòÔºâ„ÄÇÊÇ®ÁÑ°Ê≥ïÂÜçÁ∑®ËºØÊ≠§Ë©ïË´ñ„ÄÇ');
        setEditingId(null);
      } else {
        alert(isEnglish ? 'Failed to update comment' : 'Êõ¥Êñ∞Ë©ïË´ñÂ§±Êïó');
      }
    }
  }

  async function handleDeleteComment(commentId) {
    if (!window.confirm(isEnglish ? 'Are you sure you want to delete this comment?' : 'Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë©ïË´ñÂóéÔºü')) return;
    try {
      await forumService.deleteComment(commentId);
      await loadComments();
    } catch { alert(isEnglish ? 'Failed to delete comment' : 'Âà™Èô§Ë©ïË´ñÂ§±Êïó'); }
  }

  async function handleToggleLike(commentId) {
    if (!currentUser) { alert(isEnglish ? 'Please log in to like comments' : 'Ë´ãÁôªÂÖ•‰ª•ÊåâËÆöË©ïË´ñ'); return; }
    try {
      await forumService.toggleLike(commentId, currentUser.uid);
      await loadComments();
    } catch { /* ignore */ }
  }

  const formatDate = (isoString) => {
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) return isEnglish ? 'Just now' : 'ÂâõÂâõ';
    if (diffMins < 60) return `${diffMins} ${isEnglish ? 'min ago' : 'ÂàÜÈêòÂâç'}`;
    if (diffHours < 24) return `${diffHours} ${isEnglish ? 'hr ago' : 'Â∞èÊôÇÂâç'}`;
    if (diffDays < 7) return `${diffDays} ${isEnglish ? 'days ago' : 'Â§©Ââç'}`;
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
      <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b-2 border-slate-200 p-6 rounded-t-2xl z-10">
          <div className="flex justify-between items-start">
            <div className="flex-1 pr-4">
              <h2 className="text-2xl font-black text-slate-800 flex items-center gap-2 mb-2">
                <MessageSquare className="text-lab-blue" size={24} />
                {isEnglish ? 'Discussion' : 'Ë®éË´ñÂçÄ'}
              </h2>
              <div className="flex items-center gap-2 text-sm">
                <span className="bg-blue-100 text-lab-blue px-2 py-1 rounded font-bold">{question.Topic}</span>
                {question.DSEcode && <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">{question.DSEcode}</span>}
              </div>
            </div>
            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg transition-all flex-shrink-0"><X size={24} /></button>
          </div>
        </div>

        {/* Question */}
        <div className="p-6 bg-slate-50 border-b-2 border-slate-200">
          <div className="prose prose-slate max-w-none text-base text-slate-800 font-medium whitespace-pre-wrap"
            dangerouslySetInnerHTML={{ __html: question.Question }} />
          {question.Pictureurl && (
            <div className="mt-4 flex justify-center">
              <img src={question.Pictureurl} alt="Question Diagram" className="max-w-full h-auto max-h-[200px] object-contain rounded-lg border-2 border-slate-200" />
            </div>
          )}
        </div>

        {/* Comment Input */}
        {currentUser ? (
          <div className="p-6 border-b-2 border-slate-200 bg-white">
            <div className="flex gap-3">
              <div className="w-10 h-10 rounded-full bg-lab-blue flex items-center justify-center flex-shrink-0">
                <span className="text-white font-bold text-sm">{currentUser.displayName?.charAt(0).toUpperCase() || 'U'}</span>
              </div>
              <div className="flex-1">
                <textarea value={newComment} onChange={e => setNewComment(e.target.value)}
                  placeholder={isEnglish ? 'Share your thoughts...' : 'ÂàÜ‰∫´ÊÇ®ÁöÑÊÉ≥Ê≥ï...'}
                  className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-lab-blue focus:ring-2 focus:ring-blue-100 outline-none transition-all resize-none" rows="3" />
                <div className="flex justify-end mt-2">
                  <button onClick={handleSubmitComment} disabled={!newComment.trim() || submitting}
                    className="flex items-center gap-2 px-6 py-2 bg-lab-blue text-white rounded-lg font-bold hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all">
                    {submitting ? <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white" /> : <Send size={16} />}
                    {isEnglish ? 'Post' : 'ÁôºË°®'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        ) : (
          <div className="p-6 border-b-2 border-slate-200 bg-amber-50">
            <div className="flex items-center gap-3 text-amber-800">
              <AlertCircle size={20} />
              <p className="font-semibold">{isEnglish ? 'Please log in to join the discussion' : 'Ë´ãÁôªÂÖ•‰ª•ÂèÉËàáË®éË´ñ'}</p>
            </div>
          </div>
        )}

        {/* Comments */}
        <div className="p-6">
          {loading ? (
            <div className="flex justify-center py-12">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-lab-blue" />
            </div>
          ) : comments.length === 0 ? (
            <div className="text-center py-12">
              <MessageSquare className="w-16 h-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-400 text-lg mb-2">{isEnglish ? 'No comments yet' : 'Â∞öÁÑ°Ë©ïË´ñ'}</p>
              <p className="text-slate-500 text-sm">{isEnglish ? 'Be the first to share your thoughts!' : 'ÊàêÁÇ∫Á¨¨‰∏ÄÂÄãÂàÜ‰∫´ÊÉ≥Ê≥ïÁöÑ‰∫∫ÔºÅ'}</p>
            </div>
          ) : (
            <div className="space-y-4">
              <h3 className="text-lg font-bold text-slate-700 mb-4">{comments.length} {isEnglish ? 'Comments' : 'ÂâáË©ïË´ñ'}</h3>
              {comments.map(comment => {
                const isOwner = currentUser && comment.userId === currentUser.uid;
                const editable = isOwner && canEditComment(comment.createdAt);
                return (
                  <div key={comment.id} className="bg-slate-50 rounded-xl p-4 border-2 border-slate-200">
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-lab-blue flex items-center justify-center">
                          <span className="text-white font-bold text-xs">{comment.userDisplayName?.charAt(0).toUpperCase() || 'U'}</span>
                        </div>
                        <div>
                          <div className="font-bold text-slate-800">{comment.userDisplayName || 'Anonymous'}</div>
                          <div className="text-xs text-slate-500 flex items-center gap-2">
                            {formatDate(comment.createdAt)}
                            {comment.edited && <span className="text-slate-400 italic">({isEnglish ? 'edited' : 'Â∑≤Á∑®ËºØ'})</span>}
                          </div>
                        </div>
                      </div>
                      {isOwner && (
                        <div className="flex items-center gap-2">
                          {/* Edit timer badge */}
                          {editingId !== comment.id && (
                            <EditTimer createdAt={comment.createdAt} onExpire={() => forceUpdate(n => n + 1)} />
                          )}
                          {editable && (
                            <button onClick={() => { setEditingId(comment.id); setEditText(comment.text); }}
                              className="p-2 hover:bg-blue-100 rounded-lg transition-all" title={isEnglish ? 'Edit' : 'Á∑®ËºØ'}>
                              <Edit2 size={16} className="text-lab-blue" />
                            </button>
                          )}
                          {!editable && editingId !== comment.id && (
                            <button disabled title={isEnglish ? 'Edit window expired' : 'Á∑®ËºØÊôÇÈñìÂ∑≤ÈÅé'}
                              className="p-2 opacity-30 cursor-not-allowed rounded-lg">
                              <Lock size={16} className="text-slate-400" />
                            </button>
                          )}
                          <button onClick={() => handleDeleteComment(comment.id)}
                            className="p-2 hover:bg-red-100 rounded-lg transition-all" title={isEnglish ? 'Delete' : 'Âà™Èô§'}>
                            <Trash2 size={16} className="text-red-500" />
                          </button>
                        </div>
                      )}
                    </div>

                    {editingId === comment.id ? (
                      <div className="mt-3">
                        <div className="flex items-center gap-2 mb-2 text-xs text-amber-600 font-semibold">
                          <Clock size={12} />
                          {isEnglish ? 'Edit window: ' : 'Á∑®ËºØÊôÇÈôêÔºö'}
                          <EditTimer createdAt={comment.createdAt} onExpire={() => { setEditingId(null); forceUpdate(n => n + 1); }} />
                        </div>
                        <textarea value={editText} onChange={e => setEditText(e.target.value)}
                          className="w-full px-3 py-2 border-2 border-slate-300 rounded-lg focus:border-lab-blue outline-none resize-none" rows="3" />
                        <div className="flex gap-2 mt-2">
                          <button onClick={() => handleEditComment(comment.id)}
                            className="px-4 py-2 bg-lab-blue text-white rounded-lg font-bold hover:bg-blue-700 transition-all text-sm">
                            {isEnglish ? 'Save' : 'ÂÑ≤Â≠ò'}
                          </button>
                          <button onClick={() => { setEditingId(null); setEditText(''); }}
                            className="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition-all text-sm">
                            {isEnglish ? 'Cancel' : 'ÂèñÊ∂à'}
                          </button>
                        </div>
                      </div>
                    ) : (
                      <>
                        <p className="text-slate-700 leading-relaxed mt-2 whitespace-pre-wrap">{comment.text}</p>
                        <div className="mt-3 pt-3 border-t border-slate-300">
                          <button onClick={() => handleToggleLike(comment.id)} disabled={!currentUser}
                            className={`flex items-center gap-2 px-3 py-1 rounded-lg font-semibold text-sm transition-all ${comment.likedBy?.includes(currentUser?.uid) ? 'bg-blue-100 text-lab-blue' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'} ${!currentUser ? 'opacity-50 cursor-not-allowed' : ''}`}>
                            <ThumbsUp size={14} fill={comment.likedBy?.includes(currentUser?.uid) ? 'currentColor' : 'none'} />
                            {comment.likes || 0}
                          </button>
                        </div>
                      </>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ========== src/components/QuizEngine.jsx ==========

import React, { useState, useEffect, useRef } from 'react';
import QuestionCard from './QuestionCard';
import { ChevronLeft, ChevronRight, Send, Timer, FlaskConical, Flag, Clock, X } from 'lucide-react';

export default function QuizEngine({ questions, onComplete }) {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [answers, setAnswers] = useState({});
  const [flagged, setFlagged] = useState(new Set());
  const [showPeriodicTable, setShowPeriodicTable] = useState(false);
  const [showQuestionPanel, setShowQuestionPanel] = useState(false);
  const [timerEnabled, setTimerEnabled] = useState(null);
  const [questionTimes, setQuestionTimes] = useState({});
  const [currentQuestionStartTime, setCurrentQuestionStartTime] = useState(null);
  const [currentTime, setCurrentTime] = useState(Date.now());
  const [sessionStartTime, setSessionStartTime] = useState(null);
  const timerInitialized = useRef(false);
  
  const currentQuestion = questions[currentIndex];
  const totalQuestions = questions.length;
  const progress = ((currentIndex + 1) / totalQuestions) * 100;

  // Timer initialization prompt - only once
  useEffect(() => {
    if (timerEnabled === null && !timerInitialized.current) {
      timerInitialized.current = true;
      const enableTimer = window.confirm(
        "Do you want to enable the timer?\n\n" +
        "The timer will track how long you spend on each question.\n\n" +
        "Click OK to enable, Cancel to skip."
      );
      setTimerEnabled(enableTimer);
      if (enableTimer) {
        const now = Date.now();
        setCurrentQuestionStartTime(now);
        setSessionStartTime(now);
      }
    }
  }, [timerEnabled]);

  // Live timer update - updates every second
  useEffect(() => {
    if (!timerEnabled) return;
    
    const interval = setInterval(() => {
      setCurrentTime(Date.now());
    }, 1000);

    return () => clearInterval(interval);
  }, [timerEnabled]);

  // Start timer when changing questions
  useEffect(() => {
    if (timerEnabled && currentQuestion) {
      setCurrentQuestionStartTime(Date.now());
    }
  }, [currentIndex, timerEnabled]);

  // Record time when leaving a question
  const recordQuestionTime = () => {
    if (timerEnabled && currentQuestionStartTime) {
      const timeSpent = Date.now() - currentQuestionStartTime;
      setQuestionTimes(prev => ({
        ...prev,
        [currentQuestion.ID]: (prev[currentQuestion.ID] || 0) + timeSpent
      }));
    }
  };

  const handleOptionSelect = (option) => {
    setAnswers({
      ...answers,
      [currentQuestion.ID]: option
    });
  };

  const toggleFlag = () => {
    const questionId = currentQuestion.ID;
    setFlagged(prev => {
      const newSet = new Set(prev);
      if (newSet.has(questionId)) {
        newSet.delete(questionId);
      } else {
        newSet.add(questionId);
      }
      return newSet;
    });
  };

  const nextQuestion = () => {
    recordQuestionTime();
    if (currentIndex < totalQuestions - 1) {
      setCurrentIndex(currentIndex + 1);
    }
  };

  const prevQuestion = () => {
    recordQuestionTime();
    if (currentIndex > 0) {
      setCurrentIndex(currentIndex - 1);
    }
  };

  const jumpToQuestion = (index) => {
    recordQuestionTime();
    setCurrentIndex(index);
    setShowQuestionPanel(false);
  };

  const isLastQuestion = currentIndex === totalQuestions - 1;
  const allAnswered = Object.keys(answers).length === totalQuestions;

  // Calculate total time spent (accumulated + current question time)
  const getTotalTimeSpent = () => {
    const accumulated = Object.values(questionTimes).reduce((sum, time) => sum + time, 0);
    if (timerEnabled && currentQuestionStartTime) {
      const currentQuestionTime = currentTime - currentQuestionStartTime;
      return accumulated + currentQuestionTime;
    }
    return accumulated;
  };

  // Calculate session time
  const getSessionTime = () => {
    if (timerEnabled && sessionStartTime) {
      return currentTime - sessionStartTime;
    }
    return 0;
  };

  const formatTime = (ms) => {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hrs = Math.floor(minutes / 60);
    if (hrs > 0) {
      return `${hrs}:${String(minutes % 60).padStart(2, '0')}:${String(seconds % 60).padStart(2, '0')}`;
    }
    return `${minutes}:${String(seconds % 60).padStart(2, '0')}`;
  };

  // Get question status
  const getQuestionStatus = (q) => {
    if (answers[q.ID]) return 'answered';
    if (flagged.has(q.ID)) return 'flagged';
    return 'skipped';
  };

  if (timerEnabled === null) {
    return (
      <div className="flex h-screen items-center justify-center">
        <div className="text-center">
          <Clock className="animate-pulse text-lab-blue w-12 h-12 mx-auto mb-4" />
          <p className="text-slate-600">Initializing quiz...</p>
        </div>
      </div>
    );
  }

  const totalTimeSpent = getTotalTimeSpent();
  const sessionTime = getSessionTime();

  return (
    <div className="relative h-screen overflow-hidden">
      {/* Fixed Left Sidebar */}
      <div className="fixed left-8 top-32 flex flex-col gap-4 z-30 h-[calc(100vh-10rem)]">
        {/* Timer Display */}
        {timerEnabled && (
          <div className="bg-white rounded-2xl shadow-xl border-2 border-lab-blue p-6 w-48">
            <div className="text-center">
              <div className="flex items-center justify-center gap-2 mb-2">
                <Timer className="text-lab-blue" size={24} />
                <span className="text-sm font-bold text-slate-600">SESSION TIME</span>
              </div>
              <div className="text-4xl font-black text-lab-blue mb-4 font-mono">
                {formatTime(sessionTime)}
              </div>
              <div className="text-xs text-slate-500 border-t pt-2">
                <div className="flex justify-between mb-1">
                  <span>Active Time:</span>
                  <span className="font-bold">{formatTime(totalTimeSpent)}</span>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Periodic Table Button */}
        <button
          onClick={() => setShowPeriodicTable(true)}
          className="flex items-center gap-2 px-6 py-4 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition-all shadow-lg hover:scale-105 active:scale-95"
        >
          <FlaskConical size={20} />
          <span>Periodic Table</span>
        </button>

        {/* Question Panel Button */}
        <button
          onClick={() => setShowQuestionPanel(!showQuestionPanel)}
          className="flex items-center gap-2 px-6 py-4 bg-slate-700 text-white rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg hover:scale-105 active:scale-95"
        >
          <Flag size={20} />
          <span>Overview</span>
        </button>

        {/* Spacer to push button to bottom */}
        <div className="flex-1"></div>

        {/* Previous Button - Left Side - Aligned to bottom */}
        <button
          onClick={prevQuestion}
          disabled={currentIndex === 0}
          className="flex items-center justify-center w-16 h-16 bg-lab-blue text-white rounded-full font-bold hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all shadow-lg hover:scale-110 active:scale-95"
        >
          <ChevronLeft size={32} />
        </button>
      </div>

      {/* Fixed Right Sidebar */}
      <div className="fixed right-8 top-32 flex flex-col gap-4 z-30 h-[calc(100vh-10rem)]">
        {/* Flag Button */}
        <button
          onClick={toggleFlag}
          className={`w-16 h-16 rounded-full flex items-center justify-center transition-all shadow-lg hover:scale-110 active:scale-95 ${
            flagged.has(currentQuestion?.ID)
              ? 'bg-amber-500 text-white hover:bg-amber-600'
              : 'bg-white text-amber-500 border-2 border-amber-500 hover:bg-amber-50'
          }`}
          title={flagged.has(currentQuestion?.ID) ? 'Unflag Question' : 'Flag Question'}
        >
          <Flag size={28} fill={flagged.has(currentQuestion?.ID) ? 'currentColor' : 'none'} />
        </button>

        {/* Spacer to push button to bottom */}
        <div className="flex-1"></div>

        {/* Next/Submit Button - Right Side - Aligned to bottom */}
        {!isLastQuestion ? (
          <button
            onClick={nextQuestion}
            className="flex items-center justify-center w-16 h-16 bg-lab-blue text-white rounded-full font-bold hover:bg-blue-800 transition-all shadow-lg hover:scale-110 active:scale-95"
          >
            <ChevronRight size={32} />
          </button>
        ) : (
          <button
            onClick={() => {
              recordQuestionTime();
              onComplete(answers, timerEnabled ? questionTimes : null);
            }}
            className={`flex items-center justify-center w-16 h-16 rounded-full font-bold transition-all shadow-lg hover:scale-110 active:scale-95 ${
              allAnswered 
                ? 'bg-chemistry-green text-white hover:opacity-90' 
                : 'bg-slate-300 text-slate-500 cursor-not-allowed'
            }`}
            title="Finish & Submit"
          >
            <Send size={28} />
          </button>
        )}
      </div>

      {/* Question Overview Panel - Floating Left Sidebar */}
      {showQuestionPanel && (
        <>
          {/* Backdrop - semi-transparent to see content behind */}
          <div 
            className="fixed inset-0 z-40"
            style={{ backgroundColor: 'rgba(0, 0, 0, 0.15)' }}
            onClick={() => setShowQuestionPanel(false)}
          />
          
          {/* Panel - narrower sidebar on the left */}
          <div className="fixed left-0 top-0 h-full w-80 bg-white shadow-2xl z-50 overflow-y-auto animate-in slide-in-from-left duration-300">
            <div className="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
              <h3 className="text-lg font-bold text-slate-800">Question Overview</h3>
              <button 
                onClick={() => setShowQuestionPanel(false)}
                className="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100"
              >
                <X size={20} />
              </button>
            </div>
            
            <div className="p-6">
              <div className="flex flex-col gap-3 mb-6 text-sm">
                <div className="flex items-center gap-2">
                  <div className="w-6 h-6 rounded bg-chemistry-green"></div>
                  <span>Answered ({Object.keys(answers).length})</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-6 h-6 rounded bg-amber-500"></div>
                  <span>Flagged ({flagged.size})</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-6 h-6 rounded bg-slate-200"></div>
                  <span>Skipped ({totalQuestions - Object.keys(answers).length})</span>
                </div>
              </div>

              <div className="grid grid-cols-4 gap-3">
                {questions.map((q, idx) => {
                  const status = getQuestionStatus(q);
                  return (
                    <button
                      key={q.ID}
                      onClick={() => jumpToQuestion(idx)}
                      className={`aspect-square rounded-xl font-bold text-base transition-all border-2 ${
                        idx === currentIndex
                          ? 'border-lab-blue ring-2 ring-lab-blue ring-offset-2'
                          : 'border-transparent'
                      } ${
                        status === 'answered'
                          ? 'bg-chemistry-green text-white hover:opacity-80'
                          : status === 'flagged'
                          ? 'bg-amber-500 text-white hover:opacity-80'
                          : 'bg-slate-200 text-slate-600 hover:bg-slate-300'
                      }`}
                    >
                      {idx + 1}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        </>
      )}

      {/* Periodic Table Modal */}
      {showPeriodicTable && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
          onClick={() => setShowPeriodicTable(false)}
        >
          <div 
            className="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-auto"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
              <h3 className="text-xl font-bold text-slate-800">Periodic Table of Elements</h3>
              <button 
                onClick={() => setShowPeriodicTable(false)}
                className="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100"
              >
                <X size={24} />
              </button>
            </div>
            <div className="p-4">
              <img 
                src="https://upload.wikimedia.org/wikipedia/commons/2/2e/Simple_Periodic_Table_Chart-en.svg"
                alt="Periodic Table"
                className="w-full h-auto"
              />
            </div>
          </div>
        </div>
      )}

      {/* Main Content Area - Centered and compact */}
      <div className="max-w-5xl mx-auto px-4 py-6 h-full flex flex-col">
        {/* Progress Header - More Compact */}
        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
          <div className="flex justify-between items-center mb-2">
            <div className="flex items-baseline gap-3">
              <span className="text-3xl font-black text-lab-blue">
                Q{currentIndex + 1}
              </span>
              <span className="text-sm font-medium text-slate-500">
                of {totalQuestions}
              </span>
            </div>
            <span className="text-xl font-bold text-lab-blue">
              {Math.round(progress)}%
            </span>
          </div>
          <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
            <div 
              className="bg-lab-blue h-full transition-all duration-300" 
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>

        {/* Question Card Component - Takes remaining space */}
        <div className="flex-1 overflow-y-auto">
          <QuestionCard 
            question={currentQuestion}
            selectedOption={answers[currentQuestion.ID]}
            onSelect={handleOptionSelect}
          />
        </div>

        {/* Mini Progress Dots */}
        <div className="flex justify-center gap-1 mt-4 py-2">
          {questions.slice(0, Math.min(30, totalQuestions)).map((_, idx) => (
            <div 
              key={idx}
              className={`w-2 h-2 rounded-full transition-all ${
                idx === currentIndex ? 'bg-lab-blue w-6' : 
                answers[questions[idx].ID] ? 'bg-chemistry-green' : 
                flagged.has(questions[idx].ID) ? 'bg-amber-500' : 'bg-slate-200'
              }`}
            />
          ))}
          {totalQuestions > 30 && <span className="text-slate-400 text-xs">...</span>}
        </div>

        {!allAnswered && isLastQuestion && (
          <p className="text-center text-sm text-amber-600 font-medium mt-2">
            Please answer all questions before submitting.
          </p>
        )}
      </div>
    </div>
  );
}

// ========== src/components/ResultsSummary.jsx ==========

import React, { useState } from 'react';
import { CheckCircle2, XCircle, BarChart3, RotateCcw, Info, Clock, Share2, MessageSquare } from 'lucide-react';
import ShareableReport from './ShareableReport';
import QuestionForum from './QuestionForum';

export default function ResultsSummary({ questions, userAnswers, questionTimes, onRestart }) {
  const [showShareReport, setShowShareReport] = useState(false);
  const [forumQuestion, setForumQuestion] = useState(null);

  // 1. Calculate Score
  const total = questions.length;
  const correctCount = questions.reduce((acc, q) => {
    return acc + (userAnswers[q.ID] === q.CorrectOption ? 1 : 0);
  }, 0);
  const percentage = Math.round((correctCount / total) * 100);

  // Format time
  const formatTime = (ms) => {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hrs = Math.floor(minutes / 60);
    if (hrs > 0) {
      return `${hrs}h ${minutes % 60}m ${seconds % 60}s`;
    } else if (minutes > 0) {
      return `${minutes}m ${seconds % 60}s`;
    }
    return `${seconds}s`;
  };

  // Calculate total time and average
  const totalTime = questionTimes 
    ? Object.values(questionTimes).reduce((sum, time) => sum + time, 0)
    : null;
  
  const averageTimePerQuestion = questionTimes && total > 0
    ? totalTime / total
    : null;

  // 2. Strength/Weakness Analysis by Topic
  const analysis = questions.reduce((acc, q) => {
    if (!acc[q.Topic]) {
      acc[q.Topic] = { total: 0, correct: 0 };
    }
    acc[q.Topic].total += 1;
    if (userAnswers[q.ID] === q.CorrectOption) {
      acc[q.Topic].correct += 1;
    }
    return acc;
  }, {});

  const topicResults = Object.entries(analysis).map(([topic, data]) => ({
    topic,
    percent: Math.round((data.correct / data.total) * 100),
    ...data
  }));

  const strengths = topicResults.filter(t => t.percent >= 70);
  const weaknesses = topicResults.filter(t => t.percent < 70);

  return (
    <div className="space-y-8 animate-in fade-in duration-500">
      {/* Hero Score Section */}
      <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
        <div className="bg-lab-blue p-8 text-center text-white">
          <h2 className="text-xl opacity-90 mb-2">Your Performance</h2>
          <div className="text-6xl font-black mb-2">{percentage}%</div>
          <p className="text-blue-100">
            {correctCount} out of {total} questions correct
          </p>
          {totalTime && (
            <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-blue-100">
              <div className="bg-blue-700 bg-opacity-50 rounded-lg p-4">
                <div className="flex items-center justify-center gap-2 mb-1">
                  <Clock size={18} />
                  <span className="text-sm font-semibold">Total Time</span>
                </div>
                <div className="text-2xl font-bold">{formatTime(totalTime)}</div>
              </div>
              <div className="bg-blue-700 bg-opacity-50 rounded-lg p-4">
                <div className="flex items-center justify-center gap-2 mb-1">
                  <Clock size={18} />
                  <span className="text-sm font-semibold">Average per MCQ</span>
                </div>
                <div className="text-2xl font-bold">{formatTime(averageTimePerQuestion)}</div>
              </div>
            </div>
          )}
        </div>

        {/* Analytics Grid */}
        <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50">
          <div className="bg-white p-4 rounded-xl border border-slate-200">
            <h3 className="flex items-center gap-2 font-bold text-chemistry-green mb-3">
              <CheckCircle2 size={18} /> Strengths
            </h3>
            {strengths.length > 0 ? (
              strengths.map(s => (
                <div key={s.topic} className="text-sm mb-2 flex justify-between">
                  <span className="truncate mr-2">{s.topic}</span>
                  <span className="font-bold">{s.percent}%</span>
                </div>
              ))
            ) : <p className="text-sm text-slate-400 italic">Keep practicing to build strengths!</p>}
          </div>

          <div className="bg-white p-4 rounded-xl border border-slate-200">
            <h3 className="flex items-center gap-2 font-bold text-amber-600 mb-3">
              <BarChart3 size={18} /> Needs Focus
            </h3>
            {weaknesses.length > 0 ? (
              weaknesses.map(w => (
                <div key={w.topic} className="text-sm mb-2 flex justify-between">
                  <span className="truncate mr-2">{w.topic}</span>
                  <span className="font-bold text-amber-700">{w.percent}%</span>
                </div>
              ))
            ) : <p className="text-sm text-slate-400 italic">No major weaknesses detected!</p>}
          </div>
        </div>
      </div>

      {/* Action Buttons */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button
          onClick={() => setShowShareReport(true)}
          className="w-full py-4 flex items-center justify-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-bold hover:opacity-90 transition-all shadow-lg"
        >
          <Share2 size={20} />
          Share Report Card
        </button>

        <button
          onClick={onRestart}
          className="w-full py-4 flex items-center justify-center gap-2 bg-carbon-grey text-white rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg"
        >
          <RotateCcw size={20} />
          Start New Session
        </button>
      </div>

      {/* Detailed Review List */}
      <div className="space-y-4">
        <h3 className="text-xl font-bold flex items-center gap-2">
          <Info className="text-lab-blue" /> Detailed Review
        </h3>
        {questions.map((q, index) => {
          const isCorrect = userAnswers[q.ID] === q.CorrectOption;
          const timeSpent = questionTimes ? questionTimes[q.ID] : null;
          
          return (
            <div key={q.ID} className={`p-6 rounded-xl border-l-4 bg-white shadow-sm ${isCorrect ? 'border-chemistry-green' : 'border-red-500'}`}>
              <div className="flex justify-between items-start mb-4">
                <div className="flex items-center gap-3">
                  <span className="text-2xl font-black text-slate-700">Question {index + 1}</span>
                  {timeSpent && (
                    <div className="text-sm text-slate-500 flex items-center gap-1 bg-slate-100 px-3 py-1 rounded-full">
                      <Clock size={14} />
                      <span className="font-semibold">{formatTime(timeSpent)}</span>
                    </div>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  {/* Forum Button */}
                  <button
                    onClick={() => setForumQuestion(q)}
                    className="flex items-center gap-2 px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-bold hover:bg-purple-200 transition-all"
                    title="Discuss this question"
                  >
                    <MessageSquare size={16} />
                    <span className="hidden sm:inline">Discuss</span>
                  </button>
                  
                  {/* Status Icon */}
                  {isCorrect ? 
                    <CheckCircle2 className="text-chemistry-green" size={24} /> : 
                    <XCircle className="text-red-500" size={24} />
                  }
                </div>
              </div>
              
              <div className="prose prose-slate max-w-none mb-4 text-lg" dangerouslySetInnerHTML={{ __html: q.Question }} />
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
                <div className={`p-3 rounded-lg text-sm border ${userAnswers[q.ID] === q.CorrectOption ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                  <strong>Your Answer:</strong> {userAnswers[q.ID] || 'None'}
                </div>
                <div className="p-3 rounded-lg bg-blue-50 border border-blue-200 text-blue-800 text-sm">
                  <strong>Correct Answer:</strong> {q.CorrectOption}
                </div>
              </div>

              {q.Explanation && (
                <div className="mt-4 p-4 bg-slate-100 rounded-lg text-sm border border-slate-200">
                  <strong className="block mb-2 text-slate-700 flex items-center gap-1">
                    <Info size={14}/> Explanation:
                  </strong>
                  <div dangerouslySetInnerHTML={{ __html: q.Explanation }} className="leading-relaxed text-slate-600" />
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* Share Report Modal */}
      {showShareReport && (
        <ShareableReport
          questions={questions}
          userAnswers={userAnswers}
          questionTimes={questionTimes}
          onClose={() => setShowShareReport(false)}
        />
      )}

      {/* Forum Modal */}
      {forumQuestion && (
        <QuestionForum
          question={forumQuestion}
          onClose={() => setForumQuestion(null)}
        />
      )}
    </div>
  );
}

// ========== src/components/ShareableReport.jsx ==========

import React, { useRef, useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';
import { Download, Share2, X, Trophy, Target, Clock, Calendar, CheckCircle, AlertCircle } from 'lucide-react';

export default function ShareableReport({ 
  questions, 
  userAnswers, 
  questionTimes,
  onClose 
}) {
  const { currentUser } = useAuth();
  const { isEnglish } = useLanguage();
  const reportRef = useRef(null);
  const [exporting, setExporting] = useState(false);
  const [error, setError] = useState(null);

  // Calculate stats
  const totalQuestions = questions.length;
  const correctAnswers = questions.reduce((acc, q) => {
    return acc + (userAnswers[q.ID] === q.CorrectOption ? 1 : 0);
  }, 0);
  const percentage = Math.round((correctAnswers / totalQuestions) * 100);

  const topics = [...new Set(questions.map(q => q.Topic))].filter(Boolean);

  const totalTime = questionTimes 
    ? Object.values(questionTimes).reduce((sum, time) => sum + time, 0)
    : null;

  const formatTime = (ms) => {
    if (!ms) return 'N/A';
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hrs = Math.floor(minutes / 60);
    if (hrs > 0) {
      return `${hrs}h ${minutes % 60}m`;
    }
    return `${minutes}m ${seconds % 60}s`;
  };

  const formatDate = () => {
    const date = new Date();
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  };

  // Topic analysis
  const topicAnalysis = questions.reduce((acc, q) => {
    if (!acc[q.Topic]) {
      acc[q.Topic] = { total: 0, correct: 0 };
    }
    acc[q.Topic].total += 1;
    if (userAnswers[q.ID] === q.CorrectOption) {
      acc[q.Topic].correct += 1;
    }
    return acc;
  }, {});

  const topicResults = Object.entries(topicAnalysis).map(([topic, data]) => ({
    topic,
    percent: Math.round((data.correct / data.total) * 100),
    ...data
  }));

  // IMPROVED: Export as Image with better error handling and proxy for CORS
  const exportAsImage = async () => {
    if (!reportRef.current) {
      setError(isEnglish ? 'Report not ready. Please try again.' : 'Â†±ÂëäÊú™Ê∫ñÂÇôÂ•Ω„ÄÇË´ãÈáçË©¶„ÄÇ');
      return;
    }
    
    setExporting(true);
    setError(null);
    
    try {
      console.log('üîµ Starting image export...');
      
      // Wait for rendering to complete
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Create canvas with improved settings
      const canvas = await html2canvas(reportRef.current, {
        scale: 2, // High quality
        backgroundColor: '#ffffff',
        logging: false,
        useCORS: true,
        allowTaint: false, // Changed to false for better CORS handling
        foreignObjectRendering: false,
        imageTimeout: 15000, // Increased timeout
        onclone: (clonedDoc) => {
          // Remove any problematic images in the cloned document
          const images = clonedDoc.getElementsByTagName('img');
          Array.from(images).forEach(img => {
            // If image has CORS issues, replace with placeholder
            if (img.src && !img.complete) {
              img.style.display = 'none';
            }
          });
        }
      });
      
      console.log('‚úÖ Canvas created successfully');
      
      // Convert to blob and download
      canvas.toBlob((blob) => {
        if (!blob) {
          throw new Error(isEnglish ? 'Failed to create image' : 'ÁÑ°Ê≥ïÂâµÂª∫ÂúñÁâá');
        }
        
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = `ChemLeung-Report-${formatDate().replace(/\s/g, '-')}.png`;
        link.href = url;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        console.log('‚úÖ Image downloaded successfully');
        setExporting(false);
      }, 'image/png', 0.95); // High quality PNG
      
    } catch (error) {
      console.error('‚ùå Error exporting image:', error);
      setError(isEnglish 
        ? 'Failed to export image. Try PDF export instead.' 
        : 'ÂåØÂá∫ÂúñÁâáÂ§±Êïó„ÄÇË´ãÂòóË©¶ PDF ÂåØÂá∫„ÄÇ'
      );
      setExporting(false);
    }
  };

  // IMPROVED: Export as PDF with better error handling
  const exportAsPDF = async () => {
    if (!reportRef.current) {
      setError(isEnglish ? 'Report not ready. Please try again.' : 'Â†±ÂëäÊú™Ê∫ñÂÇôÂ•Ω„ÄÇË´ãÈáçË©¶„ÄÇ');
      return;
    }
    
    setExporting(true);
    setError(null);
    
    try {
      console.log('üîµ Starting PDF export...');
      
      // Wait for rendering to complete
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Create canvas
      const canvas = await html2canvas(reportRef.current, {
        scale: 2,
        backgroundColor: '#ffffff',
        logging: false,
        useCORS: true,
        allowTaint: false,
        foreignObjectRendering: false,
        imageTimeout: 15000,
        onclone: (clonedDoc) => {
          // Remove any problematic images in the cloned document
          const images = clonedDoc.getElementsByTagName('img');
          Array.from(images).forEach(img => {
            if (img.src && !img.complete) {
              img.style.display = 'none';
            }
          });
        }
      });
      
      console.log('‚úÖ Canvas created for PDF');
      
      const imgData = canvas.toDataURL('image/png', 0.95);
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4',
        compress: true
      });
      
      const imgWidth = 210; // A4 width in mm
      const pageHeight = 297; // A4 height in mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      
      let heightLeft = imgHeight;
      let position = 0;
      
      // Add first page
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
      heightLeft -= pageHeight;
      
      // Add additional pages if needed
      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
        heightLeft -= pageHeight;
      }
      
      pdf.save(`ChemLeung-Report-${formatDate().replace(/\s/g, '-')}.pdf`);
      
      console.log('‚úÖ PDF downloaded successfully');
      setExporting(false);
    } catch (error) {
      console.error('‚ùå Error exporting PDF:', error);
      setError(isEnglish 
        ? 'Failed to export PDF. Try image export instead.' 
        : 'ÂåØÂá∫ PDF Â§±Êïó„ÄÇË´ãÂòóË©¶ÂúñÁâáÂåØÂá∫„ÄÇ'
      );
      setExporting(false);
    }
  };

  const getGradeColor = (percent) => {
    if (percent >= 80) return 'from-green-500 to-emerald-600';
    if (percent >= 60) return 'from-blue-500 to-indigo-600';
    if (percent >= 40) return 'from-amber-500 to-orange-600';
    return 'from-red-500 to-rose-600';
  };

  const getGrade = (percent) => {
    if (percent >= 90) return 'A+';
    if (percent >= 80) return 'A';
    if (percent >= 70) return 'B';
    if (percent >= 60) return 'C';
    if (percent >= 50) return 'D';
    return 'F';
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
      <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        {/* Header with close and export buttons */}
        <div className="sticky top-0 bg-white border-b-2 border-slate-200 p-4 flex justify-between items-center rounded-t-2xl z-10">
          <h2 className="text-2xl font-black text-slate-800 flex items-center gap-2">
            <Share2 className="text-lab-blue" size={24} />
            {isEnglish ? 'Share Report Card' : 'ÂàÜ‰∫´ÊàêÁ∏æÂñÆ'}
          </h2>
          
          <div className="flex items-center gap-2">
            <button
              onClick={exportAsImage}
              disabled={exporting}
              className="flex items-center gap-2 px-4 py-2 bg-lab-blue text-white rounded-lg font-bold hover:bg-blue-700 disabled:bg-slate-300 transition-all"
              title={isEnglish ? 'Download as PNG image' : '‰∏ãËºâÁÇ∫ PNG ÂúñÁâá'}
            >
              <Download size={18} />
              {isEnglish ? 'Image' : 'ÂúñÁâá'}
            </button>
            
            <button
              onClick={exportAsPDF}
              disabled={exporting}
              className="flex items-center gap-2 px-4 py-2 bg-chemistry-green text-white rounded-lg font-bold hover:opacity-90 disabled:bg-slate-300 transition-all"
              title={isEnglish ? 'Download as PDF' : '‰∏ãËºâÁÇ∫ PDF'}
            >
              <Download size={18} />
              PDF
            </button>
            
            <button
              onClick={onClose}
              className="p-2 hover:bg-slate-100 rounded-lg transition-all"
              title={isEnglish ? 'Close' : 'ÈóúÈñâ'}
            >
              <X size={24} />
            </button>
          </div>
        </div>

        {/* Error Display */}
        {error && (
          <div className="mx-4 mt-4 bg-red-50 border-2 border-red-200 rounded-lg p-4 flex items-start gap-3">
            <AlertCircle className="text-red-500 flex-shrink-0 mt-0.5" size={20} />
            <div className="flex-1">
              <p className="text-red-800 font-semibold">{error}</p>
              <button
                onClick={() => setError(null)}
                className="text-sm text-red-600 hover:underline mt-1"
              >
                {isEnglish ? 'Dismiss' : 'ÈóúÈñâ'}
              </button>
            </div>
          </div>
        )}

        {/* Report Card Content - NO EXTERNAL IMAGES to avoid CORS */}
        <div ref={reportRef} className="p-8 bg-gradient-to-br from-slate-50 to-blue-50">
          {/* Header */}
          <div className="text-center mb-8">
            <div className="inline-block bg-lab-blue px-6 py-2 rounded-full mb-4">
              <h1 className="text-3xl font-black text-white">ChemLeung</h1>
            </div>
            <h2 className="text-2xl font-bold text-slate-800 mb-2">
              {isEnglish ? 'HKDSE Chemistry Practice Report' : 'HKDSE ÂåñÂ≠∏Á∑¥ÁøíÂ†±Âëä'}
            </h2>
            <div className="flex items-center justify-center gap-4 text-slate-600">
              <div className="flex items-center gap-1">
                <Calendar size={16} />
                <span className="text-sm font-semibold">{formatDate()}</span>
              </div>
            </div>
          </div>

          {/* Student Info */}
          <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border-2 border-slate-200">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <div className="text-sm text-slate-500 mb-1">
                  {isEnglish ? 'Student Name' : 'Â≠∏ÁîüÂßìÂêç'}
                </div>
                <div className="text-lg font-bold text-slate-800">
                  {currentUser?.displayName || 'Student'}
                </div>
              </div>
              <div>
                <div className="text-sm text-slate-500 mb-1">
                  {isEnglish ? 'Topics Covered' : 'Ê∂µËìã‰∏ªÈ°å'}
                </div>
                <div className="text-lg font-bold text-slate-800">
                  {topics.length} {isEnglish ? 'Topics' : 'ÂÄã‰∏ªÈ°å'}
                </div>
              </div>
            </div>
          </div>

          {/* Main Score Display */}
          <div className={`bg-gradient-to-r ${getGradeColor(percentage)} rounded-2xl shadow-2xl p-8 mb-6 text-white`}>
            <div className="text-center">
              <div className="text-6xl font-black mb-2">{percentage}%</div>
              <div className="text-3xl font-bold mb-4">{getGrade(percentage)}</div>
              <div className="text-xl opacity-90">
                {correctAnswers} {isEnglish ? 'out of' : '/'} {totalQuestions} {isEnglish ? 'Correct' : 'Ê≠£Á¢∫'}
              </div>
            </div>
          </div>

          {/* Stats Grid */}
          <div className="grid grid-cols-3 gap-4 mb-6">
            <div className="bg-white rounded-xl shadow-lg p-4 border-2 border-blue-200 text-center">
              <div className="w-8 h-8 bg-amber-500 rounded-full flex items-center justify-center mx-auto mb-2">
                <Trophy size={20} className="text-white" />
              </div>
              <div className="text-2xl font-black text-slate-800">{correctAnswers}</div>
              <div className="text-sm text-slate-600">{isEnglish ? 'Correct' : 'Ê≠£Á¢∫'}</div>
            </div>
            
            <div className="bg-white rounded-xl shadow-lg p-4 border-2 border-red-200 text-center">
              <div className="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-2">
                <Target size={20} className="text-white" />
              </div>
              <div className="text-2xl font-black text-slate-800">{totalQuestions - correctAnswers}</div>
              <div className="text-sm text-slate-600">{isEnglish ? 'Incorrect' : 'ÈåØË™§'}</div>
            </div>
            
            {totalTime && (
              <div className="bg-white rounded-xl shadow-lg p-4 border-2 border-purple-200 text-center">
                <div className="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-2">
                  <Clock size={20} className="text-white" />
                </div>
                <div className="text-2xl font-black text-slate-800">{formatTime(totalTime)}</div>
                <div className="text-sm text-slate-600">{isEnglish ? 'Time Used' : 'Áî®ÊôÇ'}</div>
              </div>
            )}
          </div>

          {/* Topic Breakdown */}
          <div className="bg-white rounded-xl shadow-lg p-6 border-2 border-slate-200">
            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <div className="w-5 h-5 bg-lab-blue rounded-full flex items-center justify-center">
                <CheckCircle size={14} className="text-white" />
              </div>
              {isEnglish ? 'Topic Breakdown' : '‰∏ªÈ°åÂàÜÊûê'}
            </h3>
            
            <div className="space-y-3">
              {topicResults.map((result, index) => (
                <div key={index} className="flex items-center justify-between">
                  <div className="flex-1">
                    <div className="flex justify-between mb-1">
                      <span className="text-sm font-semibold text-slate-700">{result.topic}</span>
                      <span className="text-sm font-bold text-slate-800">{result.percent}%</span>
                    </div>
                    <div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                      <div 
                        className={`h-full rounded-full ${
                          result.percent >= 70 ? 'bg-chemistry-green' :
                          result.percent >= 50 ? 'bg-amber-500' :
                          'bg-red-500'
                        }`}
                        style={{ width: `${result.percent}%` }}
                      />
                    </div>
                    <div className="text-xs text-slate-500 mt-1">
                      {result.correct}/{result.total} {isEnglish ? 'correct' : 'Ê≠£Á¢∫'}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Footer */}
          <div className="mt-8 pt-6 border-t-2 border-slate-200 text-center text-slate-500 text-sm">
            <p className="font-semibold">
              {isEnglish 
                ? 'Generated by ChemLeung HKDSE MCQ Practice Platform' 
                : 'Áî± ChemLeung HKDSE MCQ Á∑¥ÁøíÂπ≥Âè∞ÁîüÊàê'}
            </p>
            <p className="text-xs mt-1">www.chemleung.com</p>
          </div>
        </div>

        {/* Loading Overlay */}
        {exporting && (
          <div className="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center rounded-2xl">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-lab-blue mx-auto mb-4"></div>
              <p className="text-slate-700 font-semibold">
                {isEnglish ? 'Generating report...' : 'ÁîüÊàêÂ†±Âëä‰∏≠...'}
              </p>
              <p className="text-slate-500 text-sm mt-2">
                {isEnglish ? 'This may take a few seconds' : 'ÈÄôÂèØËÉΩÈúÄË¶ÅÂπæÁßíÈêò'}
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ========== src/components/TokenLog.jsx ==========

// ============================================================================
// TOKEN LOG - Transaction History
// ============================================================================

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { getTokenHistory } from '../services/tokenService';
import { ArrowLeft, TrendingUp, TrendingDown, Clock, Filter, Zap } from 'lucide-react';

export default function TokenLog() {
  const navigate = useNavigate();
  const { currentUser } = useAuth();
  const [history, setHistory] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all'); // all | gains | spends

  useEffect(() => {
    loadHistory();
  }, [currentUser]);

  async function loadHistory() {
    if (!currentUser) return;
    
    setLoading(true);
    try {
      const data = await getTokenHistory(currentUser.uid, 50);
      setHistory(data);
    } catch (error) {
      console.error('Error loading token history:', error);
    }
    setLoading(false);
  }

  const formatTimeAgo = (timestamp) => {
    if (!timestamp) return 'Unknown';
    
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-GB', { 
      day: '2-digit', 
      month: 'short', 
      year: 'numeric' 
    });
  };

  const filteredHistory = history.filter(entry => {
    if (filter === 'gains') return entry.type === 'gain';
    if (filter === 'spends') return entry.type === 'spend';
    return true;
  });

  // Calculate totals
  const totalGained = history
    .filter(e => e.type === 'gain')
    .reduce((sum, e) => sum + e.amount, 0);
  
  const totalSpent = history
    .filter(e => e.type === 'spend')
    .reduce((sum, e) => sum + Math.abs(e.amount), 0);

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={() => navigate('/dashboard')}
          className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all"
        >
          <ArrowLeft size={20} />
        </button>
        
        <div className="flex-1 bg-gradient-to-r from-amber-500 to-orange-600 rounded-2xl shadow-xl p-6 text-white">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <Clock size={32} />
            Token History
          </h1>
          <p className="text-orange-100 mt-1">
            Track your earnings and purchases
          </p>
        </div>
      </div>

      {/* Stats Overview */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-white rounded-xl shadow-lg border-2 border-green-200 p-6">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-3 bg-green-100 rounded-lg">
              <TrendingUp className="text-green-600" size={24} />
            </div>
            <div>
              <div className="text-sm font-semibold text-slate-600">Total Earned</div>
              <div className="text-3xl font-black text-green-600 flex items-center gap-2">
                <Zap size={24} fill="currentColor" />
                {totalGained}
              </div>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-lg border-2 border-red-200 p-6">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-3 bg-red-100 rounded-lg">
              <TrendingDown className="text-red-600" size={24} />
            </div>
            <div>
              <div className="text-sm font-semibold text-slate-600">Total Spent</div>
              <div className="text-3xl font-black text-red-600 flex items-center gap-2">
                <Zap size={24} fill="currentColor" />
                {totalSpent}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-4">
        <div className="flex items-center gap-3">
          <Filter size={18} className="text-slate-600" />
          <div className="flex gap-2">
            {[
              { value: 'all', label: 'All Transactions' },
              { value: 'gains', label: 'Gains' },
              { value: 'spends', label: 'Spends' }
            ].map(opt => (
              <button
                key={opt.value}
                onClick={() => setFilter(opt.value)}
                className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${
                  filter === opt.value
                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                }`}
              >
                {opt.label}
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Transaction List */}
      <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
        <div className="bg-slate-50 p-4 border-b-2 border-slate-200">
          <h2 className="text-lg font-bold text-slate-800">
            Recent Transactions ({filteredHistory.length})
          </h2>
        </div>

        <div className="divide-y divide-slate-100">
          {loading ? (
            <div className="flex justify-center py-12">
              <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-lab-blue"></div>
            </div>
          ) : filteredHistory.length === 0 ? (
            <div className="text-center py-12">
              <Clock className="w-16 h-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-400 text-lg">
                {filter === 'all' 
                  ? 'No transactions yet' 
                  : `No ${filter === 'gains' ? 'earnings' : 'purchases'} yet`
                }
              </p>
              <p className="text-slate-500 text-sm mt-2">
                Complete quizzes to start earning tokens!
              </p>
            </div>
          ) : (
            filteredHistory.map((entry, index) => {
              const isGain = entry.type === 'gain';
              const amount = Math.abs(entry.amount);

              return (
                <div
                  key={entry.id || index}
                  className="p-4 hover:bg-slate-50 transition-all"
                >
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4 flex-1">
                      {/* Icon */}
                      <div className={`p-3 rounded-lg ${
                        isGain ? 'bg-green-100' : 'bg-red-100'
                      }`}>
                        {isGain ? (
                          <TrendingUp className="text-green-600" size={20} />
                        ) : (
                          <TrendingDown className="text-red-600" size={20} />
                        )}
                      </div>

                      {/* Details */}
                      <div className="flex-1 min-w-0">
                        <div className="font-bold text-slate-800 mb-1">
                          {entry.reason}
                        </div>
                        <div className="text-sm text-slate-500 flex items-center gap-2">
                          <Clock size={12} />
                          {formatTimeAgo(entry.timestamp)}
                          {entry.metadata?.category && (
                            <>
                              <span>‚Ä¢</span>
                              <span className="capitalize">
                                {entry.metadata.category.replace('_', ' ')}
                              </span>
                            </>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Amount */}
                    <div className="flex items-center gap-2">
                      <div className={`text-2xl font-black ${
                        isGain ? 'text-green-600' : 'text-red-600'
                      }`}>
                        {isGain ? '+' : '-'}{amount}
                      </div>
                      <Zap 
                        size={20} 
                        className={isGain ? 'text-green-600' : 'text-red-600'}
                        fill="currentColor"
                      />
                    </div>
                  </div>

                  {/* Balance After */}
                  {entry.balanceAfter !== undefined && (
                    <div className="mt-2 text-xs text-slate-400 text-right">
                      Balance after: {entry.balanceAfter} tokens
                    </div>
                  )}
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}

// ========== src/components/dashboard/CalendarHeatmap.jsx ==========

import React, { useMemo } from 'react';
import { Calendar } from 'lucide-react';
import { useLanguage } from '../../contexts/LanguageContext';

/**
 * CalendarHeatmap: 30-day mistake-clearing activity visualization
 * Shows daily progress on a calendar grid with color intensity
 */
export default function CalendarHeatmap({ mistakes = [] }) {
  const { t } = useLanguage();

  const activityMap = useMemo(() => {
    const map = {};
    const now = new Date();

    // Initialize 30-day map
    for (let i = 0; i < 30; i++) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      map[dateStr] = 0;
    }

    // Count correct answers by date
    mistakes.forEach((mistake) => {
      if (mistake.lastCorrect) {
        const dateStr = new Date(mistake.lastCorrect).toISOString().split('T')[0];
        if (map[dateStr] !== undefined) {
          map[dateStr]++;
        }
      }
    });

    return map;
  }, [mistakes]);

  const days = Object.entries(activityMap).reverse();
  const maxActivity = Math.max(...Object.values(activityMap), 1);

  const getColor = (count) => {
    const intensity = count / maxActivity;
    if (intensity === 0) return 'bg-slate-100 hover:bg-slate-200';
    if (intensity < 0.33) return 'bg-green-200 hover:bg-green-300';
    if (intensity < 0.67) return 'bg-green-400 hover:bg-green-500';
    return 'bg-green-600 hover:bg-green-700';
  };

  const getTotalCleared = () => Object.values(activityMap).reduce((a, b) => a + b, 0);

  return (
    <div className="bg-white rounded-2xl shadow-lg border-2 border-slate-100 p-6">
      {/* Header */}
      <div className="flex items-center gap-3 mb-6">
        <div className="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center">
          <Calendar className="text-green-600" size={28} />
        </div>
        <div>
          <h3 className="text-xl font-black text-slate-800">Activity Tracker</h3>
          <p className="text-xs text-slate-500 mt-1">30-day mistake-clearing consistency</p>
        </div>
      </div>

      {/* Stats Row */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        <div className="text-center">
          <div className="text-sm text-slate-600 font-medium mb-1">Total Cleared (30 days)</div>
          <div className="text-3xl font-black text-green-600">{getTotalCleared()}</div>
        </div>
        <div className="text-center">
          <div className="text-sm text-slate-600 font-medium mb-1">Busiest Day</div>
          <div className="text-3xl font-black text-green-600">{maxActivity}</div>
        </div>
      </div>

      {/* Calendar Grid */}
      <div className="overflow-x-auto mb-4">
        <div className="inline-block min-w-full">
          <div className="grid gap-1" style={{ gridTemplateColumns: 'repeat(7, 1fr)' }}>
            {/* Day headers */}
            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, idx) => (
              <div
                key={`header-${idx}`}
                className="text-center text-xs font-bold text-slate-400 h-6 flex items-center justify-center"
              >
                {day.slice(0, 1)}
              </div>
            ))}

            {/* Calendar cells */}
            {days.map(([dateStr, count]) => {
              const date = new Date(dateStr);
              const dayOfWeek = date.getDay();
              const isToday = dateStr === new Date().toISOString().split('T')[0];

              return (
                <div
                  key={dateStr}
                  className={`w-8 h-8 rounded flex items-center justify-center text-xs font-bold text-slate-700 transition-all cursor-pointer ring-2 ring-offset-1 ${
                    isToday ? 'ring-indigo-400 ring-offset-slate-100' : 'ring-transparent'
                  } ${getColor(count)}`}
                  title={`${dateStr}: ${count} question${count !== 1 ? 's' : ''} cleared`}
                >
                  {count > 0 && <span className="text-white font-black text-xs">{count}</span>}
                </div>
              );
            })}
          </div>
        </div>
      </div>

      {/* Legend */}
      <div className="flex items-center justify-center gap-3 text-xs text-slate-600 pt-4 border-t border-slate-200">
        <span className="font-medium">Less</span>
        <div className="flex gap-1">
          {[0, 0.33, 0.67, 1.0].map((i, idx) => (
            <div
              key={idx}
              className={`w-3 h-3 rounded transition-colors ${getColor(i * maxActivity).split(' ')[0]}`}
            />
          ))}
        </div>
        <span className="font-medium">More</span>
      </div>

      {/* Motivational Message */}
      <div className="mt-4 pt-4 border-t border-slate-200 bg-green-50 rounded-lg p-3">
        <p className="text-sm text-green-800 font-semibold text-center">
          üî• Keep the streak going! Consistency builds mastery.{' '}
        </p>
      </div>
    </div>
  );
}


// ========== src/components/dashboard/CompactAttemptsList.jsx ==========

import React from 'react';
import { Clock, ChevronRight, AlertCircle } from 'lucide-react';
import { useLanguage } from '../../contexts/LanguageContext';

/**
 * CompactAttemptsList: More compact version of Recent Attempts
 * Adds Topic Badges and better visual hierarchy
 */
export default function CompactAttemptsList({ attempts = [], onSelectAttempt = () => {}, loading = false }) {
  const { t } = useLanguage();

  const formatDate = (iso) =>
    new Date(iso).toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit',
    });

  const formatTime = (ms) => {
    if (!ms) return 'N/A';
    const s = Math.floor(ms / 1000),
      m = Math.floor(s / 60),
      h = Math.floor(m / 60);
    if (h > 0) return `${h}h ${m % 60}m`;
    if (m > 0) return `${m}m ${s % 60}s`;
    return `${s}s`;
  };

  const getAccuracyColor = (percentage) => {
    if (percentage >= 70) return 'from-emerald-100 to-emerald-200 text-emerald-800 border-emerald-300';
    if (percentage >= 50) return 'from-amber-100 to-amber-200 text-amber-800 border-amber-300';
    return 'from-rose-100 to-rose-200 text-rose-800 border-rose-300';
  };

  const getTopicBadgeColor = (index) => {
    const colors = [
      'bg-blue-100 text-blue-700',
      'bg-purple-100 text-purple-700',
      'bg-pink-100 text-pink-700',
      'bg-green-100 text-green-700',
      'bg-orange-100 text-orange-700',
    ];
    return colors[index % colors.length];
  };

  return (
    <div className="bg-white rounded-2xl shadow-lg border-2 border-slate-100 overflow-hidden">
      {/* Header */}
      <div className="bg-slate-50 p-5 border-b-2 border-slate-200 flex items-center justify-between">
        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
          <Clock className="text-slate-600" size={24} />
          Recent Attempts
        </h2>
        <span className="text-sm text-slate-500 font-medium">{attempts.length} Quiz Session(s)</span>
      </div>

      {/* Content */}
      <div className="p-6">
        {attempts.length === 0 ? (
          <div className="text-center py-12">
            <AlertCircle className="w-16 h-16 text-slate-300 mx-auto mb-4" />
            <p className="text-slate-600 text-lg font-semibold mb-2">No attempts yet</p>
            <p className="text-slate-500 text-sm">Complete a quiz to see your results here</p>
          </div>
        ) : (
          <div className="space-y-2">
            {attempts.map((attempt) => (
              <button
                key={attempt.id}
                onClick={() => onSelectAttempt(attempt)}
                className="w-full flex items-center justify-between p-3 rounded-xl border-2 border-slate-100 hover:border-indigo-300 hover:bg-indigo-50/50 transition-all group"
              >
                {/* Left Side: Score + Details */}
                <div className="flex items-center gap-3 flex-1 min-w-0">
                  {/* Score Badge */}
                  <div
                    className={`w-12 h-12 rounded-lg flex items-center justify-center font-black text-lg shadow-sm flex-shrink-0 border-2 bg-gradient-to-br ${getAccuracyColor(
                      attempt.percentage
                    )}`}
                  >
                    {attempt.percentage}%
                  </div>

                  {/* Info */}
                  <div className="min-w-0 flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <div className="font-bold text-slate-800">
                        {attempt.correctAnswers}/{attempt.totalQuestions} Correct
                      </div>
                      {attempt.timeSpent && (
                        <span className="text-xs text-slate-500">
                          ‚è±Ô∏è {formatTime(attempt.timeSpent)}
                        </span>
                      )}
                    </div>

                    {/* Date & Topics */}
                    <div className="flex flex-col gap-1">
                      <div className="text-xs text-slate-500 font-medium">{formatDate(attempt.timestamp)}</div>

                      {/* Topic Badges */}
                      {attempt.topics && attempt.topics.length > 0 && (
                        <div className="flex flex-wrap gap-1">
                          {attempt.topics.slice(0, 3).map((topic, idx) => (
                            <span
                              key={idx}
                              className={`px-2 py-0.5 rounded-full text-xs font-bold truncate ${getTopicBadgeColor(
                                idx
                              )}`}
                            >
                              {topic}
                            </span>
                          ))}
                          {attempt.topics.length > 3 && (
                            <span className="px-2 py-0.5 rounded-full text-xs font-bold text-slate-600 bg-slate-100">
                              +{attempt.topics.length - 3}
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Right Side: Arrow */}
                <ChevronRight size={18} className="text-slate-400 group-hover:text-indigo-500 transition-colors flex-shrink-0 ml-2" />
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Footer CTA */}
      {attempts.length > 0 && (
        <div className="border-t border-slate-200 p-4 bg-slate-50">
          <p className="text-xs text-center text-slate-500">
            üëÜ <span className="font-semibold">Click any attempt</span> to see detailed analysis and insights
          </p>
        </div>
      )}
    </div>
  );
}


// ========== src/components/dashboard/CurrentGoalWidget.jsx ==========

import React, { useMemo } from 'react';
import { Target, ThumbsUp } from 'lucide-react';
import { getMasteryState, findClosestToMastery } from '../../utils/masteryHelper';

/**
 * CurrentGoalWidget: Shows the user's next mastery milestone
 * "You are 5 questions away from mastering Organic Chemistry."
 */
export default function CurrentGoalWidget({ mistakes }) {
  const goal = useMemo(() => findClosestToMastery(mistakes || []), [mistakes]);

  if (!goal) {
    return (
      <div className="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-2xl shadow-lg border-2 border-indigo-200 p-6">
        <div className="flex items-center gap-3 mb-4">
          <div className="w-12 h-12 rounded-xl bg-indigo-200 flex items-center justify-center">
            <Target className="text-indigo-600" size={28} />
          </div>
          <h3 className="text-xl font-black text-indigo-900">Your Next Goal</h3>
        </div>
        <p className="text-indigo-700">No tracked mistakes yet. Complete quizzes to start your learning journey!</p>
      </div>
    );
  }

  const progressPercentage = (goal.mastered / goal.total) * 100;

  return (
    <div className="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-2xl shadow-lg border-2 border-indigo-200 p-6">
      {/* Header */}
      <div className="flex items-center gap-3 mb-4">
        <div className="w-12 h-12 rounded-xl bg-indigo-200 flex items-center justify-center">
          <Target className="text-indigo-600" size={28} />
        </div>
        <h3 className="text-xl font-black text-indigo-900">Your Next Goal</h3>
      </div>

      {/* Goal Statement */}
      <div className="mb-4">
        <p className="text-indigo-900 text-lg font-bold">
          You are{' '}
          <span className="text-indigo-600 font-black">
            {Math.max(0, goal.questionsUntilMastery)}
          </span>{' '}
          questions away from mastering{' '}
          <span className="text-indigo-600 bg-indigo-200 px-2 py-1 rounded font-bold">
            {goal.topic}
          </span>
        </p>
        <p className="text-indigo-600 text-sm mt-2 flex items-center gap-1">
          <ThumbsUp size={16} /> {goal.mastered} of {goal.total} topics already solidified
        </p>
      </div>

      {/* Progress Bar */}
      <div className="bg-indigo-200/50 rounded-full h-3 overflow-hidden mb-3 border border-indigo-300">
        <div
          className="h-full bg-gradient-to-r from-indigo-500 to-indigo-600 transition-all duration-500 rounded-full"
          style={{ width: `${progressPercentage}%` }}
        ></div>
      </div>
      <div className="flex justify-between text-xs font-semibold text-indigo-700">
        <span>{goal.mastered}/{goal.total} Mastered</span>
        <span>{Math.round(progressPercentage)}%</span>
      </div>

      {/* Action CTA */}
      <div className="mt-4 pt-4 border-t border-indigo-200">
        <p className="text-xs text-indigo-600 font-medium mb-2">Pro Tip:</p>
        <p className="text-sm text-indigo-800 font-semibold">
          Focus your daily mission on {goal.topic} to reach mastery faster!
        </p>
      </div>
    </div>
  );
}


// ========== src/components/dashboard/DailyMissionCard.jsx ==========

import React from 'react';
import { useNavigate } from 'react-router-dom';
import { Zap, BookOpen } from 'lucide-react';

/**
 * DailyMissionCard: Hero section with primary "Resume AI Daily Mission" action
 * This is the main call-to-action for the dashboard
 */
export default function DailyMissionCard() {
  const navigate = useNavigate();

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
      {/* Daily Mission - Primary Action */}
      <button
        onClick={() => navigate('/')}
        className="group relative overflow-hidden rounded-2xl shadow-xl border-2 border-indigo-200 bg-gradient-to-br from-indigo-500 via-indigo-600 to-indigo-700 p-8 text-white hover:shadow-2xl transition-all active:scale-95"
      >
        {/* Background accent */}
        <div className="absolute inset-0 opacity-10 group-hover:opacity-20 transition-opacity">
          <div className="absolute -top-20 -right-20 w-64 h-64 bg-white rounded-full blur-3xl"></div>
        </div>

        <div className="relative z-10">
          {/* Icon */}
          <div className="inline-block p-4 bg-white/20 rounded-xl mb-4 group-hover:scale-110 transition-transform">
            <Zap size={40} className="text-white drop-shadow-lg" />
          </div>

          {/* Text */}
          <h2 className="text-3xl font-black mb-2 text-white drop-shadow-md">
            Resume AI Daily Mission
          </h2>
          <p className="text-indigo-100 font-semibold mb-1">20 interleaved questions</p>
          <p className="text-indigo-200 text-sm mb-6">
            AI-powered selection optimized for your learning curve
          </p>

          {/* Stats Pills */}
          <div className="flex flex-wrap gap-2 mb-6">
            <div className="px-3 py-1 bg-white/20 rounded-full text-sm font-bold text-white">
              ‚úì Spaced Repetition
            </div>
            <div className="px-3 py-1 bg-white/20 rounded-full text-sm font-bold text-white">
              ‚ö° Adaptive Difficulty
            </div>
          </div>

          {/* CTA Button */}
          <div className="flex items-center gap-3 font-black text-lg group-hover:translate-x-1 transition-transform">
            <span className="text-white drop-shadow-md">Start Now</span>
            <span>‚Üí</span>
          </div>
        </div>

        {/* Bottom accent line */}
        <div className="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white to-transparent opacity-40 group-hover:opacity-60 transition-opacity"></div>
      </button>

      {/* Browse Forum - Secondary Action */}
      <button
        onClick={() => navigate('/forum')}
        className="group relative overflow-hidden rounded-2xl shadow-lg border-2 border-purple-200 bg-gradient-to-br from-purple-50 to-pink-50 p-8 text-slate-800 hover:shadow-xl transition-all active:scale-95"
      >
        {/* Background accent */}
        <div className="absolute inset-0 opacity-5 group-hover:opacity-10 transition-opacity">
          <div className="absolute -top-20 -right-20 w-64 h-64 bg-purple-400 rounded-full blur-3xl"></div>
        </div>

        <div className="relative z-10">
          {/* Icon */}
          <div className="inline-block p-4 bg-purple-200 rounded-xl mb-4 group-hover:scale-110 transition-transform">
            <BookOpen size={40} className="text-purple-600" />
          </div>

          {/* Text */}
          <h2 className="text-3xl font-black mb-2 text-slate-800">
            Browse Community
          </h2>
          <div className="inline-block px-3 py-1 bg-red-100 rounded-full text-sm font-bold text-red-700 mb-3">
            2 New Discussions
          </div>

          <p className="text-slate-600 font-semibold mb-1">Connect with learners</p>
          <p className="text-slate-600 text-sm mb-6">
            Share insights, ask questions, and learn from peers in the community
          </p>

          {/* CTA Button */}
          <div className="flex items-center gap-3 font-black text-lg group-hover:translate-x-1 transition-transform text-purple-600">
            <span>Visit Forum</span>
            <span>‚Üí</span>
          </div>
        </div>
      </button>
    </div>
  );
}


// ========== src/components/dashboard/MasteryProgressHub.jsx ==========

import React, { useMemo } from 'react';
import { BarChart3, Zap, Target } from 'lucide-react';
import { getMasteryState, calculateMasteryStats } from '../../utils/masteryHelper';

/**
 * MasteryProgressHub: Displays the syllabus progress with Unseen/In-Progress/Mastered breakdown
 * Replaces the 5 basic stat boxes with a more meaningful visual
 */
export default function MasteryProgressHub({ userProfile, mistakes }) {
  const stats = useMemo(() => calculateMasteryStats(userProfile, mistakes || []), [userProfile, mistakes]);

  const total = stats.unseenCount + stats.inProgressCount + stats.masteredCount;
  const unseenPct = total > 0 ? Math.round((stats.unseenCount / total) * 100) : 0;
  const inProgressPct = total > 0 ? Math.round((stats.inProgressCount / total) * 100) : 0;
  const masteredPct = total > 0 ? Math.round((stats.masteredCount / total) * 100) : 0;

  return (
    <div className="bg-white rounded-2xl shadow-lg border-2 border-indigo-100 p-8">
      {/* Header */}
      <div className="flex items-center gap-3 mb-6">
        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-100 to-indigo-200 flex items-center justify-center">
          <BarChart3 className="text-indigo-600" size={28} />
        </div>
        <div>
          <h2 className="text-2xl font-black text-slate-800">Mastery Health Bar</h2>
          <p className="text-sm text-slate-500 mt-1">Based on the Rule of 3 system</p>
        </div>
      </div>

      {/* Main Progress Bar with Stacked Sections */}
      <div className="mb-8">
        <div className="flex items-center justify-between mb-2">
          <h3 className="text-lg font-bold text-slate-700">Syllabus Coverage</h3>
          <span className="text-sm font-semibold text-slate-600">{total} Topics Tracked</span>
        </div>

        {/* 3-Segment Progress Bar */}
        <div className="flex h-6 rounded-full overflow-hidden bg-slate-100 shadow-inner border border-slate-200">
          {/* Red: Unseen */}
          <div
            className="bg-red-500 flex items-center justify-center transition-all duration-300"
            style={{ width: `${unseenPct}%` }}
            title={`${unseenPct}% Unseen (${stats.unseenCount} topics)`}
          >
            {unseenPct > 5 && <span className="text-white text-xs font-bold">{unseenPct}%</span>}
          </div>

          {/* Amber: In-Progress */}
          <div
            className="bg-amber-400 flex items-center justify-center transition-all duration-300"
            style={{ width: `${inProgressPct}%` }}
            title={`${inProgressPct}% Improving (${stats.inProgressCount} topics)`}
          >
            {inProgressPct > 5 && <span className="text-white text-xs font-bold">{inProgressPct}%</span>}
          </div>

          {/* Green: Mastered */}
          <div
            className="bg-green-500 flex items-center justify-center transition-all duration-300"
            style={{ width: `${masteredPct}%` }}
            title={`${masteredPct}% Mastered (${stats.masteredCount} topics)`}
          >
            {masteredPct > 5 && <span className="text-white text-xs font-bold">{masteredPct}%</span>}
          </div>
        </div>
      </div>

      {/* Legend & Stats */}
      <div className="grid grid-cols-3 gap-4">
        {/* Unseen */}
        <div className="bg-red-50 rounded-xl p-4 border-l-4 border-red-500">
          <div className="flex items-center gap-2 mb-2">
            <div className="w-3 h-3 rounded-full bg-red-500"></div>
            <span className="text-xs font-bold text-red-700 uppercase tracking-wide">New</span>
          </div>
          <div className="text-3xl font-black text-red-600">{stats.unseenCount}</div>
          <p className="text-xs text-red-600 mt-1">Not yet attempted</p>
        </div>

        {/* In-Progress */}
        <div className="bg-amber-50 rounded-xl p-4 border-l-4 border-amber-400">
          <div className="flex items-center gap-2 mb-2">
            <div className="w-3 h-3 rounded-full bg-amber-400"></div>
            <span className="text-xs font-bold text-amber-700 uppercase tracking-wide">Improving</span>
          </div>
          <div className="text-3xl font-black text-amber-600">{stats.inProgressCount}</div>
          <p className="text-xs text-amber-600 mt-1">1-2 correct answers</p>
        </div>

        {/* Mastered */}
        <div className="bg-green-50 rounded-xl p-4 border-l-4 border-green-500">
          <div className="flex items-center gap-2 mb-2">
            <div className="w-3 h-3 rounded-full bg-green-500"></div>
            <span className="text-xs font-bold text-green-700 uppercase tracking-wide">Mastered</span>
          </div>
          <div className="text-3xl font-black text-green-600">{stats.masteredCount}</div>
          <p className="text-xs text-green-600 mt-1">3+ correct answers ‚úì</p>
        </div>
      </div>

      {/* Legacy Stats Row */}
      <div className="grid grid-cols-3 gap-4 mt-6 pt-6 border-t border-slate-200">
        <div className="text-center">
          <div className="text-sm text-slate-600 font-medium mb-1">Total Attempts</div>
          <div className="text-2xl font-black text-slate-800">{userProfile?.totalAttempts || 0}</div>
        </div>
        <div className="text-center">
          <div className="text-sm text-slate-600 font-medium mb-1">Overall Accuracy</div>
          <div className="text-2xl font-black text-slate-800">
            {userProfile?.totalQuestions > 0 ? Math.round((userProfile.totalCorrect / userProfile.totalQuestions) * 100) : 0}%
          </div>
        </div>
        <div className="text-center">
          <div className="text-sm text-slate-600 font-medium mb-1">Questions Solved</div>
          <div className="text-2xl font-black text-slate-800">{userProfile?.totalQuestions || 0}</div>
        </div>
      </div>
    </div>
  );
}


// ========== src/components/dashboard/PriorityReviewSection.jsx ==========

import React, { useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { AlertTriangle, Play, ArrowRight, Zap } from 'lucide-react';
import { getTopMistakesByPriority, getMasteryState } from '../../utils/masteryHelper';

/**
 * PriorityReviewSection: Shows top 3 urgent mistakes based on ISRS priority
 * Displays with Quick Fix button to practice immediately
 */
export default function PriorityReviewSection({ mistakes, recentTopics = [] }) {
  const navigate = useNavigate();
  const topMistakes = useMemo(() => getTopMistakesByPriority(mistakes || [], recentTopics, 3), [mistakes, recentTopics]);

  if (!topMistakes || topMistakes.length === 0) {
    return (
      <div className="bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl shadow-lg border-2 border-slate-200 p-6">
        <div className="flex items-center gap-3 mb-4">
          <div className="w-12 h-12 rounded-xl bg-slate-200 flex items-center justify-center">
            <Zap className="text-slate-600" size={28} />
          </div>
          <h3 className="text-xl font-black text-slate-800">Priority Review</h3>
        </div>
        <p className="text-slate-600 text-center py-8">
          No mistakes tracked yet. Complete quizzes and log your mistakes to get personalized review recommendations!
        </p>
      </div>
    );
  }

  const handleQuickFix = (questionId) => {
    // Navigate to quiz engine with specific question
    navigate('/', { state: { focusQuestionId: questionId } });
  };

  return (
    <div className="bg-white rounded-2xl shadow-lg border-2 border-slate-100 p-6">
      {/* Header */}
      <div className="flex items-center gap-3 mb-6">
        <div className="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center">
          <AlertTriangle className="text-red-600" size={28} />
        </div>
        <div>
          <h3 className="text-xl font-black text-slate-800">Priority Review</h3>
          <p className="text-xs text-slate-500 mt-1">Top 3 Urgent Mistakes (ISRS Algorithm)</p>
        </div>
      </div>

      {/* Mistakes List */}
      <div className="space-y-3">
        {topMistakes.map((mistake, index) => {
          const state = getMasteryState(mistake.correctCount || 0);
          const priority = mistake.masteryPriority || 0;
          const priorityLabel = priority > 8 ? 'Critical' : priority > 5 ? 'High' : 'Medium';
          const priorityColor = priority > 8 ? 'text-red-700 bg-red-50' : priority > 5 ? 'text-orange-700 bg-orange-50' : 'text-yellow-700 bg-yellow-50';

          return (
            <div
              key={mistake.questionId || index}
              className={`rounded-xl p-4 border-l-4 transition-all $${state.borderClass} ${state.bgClass}`}
            >
              {/* Top Row: Rank + Priority + Status */}
              <div className="flex items-start justify-between mb-2">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-bold text-slate-600">#{index + 1}</span>
                  <span className={`px-2 py-1 rounded-full text-xs font-bold ${priorityColor}`}>
                    {priorityLabel} Priority
                  </span>
                  <span className={`px-2 py-1 rounded-full text-xs font-bold ${state.badgeClass}`}>
                    {state.label}
                  </span>
                </div>
              </div>

              {/* Question Preview */}
              <div className="mb-3">
                <p className="text-sm font-semibold text-slate-700 line-clamp-2">
                  {mistake.Question || 'Question text not available'}
                </p>
                <div className="flex items-center gap-2 mt-2 text-xs text-slate-600">
                  <span className="font-bold text-slate-700">{mistake.Topic}</span>
                  {mistake.errorType && (
                    <>
                      <span>‚Ä¢</span>
                      <span className="capitalize">{mistake.errorType}</span>
                    </>
                  )}
                </div>
              </div>

              {/* Stats & Button */}
              <div className="flex items-center justify-between">
                <div className="flex gap-4 text-xs text-slate-600">
                  <span>Attempts: <span className="font-bold">{mistake.attemptCount || 1}</span></span>
                  <span>Correct: <span className="font-bold">{mistake.correctCount || 0}</span></span>
                </div>
                <button
                  onClick={() => handleQuickFix(mistake.questionId)}
                  className="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg font-bold text-sm hover:shadow-lg hover:from-red-600 hover:to-orange-600 transition-all active:scale-95"
                >
                  <Play size={14} />
                  Quick Fix
                </button>
              </div>
            </div>
          );
        })}
      </div>

      {/* CTA Footer */}
      <div className="mt-6 pt-4 border-t border-slate-200">
        <button
          onClick={() => navigate('/notebook')}
          className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 hover:bg-slate-200 text-slate-800 rounded-xl font-bold transition-all"
        >
          View Full Mistake Notebook
          <ArrowRight size={16} />
        </button>
      </div>
    </div>
  );
}


// ========== src/contexts/AuthContext.jsx ==========

import React, { createContext, useState, useEffect, useContext, useRef } from 'react';
import { 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  updateProfile
} from 'firebase/auth';
import { doc, setDoc, getDoc, onSnapshot } from 'firebase/firestore';
import { auth, db } from '../firebase/config';
import { initializeUserTokens } from '../services/tokenService';

const AuthContext = createContext();

export function useAuth() {
  return useContext(AuthContext);
}

export function AuthProvider({ children }) {
  const [currentUser, setCurrentUser] = useState(null);
  const [userProfile, setUserProfile] = useState(null);
  const [loading, setLoading] = useState(true);
  
  // Real-time listener cleanup ref
  const profileUnsubscribeRef = useRef(null);

  // Register new user
  async function signup(email, password, displayName) {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    
    // Update profile with display name
    await updateProfile(userCredential.user, {
      displayName: displayName
    });

    // Create user profile in Firestore with token initialization
    await setDoc(doc(db, 'users', userCredential.user.uid), {
      uid: userCredential.user.uid,
      email: email,
      displayName: displayName,
      createdAt: new Date().toISOString(),
      totalAttempts: 0,
      totalQuestions: 0,
      totalCorrect: 0,
      tokens: 100,        // Initial token balance
      inventory: [],      // Owned items
      equipped: {}        // Currently equipped items
    });

    // Initialize token system (creates welcome bonus entry)
    await initializeUserTokens(userCredential.user.uid, 100);

    return userCredential;
  }

  // Login user
  function login(email, password) {
    return signInWithEmailAndPassword(auth, email, password);
  }

  // Logout user
  function logout() {
    // Clean up real-time listener
    if (profileUnsubscribeRef.current) {
      profileUnsubscribeRef.current();
      profileUnsubscribeRef.current = null;
    }
    return signOut(auth);
  }

  // Load user profile with REAL-TIME synchronization
  function setupProfileListener(uid) {
    // Clean up existing listener
    if (profileUnsubscribeRef.current) {
      profileUnsubscribeRef.current();
    }

    const docRef = doc(db, 'users', uid);
    
    // Set up real-time listener
    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        console.log('üìä Profile updated:', {
          tokens: data.tokens,
          inventory: data.inventory?.length || 0
        });
        setUserProfile(data);
      } else {
        console.error('‚ùå User profile not found');
        setUserProfile(null);
      }
    }, (error) => {
      console.error('‚ùå Profile listener error:', error);
    });

    profileUnsubscribeRef.current = unsubscribe;
    return unsubscribe;
  }

  // Legacy: Load profile once (for backwards compatibility)
  async function loadUserProfile(uid) {
    try {
      const docRef = doc(db, 'users', uid);
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        setUserProfile(docSnap.data());
      }
    } catch (error) {
      console.error('Error loading profile:', error);
    }
  }

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      setCurrentUser(user);
      
      if (user) {
        // Set up real-time profile listener
        setupProfileListener(user.uid);
      } else {
        setUserProfile(null);
        // Clean up listener
        if (profileUnsubscribeRef.current) {
          profileUnsubscribeRef.current();
          profileUnsubscribeRef.current = null;
        }
      }
      
      setLoading(false);
    });

    return () => {
      unsubscribe();
      // Clean up listener on unmount
      if (profileUnsubscribeRef.current) {
        profileUnsubscribeRef.current();
      }
    };
  }, []);

  const value = {
    currentUser,
    userProfile,
    signup,
    login,
    logout,
    loadUserProfile  // Keep for backwards compatibility
  };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
}

// ========== src/contexts/LanguageContext.jsx ==========

import React, { createContext, useState, useContext, useEffect } from 'react';

const LanguageContext = createContext();

export function useLanguage() {
  return useContext(LanguageContext);
}

// Translation dictionary
const translations = {
  en: {
    // Branding
    appName: "ChemLeung HKDSE MCQ Practice Platform",
    tagline: "HKDSE Chemistry Practice",
    
    // Navigation
    nav: {
      dashboard: "Dashboard",
      practice: "Practice",
      leaderboard: "Leaderboard",
      history: "History",
      profile: "Profile",
      logout: "Logout",
    },
    
    // Dashboard
    dashboard: {
      welcomeBack: "Welcome back",
      totalAttempts: "Total Attempts",
      overallAccuracy: "Overall Accuracy",
      questionsSolved: "Questions Solved",
      correctAnswers: "Correct Answers",
      studyStreak: "Study Streak",
      days: "days",
      startNewQuiz: "Start New Quiz",
      viewLeaderboard: "View Leaderboard",
      recentAttempts: "Recent Attempts",
      noAttempts: "No attempts yet!",
      takeFirstQuiz: "Take Your First Quiz",
      browseForm: "Browse Forum",
      mistakeNotebook: "Mistake Notebook",
      logout: "Logout",
      confirmLogout: "Confirm Logout",
      areYouSureLogout: "Are you sure you want to logout?",
      needSignInAgain: "You will need to sign in again to access your account and continue practicing.",
      cancel: "Cancel",
      errorLoadingAttempts: "Error Loading Attempts",
      retry: "Retry",
      clickRowFullAnalysis: "Click any row to see full analysis",
      refresh: "Refresh",
      noDataYet: "No data yet",
      completeQuizSeeResults: "Complete a quiz to see your results here",
      correct: "correct",
      timeSpent: "Time spent",
      loadingDashboard: "Loading dashboard...",
    },
    
    // Practice Modes
    practice: {
      selectMode: "Select Practice Mode",
      timed: "Timed Practice",
      timedDesc: "Race against the clock - {minutes} minutes",
      marathon: "Marathon Mode",
      marathonDesc: "Unlimited time - track your progress",
      custom: "Custom Session",
      customDesc: "Choose topics and question count",
      startPractice: "Start Practice",
      selectPracticeMode: "Select Practice Mode",
      chooseHowPractice: "Choose how you want to practice today",
      perQuestion: "min per question",
      perfectForExam: "Perfect for exam simulation with a countdown timer.",
      takeYourTime: "Take your time. We'll track duration but no pressure!",
      chooseSpecificTopics: "Choose specific topics, subtopics, and question count.",
      questions: "Questions:",
      configure: "Configure",
      yourAvailableTopics: "Your Available Topics",
      more: "more",
      noTopicsConfigured: "No topics configured!",
      pleaseSetTopics: "Please set which topics you've learned in your Profile settings.",
      goToProfile: "Go to Profile",
      updateTopics: "Update Topics",
    },
    
    // Quiz Interface
    quiz: {
      question: "Question",
      of: "of",
      flagQuestion: "Flag Question",
      unflagQuestion: "Unflag Question",
      periodicTable: "Periodic Table",
      overview: "Overview",
      previous: "Previous",
      next: "Next",
      submit: "Submit",
      answered: "Answered",
      flagged: "Flagged",
      skipped: "Skipped",
      timeRemaining: "Time Remaining",
      sessionTime: "Session Time",
      totalTime: "Total Time",
      initializingQuiz: "Initializing quiz...",
      type: "Type",
      toSelect: "to select",
      flag: "flag",
      tools: "Tools",
      backToTopics: "Back to Topics",
      periodicTableOfElements: "Periodic Table of Elements",
      time: "Time",
      thisQuestion: "This Question:",
      questionOverview: "Question Overview",
      tip: "Tip:",
      press: "Press",
      pleaseAnswerAll: "Please answer all questions before submitting.",
      finishSubmit: "Finish & Submit",
      confirmBackToTopics: "Are you sure you want to go back to topic selection?\n\n‚ö†Ô∏è ALL YOUR PROGRESS WILL BE LOST!",
      enableTimer: "Enable Timer",
      trackTimeSpent: "Track time spent on questions",
      showTimer: "Show Timer",
      countdown: "Countdown",
      timedMode: "Timed Mode",
      countdownTimer: "Countdown with time limit",
      timeUp: "Time's up! Your quiz will be submitted now.",
    },
    
    // Results
    results: {
      yourPerformance: "Your Performance",
      totalTime: "Total Time",
      averagePerQuestion: "Average per MCQ",
      strengths: "Strengths",
      needsFocus: "Needs Focus",
      detailedReview: "Detailed Review",
      yourAnswer: "Your Answer",
      correctAnswer: "Correct Answer",
      explanation: "Explanation",
      shareReport: "Share Report Card",
      addToNotebook: "Add to Mistake Notebook",
      startNewSession: "Start New Session",
      savingToProfile: "Saving to your profile...",
      savedToProfile: "Saved to your profile!",
    },
    
    // Profile
    profile: {
      profileSettings: "Profile Settings",
      yourStatistics: "Your Statistics",
      displayName: "Display Name",
      email: "Email Address",
      schoolLevel: "School Level (Form)",
      studyLevel: "Current Study Level",
      memberSince: "Member Since",
      saveChanges: "Save Changes",
      topicExceptions: "Topic Exceptions",
      unlockTopic: "Unlock Topic",
      lockTopic: "Lock Topic",
      manageAccount: "Manage your account and learning preferences",
      totalAttempts: "Total Attempts",
      overallAccuracy: "Overall Accuracy",
      questionsSolved: "Questions Solved",
      accountInformation: "Account Information",
      profileUpdated: "Profile updated successfully!",
      failedUpdate: "Failed to update profile. Please try again.",
      enterYourName: "Enter your name",
      emailCannotChange: "Email cannot be changed",
      selectCurrentForm: "Select your current form (Secondary 4, 5, or 6)",
      topicsLearnedUpTo: "Topics Learned Up To",
      selectHighestTopic: "Select the highest topic number you've learned. For example, \"08\" means you've learned topics 01-08.",
      topicExceptionsLabel: "Topic Exceptions (Mark topics NOT learned)",
      clickToExclude: "Click to exclude topics you haven't covered yet, even though they're below your \"learned up to\" level.",
      yourAvailableTopicsCount: "Your Available Topics",
      theseTopicsWillAppear: "These topics will appear in your Timed and Marathon practice modes.",
      saving: "Saving...",
    },
    
    // Leaderboard
    leaderboard: {
      title: "Leaderboard",
      thisWeek: "This Week",
      thisMonth: "This Month",
      allTime: "All Time",
      you: "You",
      attempts: "attempts",
      questions: "questions",
      seeHowYouRank: "See how you rank against other students",
      noDataYet: "No data yet",
      beFirstComplete: "Be the first to complete a quiz!",
      howRankingsWork: "How rankings work:",
      averageScoreLast7: "Average score from all attempts in the last 7 days",
      averageScoreLast30: "Average score from all attempts in the last 30 days",
      overallAccuracyAllTime: "Overall accuracy across all attempts ever",
      formLevel: "S4/S5/S6 = form level",
      flameStreak: "Flame = consecutive study days",
    },
    
    // Forum
    forum: {
      title: "The MCQ Forum",
      discuss: "Discuss",
      addComment: "Add Comment",
      editComment: "Edit Comment",
      deleteComment: "Delete Comment",
      noComments: "No comments yet. Be the first to discuss!",
      loading: "Loading discussion...",
      connectDiscuss: "Connect and discuss with other students",
      notifications: "Notifications",
      markAllRead: "Mark all read",
      noNotificationsYet: "No notifications yet",
      likedYourComment: "liked your comment",
      repliedToPost: "replied to your post",
      likedYourPost: "liked your post",
      likedYourReply: "liked your reply",
      justNow: "Just now",
      mcqDiscussion: "MCQ Discussion",
      generalForum: "General Forum",
      searchQuestions: "Search questions, topics, DSE codes...",
      recent: "Recent",
      popular: "Popular",
      questionsWithDiscussions: "questions with discussions",
      noResultsFound: "No results found",
      noMcqDiscussions: "No MCQ discussions yet. Start one from any quiz!",
      comments: "comments",
      searchPosts: "Search posts...",
      all: "All",
      newPost: "New Post",
      noPosts: "No posts yet. Be the first!",
      createPost: "Create a Post",
      backToForum: "Back to forum",
      edited: "edited",
      save: "Save",
      cancel: "Cancel",
      replies: "Replies",
      writeReply: "Write a reply...",
      reply: "Reply",
      pleaseLoginReply: "Please log in to reply.",
      createNewPost: "Create New Post",
      category: "Category",
      title2: "Title",
      enterClearTitle: "Enter a clear, descriptive title",
      content: "Content",
      shareThoughts: "Share your thoughts, question, or announcement...",
      post: "Post",
      deletePost: "Delete this post?",
      deleteReply: "Delete this reply?",
      editExpired: "Edit window expired (15 min).",
    },
    
    // Mistake Notebook
    notebook: {
      // Main Navigation
      title: "Mistake Notebook",
      commandCenter: "Mistake Command Center",
      mistakeDeck: "Mistake Deck",
      learningInsights: "Learning Insights",
      learningAnalytics: "Learning Analytics",
      masteryArchive: "Mastery Archive",
      
      // Actions
      review: "Review Mistakes",
      practiceMistakes: "Practice Mistakes Only",
      practiceMistakesCount: "Practice {count} Mistake{plural}",
      practiceSelected: "Practice {count} Selected",
      cleared: "All mistakes cleared!",
      addedToNotebook: "Added to Mistake Notebook",
      removedFromNotebook: "Removed from Notebook",
      reviewMaster: "Review and master questions you got wrong",
      
      // Full Question Modal
      questionDetail: "Question Detail",
      question: "Question",
      options: "Options",
      viewFullQuestion: "View Full Question",
      viewFull: "View Full",
      attempts: "Attempts",
      masteryLevelLabel: "Mastery Level",
      lastAttemptedLabel: "Last Attempted",
      
      // Statistics
      totalMistakes: "Total Mistakes",
      topicsToFocus: "Topics to Focus",
      repeatedMistakes: "Repeated Mistakes",
      
      // Configurator
      configurePractice: "Configure Practice Session",
      numberOfQuestions: "Questions",
      questionsLabel: "1. Number of Questions",
      questionsAvailable: "available",
      questionsAvailableFull: "questions available with current filters",
      timeRange: "Time Range",
      timeRangeLabel: "2. Time Range (when you made the mistake)",
      allTime: "All Time",
      lastMonth: "Last Month",
      lastWeek: "Last Week",
      default: "default",
      
      // Filters
      topics: "Topics",
      topicsLabel: "3. Topics (leave empty for all)",
      subtopics: "Subtopics",
      subtopicsFilteredNote: "(filtered by selected topics)",
      masteryLevel: "Mastery Level",
      clearTopicFilter: "‚úï Clear topic filter",
      clearSubtopicFilter: "Clear subtopic filter",
      clearMasteryFilter: "Clear mastery filter",
      filteredFrom: "Filtered from",
      clearSelection: "Clear Selection",
      
      // Mastery Status Labels
      masteryNew: "New",
      masteryDeveloping: "Developing",
      masteryProgressing: "Progressing",
      masteryNear: "Near-Mastery",
      statusUnprocessed: "Unprocessed",
      statusInProgress: "In Progress",
      statusNearMastery: "Near Mastery",
      
      // Empty States
      allMistakes: "All Mistakes",
      noMistakesYet: "No mistakes yet!",
      keepPracticing: "Keep practicing. Wrong answers appear here.",
      startPracticing: "Start Practicing",
      noQuestionsFound: "No questions match your filters",
      tryAdjustFilters: "Try adjusting your filter settings",
      noArchivedYet: "No archived questions yet",
      archiveInstructions: "Answer 3 questions correctly to archive them",
      allCaughtUp: "All caught up!",
      
      // Question Details
      lastAttempt: "Last Attempt",
      missed: "Missed {count}√ó",
      yourAnswer: "Your Answer",
      correctAnswer: "Correct Answer",
      correct: "Correct",
      explanation: "Explanation",
      priority: "Priority",
      
      // How It Works
      howItWorks: "How it works",
      wrongAnswersAutoSaved: "Wrong answers are auto-saved here",
      useFilters: "Use filters to focus on specific topics or recent mistakes",
      practiceUntilMaster: "Practice until you master them!",
      clearAfterThreeCorrect: "‚ú® Questions automatically clear after 3 consecutive correct attempts!",
      
      // Loading States
      loadingMistakes: "Loading mistakes...",
      sessionLimited: "Session limited to {max} questions maximum.",
      
      // Topic Analysis
      topicBreakdown: "Topic Breakdown",
      hoverForDetails: "Hover over stats for details",
      weakTopics: "Weak Topics",
      focusTheseTopics: "Focus on these topics",
      repeatsByTopic: "Repeated Mistakes by Topic",
      needMorePractice: "Need more practice",
      improved: "Improved {count}",
      
      // Retention Dashboard
      retentionDashboard: "Retention Dashboard",
      addedThisWeek: "Added (7d)",
      masteredThisWeek: "Mastered (7d)",
      decayRate: "Decay Rate",
      decayImproving: "üìà Improving",
      decayStable: "‚öñÔ∏è Stable",
      decayGrowing: "üìâ Growing",
      weakestSubtopics: "Weakest Subtopics",
      urgentReviews: "Urgent Reviews (by priority score)",
      
      // Priority Badge
      priorityScore: "Spaced Repetition Priority Score",
      
      // Metacognitive Tagging
      errorTypeLabel: "Error Type:",
      tagErrorType: "Tag Error Type",
      errorCategory: "Error Category",
      clearTag: "Clear tag",
      errorMisread: "Misread Question",
      errorConceptual: "Conceptual Gap",
      errorCalculation: "Calculation Error",
      errorCareless: "Careless Mistake",
      errorVocabulary: "Vocabulary Gap",
      errorDiagram: "Diagram Misread",
      tagError: "Tag Error",
      
      // Extra Notes
      spacedRepetitionNote: "Cards sorted by Spaced Repetition priority ‚Äî highest urgency first.",
      metacognitiveNote: "Tag each mistake with an Error Category to track your patterns.",
      
      // Learning Analytics Dashboard
      mistakeClearingActivity: "Mistake Clearing Activity",
      errorDensityByTopic: "Error Density by Topic",
      improvementTrend: "Improvement Trend (14 days)",
      clickTopicToFilter: "Click a topic to filter ‚Üí",
      clickTopicsToFilter: "Click topics to filter (multi-select)",
      less: "Less",
      more: "More",
      
      // AI Daily Mission
      aiDailyMission: "AI Daily Mission",
      aiDailyMissionNote: "Smart AI selects 10 questions with interleaved practice to maximize retention.",
      needMoreQuestions: "Need 10+ mistakes (have {count})",
      interleavedPractice: "10 Questions ‚Ä¢ Interleaved Practice",
      
      // Timer Settings
      timerEnabled: "Timer Enabled",
      timedMode: "Timed Mode",
      
      // View Modes
      listView: "List View",
      kanbanView: "Kanban View",
      selectAll: "Select All",
      
      // Archive
      mastered: "Mastered",
      masteredOn: "Mastered {date}",
      archivedAt: "Archived at",
      
      // Filter Pills
      topicFilter: "Topic: {topic}",
    },
    
    // History
    history: {
      title: "Practice History",
      clickToSeeAnalysis: "Click any attempt to see the full analysis",
      totalAttempts: "Total Attempts",
      averageScore: "Average Score",
      bestScore: "Best Score",
      totalTime: "Total Time",
      filtersAndSorting: "Filters & Sorting",
      timePeriod: "Time Period",
      allTime: "All Time",
      lastMonth: "Last Month",
      lastWeek: "Last Week",
      sortBy: "Sort By",
      recent: "Recent",
      score: "Score",
      time: "Time",
      yourAttempts: "Your Attempts",
      clickViewAnalysis: "Click to view full analysis",
      refresh: "Refresh",
      noAttemptsFound: "No attempts found",
      tryChangingFilter: "Try changing the filter period",
      startPracticingHistory: "Start practicing to see your history!",
      takeFirstQuiz: "Take Your First Quiz",
      correct: "correct",
      loadingHistory: "Loading your history...",
    },
    
    // Common
    common: {
      loading: "Loading...",
      error: "Error",
      success: "Success",
      confirm: "Confirm",
      cancel: "Cancel",
      save: "Save",
      delete: "Delete",
      edit: "Edit",
      close: "Close",
      retry: "Retry",
      backToTopics: "Back to Topics",
    },
    
    // Authentication
    auth: {
      login: "Login",
      register: "Register",
      email: "Email Address",
      password: "Password",
      confirmPassword: "Confirm Password",
      fullName: "Full Name",
      createAccount: "Create Account",
      alreadyHaveAccount: "Already have an account?",
      dontHaveAccount: "Don't have an account?",
      loginHere: "Login here",
      registerHere: "Register here",
      welcomeBack: "Welcome Back",
      enterCredentials: "Enter your credentials to access your account",
      signingIn: "Signing in...",
      signIn: "Sign In",
      createAccountNow: "Create one now",
      secureLogin: "Secure login powered by Firebase Authentication",
      noAccountFound: "No account found with this email.",
      incorrectPassword: "Incorrect password.",
      invalidEmail: "Invalid email address.",
      failedLogin: "Failed to log in. Please check your credentials.",
      joinCommunity: "Join our chemistry learning community",
      creatingAccount: "Creating account...",
      passwordsNoMatch: "Passwords do not match",
      passwordMinLength: "Password must be at least 6 characters",
      enterFullName: "Please enter your full name",
      emailAlreadyInUse: "An account with this email already exists.",
      weakPassword: "Password is too weak. Use at least 6 characters.",
      failedCreateAccount: "Failed to create account. Please try again.",
      minimumCharacters: "Minimum 6 characters",
      secureRegistration: "Secure registration powered by Firebase Authentication",
      switchToChinese: "Switch to Traditional Chinese",
      switchToEnglish: "ÂàáÊèõËá≥Ëã±Êñá",
    },

    // ChemStore
    store: {
      title: "ChemStore",
      subtitle: "Unlock exclusive items with your tokens",
      yourBalance: "Your Balance",
      profilePics: "Profile Pics",
      badges: "Badges",
      themes: "Themes",
      equipped: "Equipped",
      equip: "Equip",
      buy: "Buy",
      claim: "Claim",
      locked: "Locked",
      buying: "Buying...",
      comingSoon: "Coming soon! üöÄ",
      howToEarnTokens: "How to Earn Tokens",
      perfectScore: "Perfect MCQ Score (100%):",
      perfectScoreTokens: "10 tokens",
      excellentScore: "Excellent Score (80%+):",
      excellentScoreTokens: "5 tokens",
      goodScore: "Good Score (60%+):",
      goodScoreTokens: "2 tokens",
      clearMistake: "Clear Mistake:",
      clearMistakeTokens: "1 token (once per question per day)",
      leaderboardGold: "Leaderboard Gold:",
      leaderboardTokens: "60 tokens (weekly) / 10 tokens (daily)",
      studyStreaks: "Study Streaks:",
      studyStreaksTokens: "15 tokens (7 days) / 50 tokens (30 days)",
      notEnoughTokens: "Not enough tokens! üí∏",
      purchased: "Purchased {name}! üéâ",
      purchaseFailed: "Purchase failed",
      failedToEquip: "Failed to equip",
      pleaseTryAgain: "Please try again.",
      failedToEquipItem: "Failed to equip item",
    },

    // Practice Mode Selection
    practiceMode: {
      updateYourTopics: "Update Your Topics",
      learnedUpTo: "Learned Up To:",
      exceptions: "Exceptions (Not Learned):",
      saveChanges: "Save Changes",
      updating: "Updating...",
      topicsUpdated: "Topics updated successfully!",
      failedUpdate: "Failed to update topics",
      configureCustomSession: "Configure Custom Session",
      back: "Back",
      selectTopics: "1. Select Topics (Multi-choice)",
      lockedTopicsNotLearned: "Locked topics not yet learned. Update in Profile or click button above.",
      focusSubtopics: "2. Focus on Subtopics (Optional)",
      sessionLength: "3. Session Length",
      generateExam: "GENERATE EXAM",
      startPractice: "Start Practice",
    },
  },
  
  zh: {
    // ÂìÅÁâå
    appName: "ChemLeung HKDSE MCQ Á∑¥ÁøíÂπ≥Âè∞",
    tagline: "HKDSE ÂåñÂ≠∏Á∑¥Áøí",
    
    // Â∞éËà™
    nav: {
      dashboard: "Á∏ΩË¶ß",
      practice: "Á∑¥Áøí",
      leaderboard: "ÊéíË°åÊ¶ú",
      history: "Ê≠∑Âè≤Ë®òÈåÑ",
      profile: "ÂÄã‰∫∫Ë≥áÊñô",
      logout: "ÁôªÂá∫",
    },
    
    // ÂÑÄË°®Êùø
    dashboard: {
      welcomeBack: "Ê≠°ËøéÂõû‰æÜ",
      totalAttempts: "Á∏ΩÊ∏¨È©óÊ¨°Êï∏",
      overallAccuracy: "Êï¥È´îÊ∫ñÁ¢∫Áéá",
      questionsSolved: "Â∑≤ÂÆåÊàêÈ°åÁõÆ",
      correctAnswers: "Ê≠£Á¢∫Á≠îÊ°à",
      studyStreak: "ÈÄ£Á∫åÂ≠∏ÁøíÂ§©Êï∏",
      days: "Â§©",
      startNewQuiz: "ÈñãÂßãÊñ∞Ê∏¨È©ó",
      viewLeaderboard: "Êü•ÁúãÊéíË°åÊ¶ú",
      recentAttempts: "ÊúÄËøëÊ∏¨È©ó",
      noAttempts: "Â∞öÊú™ÈÄ≤Ë°åÊ∏¨È©óÔºÅ",
      takeFirstQuiz: "ÈñãÂßãÊÇ®ÁöÑÁ¨¨‰∏ÄÂÄãÊ∏¨È©ó",
      browseForm: "ÁÄèË¶ΩË®éË´ñÂçÄ",
      mistakeNotebook: "ÈåØÈ°åÁ∞ø",
      logout: "ÁôªÂá∫",
      confirmLogout: "Á¢∫Ë™çÁôªÂá∫",
      areYouSureLogout: "Á¢∫ÂÆöË¶ÅÁôªÂá∫ÂóéÔºü",
      needSignInAgain: "ÊÇ®ÈúÄË¶ÅÂÜçÊ¨°ÁôªÂÖ•ÊâçËÉΩË®™ÂïèÊÇ®ÁöÑÂ∏≥Êà∂‰∏¶ÁπºÁ∫åÁ∑¥Áøí„ÄÇ",
      cancel: "ÂèñÊ∂à",
      errorLoadingAttempts: "ËºâÂÖ•Ë®òÈåÑÂ§±Êïó",
      retry: "ÈáçË©¶",
      clickRowFullAnalysis: "ÈªûÊìäË®òÈåÑÊü•ÁúãÂÆåÊï¥ÂàÜÊûê",
      refresh: "Âà∑Êñ∞",
      noDataYet: "Êö´ÁÑ°Êï∏Êìö",
      completeQuizSeeResults: "ÂÆåÊàêÊ∏¨È©óÂæåË®òÈåÑÂ∞áÈ°ØÁ§∫ÊñºÊ≠§",
      correct: "Ê≠£Á¢∫",
      timeSpent: "Áî®ÊôÇ",
      loadingDashboard: "ËºâÂÖ•Á∏ΩË¶ß‰∏≠...",
    },
    
    // Á∑¥ÁøíÊ®°Âºè
    practice: {
      selectMode: "ÈÅ∏ÊìáÁ∑¥ÁøíÊ®°Âºè",
      timed: "ÈôêÊôÇÁ∑¥Áøí",
      timedDesc: "ËàáÊôÇÈñìÁ´∂Ë≥Ω - {minutes} ÂàÜÈêò",
      marathon: "È¶¨ÊãâÊùæÊ®°Âºè",
      marathonDesc: "ÁÑ°ÈôêÊôÇÈñì - ËøΩËπ§ÊÇ®ÁöÑÈÄ≤Â∫¶",
      custom: "Ëá™ÂÆöÁæ©Á∑¥Áøí",
      customDesc: "ÈÅ∏Êìá‰∏ªÈ°åÂíåÈ°åÁõÆÊï∏Èáè",
      startPractice: "ÈñãÂßãÁ∑¥Áøí",
      selectPracticeMode: "ÈÅ∏ÊìáÁ∑¥ÁøíÊ®°Âºè",
      chooseHowPractice: "ÈÅ∏ÊìáÊÇ®ÁöÑÁ∑¥ÁøíÊñπÂºè",
      perQuestion: "ÂàÜÈêòÊØèÈ°å",
      perfectForExam: "ÊúÄÈÅ©ÂêàËÄÉË©¶Ê®°Êì¨ÔºåÂ∏∂ÊúâÂÄíÊï∏Ë®àÊôÇÂô®„ÄÇ",
      takeYourTime: "ÊÖ¢ÊÖ¢‰æÜ„ÄÇÊàëÂÄëÊúÉË®òÈåÑÊôÇÈñì‰ΩÜÊ≤íÊúâÂ£ìÂäõÔºÅ",
      chooseSpecificTopics: "ÈÅ∏ÊìáÁâπÂÆö‰∏ªÈ°å„ÄÅÂ≠ê‰∏ªÈ°åÂíåÈ°åÊï∏„ÄÇ",
      questions: "È°åÊï∏Ôºö",
      configure: "Ë®≠ÂÆö",
      yourAvailableTopics: "ÊÇ®ÂèØÁî®ÁöÑ‰∏ªÈ°å",
      more: "Êõ¥Â§ö",
      noTopicsConfigured: "Â∞öÊú™Ë®≠ÂÆö‰∏ªÈ°åÔºÅ",
      pleaseSetTopics: "Ë´ãÂú®ÂÄã‰∫∫Ë≥áÊñôË®≠ÂÆö‰∏≠Ë®≠ÂÆöÊÇ®Â∑≤Â≠∏ÁøíÁöÑ‰∏ªÈ°å„ÄÇ",
      goToProfile: "ÂâçÂæÄÂÄã‰∫∫Ë≥áÊñô",
      updateTopics: "Êõ¥Êñ∞‰∏ªÈ°å",
    },
    
    // Ê∏¨È©ó‰ªãÈù¢
    quiz: {
      question: "È°åÁõÆ",
      of: "ÂÖ±",
      flagQuestion: "Ê®ôË®òÈ°åÁõÆ",
      unflagQuestion: "ÂèñÊ∂àÊ®ôË®ò",
      periodicTable: "ÂÖÉÁ¥†ÈÄ±ÊúüË°®",
      overview: "Á∏ΩË¶Ω",
      previous: "‰∏ä‰∏ÄÈ°å",
      next: "‰∏ã‰∏ÄÈ°å",
      submit: "Êèê‰∫§",
      answered: "Â∑≤Á≠î",
      flagged: "Â∑≤Ê®ôË®ò",
      skipped: "Ë∑≥ÈÅé",
      timeRemaining: "Ââ©È§òÊôÇÈñì",
      sessionTime: "Á∑¥ÁøíÊôÇÈñì",
      totalTime: "Á∏ΩÊôÇÈñì",
      initializingQuiz: "ÂàùÂßãÂåñÊ∏¨È©ó‰∏≠...",
      type: "Ëº∏ÂÖ•",
      toSelect: "ÈÅ∏Êìá",
      flag: "Ê®ôË®ò",
      tools: "Â∑•ÂÖ∑",
      backToTopics: "ËøîÂõû‰∏ªÈ°å",
      periodicTableOfElements: "ÂÖÉÁ¥†ÈÄ±ÊúüË°®",
      time: "ÊôÇÈñì",
      thisQuestion: "Êú¨È°åÊôÇÈñìÔºö",
      questionOverview: "È°åÁõÆÊ¶ÇË¶Ω",
      tip: "ÊèêÁ§∫Ôºö",
      press: "Êåâ",
      pleaseAnswerAll: "Ë´ãÂú®Êèê‰∫§ÂâçÂõûÁ≠îÊâÄÊúâÂïèÈ°å„ÄÇ",
      finishSubmit: "ÂÆåÊàê‰∏¶Êèê‰∫§",
      confirmBackToTopics: "Á¢∫ÂÆöË¶ÅËøîÂõû‰∏ªÈ°åÈÅ∏ÊìáÂóéÔºü\n\n‚ö†Ô∏è ÊÇ®ÁöÑÊâÄÊúâÈÄ≤Â∫¶Â∞áÊúÉ‰∏üÂ§±ÔºÅ",
      enableTimer: "ÂïüÁî®Ë®àÊôÇÂô®",
      trackTimeSpent: "ËøΩËπ§ÊØèÈ°åÁî®ÊôÇ",
      showTimer: "È°ØÁ§∫Ë®àÊôÇÂô®",
      countdown: "ÂÄíÊï∏Ë®àÊôÇ",
      timedMode: "ÈôêÊôÇÊ®°Âºè",
      countdownTimer: "ÂÄíÊï∏Ë®àÊôÇ‰∏¶Ë®≠ÊôÇÈôê",
      timeUp: "ÊôÇÈñìÂà∞ÔºÅÊÇ®ÁöÑÊ∏¨È©óÂ∞áÁ´ãÂç≥Êèê‰∫§„ÄÇ",
    },
    
    // ÊàêÁ∏æ
    results: {
      yourPerformance: "ÊÇ®ÁöÑË°®Áèæ",
      totalTime: "Á∏ΩÊôÇÈñì",
      averagePerQuestion: "ÊØèÈ°åÂπ≥ÂùáÊôÇÈñì",
      strengths: "ÂÑ™Âã¢È†òÂüü",
      needsFocus: "ÈúÄË¶ÅÂä†Âº∑",
      detailedReview: "Ë©≥Á¥∞Ê™¢Ë®é",
      yourAnswer: "ÊÇ®ÁöÑÁ≠îÊ°à",
      correctAnswer: "Ê≠£Á¢∫Á≠îÊ°à",
      explanation: "Ëß£Èáã",
      shareReport: "ÂàÜ‰∫´ÊàêÁ∏æÂñÆ",
      addToNotebook: "Âä†ÂÖ•ÈåØÈ°åÁ∞ø",
      startNewSession: "ÈñãÂßãÊñ∞Á∑¥Áøí",
      savingToProfile: "‰øùÂ≠òËá≥ÊÇ®ÁöÑÂÄã‰∫∫Ë≥áÊñô...",
      savedToProfile: "Â∑≤‰øùÂ≠òËá≥ÊÇ®ÁöÑÂÄã‰∫∫Ë≥áÊñôÔºÅ",
    },
    
    // ÂÄã‰∫∫Ë≥áÊñô
    profile: {
      profileSettings: "ÂÄã‰∫∫Ë®≠ÂÆö",
      yourStatistics: "ÊÇ®ÁöÑÁµ±Ë®àË≥áÊñô",
      displayName: "È°ØÁ§∫ÂêçÁ®±",
      email: "ÈõªÈÉµÂú∞ÂùÄ",
      schoolLevel: "Âπ¥Á¥öÔºà‰∏≠Â≠∏Ôºâ",
      studyLevel: "Áï∂ÂâçÂ≠∏ÁøíÁ®ãÂ∫¶",
      memberSince: "Ë®ªÂÜäÊó•Êúü",
      saveChanges: "ÂÑ≤Â≠òËÆäÊõ¥",
      topicExceptions: "‰∏ªÈ°å‰æãÂ§ñ",
      unlockTopic: "Ëß£Èéñ‰∏ªÈ°å",
      lockTopic: "ÈéñÂÆö‰∏ªÈ°å",
      manageAccount: "ÁÆ°ÁêÜÊÇ®ÁöÑÂ∏≥Êà∂ÂíåÂ≠∏ÁøíÂÅèÂ•Ω",
      totalAttempts: "Á∏ΩÊ∏¨È©óÊ¨°Êï∏",
      overallAccuracy: "Êï¥È´îÊ∫ñÁ¢∫Áéá",
      questionsSolved: "Â∑≤ÂÆåÊàêÈ°åÁõÆ",
      accountInformation: "Â∏≥Êà∂Ë≥áË®ä",
      profileUpdated: "ÂÄã‰∫∫Ë≥áÊñôÊõ¥Êñ∞ÊàêÂäüÔºÅ",
      failedUpdate: "Êõ¥Êñ∞ÂÄã‰∫∫Ë≥áÊñôÂ§±Êïó„ÄÇË´ãÈáçË©¶„ÄÇ",
      enterYourName: "Ëº∏ÂÖ•ÊÇ®ÁöÑÂêçÁ®±",
      emailCannotChange: "ÈõªÈÉµÂú∞ÂùÄÁÑ°Ê≥ïÊõ¥Êîπ",
      selectCurrentForm: "ÈÅ∏ÊìáÊÇ®ÁõÆÂâçÁöÑÂπ¥Á¥öÔºà‰∏≠Âõõ„ÄÅ‰∏≠‰∫îÊàñ‰∏≠ÂÖ≠Ôºâ",
      topicsLearnedUpTo: "Â∑≤Â≠∏ÁøíËá≥ÁöÑ‰∏ªÈ°å",
      selectHighestTopic: "ÈÅ∏ÊìáÊÇ®Â∑≤Â≠∏ÁøíÁöÑÊúÄÈ´ò‰∏ªÈ°åÁ∑®Ëôü„ÄÇ‰æãÂ¶ÇÔºå„Äå08„ÄçË°®Á§∫ÊÇ®Â∑≤Â≠∏Áøí‰∏ªÈ°å 01-08„ÄÇ",
      topicExceptionsLabel: "‰∏ªÈ°å‰æãÂ§ñÔºàÊ®ôË®òÂ∞öÊú™Â≠∏ÁøíÁöÑ‰∏ªÈ°åÔºâ",
      clickToExclude: "ÈªûÊìä‰ª•ÊéíÈô§ÊÇ®Â∞öÊú™Ê∂µËìãÁöÑ‰∏ªÈ°åÔºåÂç≥‰ΩøÂÆÉÂÄë‰ΩéÊñºÊÇ®ÁöÑ„ÄåÂ∑≤Â≠∏ÁøíËá≥„ÄçÁ¥öÂà•„ÄÇ",
      yourAvailableTopicsCount: "ÊÇ®ÂèØÁî®ÁöÑ‰∏ªÈ°å",
      theseTopicsWillAppear: "ÈÄô‰∫õ‰∏ªÈ°åÂ∞áÂá∫ÁèæÂú®ÊÇ®ÁöÑË®àÊôÇÂíåÈ¶¨ÊãâÊùæÁ∑¥ÁøíÊ®°Âºè‰∏≠„ÄÇ",
      saving: "‰øùÂ≠ò‰∏≠...",
    },
    
    // ÊéíË°åÊ¶ú
    leaderboard: {
      title: "ÊéíË°åÊ¶ú",
      thisWeek: "Êú¨ÈÄ±",
      thisMonth: "Êú¨Êúà",
      allTime: "Ê≠∑Âè≤Á∏ΩÊ¶ú",
      you: "ÊÇ®",
      attempts: "Ê¨°Ê∏¨È©ó",
      questions: "È°å",
      seeHowYouRank: "ÁúãÁúãÊÇ®Âú®ÂÖ∂‰ªñÂ≠∏Áîü‰∏≠ÁöÑÊéíÂêç",
      noDataYet: "Êö´ÁÑ°Êï∏Êìö",
      beFirstComplete: "ÊàêÁÇ∫Á¨¨‰∏ÄÂÄãÂÆåÊàêÊ∏¨È©óÁöÑ‰∫∫ÔºÅ",
      howRankingsWork: "ÊéíÂêçË¶èÂâáÔºö",
      averageScoreLast7: "ÈÅéÂéª 7 Â§©ÊâÄÊúâÊ∏¨È©óÁöÑÂπ≥ÂùáÂàÜÊï∏",
      averageScoreLast30: "ÈÅéÂéª 30 Â§©ÊâÄÊúâÊ∏¨È©óÁöÑÂπ≥ÂùáÂàÜÊï∏",
      overallAccuracyAllTime: "ÊâÄÊúâÊ∏¨È©óÁöÑÊï¥È´îÊ∫ñÁ¢∫Áéá",
      formLevel: "S4/S5/S6 = Âπ¥Á¥ö",
      flameStreak: "ÁÅ´ÁÑ∞ = ÈÄ£Á∫åÂ≠∏ÁøíÂ§©Êï∏",
    },
    
    // Ë´ñÂ£á
    forum: {
      title: "MCQ Ë®éË´ñÂçÄ",
      discuss: "Ë®éË´ñ",
      addComment: "Êñ∞Â¢ûË©ïË´ñ",
      editComment: "Á∑®ËºØË©ïË´ñ",
      deleteComment: "Âà™Èô§Ë©ïË´ñ",
      noComments: "Â∞öÁÑ°Ë©ïË´ñ„ÄÇÊàêÁÇ∫Á¨¨‰∏ÄÂÄãË®éË´ñÁöÑ‰∫∫ÔºÅ",
      loading: "ËºâÂÖ•Ë®éË´ñ‰∏≠...",
      connectDiscuss: "ËàáÂÖ∂‰ªñÂ≠∏Áîü‰∫§ÊµÅË®éË´ñ",
      notifications: "ÈÄöÁü•",
      markAllRead: "ÂÖ®ÈÉ®Â∑≤ËÆÄ",
      noNotificationsYet: "Êö´ÁÑ°ÈÄöÁü•",
      likedYourComment: "ÈªûËÆö‰∫ÜÊÇ®ÁöÑË©ïË´ñ",
      repliedToPost: "ÂõûË¶Ü‰∫ÜÊÇ®ÁöÑÂ∏ñÂ≠ê",
      likedYourPost: "ÈªûËÆö‰∫ÜÊÇ®ÁöÑÂ∏ñÂ≠ê",
      likedYourReply: "ÈªûËÆö‰∫ÜÊÇ®ÁöÑÂõûË¶Ü",
      justNow: "ÂâõÂâõ",
      mcqDiscussion: "MCQ Ë®éË´ñ",
      generalForum: "‰∏ÄËà¨Ë®éË´ñÂçÄ",
      searchQuestions: "ÊêúÂ∞ãÈ°åÁõÆ„ÄÅ‰∏ªÈ°å„ÄÅDSE ‰ª£Á¢º...",
      recent: "ÊúÄÊñ∞",
      popular: "ÁÜ±ÈñÄ",
      questionsWithDiscussions: "ÂÄãÈ°åÁõÆÊúâË®éË´ñ",
      noResultsFound: "Êâæ‰∏çÂà∞ÁµêÊûú",
      noMcqDiscussions: "Â∞öÁÑ°MCQË®éË´ñ„ÄÇÂú®Ê∏¨È©ó‰∏≠ÈñãÂßãË®éË´ñÔºÅ",
      comments: "ÂâáË©ïË´ñ",
      searchPosts: "ÊêúÂ∞ãÂ∏ñÂ≠ê...",
      all: "ÂÖ®ÈÉ®",
      newPost: "Êñ∞Â∏ñÂ≠ê",
      noPosts: "Êö´ÁÑ°Â∏ñÂ≠êÔºåÊàêÁÇ∫Á¨¨‰∏ÄÂÄãÔºÅ",
      createPost: "Âª∫Á´ãÂ∏ñÂ≠ê",
      backToForum: "ËøîÂõûË®éË´ñÂçÄ",
      edited: "Â∑≤Á∑®ËºØ",
      save: "ÂÑ≤Â≠ò",
      cancel: "ÂèñÊ∂à",
      replies: "ÂâáÂõûË¶Ü",
      writeReply: "Êí∞ÂØ´ÂõûË¶Ü...",
      reply: "ÂõûË¶Ü",
      pleaseLoginReply: "Ë´ãÁôªÂÖ•‰ª•ÂõûË¶Ü„ÄÇ",
      createNewPost: "Âª∫Á´ãÊñ∞Â∏ñÂ≠ê",
      category: "È°ûÂà•",
      title2: "Ê®ôÈ°å",
      enterClearTitle: "Ëº∏ÂÖ•Ê∏ÖÊô∞ÁöÑÊ®ôÈ°å",
      content: "ÂÖßÂÆπ",
      shareThoughts: "ÂàÜ‰∫´ÊÇ®ÁöÑÊÉ≥Ê≥ï„ÄÅÂïèÈ°åÊàñÂÖ¨Âëä...",
      post: "ÁôºË°®",
      deletePost: "Âà™Èô§Ê≠§Â∏ñÂ≠êÔºü",
      deleteReply: "Âà™Èô§Ê≠§ÂõûË¶ÜÔºü",
      editExpired: "Á∑®ËºØÊôÇÈñìÂ∑≤ÈÅéÔºà15ÂàÜÈêòÔºâ„ÄÇ",
    },
    
    // ÈåØÈ°åÁ∞ø
    notebook: {
      // ‰∏ªÂ∞éËà™
      title: "ÈåØÈ°åÁ∞ø",
      commandCenter: "ÈåØÈ°åÊåáÊèÆ‰∏≠ÂøÉ",
      mistakeDeck: "ÈåØÈ°åÂç°ÁµÑ",
      learningInsights: "Â≠∏ÁøíÊ¥ûÂØü",
      learningAnalytics: "Â≠∏ÁøíÂàÜÊûê",
      masteryArchive: "ÊéåÊè°Ê™îÊ°à",
      
      // Êìç‰Ωú
      review: "Ê™¢Ë®éÈåØÈ°å",
      practiceMistakes: "Âè™Á∑¥ÁøíÈåØÈ°å",
      practiceMistakesCount: "Á∑¥Áøí {count} ÈÅìÈåØÈ°å",
      practiceSelected: "Á∑¥Áøí {count} ÈÅìÈÅ∏‰∏≠È°åÁõÆ",
      cleared: "ÊâÄÊúâÈåØÈ°åÂ∑≤Ê∏ÖÈô§ÔºÅ",
      addedToNotebook: "Â∑≤Âä†ÂÖ•ÈåØÈ°åÁ∞ø",
      removedFromNotebook: "Â∑≤ÂæûÈåØÈ°åÁ∞øÁßªÈô§",
      reviewMaster: "Ë§áÁøí‰∏¶ÊéåÊè°ÊÇ®Á≠îÈåØÁöÑÈ°åÁõÆ",
      
      // ÂÆåÊï¥È°åÁõÆÂΩàÁ™ó
      questionDetail: "È°åÁõÆË©≥ÊÉÖ",
      question: "È°åÁõÆ",
      options: "ÈÅ∏È†Ö",
      viewFullQuestion: "Êü•ÁúãÂÆåÊï¥È°åÁõÆ",
      viewFull: "Êü•ÁúãÂÆåÊï¥",
      attempts: "ÂòóË©¶Ê¨°Êï∏",
      masteryLevelLabel: "ÊéåÊè°Á®ãÂ∫¶",
      lastAttemptedLabel: "ÊúÄÂæåÂòóË©¶",
      
      // Áµ±Ë®à
      totalMistakes: "Á∏ΩÈåØÈ°åÊï∏",
      topicsToFocus: "ÈúÄÂä†Âº∑‰∏ªÈ°å",
      repeatedMistakes: "ÈáçË§áÈåØË™§",
      
      // ÈÖçÁΩÆÂô®
      configurePractice: "Ë®≠ÂÆöÁ∑¥Áøí",
      numberOfQuestions: "È°åÁõÆÊï∏Èáè",
      questionsLabel: "1. È°åÁõÆÊï∏Èáè",
      questionsAvailable: "È°åÂèØÁî®",
      questionsAvailableFull: "È°åÁ¨¶ÂêàÁõÆÂâçÁØ©ÈÅ∏Ê¢ù‰ª∂",
      timeRange: "ÊôÇÈñìÁØÑÂúç",
      timeRangeLabel: "2. ÊôÇÈñìÁØÑÂúçÔºàÁäØÈåØÊôÇÈñìÔºâ",
      allTime: "ÊâÄÊúâÊôÇÈñì",
      lastMonth: "‰∏äÂÄãÊúà",
      lastWeek: "‰∏äÈÄ±",
      default: "È†êË®≠",
      
      // ÁØ©ÈÅ∏Âô®
      topics: "‰∏ªÈ°å",
      topicsLabel: "3. ‰∏ªÈ°åÔºàÁïôÁ©∫Ë°®Á§∫ÂÖ®ÈÉ®Ôºâ",
      subtopics: "Â≠ê‰∏ªÈ°å",
      subtopicsFilteredNote: "ÔºàÂ∑≤ÊåâÈÅ∏ÂÆö‰∏ªÈ°åÁØ©ÈÅ∏Ôºâ",
      masteryLevel: "ÊéåÊè°Á®ãÂ∫¶",
      clearTopicFilter: "‚úï Ê∏ÖÈô§‰∏ªÈ°åÁØ©ÈÅ∏",
      clearSubtopicFilter: "Ê∏ÖÈô§Â≠ê‰∏ªÈ°åÁØ©ÈÅ∏",
      clearMasteryFilter: "Ê∏ÖÈô§ÊéåÊè°Á®ãÂ∫¶ÁØ©ÈÅ∏",
      filteredFrom: "Âæû‰ª•‰∏ãÈ†ÖÁõÆÁØ©ÈÅ∏",
      clearSelection: "Ê∏ÖÈô§ÈÅ∏Êìá",
      
      // ÊéåÊè°ÁãÄÊÖãÊ®ôÁ±§
      masteryNew: "Êú™ËôïÁêÜ",
      masteryDeveloping: "ÁôºÂ±ï‰∏≠",
      masteryProgressing: "ÈÄ≤Ë°å‰∏≠",
      masteryNear: "Êé•ËøëÊéåÊè°",
      statusUnprocessed: "Êú™ËôïÁêÜ",
      statusInProgress: "ÈÄ≤Ë°å‰∏≠",
      statusNearMastery: "Êé•ËøëÊéåÊè°",
      
      // Á©∫ÁãÄÊÖã
      allMistakes: "ÊâÄÊúâÈåØÈ°å",
      noMistakesYet: "ÁõÆÂâçÊ≤íÊúâÈåØÈ°åÔºÅ",
      keepPracticing: "ÁπºÁ∫åÁ∑¥Áøí„ÄÇÁ≠îÈåØÁöÑÈ°åÁõÆÊúÉÂá∫ÁèæÂú®ÈÄôË£°„ÄÇ",
      startPracticing: "ÈñãÂßãÁ∑¥Áøí",
      noQuestionsFound: "Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÈ°åÁõÆ",
      tryAdjustFilters: "Ë´ãÂòóË©¶Ë™øÊï¥ÊÇ®ÁöÑÁØ©ÈÅ∏Ë®≠ÂÆö",
      noArchivedYet: "Êö´ÁÑ°Â∑≤Ê≠∏Ê™îÈ°åÁõÆ",
      archiveInstructions: "ÈÄ£Á∫åÁ≠îÂ∞ç 3 Ê¨°‰ª•Ê≠∏Ê™îÈ°åÁõÆ",
      allCaughtUp: "ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ",
      
      // È°åÁõÆË©≥ÊÉÖ
      lastAttempt: "ÊúÄÂæåÂòóË©¶",
      missed: "ÈåØ {count} Ê¨°",
      yourAnswer: "ÊÇ®ÁöÑÁ≠îÊ°à",
      correctAnswer: "Ê≠£Á¢∫Á≠îÊ°à",
      correct: "Ê≠£Á¢∫",
      explanation: "Ëß£Èáã",
      priority: "ÂÑ™ÂÖàÂ∫¶",
      
      // ÈÅã‰ΩúÂéüÁêÜ
      howItWorks: "ÈÅã‰ΩúÂéüÁêÜ",
      wrongAnswersAutoSaved: "Á≠îÈåØÁöÑÈ°åÁõÆËá™ÂãïÂÑ≤Â≠òÂú®ÈÄôË£°",
      useFilters: "‰ΩøÁî®ÁØ©ÈÅ∏Âô®Â∞àÊ≥®ÊñºÁâπÂÆö‰∏ªÈ°åÊàñÊúÄËøëÁöÑÈåØË™§",
      practiceUntilMaster: "Á∑¥ÁøíÁõ¥Âà∞ÊÇ®ÊéåÊè°ÂÆÉÂÄëÔºÅ",
      clearAfterThreeCorrect: "‚ú® ÈÄ£Á∫åÁ≠îÂ∞ç 3 Ê¨°ÂæåÔºåÈ°åÁõÆÂ∞áËá™ÂãïÊ∏ÖÈô§ÔºÅ",
      
      // ËºâÂÖ•ÁãÄÊÖã
      loadingMistakes: "ËºâÂÖ•ÈåØÈ°å‰∏≠...",
      sessionLimited: "ÊØèÊ¨°Á∑¥ÁøíÊúÄÂ§ö {max} È°å„ÄÇ",
      
      // ‰∏ªÈ°åÂàÜÊûê
      topicBreakdown: "‰∏ªÈ°åÂàÜÊûê",
      hoverForDetails: "ÁßªËá≥Áµ±Ë®à‰ª•Êü•ÁúãË©≥ÊÉÖ",
      weakTopics: "Âº±Âã¢‰∏ªÈ°å",
      focusTheseTopics: "Â∞àÊ≥®ÊñºÈÄô‰∫õ‰∏ªÈ°å",
      repeatsByTopic: "Êåâ‰∏ªÈ°åÈáçË§áÈåØË™§",
      needMorePractice: "ÈúÄË¶ÅÊõ¥Â§öÁ∑¥Áøí",
      improved: "ÊîπÈÄ≤ {count} Ê¨°",
      
      // ‰øùÁïôÂÑÄË°®Êùø
      retentionDashboard: "Â≠∏Áøí‰øùÁïôÂÑÄË°®Êùø",
      addedThisWeek: "Êñ∞Â¢ûÔºà7Â§©Ôºâ",
      masteredThisWeek: "Â∑≤ÊéåÊè°Ôºà7Â§©Ôºâ",
      decayRate: "Ë°∞Ê∏õÁéá",
      decayImproving: "üìà ÊåÅÁ∫åÈÄ≤Ê≠•",
      decayStable: "‚öñÔ∏è Á∂≠ÊåÅÁ©©ÂÆö",
      decayGrowing: "üìâ ÈåØÈ°åÂ¢ûÂä†",
      weakestSubtopics: "ÊúÄÂº±Â≠ê‰∏ªÈ°å",
      urgentReviews: "Á∑äÊÄ•Ë§áÁøíÔºàÊåâÂÑ™ÂÖàÂàÜÊéíÂ∫èÔºâ",
      
      // ÂÑ™ÂÖàÂàÜÂæΩÁ´†
      priorityScore: "ÈñìÈöîÈáçË§áÂÑ™ÂÖàÂàÜ",
      
      // ÂÖÉË™çÁü•Ê®ôË®ò
      errorTypeLabel: "ÈåØË™§È°ûÂûãÔºö",
      tagErrorType: "Ê®ôË®òÈåØË™§È°ûÂûã",
      errorCategory: "ÈåØË™§È°ûÂà•",
      clearTag: "Ê∏ÖÈô§Ê®ôË®ò",
      errorMisread: "È°åÁõÆÁúãÈåØ",
      errorConceptual: "Ê¶ÇÂøµÁº∫Âè£",
      errorCalculation: "Ë®àÁÆóÈåØË™§",
      errorCareless: "Á≤óÂøÉÂ§ßÊÑè",
      errorVocabulary: "Ë©ûÂΩô‰∏çË∂≥",
      errorDiagram: "ÂúñË°®Ë™§ËÆÄ",
      tagError: "Ê®ôË®òÈåØË™§",
      
      // È°çÂ§ñË™™Êòé
      spacedRepetitionNote: "Âç°ÁâáÊåâÈñìÈöîÈáçË§áÂÑ™ÂÖàÂàÜÊéíÂ∫è‚Äî‚ÄîÊúÄÁ∑äÊÄ•ÁöÑÊéíÂú®ÊúÄÂâç„ÄÇ",
      metacognitiveNote: "ÁÇ∫ÊØèÈÅìÈåØÈ°åÊ®ôË®òÈåØË™§È°ûÂà•ÔºåËøΩËπ§ÊÇ®ÁöÑÂ≠∏ÁøíÊ®°Âºè„ÄÇ",
      
      // Â≠∏ÁøíÂàÜÊûêÂÑÄË°®Êùø
      mistakeClearingActivity: "ÈåØÈ°åÊ∏ÖÈô§Ê¥ªÂãï",
      errorDensityByTopic: "Êåâ‰∏ªÈ°åÈåØË™§ÂØÜÂ∫¶",
      improvementTrend: "ÊîπÈÄ≤Ë∂®Âã¢Ôºà14Â§©Ôºâ",
      clickTopicToFilter: "ÈªûÊìä‰∏ªÈ°å‰ª•ÁØ©ÈÅ∏ ‚Üí",
      clickTopicsToFilter: "ÈªûÊìä‰∏ªÈ°å‰ª•ÁØ©ÈÅ∏ÔºàÂèØÂ§öÈÅ∏Ôºâ",
      less: "ËºÉÂ∞ë",
      more: "Êõ¥Â§ö",
      
      // AIÊØèÊó•‰ªªÂãô
      aiDailyMission: "AIÊØèÊó•‰ªªÂãô",
      aiDailyMissionNote: "Êô∫ËÉΩAIÈÅ∏Êìá10ÈÅìÈ°åÁõÆÔºå‰∫§ÈåØÁ∑¥Áøí‰ª•ÊúÄÂ§ßÂåñË®òÊÜ∂‰øùÊåÅ„ÄÇ",
      needMoreQuestions: "ÈúÄË¶Å10+ÈåØÈ°åÔºàÊÇ®Êúâ{count}ÈÅìÔºâ",
      interleavedPractice: "10ÈÅìÈ°åÁõÆ ‚Ä¢ ‰∫§ÈåØÁ∑¥Áøí",
      
      // Ë®àÊôÇÂô®Ë®≠ÂÆö
      timerEnabled: "Ë®àÊôÇÂô®Â∑≤ÂïüÁî®",
      timedMode: "ÈôêÊôÇÊ®°Âºè",
      
      // Ê™¢Ë¶ñÊ®°Âºè
      listView: "ÂàóË°®Ê™¢Ë¶ñ",
      kanbanView: "ÁúãÊùøÊ™¢Ë¶ñ",
      selectAll: "ÂÖ®ÈÅ∏",
      
      // Ê≠∏Ê™î
      mastered: "Â∑≤ÊéåÊè°",
      masteredOn: "Êñº{date}ÊéåÊè°",
      archivedAt: "Ê≠∏Ê™îÊñº",
      
      // ÁØ©ÈÅ∏Ê®ôÁ±§
      topicFilter: "‰∏ªÈ°åÔºö{topic}",
    },
    
    // Ê≠∑Âè≤Ë®òÈåÑ
    history: {
      title: "Á∑¥ÁøíÊ≠∑Âè≤",
      clickToSeeAnalysis: "ÈªûÊìä‰ªª‰ΩïË®òÈåÑÊü•ÁúãÂÆåÊï¥ÂàÜÊûê",
      totalAttempts: "Á∏ΩÊ¨°Êï∏",
      averageScore: "Âπ≥ÂùáÂàÜÊï∏",
      bestScore: "ÊúÄÈ´òÂàÜÊï∏",
      totalTime: "Á∏ΩÊôÇÈñì",
      filtersAndSorting: "ÁØ©ÈÅ∏ËàáÊéíÂ∫è",
      timePeriod: "ÊôÇÈñìÁØÑÂúç",
      allTime: "ÂÖ®ÈÉ®",
      lastMonth: "‰∏äÂÄãÊúà",
      lastWeek: "‰∏äÈÄ±",
      sortBy: "ÊéíÂ∫èÊñπÂºè",
      recent: "ÊúÄÊñ∞",
      score: "ÂàÜÊï∏",
      time: "ÊôÇÈñì",
      yourAttempts: "ÊÇ®ÁöÑË®òÈåÑ",
      clickViewAnalysis: "ÈªûÊìäÊü•ÁúãÂÆåÊï¥ÂàÜÊûê",
      refresh: "Âà∑Êñ∞",
      noAttemptsFound: "Ê≤íÊúâÊâæÂà∞Ë®òÈåÑ",
      tryChangingFilter: "ÂòóË©¶Êõ¥ÊîπÊôÇÈñìÁØÑÂúç",
      startPracticingHistory: "ÈñãÂßãÁ∑¥Áøí‰ª•Êü•ÁúãÊ≠∑Âè≤Ë®òÈåÑÔºÅ",
      takeFirstQuiz: "ÈñãÂßãÁ¨¨‰∏ÄÂÄãÊ∏¨È©ó",
      correct: "Ê≠£Á¢∫",
      loadingHistory: "ËºâÂÖ•Ê≠∑Âè≤Ë®òÈåÑ...",
    },
    
    // ÈÄöÁî®
    common: {
      loading: "ËºâÂÖ•‰∏≠...",
      error: "ÈåØË™§",
      success: "ÊàêÂäü",
      confirm: "Á¢∫Ë™ç",
      cancel: "ÂèñÊ∂à",
      save: "ÂÑ≤Â≠ò",
      delete: "Âà™Èô§",
      edit: "Á∑®ËºØ",
      close: "ÈóúÈñâ",
      retry: "ÈáçË©¶",
      backToTopics: "ËøîÂõû‰∏ªÈ°åÈÅ∏Êìá",
    },
    
    // Ë™çË≠â
    auth: {
      login: "ÁôªÂÖ•",
      register: "Ë®ªÂÜä",
      email: "ÈõªÈÉµÂú∞ÂùÄ",
      password: "ÂØÜÁ¢º",
      confirmPassword: "Á¢∫Ë™çÂØÜÁ¢º",
      fullName: "ÂÖ®Âêç",
      createAccount: "Âª∫Á´ãÂ∏≥Êà∂",
      alreadyHaveAccount: "Â∑≤ÊúâÂ∏≥Êà∂Ôºü",
      dontHaveAccount: "ÈÇÑÊ≤íÊúâÂ∏≥Êà∂Ôºü",
      loginHere: "Âú®Ê≠§ÁôªÂÖ•",
      registerHere: "Âú®Ê≠§Ë®ªÂÜä",
      welcomeBack: "Ê≠°ËøéÂõû‰æÜ",
      enterCredentials: "Ëº∏ÂÖ•ÊÇ®ÁöÑÁôªÂÖ•Ë≥áÊñô‰ª•Ë®™ÂïèÂ∏≥Êà∂",
      signingIn: "ÁôªÂÖ•‰∏≠...",
      signIn: "ÁôªÂÖ•",
      createAccountNow: "Á´ãÂç≥Ë®ªÂÜä",
      secureLogin: "Áî± Firebase Êèê‰æõÂÆâÂÖ®ÁôªÂÖ•",
      noAccountFound: "Êâæ‰∏çÂà∞Ê≠§ÈõªÈÉµÁöÑÂ∏≥Êà∂„ÄÇ",
      incorrectPassword: "ÂØÜÁ¢ºÈåØË™§„ÄÇ",
      invalidEmail: "ÁÑ°ÊïàÁöÑÈõªÈÉµÂú∞ÂùÄ„ÄÇ",
      failedLogin: "ÁôªÂÖ•Â§±Êïó„ÄÇË´ãÊ™¢Êü•ÊÇ®ÁöÑÁôªÂÖ•Ë≥áÊñô„ÄÇ",
      joinCommunity: "Âä†ÂÖ•ÊàëÂÄëÁöÑÂåñÂ≠∏Â≠∏ÁøíÁ§æÁæ§",
      creatingAccount: "ÂâµÂª∫Â∏≥Êà∂‰∏≠...",
      passwordsNoMatch: "ÂØÜÁ¢º‰∏çÂåπÈÖç",
      passwordMinLength: "ÂØÜÁ¢ºÂøÖÈ†àËá≥Â∞ë6ÂÄãÂ≠óÁ¨¶",
      enterFullName: "Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂÖ®Âêç",
      emailAlreadyInUse: "Ê≠§ÈõªÈÉµÂ∑≤Ë¢´‰ΩøÁî®„ÄÇ",
      weakPassword: "ÂØÜÁ¢ºÂ§™Âº±„ÄÇË´ã‰ΩøÁî®Ëá≥Â∞ë6ÂÄãÂ≠óÁ¨¶„ÄÇ",
      failedCreateAccount: "ÂâµÂª∫Â∏≥Êà∂Â§±Êïó„ÄÇË´ãÈáçË©¶„ÄÇ",
      minimumCharacters: "ÊúÄÂ∞ë6ÂÄãÂ≠óÁ¨¶",
      secureRegistration: "Áî± Firebase Êèê‰æõÂÆâÂÖ®Ë®ªÂÜä",
      switchToChinese: "Switch to Traditional Chinese",
      switchToEnglish: "ÂàáÊèõËá≥Ëã±Êñá",
    },

    // ChemStore
    store: {
      title: "ChemStore",
      subtitle: "‰ΩøÁî®‰ª£Âπ£Ëß£ÈéñÁç®ÂÆ∂Áâ©ÂìÅ",
      yourBalance: "ÊÇ®ÁöÑÈ§òÈ°ç",
      profilePics: "È†≠ÂÉè",
      badges: "ÂæΩÁ´†",
      themes: "‰∏ªÈ°å",
      equipped: "Â∑≤Ë£ùÂÇô",
      equip: "Ë£ùÂÇô",
      buy: "Ë≥ºË≤∑",
      claim: "È†òÂèñ",
      locked: "ÈéñÂÆö",
      buying: "Ë≥ºË≤∑‰∏≠...",
      comingSoon: "Âç≥Â∞áÊé®Âá∫ÔºÅüöÄ",
      howToEarnTokens: "Â¶Ç‰ΩïË≥∫Âèñ‰ª£Âπ£",
      perfectScore: "ÂÆåÁæéÂàÜÊï∏ (100%)Ôºö",
      perfectScoreTokens: "10 ‰ª£Âπ£",
      excellentScore: "ÂÑ™ÁßÄÂàÜÊï∏ (80%+)Ôºö",
      excellentScoreTokens: "5 ‰ª£Âπ£",
      goodScore: "ËâØÂ•ΩÂàÜÊï∏ (60%+)Ôºö",
      goodScoreTokens: "2 ‰ª£Âπ£",
      clearMistake: "Ê∏ÖÈô§ÈåØË™§Ôºö",
      clearMistakeTokens: "1 ‰ª£Âπ£ÔºàÊØèÈ°åÊØèÂ§©‰∏ÄÊ¨°Ôºâ",
      leaderboardGold: "ÊéíË°åÊ¶úÈáëÁâåÔºö",
      leaderboardTokens: "60 ‰ª£Âπ£ÔºàÊØèÈÄ±Ôºâ/ 10 ‰ª£Âπ£ÔºàÊØèÊó•Ôºâ",
      studyStreaks: "Â≠∏ÁøíÈÄ£ÂãùÔºö",
      studyStreaksTokens: "15 ‰ª£Âπ£Ôºà7Â§©Ôºâ/ 50 ‰ª£Âπ£Ôºà30Â§©Ôºâ",
      notEnoughTokens: "‰ª£Âπ£‰∏çË∂≥ÔºÅüí∏",
      purchased: "Â∑≤Ë≥ºË≤∑ {name}ÔºÅüéâ",
      purchaseFailed: "Ë≥ºË≤∑Â§±Êïó",
      failedToEquip: "Ë£ùÂÇôÂ§±Êïó",
      pleaseTryAgain: "Ë´ãÈáçË©¶„ÄÇ",
      failedToEquipItem: "Ë£ùÂÇôÁâ©ÂìÅÂ§±Êïó",
    },

    // Practice Mode Selection
    practiceMode: {
      updateYourTopics: "Êõ¥Êñ∞ÊÇ®ÁöÑ‰∏ªÈ°å",
      learnedUpTo: "Â∑≤Â≠∏ÁøíËá≥Ôºö",
      exceptions: "‰æãÂ§ñÔºàÊú™Â≠∏ÁøíÔºâÔºö",
      saveChanges: "ÂÑ≤Â≠òËÆäÊõ¥",
      updating: "Êõ¥Êñ∞‰∏≠...",
      topicsUpdated: "‰∏ªÈ°åÂ∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ",
      failedUpdate: "Êõ¥Êñ∞‰∏ªÈ°åÂ§±Êïó",
      configureCustomSession: "Ëá™Ë®ÇÁ∑¥ÁøíË®≠ÂÆö",
      back: "ËøîÂõû",
      selectTopics: "1. ÈÅ∏Êìá‰∏ªÈ°åÔºàÂèØÂ§öÈÅ∏Ôºâ",
      lockedTopicsNotLearned: "ÈéñÂÆöÁöÑ‰∏ªÈ°åÂ∞öÊú™Â≠∏Áøí„ÄÇË´ãÂú®ÂÄã‰∫∫Ë≥áÊñô‰∏≠Êõ¥Êñ∞ÊàñÈªûÊìä‰∏äÊñπÊåâÈàï„ÄÇ",
      focusSubtopics: "2. ÈÅ∏ÊìáÂ≠ê‰∏ªÈ°åÔºàÂèØÈÅ∏Ôºâ",
      sessionLength: "3. Á∑¥ÁøíÈ°åÊï∏",
      generateExam: "ÈñãÂßãÁ∑¥Áøí",
      startPractice: "ÈñãÂßãÁ∑¥Áøí",
    },
  },
};

export function LanguageProvider({ children }) {
  const [language, setLanguage] = useState(() => {
    return localStorage.getItem('chemleung_language') || 'en';
  });

  useEffect(() => {
    localStorage.setItem('chemleung_language', language);
  }, [language]);

  const toggleLanguage = () => {
    setLanguage(prev => prev === 'en' ? 'zh' : 'en');
  };

  const t = (key) => {
    const keys = key.split('.');
    let value = translations[language];
    for (const k of keys) {
      if (value && typeof value === 'object') {
        value = value[k];
      } else {
        return key;
      }
    }
    return value || key;
  };

  const tf = (key, params = {}) => {
    let text = t(key);
    Object.keys(params).forEach(param => {
      text = text.replace(`{${param}}`, params[param]);
    });
    return text;
  };

  const value = {
    language,
    setLanguage,
    toggleLanguage,
    t,
    tf,
    isEnglish: language === 'en',
    isChinese: language === 'zh',
  };

  return (
    <LanguageContext.Provider value={value}>
      {children}
    </LanguageContext.Provider>
  );
}

// ========== src/firebase/config.js ==========

// Firebase configuration and initialization
import { initializeApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';

// Your web app's Firebase configuration
// TODO: Replace with your own Firebase config from Firebase Console
const firebaseConfig = {
  apiKey: "AIzaSyBKk_TsWIVQCXfIwPQXnFOXvSNQNDgyvFg",
  authDomain: "chemleung-hkdse-mcq-platform.firebaseapp.com",
  projectId: "chemleung-hkdse-mcq-platform",
  storageBucket: "chemleung-hkdse-mcq-platform.firebasestorage.app",
  messagingSenderId: "811594644247",
  appId: "1:811594644247:web:5282c3c73f1d3566955552",
  measurementId: "G-85R118KESK"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

// Initialize Firebase services
export const auth = getAuth(app);
export const db = getFirestore(app);

export default app;

// ========== src/hooks/useQuizData.js ==========

import { useState, useEffect } from 'react';
import Papa from 'papaparse';

export function useQuizData(url) {
  const [questions, setQuestions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: 'greedy',
      newline: '',
      complete: (results) => {
        try {
          const formattedData = results.data
            .filter(row => Object.values(row).join('').trim().length > 0)
            .map((row, index) => {
              const getVal = (name) => {
                const key = Object.keys(row).find(k => k.trim().toLowerCase() === name.toLowerCase());
                return row[key] ? row[key] : "";
              };

              // Convert any type of line break to <br>
              const nl2br = (text) => {
                if (!text) return "";
                return text.split(/\r\n|\r|\n/).join('<br>');
              };

              // Remove option prefix (A. B. C. D.) from the beginning
              const removePrefix = (text) => {
                if (!text) return "";
                // Remove patterns like "A. ", "B. ", "C. ", "D. " from the start
                return text.replace(/^[A-D]\.\s*/i, '');
              };

              const rawQuestion = getVal('QuestionText');

              // Image logic
              const imgRegex = /[\{\(]image:(.*?)[\}\)]/i;
              const imgMatch = rawQuestion.match(imgRegex);
              const imageUrl = getVal('Pictureurl') || (imgMatch ? imgMatch[1] : null);
              const cleanQuestion = rawQuestion.replace(imgRegex, "");

              // CRITICAL FIX: Ensure truly unique IDs
              // Use the spreadsheet ID if available AND unique, otherwise use index
              const rawId = getVal('ID');
              const uniqueId = rawId && rawId.trim() !== "" 
                ? `${rawId}-${index}` // Combine ID with index for guaranteed uniqueness
                : `q-${index}`; // Fallback to index-based ID

              return {
                ID: uniqueId,
                Topic: getVal('Topic') || "Uncategorized",
                Subtopic: getVal('Subtopic') || "",
                Question: nl2br(cleanQuestion),
                OptionA: nl2br(removePrefix(getVal('OptionA'))),
                OptionB: nl2br(removePrefix(getVal('OptionB'))),
                OptionC: nl2br(removePrefix(getVal('OptionC'))),
                OptionD: nl2br(removePrefix(getVal('OptionD'))),
                CorrectOption: getVal('CorrectOption').toUpperCase().trim(),
                Explanation: nl2br(getVal('Explanation')),
                Pictureurl: imageUrl ? imageUrl.trim() : null,
                DSEcode: getVal('DSEcode') || getVal('DSECode')
              };
            });

          setQuestions(formattedData);
          setLoading(false);
        } catch (err) {
          setError("Failed to process data.");
          setLoading(false);
        }
      }
    });
  }, [url]);

  return { questions, loading, error };
}

// ========== src/main.jsx ==========

import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App_Final.jsx'

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <App />
  </StrictMode>,
)


// ========== src/pages/DashboardPage_Fixed.jsx ==========

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { quizService } from '../services/quizService';
import { quizStorage } from '../utils/quizStorage';
import { loadMistakesFromStorage } from '../utils/masteryHelper';
import AttemptDetailModal from '../components/AttemptDetailModal';
import MasteryProgressHub from '../components/dashboard/MasteryProgressHub';
import CurrentGoalWidget from '../components/dashboard/CurrentGoalWidget';
import PriorityReviewSection from '../components/dashboard/PriorityReviewSection';
import DailyMissionCard from '../components/dashboard/DailyMissionCard';
import CalendarHeatmap from '../components/dashboard/CalendarHeatmap';
import CompactAttemptsList from '../components/dashboard/CompactAttemptsList';
import { LogOut, AlertCircle, RefreshCw, Sparkles } from 'lucide-react';

const MASTERY_THRESHOLD = 3;

// Helper function for AI Daily Mission
function calculateMasteryPriority(mistake, recentTopics = []) {
  const now = Date.now();
  const lastAttemptTime = new Date(mistake.lastAttempted).getTime();
  const daysSinceLastAttempt = Math.max(0, (now - lastAttemptTime) / (1000 * 60 * 60 * 24));
  const U = Math.pow(2, daysSinceLastAttempt / 7);
  const D = Math.min(1.0, (mistake.attemptCount || 1) / 3);
  let R = 0.5;
  if (recentTopics.length > 0 && recentTopics.includes(mistake.Topic)) {
    R = 1.5;
  }
  return (U * 0.4) + (D * 0.4) + (R * 0.2);
}

function selectAIDailyMission(mistakes, recentTopics = []) {
  const prioritized = mistakes
    .map(m => ({
      ...m,
      masteryPriority: calculateMasteryPriority(m, recentTopics)
    }))
    .sort((a, b) => b.masteryPriority - a.masteryPriority);
  
  const byTopic = {};
  prioritized.forEach(m => {
    if (!byTopic[m.Topic]) byTopic[m.Topic] = [];
    byTopic[m.Topic].push(m);
  });
  
  const selected = [];
  const topicList = Object.keys(byTopic);
  const indices = Object.fromEntries(topicList.map(t => [t, 0]));
  
  while (selected.length < 10 && topicList.some(t => indices[t] < byTopic[t].length)) {
    for (const topic of topicList) {
      if (selected.length >= 10) break;
      if (indices[topic] < byTopic[topic].length) {
        selected.push(byTopic[topic][indices[topic]++]);
      }
    }
  }
  
  return selected.slice(0, 10);
}

export default function DashboardPage() {
  const { currentUser, userProfile, logout } = useAuth();
  const { t } = useLanguage();
  const [attempts, setAttempts] = useState([]);
  const [mistakes, setMistakes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [selectedAttempt, setSelectedAttempt] = useState(null);
  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
  const [loadingAIMission, setLoadingAIMission] = useState(false);
  const navigate = useNavigate();

  useEffect(() => {
    loadAttempts();
    loadMistakes();
  }, [currentUser]);

  async function loadAttempts() {
    if (!currentUser) { setLoading(false); return; }
    try {
      setError(null);
      setLoading(true);
      const userAttempts = await quizService.getUserAttempts(currentUser.uid, 10);
      setAttempts(userAttempts);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }

  function loadMistakes() {
    try {
      const loadedMistakes = loadMistakesFromStorage();
      setMistakes(loadedMistakes);
    } catch (err) {
      console.error('Error loading mistakes:', err);
      setMistakes([]);
    }
  }

  async function handleAIDailyMission() {
    setLoadingAIMission(true);
    try {
      // Load user's mistakes
      const userAttempts = await quizService.getUserAttempts(currentUser.uid, 100);
      const incorrectMap = new Map();
      const improvementData = JSON.parse(
        localStorage.getItem('mistake_improvements') || '{}'
      );
      const recentTopics = JSON.parse(localStorage.getItem('recent_quiz_topics') || '[]');
      
      userAttempts.forEach((attempt) => {
        if (!attempt.answers || !attempt.questions) return;
        attempt.questions.forEach((question) => {
          const userAnswer = attempt.answers[question.ID];
          const isCorrect = userAnswer && userAnswer === question.CorrectOption;
          
          if (isCorrect && improvementData[question.ID]) {
            improvementData[question.ID].correctCount =
              (improvementData[question.ID].correctCount || 0) + 1;
            improvementData[question.ID].lastCorrect = attempt.timestamp;
          }
          
          if (userAnswer && userAnswer !== question.CorrectOption) {
            const improveCount = improvementData[question.ID]?.correctCount || 0;
            if (improveCount >= MASTERY_THRESHOLD) return;
            
            if (!incorrectMap.has(question.ID)) {
              incorrectMap.set(question.ID, {
                ...question,
                attemptCount: 1,
                lastAttempted: attempt.timestamp,
                userAnswer,
                improvementCount: improveCount,
              });
            } else {
              const existing = incorrectMap.get(question.ID);
              existing.attemptCount += 1;
              existing.improvementCount = improveCount;
              if (new Date(attempt.timestamp) > new Date(existing.lastAttempted)) {
                existing.lastAttempted = attempt.timestamp;
                existing.userAnswer = userAnswer;
              }
            }
          }
        });
      });

      const mistakesList = Array.from(incorrectMap.values());
      
      if (mistakesList.length < 10) {
        alert(`You need at least 10 mistakes to start AI Daily Mission. You currently have ${mistakesList.length}.`);
        setLoadingAIMission(false);
        return;
      }

      // Use AI selection
      const selected = selectAIDailyMission(mistakesList, recentTopics);
      
      // Start quiz directly
      quizStorage.clearQuizData();
      quizStorage.saveSelectedQuestions(selected);
      localStorage.setItem('quiz_mode', 'ai-daily');
      localStorage.setItem('quiz_timer_enabled', 'true');
      localStorage.setItem('quiz_is_timed_mode', 'true');
      navigate('/quiz');
    } catch (error) {
      console.error('Error loading AI Daily Mission:', error);
      alert('Failed to load AI Daily Mission. Please try again.');
      setLoadingAIMission(false);
    }
  }

  async function handleLogout() {
    try { 
      await logout(); 
      navigate('/login'); 
    } catch (e) { 
      console.error(e); 
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen bg-gray-50">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
          <p className="text-slate-700 font-semibold">Personalizing your learning experience...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6 p-4 bg-gradient-to-br from-slate-50 via-white to-slate-50 min-h-screen">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* HEADER */}
        <div className="bg-white rounded-2xl shadow-lg p-8 border-2 border-indigo-100">
          <div className="flex justify-between items-start">
            <div>
              <h1 className="text-4xl font-black text-slate-800 mb-2 leading-tight">
                Welcome back, {currentUser?.displayName}! üéì
              </h1>
              <p className="text-lg text-slate-600 font-medium">{currentUser?.email}</p>
            </div>
            <button
              onClick={() => setShowLogoutConfirm(true)}
              className="flex items-center gap-2 px-4 py-2 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-bold transition-all shadow-md"
            >
              <LogOut size={18} />
              Logout
            </button>
          </div>
        </div>

        {/* ERROR DISPLAY */}
        {error && (
          <div className="bg-red-50 border-2 border-red-200 rounded-xl p-5">
            <div className="flex items-start gap-3">
              <AlertCircle className="text-red-600 flex-shrink-0 mt-1" size={20} />
              <div className="flex-1">
                <h3 className="font-bold text-red-900 mb-1">
                  Error Loading Data
                </h3>
                <p className="text-sm text-red-800 mb-3">{error}</p>
                <button
                  onClick={loadAttempts}
                  className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-all"
                >
                  <RefreshCw size={16} />
                  Retry
                </button>
              </div>
            </div>
          </div>
        )}

        {/* AI DAILY MISSION HERO SECTION */}
        <div className="bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 rounded-2xl shadow-xl p-8 text-white">
          <div className="flex items-center justify-between">
            <div className="flex-1">
              <div className="flex items-center gap-3 mb-3">
                <Sparkles size={32} strokeWidth={3} />
                <h2 className="text-3xl font-black">AI Daily Mission</h2>
                <div className="bg-white/20 rounded-full px-3 py-1 text-sm font-bold">
                  10 Questions
                </div>
              </div>
              <p className="text-purple-100 mb-4 max-w-2xl">
                AI-optimized mistake review using spaced repetition and topic interleaving for maximum retention
              </p>
              <button
                onClick={handleAIDailyMission}
                disabled={loadingAIMission}
                className="px-8 py-4 bg-white text-purple-700 rounded-xl font-black text-lg shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2 hover:scale-105 active:scale-95"
              >
                {loadingAIMission ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-purple-700" />
                    Loading...
                  </>
                ) : (
                  <>
                    <Sparkles size={20} />
                    Start Mission
                  </>
                )}
              </button>
            </div>
            <div className="hidden lg:block">
              <div className="w-48 h-48 bg-white/10 rounded-2xl flex items-center justify-center backdrop-blur">
                <Sparkles size={96} className="text-white/40" />
              </div>
            </div>
          </div>
        </div>

        {/* TWO-COLUMN LAYOUT */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* LEFT COLUMN: 2/3 width - Learning Progress */}
          <div className="lg:col-span-2 space-y-6">
            {/* Mastery Health Bar */}
            <MasteryProgressHub userProfile={userProfile} mistakes={mistakes} />

            {/* Current Goal Widget */}
            <CurrentGoalWidget mistakes={mistakes} />

            {/* Calendar Heatmap */}
            <CalendarHeatmap mistakes={mistakes} />
          </div>

          {/* RIGHT COLUMN: 1/3 width - Quick Actions & Review */}
          <div className="space-y-6">
            {/* Priority Review Section */}
            <PriorityReviewSection 
              mistakes={mistakes} 
              recentTopics={attempts.length > 0 ? attempts[0].topics || [] : []}
            />

            {/* Quick Stats Cards */}
            <div className="bg-white rounded-2xl shadow-lg border-2 border-slate-100 p-6">
              <h3 className="text-lg font-black text-slate-800 mb-4">Quick Stats</h3>
              <div className="space-y-3">
                <div className="flex justify-between items-center p-3 bg-indigo-50 rounded-lg">
                  <span className="text-sm font-bold text-slate-700">Study Streak</span>
                  <span className="text-2xl font-black text-indigo-600">üî•</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                  <span className="text-sm font-bold text-slate-700">Topics Mastered</span>
                  <span className="text-2xl font-black text-green-600">‚úì</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-amber-50 rounded-lg">
                  <span className="text-sm font-bold text-slate-700">In Progress</span>
                  <span className="text-2xl font-black text-amber-600">‚Üí</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* RECENT ATTEMPTS SECTION */}
        <CompactAttemptsList 
          attempts={attempts} 
          onSelectAttempt={setSelectedAttempt}
          loading={loading}
        />

        {/* Attempt Detail Modal */}
        {selectedAttempt && (
          <AttemptDetailModal
            attempt={selectedAttempt}
            onClose={() => setSelectedAttempt(null)}
          />
        )}

        {/* Logout Confirmation Modal */}
        {showLogoutConfirm && (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-in fade-in slide-in-from-bottom duration-200">
              <div className="p-6 border-b border-slate-200">
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 rounded-full bg-rose-100 flex items-center justify-center">
                    <LogOut className="text-rose-600" size={24} />
                  </div>
                  <div>
                    <h3 className="text-xl font-black text-slate-800">
                      Confirm Logout
                    </h3>
                    <p className="text-sm text-slate-500">
                      Are you sure you want to leave?
                    </p>
                  </div>
                </div>
              </div>
              <div className="p-6">
                <p className="text-slate-600 mb-6">
                  You'll need to sign in again to access your dashboard.
                </p>
                <div className="flex gap-3">
                  <button
                    onClick={() => setShowLogoutConfirm(false)}
                    className="flex-1 px-4 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold transition-all"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleLogout}
                    className="flex-1 px-4 py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-bold transition-all flex items-center justify-center gap-2"
                  >
                    <LogOut size={18} />
                    Logout
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ========== src/pages/DebugDashboard.jsx ==========

import React, { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { quizService } from '../services/quizService';
import { collection, getDocs, query, where, orderBy, limit } from 'firebase/firestore';
import { db } from '../firebase/config';
import { CheckCircle, XCircle, AlertCircle, Database, RefreshCw } from 'lucide-react';

export default function DebugDashboard() {
  const { currentUser, userProfile } = useAuth();
  const { t } = useLanguage();
  const [logs, setLogs] = useState([]);
  const [testing, setTesting] = useState(false);
  const [rawData, setRawData] = useState(null);

  const addLog = (type, message) => {
    setLogs(prev => [...prev, { type, message, timestamp: new Date().toLocaleTimeString() }]);
  };

  async function testEverything() {
    setLogs([]);
    setTesting(true);
    
    addLog('info', `üîç ${t('Starting comprehensive diagnostics...')}`);
    
    // Test 1: Check Authentication
    addLog('info', `--- ${t('TEST 1: Authentication')} ---`);
    if (currentUser) {
      addLog('success', `‚úÖ ${t('User authenticated:')} ${currentUser.email}`);
      addLog('info', `${t('User ID:')} ${currentUser.uid}`);
    } else {
      addLog('error', `‚ùå ${t('No user authenticated')}`);
      setTesting(false);
      return;
    }

    // Test 2: Check User Profile
    addLog('info', `--- ${t('TEST 2: User Profile')} ---`);
    if (userProfile) {
      addLog('success', `‚úÖ ${t('Profile loaded')}`);
      addLog('info', `${t('Display Name:')} ${userProfile.displayName}`);
      addLog('info', `${t('Total Attempts:')} ${userProfile.totalAttempts || 0}`);
      addLog('info', `${t('Total Questions:')} ${userProfile.totalQuestions || 0}`);
      addLog('info', `${t('Total Correct:')} ${userProfile.totalCorrect || 0}`);
    } else {
      addLog('error', `‚ùå ${t('Profile not loaded')}`);
    }

    // Test 3: Direct Firestore Read - Users Collection
    addLog('info', `--- ${t('TEST 3: Direct Firestore Read (Users)')} ---`);
    try {
      const { doc, getDoc } = await import('firebase/firestore');
      const userDocRef = doc(db, 'users', currentUser.uid);
      const userDocSnap = await getDoc(userDocRef);
      
      if (userDocSnap.exists()) {
        addLog('success', `‚úÖ ${t('User document exists in Firestore')}`);
        addLog('info', `${t('Data:')} ${JSON.stringify(userDocSnap.data())}`);
      } else {
        addLog('error', `‚ùå ${t('User document does NOT exist in Firestore')}`);
      }
    } catch (error) {
      addLog('error', `‚ùå ${t('Error reading user document:')} ${error.message}`);
    }

    // Test 4: Direct Firestore Read - Attempts Collection
    addLog('info', `--- ${t('TEST 4: Direct Firestore Read (Attempts)')} ---`);
    try {
      const attemptsQuery = query(
        collection(db, 'attempts'),
        where('userId', '==', currentUser.uid),
        orderBy('timestamp', 'desc'),
        limit(10)
      );
      
      const querySnapshot = await getDocs(attemptsQuery);
      addLog('info', `${t('Found')} ${querySnapshot.size} ${t('attempts in Firestore')}`);
      
      if (querySnapshot.size > 0) {
        addLog('success', `‚úÖ ${t('Attempts collection has data')}`);
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          addLog('info', `${t('Attempt')} ${doc.id}: ${data.percentage}% - ${data.timestamp}`);
        });
      } else {
        addLog('warning', `‚ö†Ô∏è ${t('Attempts collection is EMPTY - no quiz results saved yet')}`);
      }

      setRawData({ attempts: querySnapshot.size });
    } catch (error) {
      addLog('error', `‚ùå ${t('Error reading attempts:')} ${error.message}`);
      if (error.code === 'failed-precondition') {
        addLog('error', `‚ùå ${t('FIRESTORE INDEX MISSING! You need to create an index.')}`);
        addLog('info', t('Firebase will show a link in the console to create the index automatically.'));
      }
    }

    // Test 5: Test Save Function
    addLog('info', `--- ${t('TEST 5: Test Save Attempt')} ---`);
    try {
      const testAttemptData = {
        score: 85,
        totalQuestions: 10,
        correctAnswers: 8,
        percentage: 80,
        topics: ['Test Topic'],
        timeSpent: 120000,
        questionTimes: {},
        answers: {}
      };

      addLog('info', t('Attempting to save test quiz result...'));
      const attemptId = await quizService.saveAttempt(currentUser.uid, testAttemptData);
      addLog('success', `‚úÖ ${t('Test attempt saved successfully! ID:')} ${attemptId}`);
    } catch (error) {
      addLog('error', `‚ùå ${t('Failed to save test attempt:')} ${error.message}`);
      addLog('error', `${t('Error code:')} ${error.code}`);
    }

    // Test 6: Test Fetch Function
    addLog('info', `--- ${t('TEST 6: Test Fetch Attempts')} ---`);
    try {
      const attempts = await quizService.getUserAttempts(currentUser.uid, 5);
      addLog('success', `‚úÖ ${t('Successfully fetched')} ${attempts.length} ${t('attempts')}`);
      if (attempts.length > 0) {
        attempts.forEach((att, idx) => {
          addLog('info', `${t('Attempt')} ${idx + 1}: ${att.percentage}% (${att.correctAnswers}/${att.totalQuestions})`);
        });
      }
    } catch (error) {
      addLog('error', `‚ùå ${t('Failed to fetch attempts:')} ${error.message}`);
    }

    // Test 7: Check Leaderboard
    addLog('info', `--- ${t('TEST 7: Test Leaderboard')} ---`);
    try {
      const leaderboard = await quizService.getWeeklyLeaderboard(5);
      addLog('success', `‚úÖ ${t('Leaderboard loaded with')} ${leaderboard.length} ${t('users')}`);
    } catch (error) {
      addLog('error', `‚ùå ${t('Failed to load leaderboard:')} ${error.message}`);
    }

    addLog('info', `‚úÖ ${t('Diagnostics complete!')}`);
    setTesting(false);
  }

  async function createTestAttempt() {
    if (!currentUser) {
      addLog('error', `‚ùå ${t('Must be logged in')}`);
      return;
    }

    addLog('info', t('Creating test quiz attempt...'));
    
    try {
      const testAttemptData = {
        score: Math.floor(Math.random() * 40) + 60,
        totalQuestions: 10,
        correctAnswers: Math.floor(Math.random() * 4) + 6,
        percentage: Math.floor(Math.random() * 40) + 60,
        topics: ['Organic Chemistry', 'Acids and Bases'],
        timeSpent: Math.floor(Math.random() * 300000) + 60000,
        questionTimes: {},
        answers: {}
      };

      const attemptId = await quizService.saveAttempt(currentUser.uid, testAttemptData);
      addLog('success', `‚úÖ ${t('Test attempt created! ID:')} ${attemptId}`);
      addLog('info', t('Now check Dashboard and History pages to see if it appears'));
    } catch (error) {
      addLog('error', `‚ùå ${t('Failed to create test attempt:')} ${error.message}`);
    }
  }

  const getLogIcon = (type) => {
    switch (type) {
      case 'success':
        return <CheckCircle className="text-green-500" size={16} />;
      case 'error':
        return <XCircle className="text-red-500" size={16} />;
      case 'warning':
        return <AlertCircle className="text-amber-500" size={16} />;
      default:
        return <Database className="text-blue-500" size={16} />;
    }
  };

  return (
    <div className="max-w-6xl mx-auto space-y-6">
      <div className="bg-gradient-to-r from-red-600 to-orange-600 rounded-2xl shadow-xl p-6 text-white">
        <h1 className="text-3xl font-black flex items-center gap-3">
          <Database size={32} />
          {t('Firebase Debug Dashboard')}
        </h1>
        <p className="text-orange-100 mt-1">
          {t('Comprehensive diagnostics for data saving issues')}
        </p>
      </div>

      {/* Quick Actions */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button
          onClick={testEverything}
          disabled={testing}
          className="py-6 bg-lab-blue text-white rounded-xl font-bold text-lg shadow-lg hover:bg-blue-800 disabled:bg-slate-300 transition-all flex items-center justify-center gap-2"
        >
          {testing ? (
            <>
              <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
              {t('Running Tests...')}
            </>
          ) : (
            <>
              <RefreshCw size={20} />
              {t('Run Full Diagnostics')}
            </>
          )}
        </button>

        <button
          onClick={createTestAttempt}
          className="py-6 bg-chemistry-green text-white rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all flex items-center justify-center gap-2"
        >
          <Database size={20} />
          {t('Create Test Quiz Attempt')}
        </button>
      </div>

      {/* Console Output */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-slate-800 p-4 border-b">
          <h2 className="text-lg font-bold text-white font-mono flex items-center gap-2">
            <Database size={20} />
            {t('Console Output')}
          </h2>
        </div>

        <div className="p-4 bg-slate-900 max-h-[600px] overflow-y-auto">
          {logs.length === 0 ? (
            <p className="text-slate-500 text-center py-8 font-mono">
              {t('Click "Run Full Diagnostics" to start testing...')}
            </p>
          ) : (
            <div className="space-y-2 font-mono text-sm">
              {logs.map((log, idx) => (
                <div
                  key={idx}
                  className={`flex items-start gap-3 p-2 rounded ${
                    log.type === 'error' ? 'bg-red-900/20' :
                    log.type === 'success' ? 'bg-green-900/20' :
                    log.type === 'warning' ? 'bg-amber-900/20' :
                    'bg-slate-800'
                  }`}
                >
                  {getLogIcon(log.type)}
                  <span className="text-slate-400 text-xs">[{log.timestamp}]</span>
                  <span className={
                    log.type === 'error' ? 'text-red-400' :
                    log.type === 'success' ? 'text-green-400' :
                    log.type === 'warning' ? 'text-amber-400' :
                    'text-blue-400'
                  }>
                    {log.message}
                  </span>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Instructions */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
          <h3 className="font-bold text-blue-900 mb-2 flex items-center gap-2">
            <CheckCircle size={18} />
            {t('What Success Looks Like')}
          </h3>
          <ul className="text-sm text-blue-800 space-y-1">
            <li>‚úÖ {t('User authenticated')}</li>
            <li>‚úÖ {t('Profile loaded')}</li>
            <li>‚úÖ {t('User document exists')}</li>
            <li>‚úÖ {t('Can read attempts collection')}</li>
            <li>‚úÖ {t('Can save test attempt')}</li>
            <li>‚úÖ {t('Can fetch attempts')}</li>
            <li>‚úÖ {t('Leaderboard loads')}</li>
          </ul>
        </div>

        <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4">
          <h3 className="font-bold text-red-900 mb-2 flex items-center gap-2">
            <XCircle size={18} />
            {t('Common Errors & Fixes')}
          </h3>
          <ul className="text-sm text-red-800 space-y-2">
            <li><strong>{t('Permission denied:')}</strong> {t('Update Firestore rules')}</li>
            <li><strong>{t('Failed precondition:')}</strong> {t('Missing Firestore index')}</li>
            <li><strong>{t('Not authenticated:')}</strong> {t('Log in first')}</li>
            <li><strong>{t('Empty attempts:')}</strong> {t('Complete a quiz first')}</li>
          </ul>
        </div>
      </div>

      {/* Firestore Rules Reminder */}
      <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4">
        <h3 className="font-bold text-amber-900 mb-2">
          üìã {t('Required Firestore Rules')}
        </h3>
        <pre className="bg-slate-900 text-green-400 p-4 rounded-lg overflow-x-auto text-xs">
{`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /attempts/{attemptId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}`}
        </pre>
        <p className="text-sm text-amber-800 mt-2">
          {t('Copy this to Firebase Console ‚Üí Firestore Database ‚Üí Rules tab ‚Üí Publish')}
        </p>
      </div>
    </div>
  );
}

// ========== src/pages/FirebaseTestPage.jsx ==========

import React, { useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { quizService } from '../services/quizService';
import { CheckCircle, XCircle, AlertCircle } from 'lucide-react';

export default function FirebaseTestPage() {
  const { currentUser, userProfile } = useAuth();
  const [testResults, setTestResults] = useState({});
  const [testing, setTesting] = useState(false);

  async function runTests() {
    setTesting(true);
    const results = {};

    // Test 1: Check if user is authenticated
    results.auth = {
      status: currentUser ? 'success' : 'error',
      message: currentUser 
        ? `‚úÖ Authenticated as ${currentUser.email}` 
        : '‚ùå Not authenticated'
    };

    // Test 2: Check if user profile exists
    results.profile = {
      status: userProfile ? 'success' : 'error',
      message: userProfile 
        ? `‚úÖ Profile loaded (${userProfile.totalAttempts} attempts)` 
        : '‚ùå Profile not found'
    };

    // Test 3: Try to save a test attempt
    if (currentUser) {
      try {
        const testAttempt = {
          score: 75,
          totalQuestions: 10,
          correctAnswers: 7,
          percentage: 70,
          topics: ['Test Topic'],
          timeSpent: 120000,
          questionTimes: {},
          answers: {}
        };

        const attemptId = await quizService.saveAttempt(currentUser.uid, testAttempt);
        results.saveAttempt = {
          status: 'success',
          message: `‚úÖ Test attempt saved! ID: ${attemptId}`
        };
      } catch (error) {
        results.saveAttempt = {
          status: 'error',
          message: `‚ùå Failed to save attempt: ${error.message}`
        };
      }
    } else {
      results.saveAttempt = {
        status: 'warning',
        message: '‚ö†Ô∏è Skipped - not authenticated'
      };
    }

    // Test 4: Try to fetch user attempts
    if (currentUser) {
      try {
        const attempts = await quizService.getUserAttempts(currentUser.uid, 5);
        results.fetchAttempts = {
          status: 'success',
          message: `‚úÖ Fetched ${attempts.length} attempts`
        };
      } catch (error) {
        results.fetchAttempts = {
          status: 'error',
          message: `‚ùå Failed to fetch attempts: ${error.message}`
        };
      }
    } else {
      results.fetchAttempts = {
        status: 'warning',
        message: '‚ö†Ô∏è Skipped - not authenticated'
      };
    }

    // Test 5: Check leaderboard
    try {
      const leaderboard = await quizService.getWeeklyLeaderboard(5);
      results.leaderboard = {
        status: 'success',
        message: `‚úÖ Leaderboard loaded (${leaderboard.length} users)`
      };
    } catch (error) {
      results.leaderboard = {
        status: 'error',
        message: `‚ùå Failed to load leaderboard: ${error.message}`
      };
    }

    setTestResults(results);
    setTesting(false);
  }

  const getIcon = (status) => {
    switch (status) {
      case 'success':
        return <CheckCircle className="text-green-500" size={24} />;
      case 'error':
        return <XCircle className="text-red-500" size={24} />;
      case 'warning':
        return <AlertCircle className="text-amber-500" size={24} />;
      default:
        return null;
    }
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div className="bg-gradient-to-r from-purple-600 to-blue-600 rounded-2xl shadow-xl p-6 text-white">
        <h1 className="text-3xl font-black">Firebase Connection Test</h1>
        <p className="text-purple-100 mt-1">
          Diagnose data saving issues
        </p>
      </div>

      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="p-6">
          <button
            onClick={runTests}
            disabled={testing}
            className="w-full py-4 bg-lab-blue text-white rounded-xl font-bold text-lg shadow-lg hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2"
          >
            {testing ? (
              <>
                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                Running Tests...
              </>
            ) : (
              'Run Firebase Tests'
            )}
          </button>
        </div>

        {Object.keys(testResults).length > 0 && (
          <div className="border-t border-slate-200 p-6 space-y-4">
            <h2 className="text-xl font-bold text-slate-800 mb-4">Test Results</h2>
            
            {Object.entries(testResults).map(([test, result]) => (
              <div
                key={test}
                className="flex items-start gap-4 p-4 rounded-lg border-2 border-slate-100"
              >
                {getIcon(result.status)}
                <div className="flex-1">
                  <div className="font-bold text-slate-800 capitalize mb-1">
                    {test.replace(/([A-Z])/g, ' $1').trim()}
                  </div>
                  <div className="text-sm text-slate-600">
                    {result.message}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
        <h3 className="font-bold text-blue-900 mb-2">üí° How to interpret results:</h3>
        <ul className="text-sm text-blue-800 space-y-1">
          <li><strong>Auth:</strong> Should show your email if logged in</li>
          <li><strong>Profile:</strong> Should load your user data from Firestore</li>
          <li><strong>Save Attempt:</strong> Should successfully save a test quiz result</li>
          <li><strong>Fetch Attempts:</strong> Should retrieve your quiz history</li>
          <li><strong>Leaderboard:</strong> Should load ranking data</li>
        </ul>
      </div>

      <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4">
        <h3 className="font-bold text-red-900 mb-2">üîß Common Issues:</h3>
        <ul className="text-sm text-red-800 space-y-2">
          <li>
            <strong>‚ùå Not authenticated:</strong> Make sure you're logged in
          </li>
          <li>
            <strong>‚ùå Failed to save/fetch:</strong> Check Firebase Firestore rules
          </li>
          <li>
            <strong>‚ùå Permission denied:</strong> Update Firestore security rules to allow read/write
          </li>
        </ul>
      </div>

      <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4">
        <h3 className="font-bold text-amber-900 mb-2">üìã Recommended Firestore Rules:</h3>
        <pre className="bg-slate-900 text-green-400 p-4 rounded-lg overflow-x-auto text-xs">
{`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Attempts collection
    match /attempts/{attemptId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}`}
        </pre>
      </div>
    </div>
  );
}

// ========== src/pages/ForumPage.jsx ==========

import React, { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { useQuizData } from '../hooks/useQuizData';
import { forumService, canEditComment, editTimeRemaining } from '../services/forumService';
import {
  MessageSquare, ArrowLeft, Search, TrendingUp, Clock, MessageCircle,
  PlusCircle, X, Send, Edit2, Trash2, ThumbsUp, Bell, BellDot,
  Lock, Tag, Pin, ChevronLeft, AlertCircle
} from 'lucide-react';
import QuestionForum from '../components/QuestionForum';

const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTK36yaUN-NMCkQNT-DAHgc6FMZPjUc0Yv3nYEK4TA9W2qE9V1TqVD10Tq98-wXQoAvKOZlwGWRSDkU/pub?gid=1182550140&single=true&output=csv';

const CATEGORIES = ['general', 'question', 'announcement'];

// ‚îÄ‚îÄ Notification Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function NotificationPanel({ userId, onClose }) {
  const { t } = useLanguage();
  const [notifs, setNotifs] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    setLoading(true);
    const unsub = forumService.subscribeToNotifications(userId, (data) => {
      setNotifs(data);
      setLoading(false);
    });
    return () => unsub && unsub();
  }, [userId]);

  const handleMarkAllRead = async () => {
    await forumService.markAllNotificationsRead(userId);
  };

  const handleMarkRead = async (id) => {
    await forumService.markNotificationRead(id);
  };

  const typeLabel = (n) => {
    switch (n.type) {
      case 'like': return t('forum.likedYourComment');
      case 'reply': return t('forum.repliedToPost');
      case 'post_like': return t('forum.likedYourPost');
      case 'reply_like': return t('forum.likedYourReply');
      default: return 'interacted with your content';
    }
  };

  const formatAgo = (iso) => {
    const diffMs = Date.now() - new Date(iso).getTime();
    const mins = Math.floor(diffMs / 60000);
    if (mins < 1) return t('forum.justNow');
    if (mins < 60) return `${mins}m`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h`;
    return `${Math.floor(hrs / 24)}d`;
  };

  const unread = notifs.filter(n => !n.read).length;

  return (
    <div className="absolute right-0 top-12 w-80 bg-white rounded-2xl shadow-2xl border-2 border-slate-200 z-50 overflow-hidden max-h-[480px] flex flex-col">
      <div className="p-4 border-b flex items-center justify-between bg-slate-50">
        <h3 className="font-bold text-slate-800 flex items-center gap-2">
          <Bell size={18} />
          {t('forum.notifications')}
          {unread > 0 && <span className="bg-red-500 text-white text-xs rounded-full px-2 py-0.5">{unread}</span>}
        </h3>
        <div className="flex items-center gap-2">
          {unread > 0 && (
            <button onClick={handleMarkAllRead} className="text-xs text-lab-blue hover:underline font-semibold">
              {t('forum.markAllRead')}
            </button>
          )}
          <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded"><X size={16} /></button>
        </div>
      </div>

      <div className="overflow-y-auto flex-1">
        {loading ? (
          <div className="flex justify-center py-8"><div className="animate-spin rounded-full h-6 w-6 border-b-2 border-lab-blue" /></div>
        ) : notifs.length === 0 ? (
          <div className="text-center py-10 text-slate-400 text-sm">{t('forum.noNotificationsYet')}</div>
        ) : (
          notifs.map(n => (
            <div key={n.id} onClick={() => handleMarkRead(n.id)}
              className={`p-4 border-b cursor-pointer hover:bg-slate-50 transition-all ${!n.read ? 'bg-blue-50' : ''}`}>
              <div className="flex items-start gap-3">
                <div className={`w-2 h-2 rounded-full mt-2 flex-shrink-0 ${!n.read ? 'bg-lab-blue' : 'bg-transparent'}`} />
                <div className="flex-1 min-w-0">
                  <p className="text-sm text-slate-800 font-medium leading-snug">
                    <span className="font-bold">Someone</span> {typeLabel(n)}
                  </p>
                  {n.previewText && (
                    <p className="text-xs text-slate-500 mt-1 truncate">"{n.previewText}"</p>
                  )}
                  {n.postTitle && (
                    <p className="text-xs text-lab-blue mt-0.5 truncate">‚Üí {n.postTitle}</p>
                  )}
                  <p className="text-xs text-slate-400 mt-1">{formatAgo(n.createdAt)}</p>
                </div>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ General Forum Post Detail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function PostDetail({ postId, currentUser, onBack }) {
  const { t } = useLanguage();
  const [post, setPost] = useState(null);
  const [replies, setReplies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [newReply, setNewReply] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [editingId, setEditingId] = useState(null); // 'post' | reply id
  const [editText, setEditText] = useState('');
  const [editTitle, setEditTitle] = useState('');
  const [, forceUpdate] = useState(0);

  useEffect(() => { loadAll(); }, [postId]);
  useEffect(() => {
    const i = setInterval(() => forceUpdate(n => n + 1), 10000);
    return () => clearInterval(i);
  }, []);

  async function loadAll() {
    setLoading(true);
    try {
      const [p, r] = await Promise.all([forumService.getPost(postId), forumService.getReplies(postId)]);
      setPost(p); setReplies(r);
    } catch { /* post may have been deleted */ }
    setLoading(false);
  }

  async function handleReply() {
    if (!newReply.trim() || !currentUser) return;
    setSubmitting(true);
    try {
      await forumService.addReply(postId, currentUser.uid, currentUser.displayName || 'Anonymous', newReply.trim());
      setNewReply(''); await loadAll();
    } catch (e) { alert(e.message); }
    setSubmitting(false);
  }

  async function handleEditPost() {
    try {
      await forumService.updatePost(postId, currentUser.uid, editText, editTitle || undefined);
      setEditingId(null); await loadAll();
    } catch (e) {
      if (e.message === 'EDIT_EXPIRED') alert(t('forum.editExpired'));
      else alert(e.message);
    }
  }

  async function handleDeletePost() {
    if (!window.confirm(t('forum.deletePost'))) return;
    await forumService.deletePost(postId);
    onBack();
  }

  async function handleEditReply(replyId) {
    try {
      await forumService.updateReply(replyId, editText);
      setEditingId(null); await loadAll();
    } catch (e) {
      if (e.message === 'EDIT_EXPIRED') alert(t('forum.editExpired'));
      else alert(e.message);
    }
  }

  async function handleDeleteReply(replyId) {
    if (!window.confirm(t('forum.deleteReply'))) return;
    await forumService.deleteReply(replyId); await loadAll();
  }

  async function handleLikePost() {
    if (!currentUser) return;
    await forumService.togglePostLike(postId, currentUser.uid); await loadAll();
  }

  async function handleLikeReply(replyId) {
    if (!currentUser) return;
    await forumService.toggleReplyLike(replyId, currentUser.uid); await loadAll();
  }

  const formatDate = (iso) => {
    const d = new Date(iso), now = new Date();
    const mins = Math.floor((now - d) / 60000);
    if (mins < 1) return t('forum.justNow');
    if (mins < 60) return `${mins} min ago`;
    if (mins < 1440) return `${Math.floor(mins / 60)} hr ago`;
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  };

  const categoryColor = { general: 'bg-blue-100 text-blue-700', question: 'bg-amber-100 text-amber-700', announcement: 'bg-purple-100 text-purple-700' };

  if (loading) return <div className="flex justify-center py-16"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-lab-blue" /></div>;
  if (!post) return <div className="text-center py-12 text-slate-400">Post not found.</div>;

  return (
    <div className="space-y-4">
      <button onClick={onBack} className="flex items-center gap-2 text-sm font-bold text-slate-600 hover:text-lab-blue transition-colors">
        <ChevronLeft size={18} /> {t('forum.backToForum')}
      </button>

      {/* Post */}
      <div className="bg-white rounded-2xl shadow-lg border-2 border-slate-200 overflow-hidden">
        <div className="p-6">
          <div className="flex items-start justify-between gap-4 mb-4">
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-2">
                <span className={`text-xs font-bold px-2 py-1 rounded-full ${categoryColor[post.category] || categoryColor.general}`}>
                  {post.category?.toUpperCase()}
                </span>
                {post.edited && <span className="text-xs text-slate-400 italic">({t('forum.edited')})</span>}
              </div>
              {editingId === 'post' ? (
                <div className="space-y-2">
                  <input value={editTitle} onChange={e => setEditTitle(e.target.value)}
                    className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue font-bold text-lg" />
                  <textarea value={editText} onChange={e => setEditText(e.target.value)} rows="4"
                    className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue resize-none" />
                  <div className="flex gap-2">
                    <button onClick={handleEditPost} className="px-4 py-2 bg-lab-blue text-white rounded-lg font-bold text-sm">{t('forum.save')}</button>
                    <button onClick={() => setEditingId(null)} className="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold text-sm">{t('forum.cancel')}</button>
                  </div>
                </div>
              ) : (
                <>
                  <h2 className="text-2xl font-black text-slate-800 mb-3">{post.title}</h2>
                  <p className="text-slate-700 leading-relaxed whitespace-pre-wrap">{post.content}</p>
                </>
              )}
            </div>
            {currentUser && post.userId === currentUser.uid && editingId !== 'post' && (
              <div className="flex items-center gap-1 flex-shrink-0">
                {canEditComment(post.createdAt) ? (
                  <button onClick={() => { setEditingId('post'); setEditText(post.content); setEditTitle(post.title); }}
                    className="p-2 hover:bg-blue-100 rounded-lg transition-all"><Edit2 size={16} className="text-lab-blue" /></button>
                ) : (
                  <button disabled className="p-2 opacity-30 cursor-not-allowed rounded-lg"><Lock size={16} className="text-slate-400" /></button>
                )}
                <button onClick={handleDeletePost} className="p-2 hover:bg-red-100 rounded-lg transition-all"><Trash2 size={16} className="text-red-500" /></button>
              </div>
            )}
          </div>
          <div className="flex items-center justify-between pt-4 border-t border-slate-200">
            <div className="flex items-center gap-3 text-sm text-slate-500">
              <div className="w-7 h-7 rounded-full bg-slate-300 flex items-center justify-center text-xs font-bold text-slate-700">
                {post.userDisplayName?.charAt(0).toUpperCase() || 'U'}
              </div>
              <span className="font-semibold">{post.userDisplayName}</span>
              <span>¬∑</span>
              <span>{formatDate(post.createdAt)}</span>
            </div>
            <button onClick={handleLikePost} disabled={!currentUser}
              className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${post.likedBy?.includes(currentUser?.uid) ? 'bg-blue-100 text-lab-blue' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
              <ThumbsUp size={14} fill={post.likedBy?.includes(currentUser?.uid) ? 'currentColor' : 'none'} />
              {post.likes || 0}
            </button>
          </div>
        </div>
      </div>

      {/* Replies */}
      <div className="space-y-3">
        <h3 className="font-bold text-slate-700">{replies.length} {t('forum.replies')}</h3>
        {replies.map(reply => {
          const isOwner = currentUser && reply.userId === currentUser.uid;
          return (
            <div key={reply.id} className="bg-white rounded-xl border-2 border-slate-200 p-4">
              <div className="flex items-start justify-between gap-3 mb-2">
                <div className="flex items-center gap-2">
                  <div className="w-7 h-7 rounded-full bg-lab-blue flex items-center justify-center text-white text-xs font-bold">
                    {reply.userDisplayName?.charAt(0).toUpperCase() || 'U'}
                  </div>
                  <div>
                    <span className="font-bold text-slate-800 text-sm">{reply.userDisplayName}</span>
                    <span className="text-xs text-slate-400 ml-2">{formatDate(reply.createdAt)}</span>
                    {reply.edited && <span className="text-xs text-slate-400 italic ml-1">({t('forum.edited')})</span>}
                  </div>
                </div>
                {isOwner && (
                  <div className="flex items-center gap-1">
                    {canEditComment(reply.createdAt) ? (
                      <button onClick={() => { setEditingId(reply.id); setEditText(reply.text); }}
                        className="p-1.5 hover:bg-blue-100 rounded-lg"><Edit2 size={14} className="text-lab-blue" /></button>
                    ) : (
                      <button disabled className="p-1.5 opacity-30 cursor-not-allowed rounded-lg"><Lock size={14} className="text-slate-400" /></button>
                    )}
                    <button onClick={() => handleDeleteReply(reply.id)} className="p-1.5 hover:bg-red-100 rounded-lg"><Trash2 size={14} className="text-red-500" /></button>
                  </div>
                )}
              </div>
              {editingId === reply.id ? (
                <div className="space-y-2">
                  <textarea value={editText} onChange={e => setEditText(e.target.value)} rows="3"
                    className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue resize-none text-sm" />
                  <div className="flex gap-2">
                    <button onClick={() => handleEditReply(reply.id)} className="px-3 py-1.5 bg-lab-blue text-white rounded-lg font-bold text-xs">{t('forum.save')}</button>
                    <button onClick={() => setEditingId(null)} className="px-3 py-1.5 bg-slate-200 text-slate-700 rounded-lg font-bold text-xs">{t('forum.cancel')}</button>
                  </div>
                </div>
              ) : (
                <div className="flex items-start justify-between gap-4">
                  <p className="text-slate-700 text-sm leading-relaxed whitespace-pre-wrap flex-1">{reply.text}</p>
                  <button onClick={() => handleLikeReply(reply.id)} disabled={!currentUser}
                    className={`flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold transition-all flex-shrink-0 ${reply.likedBy?.includes(currentUser?.uid) ? 'bg-blue-100 text-lab-blue' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                    <ThumbsUp size={12} fill={reply.likedBy?.includes(currentUser?.uid) ? 'currentColor' : 'none'} />
                    {reply.likes || 0}
                  </button>
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* Reply Input */}
      {currentUser ? (
        <div className="bg-white rounded-xl border-2 border-slate-200 p-4">
          <div className="flex gap-3">
            <div className="w-8 h-8 rounded-full bg-lab-blue flex items-center justify-center flex-shrink-0">
              <span className="text-white font-bold text-xs">{currentUser.displayName?.charAt(0).toUpperCase() || 'U'}</span>
            </div>
            <div className="flex-1">
              <textarea value={newReply} onChange={e => setNewReply(e.target.value)} rows="3"
                placeholder={t('forum.writeReply')}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue resize-none text-sm" />
              <div className="flex justify-end mt-2">
                <button onClick={handleReply} disabled={!newReply.trim() || submitting}
                  className="flex items-center gap-2 px-4 py-2 bg-lab-blue text-white rounded-lg font-bold text-sm hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all">
                  {submitting ? <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-white" /> : <Send size={14} />}
                  {t('forum.reply')}
                </button>
              </div>
            </div>
          </div>
        </div>
      ) : (
        <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 text-sm font-semibold text-amber-800">
          {t('forum.pleaseLoginReply')}
        </div>
      )}
    </div>
  );
}

// ‚îÄ‚îÄ New Post Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function NewPostModal({ currentUser, onClose, onCreated }) {
  const { t } = useLanguage();
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [category, setCategory] = useState('general');
  const [submitting, setSubmitting] = useState(false);

  const handleSubmit = async () => {
    if (!title.trim() || !content.trim()) return;
    setSubmitting(true);
    try {
      await forumService.createPost(currentUser.uid, currentUser.displayName || 'Anonymous', { title, content, category });
      onCreated();
    } catch (e) { alert(e.message); }
    setSubmitting(false);
  };

  const catColors = { general: 'border-blue-400 bg-blue-50 text-blue-700', question: 'border-amber-400 bg-amber-50 text-amber-700', announcement: 'border-purple-400 bg-purple-50 text-purple-700' };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl">
        <div className="p-6 border-b flex items-center justify-between">
          <h2 className="text-xl font-black text-slate-800">{t('forum.createNewPost')}</h2>
          <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg"><X size={20} /></button>
        </div>
        <div className="p-6 space-y-4">
          <div>
            <label className="block text-sm font-bold text-slate-600 mb-2">{t('forum.category')}</label>
            <div className="flex gap-2">
              {CATEGORIES.map(cat => (
                <button key={cat} onClick={() => setCategory(cat)}
                  className={`px-3 py-1.5 rounded-full text-xs font-bold border-2 transition-all ${category === cat ? catColors[cat] : 'border-slate-200 text-slate-500 hover:border-slate-300'}`}>
                  {cat.charAt(0).toUpperCase() + cat.slice(1)}
                </button>
              ))}
            </div>
          </div>
          <div>
            <label className="block text-sm font-bold text-slate-600 mb-2">{t('forum.title2')}</label>
            <input value={title} onChange={e => setTitle(e.target.value)} maxLength={120}
              placeholder={t('forum.enterClearTitle')}
              className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue font-semibold" />
          </div>
          <div>
            <label className="block text-sm font-bold text-slate-600 mb-2">{t('forum.content')}</label>
            <textarea value={content} onChange={e => setContent(e.target.value)} rows="6"
              placeholder={t('forum.shareThoughts')}
              className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue resize-none" />
          </div>
        </div>
        <div className="p-6 border-t flex gap-3 justify-end">
          <button onClick={onClose} className="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition-all">
            {t('forum.cancel')}
          </button>
          <button onClick={handleSubmit} disabled={!title.trim() || !content.trim() || submitting}
            className="flex items-center gap-2 px-6 py-2 bg-lab-blue text-white rounded-lg font-bold hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all">
            {submitting ? <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white" /> : <Send size={16} />}
            {t('forum.post')}
          </button>
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ Main ForumPage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export default function ForumPage() {
  const navigate = useNavigate();
  const { currentUser } = useAuth();
  const { t } = useLanguage();
  const { questions, loading: questionsLoading } = useQuizData(SHEET_URL);

  const [activeTab, setActiveTab] = useState('mcq'); // 'mcq' | 'general'
  const [showNotifPanel, setShowNotifPanel] = useState(false);
  const [unreadCount, setUnreadCount] = useState(0);

  // MCQ tab state
  const [discussedQuestions, setDiscussedQuestions] = useState([]);
  const [mcqLoading, setMcqLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [sortBy, setSortBy] = useState('recent');
  const [selectedQuestion, setSelectedQuestion] = useState(null);

  // General tab state
  const [posts, setPosts] = useState([]);
  const [postsLoading, setPostsLoading] = useState(false);
  const [activePost, setActivePost] = useState(null); // postId
  const [showNewPost, setShowNewPost] = useState(false);
  const [postSearch, setPostSearch] = useState('');
  const [postCategory, setPostCategory] = useState('all');

  // Subscribe to notifications
  useEffect(() => {
    if (!currentUser) return;
    const unsub = forumService.subscribeToNotifications(currentUser.uid, (notifs) => {
      setUnreadCount(notifs.filter(n => !n.read).length);
    });
    return () => unsub && unsub();
  }, [currentUser]);

  useEffect(() => { loadDiscussedQuestions(); }, []);
  useEffect(() => { if (activeTab === 'general') loadPosts(); }, [activeTab]);

  async function loadDiscussedQuestions() {
    setMcqLoading(true);
    try {
      const discussed = await forumService.getQuestionsWithComments();
      setDiscussedQuestions(discussed);
    } catch { /* ignore */ }
    setMcqLoading(false);
  }

  async function loadPosts() {
    setPostsLoading(true);
    try {
      const data = await forumService.getPosts({ limit: 50 });
      setPosts(data);
    } catch { /* ignore */ }
    setPostsLoading(false);
  }

  const getQuestionDetails = (questionId) => questions.find(q => q.ID === questionId);

  const filteredMcqQuestions = discussedQuestions
    .filter(dq => {
      const qd = getQuestionDetails(dq.questionId);
      if (!qd) return false;
      if (!searchTerm) return true;
      const s = searchTerm.toLowerCase();
      return qd.Question?.toLowerCase().includes(s) || qd.Topic?.toLowerCase().includes(s) || qd.DSEcode?.toLowerCase().includes(s);
    })
    .sort((a, b) => sortBy === 'recent' ? new Date(b.lastActivity) - new Date(a.lastActivity) : b.commentCount - a.commentCount);

  const filteredPosts = posts
    .filter(p => {
      if (postCategory !== 'all' && p.category !== postCategory) return false;
      if (!postSearch) return true;
      return p.title?.toLowerCase().includes(postSearch.toLowerCase()) || p.content?.toLowerCase().includes(postSearch.toLowerCase());
    });

  const formatDate = (iso) => {
    const d = new Date(iso), now = new Date(), diffMs = now - d;
    const mins = Math.floor(diffMs / 60000);
    if (mins < 1) return t('forum.justNow');
    if (mins < 60) return `${mins} min ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs} hr ago`;
    const days = Math.floor(hrs / 24);
    if (days < 7) return `${days} days ago`;
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  };

  const catColors = { general: 'bg-blue-100 text-blue-700', question: 'bg-amber-100 text-amber-700', announcement: 'bg-purple-100 text-purple-700' };

  if (activePost) {
    return (
      <div className="max-w-4xl mx-auto space-y-6">
        <PostDetail postId={activePost} currentUser={currentUser}
          onBack={() => { setActivePost(null); loadPosts(); }} />
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button onClick={() => navigate('/dashboard')} className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all">
          <ArrowLeft size={20} />
        </button>
        <div className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-6 text-white">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <MessageSquare size={32} />
            {t('forum.title')}
          </h1>
          <p className="text-purple-100 mt-1">{t('forum.connectDiscuss')}</p>
        </div>
        {/* Notification Bell */}
        {currentUser && (
          <div className="relative">
            <button onClick={() => setShowNotifPanel(v => !v)}
              className="relative p-3 bg-white rounded-xl border-2 border-slate-200 hover:border-purple-400 transition-all shadow-sm">
              {unreadCount > 0 ? <BellDot size={22} className="text-purple-600" /> : <Bell size={22} className="text-slate-600" />}
              {unreadCount > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                  {unreadCount > 9 ? '9+' : unreadCount}
                </span>
              )}
            </button>
            {showNotifPanel && (
              <NotificationPanel userId={currentUser.uid} onClose={() => setShowNotifPanel(false)} />
            )}
          </div>
        )}
      </div>

      {/* Tabs */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="flex border-b">
          <button onClick={() => setActiveTab('mcq')}
            className={`flex-1 px-6 py-4 font-bold text-base transition-all flex items-center justify-center gap-2 ${activeTab === 'mcq' ? 'bg-lab-blue text-white' : 'text-slate-600 hover:bg-slate-50'}`}>
            <MessageCircle size={18} />
            {t('forum.mcqDiscussion')}
          </button>
          <button onClick={() => setActiveTab('general')}
            className={`flex-1 px-6 py-4 font-bold text-base transition-all flex items-center justify-center gap-2 ${activeTab === 'general' ? 'bg-purple-600 text-white' : 'text-slate-600 hover:bg-slate-50'}`}>
            <MessageSquare size={18} />
            {t('forum.generalForum')}
          </button>
        </div>

        {/* ‚îÄ‚îÄ MCQ Tab ‚îÄ‚îÄ */}
        {activeTab === 'mcq' && (
          <div className="p-6 space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
                <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                  placeholder={t('forum.searchQuestions')}
                  className="w-full pl-11 pr-4 py-3 border-2 border-slate-200 rounded-lg focus:border-lab-blue outline-none transition-all" />
              </div>
              <div className="flex gap-2">
                {[['recent', <Clock size={16} />, t('forum.recent')], ['popular', <TrendingUp size={16} />, t('forum.popular')]].map(([val, icon, label]) => (
                  <button key={val} onClick={() => setSortBy(val)}
                    className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-bold transition-all ${sortBy === val ? 'bg-lab-blue text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                    {icon}{label}
                  </button>
                ))}
              </div>
            </div>
            <p className="text-sm text-slate-600"><span className="font-bold text-lab-blue">{filteredMcqQuestions.length}</span> {t('forum.questionsWithDiscussions')}</p>

            {mcqLoading || questionsLoading ? (
              <div className="flex justify-center py-12"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-lab-blue" /></div>
            ) : filteredMcqQuestions.length === 0 ? (
              <div className="text-center py-12">
                <MessageSquare className="w-14 h-14 text-slate-300 mx-auto mb-3" />
                <p className="text-slate-400">{searchTerm ? t('forum.noResultsFound') : t('forum.noMcqDiscussions')}</p>
              </div>
            ) : (
              <div className="space-y-3">
                {filteredMcqQuestions.map(dq => {
                  const qd = getQuestionDetails(dq.questionId);
                  if (!qd) return null;
                  return (
                    <div key={dq.questionId} onClick={() => setSelectedQuestion(qd)}
                      className="p-4 rounded-xl border-2 border-slate-100 hover:border-purple-200 hover:bg-purple-50 transition-all cursor-pointer">
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-2">
                            <span className="bg-blue-100 text-lab-blue px-2 py-1 rounded text-xs font-bold">{qd.Topic}</span>
                            {qd.DSEcode && <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">{qd.DSEcode}</span>}
                          </div>
                          <div className="text-slate-700 font-medium mb-2 line-clamp-2"
                            dangerouslySetInnerHTML={{ __html: qd.Question.substring(0, 150) + '...' }} />
                          <div className="flex items-center gap-4 text-sm text-slate-500">
                            <div className="flex items-center gap-1"><MessageCircle size={14} /><span className="font-semibold">{dq.commentCount}</span><span>{t('forum.comments')}</span></div>
                            <div className="flex items-center gap-1"><Clock size={14} /><span>{formatDate(dq.lastActivity)}</span></div>
                          </div>
                        </div>
                        <div className="flex-shrink-0 w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                          <span className="text-lg font-black text-purple-600">{dq.commentCount}</span>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}

        {/* ‚îÄ‚îÄ General Forum Tab ‚îÄ‚îÄ */}
        {activeTab === 'general' && (
          <div className="p-6 space-y-4">
            <div className="flex flex-col md:flex-row gap-4 items-start md:items-center">
              <div className="relative flex-1">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                <input type="text" value={postSearch} onChange={e => setPostSearch(e.target.value)}
                  placeholder={t('forum.searchPosts')}
                  className="w-full pl-10 pr-4 py-2.5 border-2 border-slate-200 rounded-lg focus:border-purple-400 outline-none" />
              </div>
              {/* Category filter */}
              <div className="flex gap-2">
                {['all', ...CATEGORIES].map(cat => (
                  <button key={cat} onClick={() => setPostCategory(cat)}
                    className={`px-3 py-2 rounded-lg text-xs font-bold border-2 transition-all ${postCategory === cat ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                    {cat === 'all' ? t('forum.all') : cat.charAt(0).toUpperCase() + cat.slice(1)}
                  </button>
                ))}
              </div>
              {currentUser && (
                <button onClick={() => setShowNewPost(true)}
                  className="flex items-center gap-2 px-5 py-2.5 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-all shadow-md whitespace-nowrap">
                  <PlusCircle size={18} />
                  {t('forum.newPost')}
                </button>
              )}
            </div>

            {postsLoading ? (
              <div className="flex justify-center py-12"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600" /></div>
            ) : filteredPosts.length === 0 ? (
              <div className="text-center py-12">
                <MessageSquare className="w-14 h-14 text-slate-300 mx-auto mb-3" />
                <p className="text-slate-400 mb-3">{t('forum.noPosts')}</p>
                {currentUser && (
                  <button onClick={() => setShowNewPost(true)} className="px-5 py-2 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-all">
                    {t('forum.createPost')}
                  </button>
                )}
              </div>
            ) : (
              <div className="space-y-3">
                {filteredPosts.map(post => (
                  <div key={post.id} onClick={() => setActivePost(post.id)}
                    className="p-4 rounded-xl border-2 border-slate-100 hover:border-purple-200 hover:bg-purple-50 transition-all cursor-pointer">
                    <div className="flex items-start gap-4">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1.5">
                          <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${catColors[post.category] || catColors.general}`}>
                            {post.category?.toUpperCase()}
                          </span>
                          {post.edited && <span className="text-xs text-slate-400 italic">({t('forum.edited')})</span>}
                        </div>
                        <h3 className="font-bold text-slate-800 text-base mb-1 line-clamp-1">{post.title}</h3>
                        <p className="text-sm text-slate-600 line-clamp-2">{post.content}</p>
                        <div className="flex items-center gap-4 mt-2 text-xs text-slate-500">
                          <span className="font-semibold">{post.userDisplayName}</span>
                          <span>{formatDate(post.createdAt)}</span>
                          <span className="flex items-center gap-1"><MessageCircle size={12} />{post.replyCount || 0}</span>
                          <span className="flex items-center gap-1"><ThumbsUp size={12} />{post.likes || 0}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </div>

      {/* MCQ Forum Modal */}
      {selectedQuestion && (
        <QuestionForum question={selectedQuestion}
          onClose={() => { setSelectedQuestion(null); loadDiscussedQuestions(); }} />
      )}

      {/* New Post Modal */}
      {showNewPost && currentUser && (
        <NewPostModal currentUser={currentUser}
          onClose={() => setShowNewPost(false)}
          onCreated={() => { setShowNewPost(false); loadPosts(); }} />
      )}
    </div>
  );
}

// ========== src/pages/HistoryPage_Fixed.jsx ==========

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { quizService } from '../services/quizService';
import AttemptDetailModal from '../components/AttemptDetailModal';
import {
  History, ArrowLeft, Calendar, Clock, Target, TrendingUp,
  Filter, ChevronDown, Trophy, AlertCircle, RefreshCw, ChevronRight,
} from 'lucide-react';

export default function HistoryPage() {
  const { currentUser } = useAuth();
  const { t } = useLanguage();
  const navigate = useNavigate();
  const [attempts, setAttempts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [filterPeriod, setFilterPeriod] = useState('all');
  const [sortBy, setSortBy] = useState('recent');
  const [showFilters, setShowFilters] = useState(false);
  const [selectedAttempt, setSelectedAttempt] = useState(null);

  useEffect(() => { loadHistory(); }, [currentUser]);

  async function loadHistory() {
    if (!currentUser) { setLoading(false); return; }
    try {
      setError(null);
      setLoading(true);
      const userAttempts = await quizService.getUserAttempts(currentUser.uid, 100);
      setAttempts(userAttempts);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }

  const formatDate = (iso) =>
    new Date(iso).toLocaleDateString('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit',
    });

  const formatTime = (ms) => {
    if (!ms) return 'N/A';
    const s = Math.floor(ms / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60);
    if (h > 0) return `${h}h ${m % 60}m`;
    if (m > 0) return `${m}m ${s % 60}s`;
    return `${s}s`;
  };

  const getFilteredAttempts = () => {
    let filtered = [...attempts];
    if (filterPeriod === 'week') {
      const w = new Date(); w.setDate(w.getDate() - 7);
      filtered = filtered.filter(a => new Date(a.timestamp) >= w);
    } else if (filterPeriod === 'month') {
      const m = new Date(); m.setMonth(m.getMonth() - 1);
      filtered = filtered.filter(a => new Date(a.timestamp) >= m);
    }
    if (sortBy === 'recent') filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    else if (sortBy === 'score') filtered.sort((a, b) => b.percentage - a.percentage);
    else if (sortBy === 'time') filtered.sort((a, b) => (b.timeSpent || 0) - (a.timeSpent || 0));
    return filtered;
  };

  const filteredAttempts = getFilteredAttempts();
  const stats = {
    total: filteredAttempts.length,
    average: filteredAttempts.length > 0
      ? Math.round(filteredAttempts.reduce((s, a) => s + a.percentage, 0) / filteredAttempts.length) : 0,
    best: filteredAttempts.length > 0 ? Math.max(...filteredAttempts.map(a => a.percentage)) : 0,
    totalTime: filteredAttempts.reduce((s, a) => s + (a.timeSpent || 0), 0),
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-lab-blue mx-auto mb-4"></div>
          <p className="text-slate-600">{t('history.loadingHistory')}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button onClick={() => navigate('/dashboard')} className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all">
          <ArrowLeft size={20} />
        </button>
        <div className="flex-1 bg-gradient-to-r from-purple-600 to-purple-800 rounded-2xl shadow-xl p-6 text-white">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <History size={32} />
            {t('history.title')}
          </h1>
          <p className="text-purple-100 mt-1">
            {t('history.clickToSeeAnalysis')}
          </p>
        </div>
      </div>

      {error && (
        <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4">
          <div className="flex items-start gap-3">
            <AlertCircle className="text-red-500 flex-shrink-0 mt-1" size={20} />
            <div className="flex-1">
              <h3 className="font-bold text-red-900 mb-1">{t('dashboard.errorLoadingAttempts')}</h3>
              <p className="text-sm text-red-800 mb-3">{error}</p>
              <button onClick={loadHistory} className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-all">
                <RefreshCw size={16} /> {t('dashboard.retry')}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        {[
          { icon: <Target className="text-lab-blue" size={20} />, label: t('history.totalAttempts'), val: stats.total, color: 'text-lab-blue' },
          { icon: <TrendingUp className="text-chemistry-green" size={20} />, label: t('history.averageScore'), val: `${stats.average}%`, color: 'text-chemistry-green' },
          { icon: <Trophy className="text-amber-500" size={20} />, label: t('history.bestScore'), val: `${stats.best}%`, color: 'text-amber-500' },
          { icon: <Clock className="text-purple-600" size={20} />, label: t('history.totalTime'), val: formatTime(stats.totalTime), color: 'text-purple-600' },
        ].map(({ icon, label, val, color }) => (
          <div key={label} className="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-4">
            <div className="flex items-center gap-2 mb-2">{icon}<span className="text-sm font-semibold text-slate-600">{label}</span></div>
            <div className={`text-3xl font-black ${color}`}>{val}</div>
          </div>
        ))}
      </div>

      {/* Filters */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <button
          onClick={() => setShowFilters(!showFilters)}
          className="w-full flex items-center justify-between p-4 hover:bg-slate-50 transition-all"
        >
          <div className="flex items-center gap-2">
            <Filter className="text-lab-blue" size={20} />
            <span className="font-bold text-slate-800">{t('history.filtersAndSorting')}</span>
          </div>
          <ChevronDown size={20} className={`text-slate-400 transition-transform ${showFilters ? 'rotate-180' : ''}`} />
        </button>
        {showFilters && (
          <div className="p-4 border-t border-slate-200 bg-slate-50">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-bold text-slate-700 mb-2">
                  {t('history.timePeriod')}
                </label>
                <div className="grid grid-cols-3 gap-2">
                  {[
                    { value: 'all', label: t('history.allTime') },
                    { value: 'month', label: t('history.lastMonth') },
                    { value: 'week', label: t('history.lastWeek') },
                  ].map(o => (
                    <button key={o.value} onClick={() => setFilterPeriod(o.value)}
                      className={`py-2 rounded-lg font-semibold text-sm transition-all ${filterPeriod === o.value ? 'bg-lab-blue text-white' : 'bg-white text-slate-600 hover:bg-slate-100 border-2 border-slate-200'}`}>
                      {o.label}
                    </button>
                  ))}
                </div>
              </div>
              <div>
                <label className="block text-sm font-bold text-slate-700 mb-2">
                  {t('history.sortBy')}
                </label>
                <div className="grid grid-cols-3 gap-2">
                  {[
                    { value: 'recent', label: t('history.recent') },
                    { value: 'score', label: t('history.score') },
                    { value: 'time', label: t('history.time') },
                  ].map(o => (
                    <button key={o.value} onClick={() => setSortBy(o.value)}
                      className={`py-2 rounded-lg font-semibold text-sm transition-all ${sortBy === o.value ? 'bg-chemistry-green text-white' : 'bg-white text-slate-600 hover:bg-slate-100 border-2 border-slate-200'}`}>
                      {o.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Attempts List */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-slate-50 p-4 border-b flex items-center justify-between">
          <h2 className="text-lg font-bold text-slate-800">
            {t('history.yourAttempts')} ({filteredAttempts.length})
          </h2>
          <div className="flex items-center gap-3">
            <span className="text-xs text-slate-400 italic hidden sm:block">
              {t('history.clickViewAnalysis')}
            </span>
            <button onClick={loadHistory} className="text-sm text-lab-blue hover:underline flex items-center gap-1">
              <RefreshCw size={14} /> {t('history.refresh')}
            </button>
          </div>
        </div>

        <div className="p-6">
          {filteredAttempts.length === 0 ? (
            <div className="text-center py-12">
              <History className="w-16 h-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-400 text-lg mb-2">{t('history.noAttemptsFound')}</p>
              <p className="text-slate-500 text-sm mb-4">
                {filterPeriod !== 'all'
                  ? t('history.tryChangingFilter')
                  : t('history.startPracticingHistory')}
              </p>
              {attempts.length === 0 && (
                <button onClick={() => navigate('/')} className="px-6 py-3 bg-lab-blue text-white rounded-lg font-bold hover:bg-blue-800 transition-all">
                  {t('history.takeFirstQuiz')}
                </button>
              )}
            </div>
          ) : (
            <div className="space-y-3">
              {filteredAttempts.map((attempt, index) => (
                <button
                  key={attempt.id}
                  onClick={() => setSelectedAttempt(attempt)}
                  className="w-full flex items-center justify-between p-4 rounded-xl border-2 border-slate-100 hover:border-purple-300 hover:bg-purple-50 transition-all hover:shadow-md text-left group"
                >
                  <div className="flex items-center gap-4 flex-1">
                    <div className="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center font-black text-slate-600">
                      #{index + 1}
                    </div>
                    <div className={`w-16 h-16 rounded-xl flex items-center justify-center font-black text-2xl ${
                      attempt.percentage >= 70 ? 'bg-green-100 text-green-700'
                      : attempt.percentage >= 50 ? 'bg-yellow-100 text-yellow-700'
                      : 'bg-red-100 text-red-700'
                    }`}>
                      {attempt.percentage}%
                    </div>
                    <div className="flex-1">
                      <div className="font-bold text-slate-800 text-lg">
                        {attempt.correctAnswers}/{attempt.totalQuestions} {t('history.correct')}
                      </div>
                      <div className="text-sm text-slate-500 flex items-center gap-2">
                        <Calendar size={14} /> {formatDate(attempt.timestamp)}
                      </div>
                      {attempt.topics && (
                        <div className="flex flex-wrap gap-1 mt-1">
                          {attempt.topics.slice(0, 3).map((topic, i) => (
                            <span key={i} className="text-xs bg-blue-100 text-lab-blue px-2 py-0.5 rounded-full font-semibold">{topic}</span>
                          ))}
                          {attempt.topics.length > 3 && (
                            <span className="text-xs text-slate-400 px-1">+{attempt.topics.length - 3}</span>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    {attempt.timeSpent && (
                      <div className="text-right hidden sm:block">
                        <div className="flex items-center gap-1 text-sm font-semibold text-slate-600">
                          <Clock size={14} /> {formatTime(attempt.timeSpent)}
                        </div>
                        <div className="text-xs text-slate-400">
                          {formatTime(attempt.timeSpent / attempt.totalQuestions)}/Q
                        </div>
                      </div>
                    )}
                    <ChevronRight size={20} className="text-slate-400 group-hover:text-purple-500 transition-colors flex-shrink-0" />
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Attempt Detail Modal */}
      {selectedAttempt && (
        <AttemptDetailModal
          attempt={selectedAttempt}
          onClose={() => setSelectedAttempt(null)}
        />
      )}
    </div>
  );
}

// ========== src/pages/LeaderboardPage.jsx ==========

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { quizService } from '../services/quizService';
import { Trophy, Medal, Award, Calendar, TrendingUp, ArrowLeft, Flame, GraduationCap } from 'lucide-react';

// ‚îÄ‚îÄ Level badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function LevelBadge({ level, rank }) {
  if (!level) return null;
  const isTopThree = rank <= 3;
  const colors = {
    S4: isTopThree ? 'bg-white/20 text-white border-white/40' : 'bg-sky-100 text-sky-700 border-sky-200',
    S5: isTopThree ? 'bg-white/20 text-white border-white/40' : 'bg-violet-100 text-violet-700 border-violet-200',
    S6: isTopThree ? 'bg-white/20 text-white border-white/40' : 'bg-emerald-100 text-emerald-700 border-emerald-200',
  };
  return (
    <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-xs font-bold ${colors[level] || colors.S5}`}>
      <GraduationCap size={10} />
      {level}
    </span>
  );
}

// ‚îÄ‚îÄ Streak badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function StreakBadge({ streak, rank }) {
  const { t } = useLanguage();
  if (!streak || streak < 1) return null;
  const isTopThree = rank <= 3;
  return (
    <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-bold ${
      isTopThree ? 'bg-white/20 text-white border border-white/40' : 'bg-orange-100 text-orange-700 border border-orange-200'
    }`}>
      <Flame size={10} />
      {streak} {t('dashboard.days').charAt(0)}
    </span>
  );
}

export default function LeaderboardPage() {
  const [activeTab, setActiveTab] = useState('weekly');
  const [leaderboard, setLeaderboard] = useState([]);
  const [loading, setLoading] = useState(true);
  const { currentUser } = useAuth();
  const { t } = useLanguage();
  const navigate = useNavigate();

  useEffect(() => { loadLeaderboard(); }, [activeTab]);

  async function loadLeaderboard() {
    setLoading(true);
    try {
      let data;
      if (activeTab === 'weekly') data = await quizService.getWeeklyLeaderboard(20);
      else if (activeTab === 'monthly') data = await quizService.getMonthlyLeaderboard(20);
      else data = await quizService.getAllTimeLeaderboard(20);
      setLeaderboard(data);
    } catch (error) {
      console.error('Error loading leaderboard:', error);
    }
    setLoading(false);
  }

  const getRankIcon = (rank) => {
    if (rank === 1) return <Trophy className="text-yellow-400" size={24} />;
    if (rank === 2) return <Medal className="text-slate-300" size={24} />;
    if (rank === 3) return <Award className="text-amber-500" size={24} />;
    return (
      <div className="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-600">
        {rank}
      </div>
    );
  };

  const getRankStyle = (rank) => {
    if (rank === 1) return 'bg-gradient-to-r from-yellow-400 to-yellow-600 text-white shadow-lg';
    if (rank === 2) return 'bg-gradient-to-r from-slate-300 to-slate-500 text-white shadow-md';
    if (rank === 3) return 'bg-gradient-to-r from-amber-500 to-amber-700 text-white shadow-md';
    return 'bg-white border-2 border-slate-200 hover:border-slate-300';
  };

  const tabs = [
    {
      value: 'weekly',
      icon: <Calendar size={16} />,
      label: t('leaderboard.thisWeek'),
    },
    {
      value: 'monthly',
      icon: <TrendingUp size={16} />,
      label: t('leaderboard.thisMonth'),
    },
    {
      value: 'alltime',
      icon: <Trophy size={16} />,
      label: t('leaderboard.allTime'),
    },
  ];

  const periodInfo = {
    weekly: t('leaderboard.averageScoreLast7'),
    monthly: t('leaderboard.averageScoreLast30'),
    alltime: t('leaderboard.overallAccuracyAllTime'),
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={() => navigate('/dashboard')}
          className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all"
        >
          <ArrowLeft size={20} />
        </button>
        <div className="flex-1 bg-gradient-to-r from-amber-500 to-orange-600 rounded-2xl shadow-xl p-6 text-white">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <Trophy size={32} />
            {t('leaderboard.title')}
          </h1>
          <p className="text-orange-100 mt-1">
            {t('leaderboard.seeHowYouRank')}
          </p>
        </div>
      </div>

      {/* Tabs */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="flex border-b">
          {tabs.map(tab => (
            <button
              key={tab.value}
              onClick={() => setActiveTab(tab.value)}
              className={`flex-1 px-4 py-4 font-bold transition-all flex items-center justify-center gap-2 text-sm sm:text-base ${
                activeTab === tab.value
                  ? 'bg-lab-blue text-white'
                  : 'text-slate-600 hover:bg-slate-50'
              }`}
            >
              {tab.icon}
              {tab.label}
            </button>
          ))}
        </div>

        {/* List */}
        <div className="p-6">
          {loading ? (
            <div className="flex items-center justify-center py-16">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-lab-blue"></div>
            </div>
          ) : leaderboard.length === 0 ? (
            <div className="text-center py-16">
              <Trophy className="w-16 h-16 text-slate-200 mx-auto mb-4" />
              <p className="text-slate-400 text-lg font-semibold">
                {t('leaderboard.noDataYet')}
              </p>
              <p className="text-slate-500 text-sm mt-2">
                {t('leaderboard.beFirstComplete')}
              </p>
            </div>
          ) : (
            <div className="space-y-3">
              {leaderboard.map((entry, index) => {
                const rank = index + 1;
                const isCurrentUser = entry.userId === currentUser?.uid;
                const scoreToShow = activeTab === 'alltime' ? entry.overallPercentage : entry.averageScore;
                const isTopThree = rank <= 3;

                return (
                  <div
                    key={entry.userId}
                    className={`flex items-center gap-4 p-4 rounded-xl transition-all ${getRankStyle(rank)} ${
                      isCurrentUser ? 'ring-4 ring-chemistry-green ring-offset-2' : ''
                    }`}
                  >
                    {/* Rank icon */}
                    <div className="flex-shrink-0 w-8 flex items-center justify-center">
                      {getRankIcon(rank)}
                    </div>

                    {/* User info */}
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center flex-wrap gap-2 mb-1">
                        <span className={`font-bold text-base truncate ${isTopThree ? 'text-white' : 'text-slate-800'}`}>
                          {entry.displayName}
                        </span>
                        {isCurrentUser && (
                          <span className="text-xs bg-chemistry-green text-white px-2 py-0.5 rounded-full font-bold flex-shrink-0">
                            {t('leaderboard.you')}
                          </span>
                        )}
                        {entry.level && <LevelBadge level={entry.level} rank={rank} />}
                        {entry.streak > 0 && <StreakBadge streak={entry.streak} rank={rank} />}
                      </div>
                      <div className={`text-xs ${isTopThree ? 'text-white/75' : 'text-slate-500'}`}>
                        {activeTab === 'alltime'
                          ? `${entry.totalAttempts} ${t('leaderboard.attempts')} ¬∑ ${entry.totalQuestions} ${t('leaderboard.questions')}`
                          : `${entry.attemptCount} ${t('leaderboard.attempts')} ¬∑ ${entry.totalQuestions} ${t('leaderboard.questions')}`
                        }
                      </div>
                    </div>

                    {/* Score */}
                    <div className="text-right flex-shrink-0">
                      <div className={`text-3xl font-black ${isTopThree ? 'text-white' : 'text-lab-blue'}`}>
                        {scoreToShow}%
                      </div>
                      <div className={`text-xs ${isTopThree ? 'text-white/70' : 'text-slate-500'}`}>
                        {entry.totalCorrect}/{entry.totalQuestions}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>

      {/* Info box */}
      <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 text-sm text-blue-800">
        <p className="font-semibold mb-2">
          üìä {t('leaderboard.howRankingsWork')}
        </p>
        <p className="text-blue-700">{periodInfo[activeTab]}</p>
        <div className="mt-3 flex flex-wrap gap-4 text-xs text-blue-700">
          <span className="flex items-center gap-1">
            <GraduationCap size={12} />
            {t('leaderboard.formLevel')}
          </span>
          <span className="flex items-center gap-1">
            <Flame size={12} />
            {t('leaderboard.flameStreak')}
          </span>
        </div>
      </div>
    </div>
  );
}

// ========== src/pages/LoginPage.jsx ==========

import React, { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { Beaker, Mail, Lock, LogIn, AlertCircle, Sparkles, Languages } from 'lucide-react';

export default function LoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const { login } = useAuth();
  const { t, toggleLanguage } = useLanguage();
  const navigate = useNavigate();

  async function handleSubmit(e) {
    e.preventDefault();

    try {
      setError('');
      setLoading(true);
      await login(email, password);
      navigate('/');
    } catch (err) {
      console.error(err);
      if (err.code === 'auth/user-not-found') {
        setError(t('auth.noAccountFound'));
      } else if (err.code === 'auth/wrong-password') {
        setError(t('auth.incorrectPassword'));
      } else if (err.code === 'auth/invalid-email') {
        setError(t('auth.invalidEmail'));
      } else {
        setError(t('auth.failedLogin'));
      }
    }
    setLoading(false);
  }

  return (
    <div className="min-h-screen w-full flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-4">
      {/* Language Toggle - Top Right */}
      <button
        onClick={toggleLanguage}
        className="fixed top-6 right-6 z-50 flex items-center gap-2 px-4 py-2 bg-white/10 backdrop-blur-md border-2 border-white/20 rounded-xl font-bold text-white hover:bg-white/20 transition-all shadow-lg"
        title={t('auth.switchToChinese')}
      >
        <Languages size={20} strokeWidth={3} />
        <span className="text-sm">{t('auth.switchToEnglish')}</span>
      </button>

      {/* Animated Background Elements */}
      <div className="absolute inset-0 overflow-hidden">
        <div className="absolute top-20 left-10 w-72 h-72 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob"></div>
        <div className="absolute top-40 right-10 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-2000"></div>
        <div className="absolute -bottom-8 left-20 w-72 h-72 bg-pink-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-4000"></div>
      </div>

      {/* Floating Chemistry Icons */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-1/4 left-1/4 text-6xl opacity-10 animate-float">‚öõÔ∏è</div>
        <div className="absolute top-1/3 right-1/4 text-5xl opacity-10 animate-float animation-delay-1000">üß™</div>
        <div className="absolute bottom-1/4 left-1/3 text-7xl opacity-10 animate-float animation-delay-2000">üî¨</div>
        <div className="absolute top-1/2 right-1/3 text-4xl opacity-10 animate-float animation-delay-3000">‚öóÔ∏è</div>
      </div>

      <div className="max-w-md w-full relative z-10">
        {/* Logo Header */}
        <div className="text-center mb-8 animate-in fade-in slide-in-from-top duration-700">
          <div className="flex justify-center mb-6">
            <div className="relative">
              <div className="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl blur-xl opacity-75 animate-pulse"></div>
              <div className="relative bg-gradient-to-r from-blue-500 to-purple-600 p-5 rounded-2xl shadow-2xl transform hover:scale-110 transition-transform duration-300">
                <Beaker className="text-white" size={56} strokeWidth={2.5} />
              </div>
            </div>
          </div>
          <h1 className="text-4xl font-black text-white mb-2 tracking-tight">
            ChemLeung
          </h1>
          <p className="text-blue-200 text-lg font-medium">
            {t('tagline')}
          </p>
          <div className="flex items-center justify-center gap-2 mt-3 text-blue-300 text-sm">
            <Sparkles size={16} />
            <span>{t('auth.signInToContinue')}</span>
          </div>
        </div>

        {/* Login Form */}
        <div className="bg-white/10 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 overflow-hidden animate-in fade-in slide-in-from-bottom duration-700">
          <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-center">
            <h2 className="text-2xl font-bold text-white flex items-center justify-center gap-2">
              <LogIn size={24} />
              {t('auth.welcomeBack')}
            </h2>
            <p className="text-blue-100 text-sm mt-1">
              {t('auth.enterCredentials')}
            </p>
          </div>

          <form onSubmit={handleSubmit} className="p-8 space-y-6">
            {error && (
              <div className="bg-red-500/20 backdrop-blur border-2 border-red-400/50 rounded-xl p-4 flex items-start gap-3 animate-in shake">
                <AlertCircle className="text-red-300 flex-shrink-0 mt-0.5" size={20} />
                <p className="text-red-100 text-sm font-medium">{error}</p>
              </div>
            )}

            {/* Email Field */}
            <div className="space-y-2">
              <label className="block text-sm font-bold text-white/90 ml-1">
                {t('auth.email')}
              </label>
              <div className="relative group">
                <Mail className="absolute left-4 top-1/2 transform -translate-y-1/2 text-blue-300 group-focus-within:text-blue-400 transition-colors" size={20} />
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="w-full pl-12 pr-4 py-4 bg-white/10 backdrop-blur border-2 border-white/20 rounded-xl focus:border-blue-400 focus:ring-4 focus:ring-blue-500/20 outline-none transition-all text-white placeholder-white/50 font-medium"
                  placeholder="your.email@example.com"
                />
              </div>
            </div>

            {/* Password Field */}
            <div className="space-y-2">
              <label className="block text-sm font-bold text-white/90 ml-1">
                {t('auth.password')}
              </label>
              <div className="relative group">
                <Lock className="absolute left-4 top-1/2 transform -translate-y-1/2 text-blue-300 group-focus-within:text-blue-400 transition-colors" size={20} />
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  className="w-full pl-12 pr-4 py-4 bg-white/10 backdrop-blur border-2 border-white/20 rounded-xl focus:border-blue-400 focus:ring-4 focus:ring-blue-500/20 outline-none transition-all text-white placeholder-white/50 font-medium"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
              </div>
            </div>

            {/* Submit Button */}
            <button
              type="submit"
              disabled={loading}
              className="relative w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold text-lg shadow-2xl hover:shadow-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-all overflow-hidden group"
            >
              <div className="relative flex items-center justify-center gap-2">
                {loading ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    <span>{t('auth.signingIn')}</span>
                  </>
                ) : (
                  <>
                    <LogIn size={20} />
                    <span>{t('auth.signIn')}</span>
                  </>
                )}
              </div>
            </button>
          </form>

          {/* Register Link */}
          <div className="bg-white/5 px-8 py-6 border-t border-white/10 text-center">
            <p className="text-white/70 text-sm">
              {t('auth.dontHaveAccount')} {' '}
              <Link 
                to="/register" 
                className="text-blue-300 font-bold hover:text-blue-200 transition-colors hover:underline"
              >
                {t('auth.createAccountNow')}
              </Link>
            </p>
          </div>
        </div>

        {/* Footer Note */}
        <p className="text-center text-white/50 text-xs mt-6 animate-in fade-in duration-1000">
          {t('auth.secureLogin')}
        </p>
      </div>

      {/* Custom CSS for animations */}
      <style jsx>{`
        @keyframes blob {
          0%, 100% { transform: translate(0, 0) scale(1); }
          33% { transform: translate(30px, -50px) scale(1.1); }
          66% { transform: translate(-20px, 20px) scale(0.9); }
        }
        @keyframes float {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(-20px); }
        }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
          20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-blob {
          animation: blob 7s infinite;
        }
        .animate-float {
          animation: float 3s ease-in-out infinite;
        }
        .animation-delay-1000 {
          animation-delay: 1s;
        }
        .animation-delay-2000 {
          animation-delay: 2s;
        }
        .animation-delay-3000 {
          animation-delay: 3s;
        }
        .animation-delay-4000 {
          animation-delay: 4s;
        }
        .animate-in {
          animation: fadeIn 0.5s ease-out;
        }
        .shake {
          animation: shake 0.5s;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
      `}</style>
    </div>
  );
}

// ========== src/pages/MistakeNotebookPage.jsx ==========

import React, {
  useState, useEffect, useMemo, useCallback,
} from 'react';
import { createPortal } from 'react-dom';
import { useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { quizService } from '../services/quizService';
import { quizStorage } from '../utils/quizStorage';
import { useFloating, offset, flip, shift, autoUpdate } from '@floating-ui/react';
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import {
  BookOpen, ArrowLeft, Play, AlertCircle, Target,
  CheckCircle, Filter, ChevronDown, Calendar, Hash, Tag,
  Clock, Zap, TrendingUp, Brain, BarChart2, Layers, X,
  AlertTriangle, Flame, Star, PlusCircle, Wand2, Eye, EyeOff, 
  Grid3x3, List as ListIcon, Command, Archive, Sparkles,
  ChevronRight, Maximize2, Check, Activity, LineChart,
} from 'lucide-react';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MASTERY_THRESHOLD = 3;
const ERROR_TYPES = [
  { value: 'misread', label: 'Misread Question', color: 'blue' },
  { value: 'calculation', label: 'Calculation Error', color: 'red' },
  { value: 'conceptual', label: 'Conceptual Gap', color: 'orange' },
  { value: 'careless', label: 'Careless Mistake', color: 'yellow' },
  { value: 'vocab', label: 'Vocabulary Gap', color: 'purple' },
  { value: 'diagram', label: 'Diagram Misread', color: 'pink' },
];
const MASTERY_LEVELS = {
  new:        { label: 'New',         min: 0, max: 0, color: 'red' },
  progressing:{ label: 'Developing', min: 1, max: 1, color: 'amber' },
  near:       { label: 'Near-Mastery', min: 2, max: 2, color: 'green' },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPER FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calculateMasteryPriority(mistake, recentTopics = []) {
  const now = Date.now();
  const lastAttemptTime = new Date(mistake.lastAttempted).getTime();
  const daysSinceLastAttempt = Math.max(0, (now - lastAttemptTime) / (1000 * 60 * 60 * 24));
  const U = Math.pow(2, daysSinceLastAttempt / 7);
  const D = Math.min(1.0, (mistake.attemptCount || 1) / 3);
  let R = 0.5;
  if (recentTopics.length > 0 && recentTopics.includes(mistake.Topic)) {
    R = 1.5;
  }
  return (U * 0.4) + (D * 0.4) + (R * 0.2);
}

function getMasteryState(improvementCount = 0) {
  if (improvementCount === 0) return { state: 0, label: 'Unprocessed', color: 'red' };
  if (improvementCount === 1) return { state: 1, label: 'Acquiring', color: 'amber' };
  if (improvementCount === 2) return { state: 2, label: 'Consolidating', color: 'yellow' };
  return { state: 3, label: 'Mastered', color: 'green' };
}

function calcPriority(mistake) {
  const days = (Date.now() - new Date(mistake.lastAttempted).getTime()) / (1000 * 60 * 60 * 24);
  return days * 1.2 - (mistake.improvementCount ?? 0) * 2;
}

function masteryStyle(improvementCount) {
  if (improvementCount >= 2)
    return {
      border: 'border-green-300',
      bg: 'bg-green-50/60',
      badge: 'bg-green-100 text-green-700',
      dot: 'bg-green-500',
    };
  if (improvementCount === 1)
    return {
      border: 'border-amber-300',
      bg: 'bg-amber-50/60',
      badge: 'bg-amber-100 text-amber-700',
      dot: 'bg-amber-400',
    };
  return {
    border: 'border-red-200',
    bg: 'bg-white',
    badge: 'bg-red-100 text-red-700',
    dot: 'bg-red-500',
  };
}

function applyRuleOfThree(improvements) {
  const archived = JSON.parse(localStorage.getItem('mistake_archive') || '{}');
  const activeImprovements = { ...improvements };
  
  Object.entries(improvements).forEach(([questionId, data]) => {
    if ((data.correctCount || 0) >= 3) {
      archived[questionId] = { ...data, archivedAt: new Date().toISOString() };
      delete activeImprovements[questionId];
    }
  });
  
  if (Object.keys(archived).length > Object.keys(JSON.parse(localStorage.getItem('mistake_archive') || '{}')).length) {
    localStorage.setItem('mistake_archive', JSON.stringify(archived));
  }
  
  return activeImprovements;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI COMPONENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * FullQuestionModal: Pop-up to show complete question details
 */
function FullQuestionModal({ mistake, errorTag, onTag, onClose }) {
  const { t } = useLanguage();
  const [selectedTag, setSelectedTag] = useState(errorTag || '');

  const handleTagSelect = (tag) => {
    setSelectedTag(tag);
    onTag(mistake.ID, tag);
  };

  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4 overflow-y-auto">
      <motion.div 
        initial={{ opacity: 0, scale: 0.95 }}
        animate={{ opacity: 1, scale: 1 }}
        exit={{ opacity: 0, scale: 0.95 }}
        className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl my-6"
      >
        {/* Header */}
        <div className="bg-gradient-to-r from-slate-700 to-slate-900 p-6 rounded-t-2xl flex justify-between items-center">
          <div>
            <h2 className="text-2xl font-black text-white mb-1">{t('notebook.questionDetail')}</h2>
            <p className="text-slate-300 text-sm">{mistake.Topic} ‚Üí {mistake.Subtopic}</p>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover:bg-white/20 rounded-lg transition-all text-white"
          >
            <X size={24} />
          </button>
        </div>

        <div className="p-8 space-y-6 max-h-[70vh] overflow-y-auto">
          {/* Question */}
          <div>
            <h3 className="text-sm font-black text-slate-500 uppercase tracking-widest mb-3">
              {t('notebook.question')}
            </h3>
            <div
              className="prose prose-slate max-w-none text-base bg-slate-50 p-4 rounded-xl border-2 border-slate-200"
              dangerouslySetInnerHTML={{ __html: mistake.Question }}
            />
          </div>

          {/* Image if exists */}
          {mistake.Pictureurl && (
            <div className="flex justify-center">
              <img 
                src={mistake.Pictureurl} 
                alt="Question diagram" 
                className="max-h-96 object-contain rounded-lg border-2 border-slate-200 shadow-md" 
              />
            </div>
          )}

          {/* Options Grid */}
          <div>
            <h3 className="text-sm font-black text-slate-500 uppercase tracking-widest mb-3">
              {t('notebook.options')}
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {['A', 'B', 'C', 'D'].map((opt) => {
                const isUserAnswer = mistake.userAnswer === opt;
                const isCorrect = mistake.CorrectOption === opt;
                
                return (
                  <div
                    key={opt}
                    className={`p-4 rounded-xl border-2 ${
                      isCorrect
                        ? 'border-green-500 bg-green-50'
                        : isUserAnswer
                        ? 'border-red-500 bg-red-50'
                        : 'border-slate-200 bg-white'
                    }`}
                  >
                    <div className="flex items-start gap-3">
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center font-black text-sm flex-shrink-0 ${
                        isCorrect
                          ? 'bg-green-500 text-white'
                          : isUserAnswer
                          ? 'bg-red-500 text-white'
                          : 'bg-slate-200 text-slate-600'
                      }`}>
                        {opt}
                      </div>
                      <div className="flex-1">
                        {isCorrect && (
                          <div className="text-xs font-bold text-green-700 mb-1 flex items-center gap-1">
                            <CheckCircle size={12} /> {t('notebook.correctAnswer')}
                          </div>
                        )}
                        {isUserAnswer && !isCorrect && (
                          <div className="text-xs font-bold text-red-700 mb-1">
                            {t('notebook.yourAnswer')}
                          </div>
                        )}
                        <div className={`text-sm ${
                          isCorrect ? 'text-green-900 font-semibold' : isUserAnswer ? 'text-red-900' : 'text-slate-700'
                        }`}>
                          {mistake[`Option${opt}`] || opt}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Explanation */}
          {mistake.Explanation && (
            <div>
              <h3 className="text-sm font-black text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                <BookOpen size={16} className="text-blue-600" />
                {t('notebook.explanation')}
              </h3>
              <div
                className="prose prose-slate max-w-none text-sm bg-blue-50 p-4 rounded-xl border-2 border-blue-200"
                dangerouslySetInnerHTML={{ __html: mistake.Explanation }}
              />
            </div>
          )}

          {/* Error Type Tagging */}
          <div>
            <h3 className="text-sm font-black text-slate-500 uppercase tracking-widest mb-3">
              {t('notebook.tagErrorType')}
            </h3>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
              {ERROR_TYPES.map((type) => (
                <button
                  key={type.value}
                  onClick={() => handleTagSelect(type.value)}
                  className={`p-3 rounded-lg text-sm font-bold border-2 transition-all ${
                    selectedTag === type.value
                      ? `border-${type.color}-500 bg-${type.color}-50 text-${type.color}-700`
                      : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'
                  }`}
                >
                  <div className="flex items-center gap-2">
                    <div className={`w-3 h-3 rounded-full bg-${type.color}-500`} />
                    <span>{type.label}</span>
                  </div>
                </button>
              ))}
            </div>
          </div>

          {/* Stats */}
          <div className="grid grid-cols-3 gap-4 pt-4 border-t border-slate-200">
            <div className="text-center">
              <div className="text-xs font-black text-slate-500 uppercase tracking-widest mb-1">
                {t('notebook.attempts')}
              </div>
              <div className="text-2xl font-black text-slate-700">{mistake.attemptCount || 1}</div>
            </div>
            <div className="text-center">
              <div className="text-xs font-black text-slate-500 uppercase tracking-widest mb-1">
                {t('notebook.masteryLevel')}
              </div>
              <div className="text-2xl font-black text-amber-600">{mistake.improvementCount || 0}/3</div>
            </div>
            <div className="text-center">
              <div className="text-xs font-black text-slate-500 uppercase tracking-widest mb-1">
                {t('notebook.lastAttempted')}
              </div>
              <div className="text-sm font-bold text-slate-700">
                {new Date(mistake.lastAttempted).toLocaleDateString('en-GB', {
                  day: '2-digit',
                  month: 'short'
                })}
              </div>
            </div>
          </div>
        </div>
      </motion.div>
    </div>
  );
}

/**
 * ProgressSegments: 3-segment progress bar
 */
function ProgressSegments({ current, target = 3, size = 'sm' }) {
  const sizeClasses = {
    sm: 'h-2',
    md: 'h-3',
    lg: 'h-4',
  };
  
  return (
    <div className={`flex gap-1 ${sizeClasses[size]}`}>
      {Array.from({ length: target }).map((_, i) => (
        <div
          key={i}
          className={`flex-1 rounded-full transition-all duration-300 ${
            i < current
              ? 'bg-green-500 shadow-lg'
              : i === current
              ? 'bg-amber-400'
              : 'bg-slate-200'
          }`}
        />
      ))}
    </div>
  );
}

/**
 * TooltipWithPortal: Floating tooltip
 */
function TooltipWithPortal({ trigger, content, placement = 'top' }) {
  const [open, setOpen] = useState(false);
  
  const { refs, floatingStyles } = useFloating({
    placement,
    open,
    onOpenChange: setOpen,
    middleware: [offset(10), flip(), shift({ padding: 8 })],
    whileElementsMounted: autoUpdate
  });
  
  return (
    <>
      <div
        ref={refs.setReference}
        onMouseEnter={() => setOpen(true)}
        onMouseLeave={() => setOpen(false)}
        className="cursor-help"
      >
        {trigger}
      </div>
      
      {open && createPortal(
        <div
          ref={refs.setFloating}
          style={floatingStyles}
          className="z-[9999] bg-slate-900 text-white text-xs rounded-xl p-3 shadow-2xl ring-1 ring-white/10 max-w-xs pointer-events-none"
        >
          {content}
        </div>,
        document.body
      )}
    </>
  );
}

/**
 * InteractiveTopicHeatmap: Clickable topic density chart with multi-select
 */
function InteractiveTopicHeatmap({ mistakes, selectedTopics, onTopicToggle }) {
  const { t } = useLanguage();
  
  const errorDensity = useMemo(() => {
    const topicMap = {};
    mistakes.forEach(m => {
      if (!topicMap[m.Topic]) {
        topicMap[m.Topic] = { attempted: 0, wrong: 0 };
      }
      topicMap[m.Topic].wrong++;
      topicMap[m.Topic].attempted += Math.max(m.attemptCount, 1);
    });
    
    return Object.entries(topicMap).map(([topic, data]) => ({
      topic,
      errorDensity: Math.min(1.0, data.wrong / Math.max(data.attempted, 1)),
      wrongCount: data.wrong,
      attemptedCount: data.attempted
    })).sort((a, b) => b.errorDensity - a.errorDensity);
  }, [mistakes]);
  
  const getColor = (density, isSelected) => {
    const base = density < 0.2 ? 'yellow' 
      : density < 0.4 ? 'orange' 
      : density < 0.6 ? 'orange' 
      : density < 0.8 ? 'red'
      : 'red';
    
    if (isSelected) {
      return `from-${base}-600 to-${base}-700 text-white ring-2 ring-${base}-400 ring-offset-2`;
    }
    
    if (density < 0.2) return 'from-yellow-100 to-yellow-200 text-yellow-900 hover:from-yellow-200 hover:to-yellow-300';
    if (density < 0.4) return 'from-orange-200 to-orange-300 text-orange-900 hover:from-orange-300 hover:to-orange-400';
    if (density < 0.6) return 'from-orange-400 to-orange-500 text-white hover:from-orange-500 hover:to-orange-600';
    if (density < 0.8) return 'from-red-500 to-red-600 text-white hover:from-red-600 hover:to-red-700';
    return 'from-red-700 to-red-800 text-white hover:from-red-800 hover:to-red-900';
  };
  
  return (
    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h3 className="font-bold text-lg text-slate-800 mb-2 flex items-center gap-2">
        <BarChart2 size={20} className="text-orange-600" />
        {t('notebook.errorDensityByTopic')}
      </h3>
      <p className="text-xs text-slate-500 mb-4">
        {t('notebook.clickTopicsToFilter')} ‚Ä¢ {selectedTopics.length > 0 && `${selectedTopics.length} selected`}
      </p>
      
      <div className="space-y-3">
        {errorDensity.map(({ topic, errorDensity: density, wrongCount, attemptedCount }) => {
          const isSelected = selectedTopics.includes(topic);
          return (
            <button
              key={topic}
              onClick={() => onTopicToggle(topic)}
              className={`w-full flex items-center gap-4 p-4 rounded-lg bg-gradient-to-r transition-all transform hover:scale-105 active:scale-95 cursor-pointer ${getColor(density, isSelected)}`}
            >
              <div className="w-32 font-semibold text-sm text-left truncate flex items-center gap-2">
                {isSelected && <Check size={14} />}
                {topic}
              </div>
              <div className="flex-1 text-right font-bold text-sm">
                {(density * 100).toFixed(0)}% ({wrongCount}/{attemptedCount})
              </div>
              <ChevronRight size={16} />
            </button>
          );
        })}
      </div>
      
      {selectedTopics.length > 0 && (
        <button
          onClick={() => selectedTopics.forEach(onTopicToggle)}
          className="mt-4 w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-bold transition-all"
        >
          {t('notebook.clearSelection')}
        </button>
      )}
    </div>
  );
}

/**
 * CalendarHeatmap: 30-day activity visualization
 */
function CalendarHeatmap({ improvements }) {
  const { t } = useLanguage();
  
  const activityMap = useMemo(() => {
    const map = {};
    const now = new Date();
    
    for (let i = 0; i < 30; i++) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      map[dateStr] = 0;
    }
    
    Object.values(improvements).forEach(data => {
      if (data.lastCorrect) {
        const dateStr = new Date(data.lastCorrect).toISOString().split('T')[0];
        if (map[dateStr] !== undefined) map[dateStr]++;
      }
    });
    
    return map;
  }, [improvements]);
  
  const days = Object.entries(activityMap).reverse();
  const maxActivity = Math.max(...Object.values(activityMap), 1);
  
  const getColor = (count) => {
    const intensity = count / maxActivity;
    if (intensity === 0) return 'bg-slate-100';
    if (intensity < 0.33) return 'bg-blue-200';
    if (intensity < 0.67) return 'bg-blue-400';
    return 'bg-blue-600';
  };
  
  return (
    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
        <Calendar size={20} className="text-blue-600" />
        {t('notebook.mistakeClearingActivity')}
      </h3>
      
      <div className="grid grid-cols-7 gap-1">
        {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((day, idx) => (
          <div key={`header-${idx}`} className="text-center text-xs font-bold text-slate-400 h-6">
            {day}
          </div>
        ))}
        
        {days.map(([dateStr, count]) => (
          <TooltipWithPortal
            key={dateStr}
            trigger={
              <div
                className={`w-8 h-8 rounded ${getColor(count)} flex items-center justify-center text-xs font-bold text-slate-700 hover:ring-2 ring-blue-400 transition-all cursor-pointer`}
              >
                {count > 0 && count}
              </div>
            }
            content={`${dateStr}: ${count} cleared`}
          />
        ))}
      </div>
      
      <div className="flex items-center gap-2 mt-4 text-xs text-slate-500">
        <span>{t('notebook.less')}</span>
        <div className="flex gap-1">
          {[0, 0.33, 0.67, 1.0].map((i, idx) => (
            <div key={idx} className={`w-3 h-3 rounded ${getColor(i * maxActivity)}`} />
          ))}
        </div>
        <span>{t('notebook.more')}</span>
      </div>
    </div>
  );
}

/**
 * ImprovementTrendChart: 14-day mastery progression
 */
function ImprovementTrendChart({ improvements }) {
  const { t } = useLanguage();
  
  const trendData = useMemo(() => {
    const stateHistory = {};
    
    Object.values(improvements).forEach(data => {
      const state = getMasteryState(data.correctCount || 0);
      const dateStr = data.lastCorrect
        ? new Date(data.lastCorrect).toISOString().split('T')[0]
        : new Date().toISOString().split('T')[0];
      
      if (!stateHistory[dateStr]) {
        stateHistory[dateStr] = { Unprocessed: 0, Acquiring: 0, Consolidating: 0, Mastered: 0 };
      }
      stateHistory[dateStr][state.label]++;
    });
    
    return Object.entries(stateHistory)
      .sort((a, b) => new Date(a[0]) - new Date(b[0]))
      .map(([date, states]) => ({ date, ...states }))
      .slice(-14);
  }, [improvements]);
  
  return (
    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
        <TrendingUp size={20} className="text-purple-600" />
        {t('notebook.improvementTrend')}
      </h3>
      
      <ResponsiveContainer width="100%" height={300}>
        <AreaChart data={trendData}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="date" />
          <YAxis />
          <Tooltip />
          <Legend />
          <Area type="monotone" dataKey="Unprocessed" stackId="1" stroke="#ef4444" fill="#fecaca" />
          <Area type="monotone" dataKey="Acquiring" stackId="1" stroke="#f59e0b" fill="#fed7aa" />
          <Area type="monotone" dataKey="Consolidating" stackId="1" stroke="#eab308" fill="#fef08a" />
          <Area type="monotone" dataKey="Mastered" stackId="1" stroke="#22c55e" fill="#bbf7d0" />
        </AreaChart>
      </ResponsiveContainer>
    </div>
  );
}

/**
 * RetentionDashboard: Learning metrics overview
 */
function RetentionDashboard({ mistakes, improvements }) {
  const { t, tf } = useLanguage();
  const [open, setOpen] = useState(true);
  
  const stats = useMemo(() => {
    const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
    const addedThisWeek = mistakes.filter(
      (m) => new Date(m.lastAttempted).getTime() >= weekAgo
    ).length;
    const masteredThisWeek = Object.values(improvements).filter(
      (d) => (d.correctCount || 0) >= MASTERY_THRESHOLD &&
             d.lastCorrect &&
             new Date(d.lastCorrect).getTime() >= weekAgo
    ).length;
    
    const subtopicMap = {};
    mistakes.forEach((m) => {
      const key = m.Subtopic || 'Unknown';
      if (!subtopicMap[key]) subtopicMap[key] = { count: 0, repeats: 0 };
      subtopicMap[key].count++;
      if (m.attemptCount > 1) subtopicMap[key].repeats++;
    });
    
    const weakest = Object.entries(subtopicMap)
      .sort((a, b) => b[1].count + b[1].repeats * 2 - (a[1].count + a[1].repeats * 2))
      .slice(0, 6);
    
    return { addedThisWeek, masteredThisWeek, weakest };
  }, [mistakes, improvements]);
  
  const decayLabel =
    stats.addedThisWeek === 0 && stats.masteredThisWeek === 0
      ? '‚Äî'
      : stats.masteredThisWeek > stats.addedThisWeek
      ? t('notebook.decayImproving')
      : stats.masteredThisWeek === stats.addedThisWeek
      ? t('notebook.decayStable')
      : t('notebook.decayGrowing');
  
  return (
    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
      <button
        onClick={() => setOpen((o) => !o)}
        className="w-full flex items-center justify-between p-5 hover:bg-slate-50 transition-all"
      >
        <div className="flex items-center gap-2">
          <Activity className="text-purple-600" size={20} />
          <span className="font-bold text-slate-800 text-lg">{t('notebook.retentionDashboard')}</span>
        </div>
        <ChevronDown
          size={20}
          className={`text-slate-400 transition-transform ${open ? 'rotate-180' : ''}`}
        />
      </button>
      
      <AnimatePresence>
        {open && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.3 }}
            className="border-t border-slate-200 overflow-hidden"
          >
            <div className="p-6 space-y-6 bg-slate-50">
              <div className="grid grid-cols-3 gap-4">
                <div className="bg-white rounded-xl p-4 border-2 border-slate-200 text-center">
                  <div className="text-xs font-black text-slate-500 uppercase tracking-widest mb-1">
                    {t('notebook.addedThisWeek')}
                  </div>
                  <div className="text-3xl font-black text-red-500">{stats.addedThisWeek}</div>
                </div>
                <div className="bg-white rounded-xl p-4 border-2 border-slate-200 text-center">
                  <div className="text-xs font-black text-slate-500 uppercase tracking-widest mb-1">
                    {t('notebook.masteredThisWeek')}
                  </div>
                  <div className="text-3xl font-black text-green-600">{stats.masteredThisWeek}</div>
                </div>
                <div className="bg-white rounded-xl p-4 border-2 border-purple-200 text-center">
                  <div className="text-xs font-black text-slate-500 uppercase tracking-widest mb-1">
                    {t('notebook.decayRate')}
                  </div>
                  <div className="text-lg font-black text-purple-700 mt-1">{decayLabel}</div>
                </div>
              </div>
              
              <div>
                <h3 className="text-sm font-black text-slate-600 uppercase tracking-widest mb-3 flex items-center gap-2">
                  <Flame size={14} className="text-red-500" />
                  {t('notebook.weakestSubtopics')}
                </h3>
                <div className="space-y-2">
                  {stats.weakest.map(([subtopic, data]) => {
                    const max = stats.weakest[0][1].count + stats.weakest[0][1].repeats * 2;
                    const score = data.count + data.repeats * 2;
                    const pct = max > 0 ? (score / max) * 100 : 0;
                    return (
                      <div key={subtopic} className="flex items-center gap-3">
                        <div className="w-32 text-xs text-slate-600 font-semibold truncate shrink-0">
                          {subtopic}
                        </div>
                        <div className="flex-1 bg-slate-200 rounded-full h-2">
                          <div
                            className="bg-gradient-to-r from-red-400 to-orange-400 h-2 rounded-full transition-all"
                            style={{ width: `${pct}%` }}
                          />
                        </div>
                        <div className="text-xs text-slate-500 shrink-0 w-8 text-right">
                          {data.count}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

/**
 * LIST VIEW: Compact expandable rows
 */
function ListViewDeck({ mistakes, errorTags, onTag, selectedIds, onToggleSelect, onToggleSelectAll, allSelected, onViewFull }) {
  const { t } = useLanguage();
  const [expandedId, setExpandedId] = useState(null);
  
  return (
    <div className="space-y-2">
      {/* Select All */}
      <div className="flex items-center gap-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
        <input
          type="checkbox"
          checked={allSelected}
          onChange={onToggleSelectAll}
          className="w-4 h-4 rounded cursor-pointer"
        />
        <span className="text-sm font-bold text-slate-700">
          {t('notebook.selectAll')} ({selectedIds.size}/{mistakes.length})
        </span>
      </div>
      
      {/* Mistake Rows */}
      <AnimatePresence>
        {mistakes.map((mistake) => {
          const style = masteryStyle(mistake.improvementCount ?? 0);
          const priority = calcPriority(mistake);
          const isExpanded = expandedId === mistake.ID;
          const isSelected = selectedIds.has(mistake.ID);
          const isUrgent = priority > 15;
          
          return (
            <motion.div
              key={mistake.ID}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              className={`rounded-lg border-2 transition-all ${style.border} ${style.bg} ${
                isUrgent ? 'ring-2 ring-red-400' : ''
              }`}
            >
              {/* Row Header */}
              <div className="flex items-center gap-3 p-4">
                <input
                  type="checkbox"
                  checked={isSelected}
                  onChange={() => onToggleSelect(mistake.ID)}
                  className="w-4 h-4 rounded cursor-pointer"
                />
                <button
                  onClick={() => setExpandedId(isExpanded ? null : mistake.ID)}
                  className="flex-1 flex items-center justify-between hover:bg-white/50 p-2 rounded-lg transition-all"
                >
                  <div className="flex items-center gap-3 flex-1">
                    <div className="w-10 h-10 rounded bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-600">
                      {mistake.Topic.slice(0, 2)}
                    </div>
                    <div className="text-left min-w-0 flex-1">
                      <div className="text-xs font-bold text-slate-600">
                        {mistake.Topic} ‚Üí {mistake.Subtopic}
                      </div>
                      <div className="text-sm text-slate-800 font-semibold truncate">
                        {mistake.Question?.replace(/<[^>]*>/g, '').substring(0, 60)}...
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center gap-2 shrink-0">
                    <div className="w-24">
                      <ProgressSegments current={mistake.improvementCount ?? 0} target={3} size="sm" />
                    </div>
                    <span className={`text-xs font-black px-2 py-1 rounded-full ${
                      isUrgent ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'
                    }`}>
                      {priority.toFixed(1)}
                    </span>
                    <ChevronRight size={16} className={`transition-transform ${isExpanded ? 'rotate-90' : ''}`} />
                  </div>
                </button>
                <button
                  onClick={() => onViewFull(mistake)}
                  className="p-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-all"
                  title={t('notebook.viewFullQuestion')}
                >
                  <Maximize2 size={18} />
                </button>
              </div>
              
              {/* Expanded Content */}
              <AnimatePresence>
                {isExpanded && (
                  <motion.div
                    initial={{ height: 0, opacity: 0 }}
                    animate={{ height: 'auto', opacity: 1 }}
                    exit={{ height: 0, opacity: 0 }}
                    transition={{ duration: 0.2 }}
                    className="overflow-hidden"
                  >
                    <div className="p-4 border-t border-slate-300 space-y-3">
                      <div className="grid grid-cols-2 gap-3">
                        <div className="p-3 rounded-lg bg-red-50 border border-red-200">
                          <div className="text-xs font-bold text-red-700 mb-1">{t('notebook.yourAnswer')}</div>
                          <div className="text-sm font-semibold text-red-900">{mistake.userAnswer}</div>
                        </div>
                        <div className="p-3 rounded-lg bg-green-50 border border-green-200">
                          <div className="text-xs font-bold text-green-700 mb-1">{t('notebook.correctAnswer')}</div>
                          <div className="text-sm font-semibold text-green-900">{mistake.CorrectOption}</div>
                        </div>
                      </div>
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </motion.div>
          );
        })}
      </AnimatePresence>
    </div>
  );
}

/**
 * KANBAN VIEW: 3-column layout (New, Developing, Near-Mastery)
 */
function KanbanViewDeck({ columns, errorTags, onTag, onViewFull }) {
  const { t } = useLanguage();
  const [expandedId, setExpandedId] = useState(null);
  
  const columnConfig = {
    new: { label: t('notebook.masteryNew'), color: 'red', icon: AlertTriangle, gradient: 'from-red-50 to-red-100', border: 'border-red-300' },
    progressing: { label: t('notebook.masteryDeveloping'), color: 'amber', icon: Flame, gradient: 'from-amber-50 to-amber-100', border: 'border-amber-300' },
    near: { label: t('notebook.masteryNear'), color: 'green', icon: Star, gradient: 'from-green-50 to-green-100', border: 'border-green-300' },
  };
  
  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
      {Object.entries(columns).map(([key, mistakes]) => {
        const config = columnConfig[key];
        
        return (
          <motion.div
            key={key}
            initial={{ opacity: 0, x: -20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ duration: 0.3 }}
            className={`rounded-2xl border-2 ${config.border} bg-gradient-to-b ${config.gradient} p-4 flex flex-col`}
          >
            {/* Column Header */}
            <div className="mb-4 pb-3 border-b-2 border-slate-300">
              <h3 className="font-black text-lg text-slate-800 flex items-center gap-2">
                <config.icon size={20} className={`text-${config.color}-600`} />
                {config.label} ({mistakes.length})
              </h3>
            </div>
            
            {/* Column Cards */}
            <div className="flex-1 overflow-y-auto space-y-3 pr-2">
              {mistakes.length === 0 ? (
                <div className="text-center py-8">
                  <CheckCircle size={32} className={`text-${config.color}-300 mx-auto mb-2`} />
                  <p className={`text-xs font-bold text-${config.color}-700`}>
                    {t('notebook.allCaughtUp')}
                  </p>
                </div>
              ) : (
                <AnimatePresence>
                  {mistakes.map((mistake) => {
                    const priority = calcPriority(mistake);
                    const isUrgent = priority > 15;
                    
                    return (
                      <motion.div
                        key={mistake.ID}
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, scale: 0.9 }}
                        className={`bg-white rounded-xl p-4 shadow-md border-2 border-slate-200 hover:shadow-lg transition-all ${
                          isUrgent ? 'ring-2 ring-red-400' : ''
                        }`}
                      >
                        {/* Card Header */}
                        <div className="mb-3">
                          <div className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">
                            {mistake.Topic}
                          </div>
                          <div className="text-sm font-bold text-slate-800 line-clamp-2">
                            {mistake.Question?.replace(/<[^>]*>/g, '').substring(0, 80)}...
                          </div>
                        </div>
                        
                        {/* Progress Bar */}
                        <div className="mb-3">
                          <ProgressSegments current={mistake.improvementCount ?? 0} target={3} size="md" />
                        </div>
                        
                        {/* Priority Badge */}
                        <div className={`inline-block text-xs font-black px-2 py-1 rounded-full mb-3 ${
                          isUrgent
                            ? 'bg-red-100 text-red-700'
                            : priority > 7
                            ? 'bg-amber-100 text-amber-700'
                            : 'bg-slate-100 text-slate-600'
                        }`}>
                          {t('notebook.priority')}: {priority.toFixed(1)}
                        </div>
                        
                        {/* View Full Button */}
                        <button
                          onClick={() => onViewFull(mistake)}
                          className="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700 transition-all flex items-center justify-center gap-2"
                        >
                          <Maximize2 size={14} />
                          {t('notebook.viewFull')}
                        </button>
                      </motion.div>
                    );
                  })}
                </AnimatePresence>
              )}
            </div>
          </motion.div>
        );
      })}
    </div>
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN COMPONENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
export default function MistakeNotebookPage() {
  const { currentUser } = useAuth();
  const { t, tf } = useLanguage();
  const navigate = useNavigate();
  
  // Core state
  const [mistakes, setMistakes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [improvements, setImprovements] = useState({});
  const [errorTags, setErrorTags] = useState(() =>
    JSON.parse(localStorage.getItem('mistake_error_tags') || '{}')
  );
  const [recentQuizTopics, setRecentQuizTopics] = useState(() =>
    JSON.parse(localStorage.getItem('recent_quiz_topics') || '[]')
  );
  const [archivedMistakes, setArchivedMistakes] = useState(() =>
    JSON.parse(localStorage.getItem('mistake_archive') || '{}')
  );
  
  // Filter state
  const [questionCount, setQuestionCount] = useState('10');
  const [datePeriod, setDatePeriod] = useState('all');
  const [selectedTopics, setSelectedTopics] = useState([]);
  const [selectedSubtopics, setSelectedSubtopics] = useState([]);
  const [selectedMasteryLevels, setSelectedMasteryLevels] = useState([]);
  
  // Timer settings
  const [timerEnabled, setTimerEnabled] = useState(true);
  const [isTimedMode, setIsTimedMode] = useState(false);
  
  // UI state
  const [activeTab, setActiveTab] = useState('deck');
  const [viewMode, setViewMode] = useState('list');
  const [selectedMistakeIds, setSelectedMistakeIds] = useState(new Set());
  const [fullViewMistake, setFullViewMistake] = useState(null);
  
  // Load data
  useEffect(() => { loadMistakes(); }, [currentUser]);
  
  async function loadMistakes() {
    if (!currentUser) { setLoading(false); return; }
    try {
      setLoading(true);
      const attempts = await quizService.getUserAttempts(currentUser.uid, 100);
      const incorrectMap = new Map();
      const improvementData = JSON.parse(
        localStorage.getItem('mistake_improvements') || '{}'
      );
      
      attempts.forEach((attempt) => {
        if (!attempt.answers || !attempt.questions) return;
        attempt.questions.forEach((question) => {
          const userAnswer = attempt.answers[question.ID];
          const isCorrect = userAnswer && userAnswer === question.CorrectOption;
          
          if (isCorrect && improvementData[question.ID]) {
            improvementData[question.ID].correctCount =
              (improvementData[question.ID].correctCount || 0) + 1;
            improvementData[question.ID].lastCorrect = attempt.timestamp;
          }
          
          if (userAnswer && userAnswer !== question.CorrectOption) {
            const improveCount = improvementData[question.ID]?.correctCount || 0;
            if (improveCount >= MASTERY_THRESHOLD) return;
            
            if (!incorrectMap.has(question.ID)) {
              incorrectMap.set(question.ID, {
                ...question,
                attemptCount: 1,
                lastAttempted: attempt.timestamp,
                userAnswer,
                improvementCount: improveCount,
              });
            } else {
              const existing = incorrectMap.get(question.ID);
              existing.attemptCount += 1;
              existing.improvementCount = improveCount;
              if (new Date(attempt.timestamp) > new Date(existing.lastAttempted)) {
                existing.lastAttempted = attempt.timestamp;
                existing.userAnswer = userAnswer;
              }
            }
          }
        });
      });
      
      localStorage.setItem('mistake_improvements', JSON.stringify(improvementData));
      setImprovements(improvementData);
      
      const arr = Array.from(incorrectMap.values()).sort(
        (a, b) => calcPriority(b) - calcPriority(a)
      );
      setMistakes(arr);
    } catch (err) {
      console.error('Error loading mistakes:', err);
    } finally {
      setLoading(false);
    }
  }
  
  // Persistence effects
  useEffect(() => {
    localStorage.setItem('mistake_error_tags', JSON.stringify(errorTags));
  }, [errorTags]);
  
  useEffect(() => {
    const updated = applyRuleOfThree(improvements);
    setArchivedMistakes(JSON.parse(localStorage.getItem('mistake_archive') || '{}'));
  }, [improvements]);
  
  // Computed values
  const allTopics = useMemo(
    () => [...new Set(mistakes.map((m) => m.Topic).filter(Boolean))].sort(),
    [mistakes]
  );
  
  const availableSubtopics = useMemo(() => {
    const base = selectedTopics.length > 0
      ? mistakes.filter((m) => selectedTopics.includes(m.Topic))
      : mistakes;
    return [...new Set(base.map((m) => m.Subtopic).filter(Boolean))].sort();
  }, [mistakes, selectedTopics]);
  
  useEffect(() => {
    setSelectedSubtopics((prev) =>
      prev.filter((s) => availableSubtopics.includes(s))
    );
  }, [availableSubtopics]);
  
  const filteredMistakes = useMemo(() => {
    let result = [...mistakes];
    
    if (datePeriod === 'week') {
      const weekAgo = new Date(); 
      weekAgo.setDate(weekAgo.getDate() - 7);
      result = result.filter((m) => new Date(m.lastAttempted) >= weekAgo);
    } else if (datePeriod === 'month') {
      const monthAgo = new Date(); 
      monthAgo.setMonth(monthAgo.getMonth() - 1);
      result = result.filter((m) => new Date(m.lastAttempted) >= monthAgo);
    }
    
    if (selectedTopics.length > 0)
      result = result.filter((m) => selectedTopics.includes(m.Topic));
    
    if (selectedSubtopics.length > 0)
      result = result.filter((m) => selectedSubtopics.includes(m.Subtopic));
    
    if (selectedMasteryLevels.length > 0) {
      result = result.filter((m) => {
        const ic = m.improvementCount ?? 0;
        return selectedMasteryLevels.some((lvl) => {
          const { min, max } = MASTERY_LEVELS[lvl];
          return ic >= min && ic <= max;
        });
      });
    }
    
    return result;
  }, [mistakes, datePeriod, selectedTopics, selectedSubtopics, selectedMasteryLevels]);
  
  const practiceCount =
    questionCount === 'All'
      ? filteredMistakes.length
      : Math.min(parseInt(questionCount), filteredMistakes.length);
  
  // Kanban columns
  const kanbanColumns = useMemo(() => ({
    new: filteredMistakes.filter(m => (m.improvementCount ?? 0) === 0),
    progressing: filteredMistakes.filter(m => (m.improvementCount ?? 0) === 1),
    near: filteredMistakes.filter(m => (m.improvementCount ?? 0) === 2),
  }), [filteredMistakes]);
  
  // Handlers
  const handleTag = useCallback((questionId, tag) => {
    setErrorTags((prev) => {
      const next = { ...prev };
      if (tag === null) delete next[questionId];
      else next[questionId] = tag;
      return next;
    });
  }, []);
  
  const toggleTopic = useCallback((topic) => {
    setSelectedTopics((prev) =>
      prev.includes(topic) ? prev.filter((t) => t !== topic) : [...prev, topic]
    );
  }, []);
  
  const toggleSubtopic = useCallback((sub) => {
    setSelectedSubtopics((prev) =>
      prev.includes(sub) ? prev.filter((s) => s !== sub) : [...prev, sub]
    );
  }, []);
  
  const toggleMasteryLevel = useCallback((lvl) => {
    setSelectedMasteryLevels((prev) =>
      prev.includes(lvl) ? prev.filter((l) => l !== lvl) : [...prev, lvl]
    );
  }, []);
  
  const handlePracticeMistakes = () => {
    if (filteredMistakes.length === 0) return;
    
    const selected = selectedMistakeIds.size > 0
      ? filteredMistakes.filter(m => selectedMistakeIds.has(m.ID))
      : [...filteredMistakes]
          .sort((a, b) => calcPriority(b) - calcPriority(a))
          .slice(0, practiceCount);
    
    quizStorage.clearQuizData();
    quizStorage.saveSelectedQuestions(selected);
    localStorage.setItem('quiz_mode', 'mistakes');
    localStorage.setItem('quiz_timer_enabled', timerEnabled.toString());
    localStorage.setItem('quiz_is_timed_mode', isTimedMode.toString());
    navigate('/quiz');
  };
  
  const toggleMistakeSelection = (questionId) => {
    setSelectedMistakeIds(prev => {
      const next = new Set(prev);
      if (next.has(questionId)) next.delete(questionId);
      else next.add(questionId);
      return next;
    });
  };
  
  const toggleSelectAll = () => {
    if (selectedMistakeIds.size === filteredMistakes.length) {
      setSelectedMistakeIds(new Set());
    } else {
      setSelectedMistakeIds(new Set(filteredMistakes.map(m => m.ID)));
    }
  };
  
  const formatDate = (iso) =>
    new Date(iso).toLocaleDateString('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric',
    });
  
  // Loading state
  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen bg-slate-50">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4" />
          <p className="text-slate-600 font-semibold">{t('notebook.loadingMistakes')}</p>
        </div>
      </div>
    );
  }
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // RENDER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  return (
    <div className="flex h-screen bg-slate-50 overflow-hidden">
      {/* Full Question Modal */}
      <AnimatePresence>
        {fullViewMistake && (
          <FullQuestionModal
            mistake={fullViewMistake}
            errorTag={errorTags[fullViewMistake.ID]}
            onTag={handleTag}
            onClose={() => setFullViewMistake(null)}
          />
        )}
      </AnimatePresence>

      {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          SIDEBAR: Practice Configurator
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
      
      <div className="w-80 bg-white border-r border-slate-200 flex flex-col overflow-y-auto">
        {/* Header */}
        <div className="p-4 border-b border-slate-200 flex items-center gap-2">
          <button
            onClick={() => navigate('/dashboard')}
            className="p-2 hover:bg-slate-100 rounded-lg transition-all"
            title="Back to Dashboard"
          >
            <ArrowLeft size={20} className="text-slate-700" />
          </button>
          <h1 className="font-black text-lg text-slate-800 flex items-center gap-2">
            <Command size={20} className="text-indigo-600"/>
            {t('notebook.commandCenter')}
          </h1>
        </div>
        
        {/* Configurator */}
        <div className="flex-1 p-4 space-y-4 overflow-y-auto">
          {/* Question Count */}
          <div>
            <label className="text-xs font-black text-slate-600 uppercase tracking-widest mb-2 flex items-center gap-1">
              <Hash size={12} />
              {t('notebook.numberOfQuestions')}
            </label>
            <div className="grid grid-cols-3 gap-1">
              {['5', '10', '15', '20', '30', 'All'].map((num) => (
                <button
                  key={num}
                  onClick={() => setQuestionCount(num)}
                  disabled={num !== 'All' && parseInt(num) > filteredMistakes.length}
                  className={`py-2 rounded-lg border text-xs font-bold transition-all ${
                    questionCount === num
                      ? 'border-indigo-500 bg-indigo-50 text-indigo-600'
                      : 'border-slate-200 text-slate-500 hover:border-slate-300 disabled:opacity-30'
                  }`}
                >
                  {num}
                </button>
              ))}
            </div>
          </div>
          
          {/* Date Range */}
          <div>
            <label className="text-xs font-black text-slate-600 uppercase tracking-widest mb-2 flex items-center gap-1">
              <Calendar size={12} />
              {t('notebook.timeRange')}
            </label>
            <div className="space-y-1">
              {[
                { value: 'all',   label: t('notebook.allTime') },
                { value: 'month', label: t('notebook.lastMonth') },
                { value: 'week',  label: t('notebook.lastWeek') },
              ].map((o) => (
                <button
                  key={o.value}
                  onClick={() => setDatePeriod(o.value)}
                  className={`w-full px-3 py-2 rounded-lg border text-xs font-bold text-left transition-all ${
                    datePeriod === o.value
                      ? 'border-indigo-500 bg-indigo-50 text-indigo-700'
                      : 'border-slate-200 text-slate-600 hover:border-slate-300'
                  }`}
                >
                  {o.label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Mastery Level */}
          <div>
            <label className="text-xs font-black text-slate-600 uppercase tracking-widest mb-2">
              {t('notebook.masteryLevel')}
            </label>
            <div className="space-y-1">
              {Object.entries(MASTERY_LEVELS).map(([key, lvl]) => {
                const count = mistakes.filter((m) => {
                  const ic = m.improvementCount ?? 0;
                  return ic >= lvl.min && ic <= lvl.max;
                }).length;
                
                return (
                  <button
                    key={key}
                    onClick={() => toggleMasteryLevel(key)}
                    className={`w-full px-3 py-2 rounded-lg text-xs font-bold border text-left transition-all ${
                      selectedMasteryLevels.includes(key)
                        ? `bg-${lvl.color}-500 border-${lvl.color}-500 text-white`
                        : `bg-white border-${lvl.color}-200 text-${lvl.color}-700`
                    }`}
                  >
                    {lvl.label}
                    <span className="ml-1 opacity-70">({count})</span>
                  </button>
                );
              })}
            </div>
          </div>
          
          {/* Topics */}
          {allTopics.length > 1 && (
            <div>
              <label className="text-xs font-black text-slate-600 uppercase tracking-widest mb-2">
                {t('notebook.topics')}
              </label>
              <div className="space-y-1 max-h-48 overflow-y-auto">
                {allTopics.map((topic) => (
                  <button
                    key={topic}
                    onClick={() => toggleTopic(topic)}
                    className={`w-full px-3 py-2 rounded-lg text-xs font-bold text-left border transition-all ${
                      selectedTopics.includes(topic)
                        ? 'bg-indigo-500 border-indigo-500 text-white'
                        : 'bg-white border-slate-200 text-slate-600 hover:border-indigo-300'
                    }`}
                  >
                    {topic}
                    <span className="ml-1 opacity-70">
                      ({mistakes.filter((m) => m.Topic === topic).length})
                    </span>
                  </button>
                ))}
              </div>
            </div>
          )}
          
          {/* Subtopics */}
          {availableSubtopics.length > 1 && (
            <div>
              <label className="text-xs font-black text-slate-600 uppercase tracking-widest mb-2">
                {t('notebook.subtopics')}
              </label>
              <div className="space-y-1 max-h-48 overflow-y-auto">
                {availableSubtopics.slice(0, 12).map((sub) => (
                  <button
                    key={sub}
                    onClick={() => toggleSubtopic(sub)}
                    className={`w-full px-3 py-2 rounded-lg text-xs font-bold text-left border transition-all ${
                      selectedSubtopics.includes(sub)
                        ? 'bg-indigo-400 border-indigo-400 text-white'
                        : 'bg-white border-slate-200 text-slate-600 hover:border-indigo-200'
                    }`}
                  >
                    {sub}
                  </button>
                ))}
              </div>
            </div>
          )}
          
          {/* Timer Settings */}
          <div className="space-y-2 pt-2 border-t border-slate-200">
            <button
              onClick={() => setTimerEnabled(!timerEnabled)}
              className={`w-full px-3 py-2 rounded-lg text-xs font-bold border transition-all text-left flex items-center justify-between ${
                timerEnabled
                  ? 'bg-green-600 border-green-600 text-white'
                  : 'bg-white border-slate-200 text-slate-600'
              }`}
            >
              <span className="flex items-center gap-1">
                <Clock size={12} />
                {t('notebook.timerEnabled')}
              </span>
              {timerEnabled && <Check size={14} />}
            </button>
            {timerEnabled && (
              <button
                onClick={() => setIsTimedMode(!isTimedMode)}
                className={`w-full px-3 py-2 rounded-lg text-xs font-bold border transition-all text-left flex items-center justify-between ${
                  isTimedMode
                    ? 'bg-amber-600 border-amber-600 text-white'
                    : 'bg-white border-slate-200 text-slate-600'
                }`}
              >
                <span className="flex items-center gap-1">
                  <Zap size={12} />
                  {t('notebook.timedMode')}
                </span>
                {isTimedMode && <Check size={14} />}
              </button>
            )}
          </div>
        </div>
        
        {/* Practice Button */}
        <div className="p-4 border-t border-slate-200">
          <button
            onClick={handlePracticeMistakes}
            disabled={filteredMistakes.length === 0}
            className="w-full py-3 bg-orange-600 text-white rounded-xl font-black text-sm shadow-lg hover:bg-orange-700 disabled:bg-slate-300 transition-all flex items-center justify-center gap-2 active:scale-95"
          >
            <Play fill="currentColor" size={16} />
            {selectedMistakeIds.size > 0 
              ? tf('notebook.practiceSelected', { count: selectedMistakeIds.size })
              : tf('notebook.practiceMistakesCount', { 
                  count: practiceCount,
                  plural: practiceCount !== 1 ? 's' : ''
                })}
          </button>
          <p className="text-xs text-slate-500 mt-2 text-center">
            {filteredMistakes.length} {t('notebook.questionsAvailable')}
          </p>
        </div>
      </div>
      
      {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          MAIN WORKSPACE: Tabbed Interface
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
      
      <div className="flex-1 flex flex-col overflow-hidden">
        {/* Tab Navigation */}
        <div className="bg-white border-b border-slate-200 p-4">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-1">
              <button
                onClick={() => setActiveTab('analytics')}
                className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${
                  activeTab === 'analytics'
                    ? 'bg-indigo-100 text-indigo-700 border-2 border-indigo-500'
                    : 'bg-slate-100 text-slate-600 border-2 border-slate-200 hover:border-slate-300'
                }`}
              >
                <Brain size={16} className="inline mr-2" />
                {t('notebook.learningInsights')}
              </button>
              <button
                onClick={() => setActiveTab('deck')}
                className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${
                  activeTab === 'deck'
                    ? 'bg-indigo-100 text-indigo-700 border-2 border-indigo-500'
                    : 'bg-slate-100 text-slate-600 border-2 border-slate-200 hover:border-slate-300'
                }`}
              >
                <Grid3x3 size={16} className="inline mr-2" />
                {t('notebook.mistakeDeck')} ({filteredMistakes.length})
              </button>
              <button
                onClick={() => setActiveTab('archive')}
                className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${
                  activeTab === 'archive'
                    ? 'bg-indigo-100 text-indigo-700 border-2 border-indigo-500'
                    : 'bg-slate-100 text-slate-600 border-2 border-slate-200 hover:border-slate-300'
                }`}
              >
                <Archive size={16} className="inline mr-2" />
                {t('notebook.masteryArchive')} ({Object.keys(archivedMistakes).length})
              </button>
            </div>
            
            {activeTab === 'deck' && (
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setViewMode('list')}
                  className={`p-2 rounded-lg transition-all ${
                    viewMode === 'list'
                      ? 'bg-indigo-500 text-white'
                      : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                  }`}
                  title={t('notebook.listView')}
                >
                  <ListIcon size={18} />
                </button>
                <button
                  onClick={() => setViewMode('kanban')}
                  className={`p-2 rounded-lg transition-all ${
                    viewMode === 'kanban'
                      ? 'bg-indigo-500 text-white'
                      : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                  }`}
                  title={t('notebook.kanbanView')}
                >
                  <Grid3x3 size={18} />
                </button>
              </div>
            )}
          </div>
          
          {/* Filter Summary */}
          {(selectedTopics.length > 0 || selectedMasteryLevels.length > 0 || datePeriod !== 'all') && (
            <div className="flex flex-wrap gap-2 text-xs">
              {selectedTopics.map(t => (
                <span key={t} className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-semibold">
                  {tf('notebook.topicFilter', { topic: t })}
                  <button onClick={() => toggleTopic(t)} className="ml-1">‚úï</button>
                </span>
              ))}
              {selectedMasteryLevels.map(l => (
                <span key={l} className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-semibold">
                  {MASTERY_LEVELS[l].label}
                  <button onClick={() => toggleMasteryLevel(l)} className="ml-1">‚úï</button>
                </span>
              ))}
              {datePeriod !== 'all' && (
                <span className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-semibold">
                  {datePeriod === 'week' ? t('notebook.lastWeek') : t('notebook.lastMonth')}
                  <button onClick={() => setDatePeriod('all')} className="ml-1">‚úï</button>
                </span>
              )}
            </div>
          )}
        </div>
        
        {/* Tab Content */}
        <div className="flex-1 overflow-y-auto p-6">
          <AnimatePresence mode="wait">
            {/* Tab 1: Learning Insights */}
            {activeTab === 'analytics' && mistakes.length > 0 && (
              <motion.div
                key="analytics"
                initial={{ opacity: 0, x: -20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: 20 }}
                className="space-y-6"
              >
                {/* Quick Stats */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
                    <div className="text-xs font-black text-slate-500 uppercase tracking-widest mb-2">
                      {t('notebook.totalMistakes')}
                    </div>
                    <div className="text-3xl font-black text-red-600">{mistakes.length}</div>
                  </div>
                  <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
                    <div className="text-xs font-black text-slate-500 uppercase tracking-widest mb-2">
                      {t('notebook.topicsToFocus')}
                    </div>
                    <div className="text-3xl font-black text-amber-600">
                      {new Set(mistakes.map((m) => m.Topic)).size}
                    </div>
                  </div>
                  <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
                    <div className="text-xs font-black text-slate-500 uppercase tracking-widest mb-2">
                      {t('notebook.repeatedMistakes')}
                    </div>
                    <div className="text-3xl font-black text-green-600">
                      {mistakes.filter((m) => m.attemptCount > 1).length}
                    </div>
                  </div>
                </div>
                
                {/* Interactive Heatmap */}
                <InteractiveTopicHeatmap 
                  mistakes={mistakes} 
                  selectedTopics={selectedTopics}
                  onTopicToggle={toggleTopic}
                />
                
                {/* Retention Dashboard */}
                <RetentionDashboard mistakes={mistakes} improvements={improvements} />
                
                {/* Charts */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <CalendarHeatmap improvements={improvements} />
                </div>
                
                <ImprovementTrendChart improvements={improvements} />
              </motion.div>
            )}
            
            {/* Tab 2: Mistake Deck */}
            {activeTab === 'deck' && (
              <motion.div
                key="deck"
                initial={{ opacity: 0, x: -20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: 20 }}
              >
                {mistakes.length === 0 ? (
                  <div className="text-center py-12">
                    <CheckCircle className="w-16 h-16 text-green-300 mx-auto mb-4" />
                    <p className="text-slate-400 text-lg mb-2 font-semibold">
                      {t('notebook.noMistakesYet')}
                    </p>
                    <p className="text-slate-500 text-sm mb-4">
                      {t('notebook.keepPracticing')}
                    </p>
                    <button
                      onClick={() => navigate('/')}
                      className="px-6 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-all"
                    >
                      {t('notebook.startPracticing')}
                    </button>
                  </div>
                ) : filteredMistakes.length === 0 ? (
                  <div className="text-center py-12">
                    <AlertCircle className="w-16 h-16 text-amber-300 mx-auto mb-4" />
                    <p className="text-slate-400 text-lg mb-2 font-semibold">
                      {t('notebook.noQuestionsFound')}
                    </p>
                    <p className="text-slate-500 text-sm">
                      {t('notebook.tryAdjustFilters')}
                    </p>
                  </div>
                ) : viewMode === 'list' ? (
                  <ListViewDeck
                    mistakes={filteredMistakes}
                    errorTags={errorTags}
                    onTag={handleTag}
                    selectedIds={selectedMistakeIds}
                    onToggleSelect={toggleMistakeSelection}
                    onToggleSelectAll={toggleSelectAll}
                    allSelected={selectedMistakeIds.size === filteredMistakes.length}
                    onViewFull={setFullViewMistake}
                  />
                ) : (
                  <KanbanViewDeck
                    columns={kanbanColumns}
                    errorTags={errorTags}
                    onTag={handleTag}
                    onViewFull={setFullViewMistake}
                  />
                )}
              </motion.div>
            )}
            
            {/* Tab 3: Mastery Archive */}
            {activeTab === 'archive' && (
              <motion.div
                key="archive"
                initial={{ opacity: 0, x: -20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: 20 }}
              >
                {Object.keys(archivedMistakes).length === 0 ? (
                  <div className="text-center py-12">
                    <Archive className="w-16 h-16 text-slate-300 mx-auto mb-4" />
                    <p className="text-slate-400 text-lg mb-2 font-semibold">
                      {t('notebook.noArchivedYet')}
                    </p>
                    <p className="text-slate-500 text-sm">
                      {t('notebook.archiveInstructions')}
                    </p>
                  </div>
                ) : (
                  <div className="space-y-3">
                    {Object.values(archivedMistakes).map((question) => (
                      <motion.div
                        key={question.ID}
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        className="p-4 rounded-lg bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300"
                      >
                        <div className="flex items-start justify-between mb-2">
                          <div>
                            <div className="text-xs font-bold text-green-700 uppercase">
                              {question.Topic}
                            </div>
                            <div className="text-xs text-green-600">{question.Subtopic}</div>
                          </div>
                          <div className="text-xs text-green-600 font-bold flex items-center gap-1">
                            <CheckCircle size={14} />
                            {tf('notebook.masteredOn', { date: formatDate(question.archivedAt) })}
                          </div>
                        </div>
                        <div className="text-sm text-green-900 font-medium">
                          {question.Question?.replace(/<[^>]*>/g, '').substring(0, 100)}...
                        </div>
                      </motion.div>
                    ))}
                  </div>
                )}
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </div>
    </div>
  );
}

// ========== src/pages/PracticeModeSelection.jsx ==========

import React, { useState, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { Clock, Infinity, Settings, Play, Zap, BookOpen, Lock, Check, AlertCircle, Heart, Sparkles, Brain } from 'lucide-react';
import { quizStorage } from '../utils/quizStorage';
import { useLanguage } from '../contexts/LanguageContext';
import { doc, updateDoc } from 'firebase/firestore';
import { db } from '../firebase/config';
import { quizService } from '../services/quizService';

// Helper function for AI Daily Mission selection
function calculateMasteryPriority(mistake, recentTopics = []) {
  const now = Date.now();
  const lastAttemptTime = new Date(mistake.lastAttempted).getTime();
  const daysSinceLastAttempt = Math.max(0, (now - lastAttemptTime) / (1000 * 60 * 60 * 24));
  const U = Math.pow(2, daysSinceLastAttempt / 7);
  const D = Math.min(1.0, (mistake.attemptCount || 1) / 3);
  let R = 0.5;
  if (recentTopics.length > 0 && recentTopics.includes(mistake.Topic)) {
    R = 1.5;
  }
  return (U * 0.4) + (D * 0.4) + (R * 0.2);
}

function selectAIDailyMission(mistakes, recentTopics = []) {
  const prioritized = mistakes
    .map(m => ({
      ...m,
      masteryPriority: calculateMasteryPriority(m, recentTopics)
    }))
    .sort((a, b) => b.masteryPriority - a.masteryPriority);
  
  const byTopic = {};
  prioritized.forEach(m => {
    if (!byTopic[m.Topic]) byTopic[m.Topic] = [];
    byTopic[m.Topic].push(m);
  });
  
  const selected = [];
  const topicList = Object.keys(byTopic);
  const indices = Object.fromEntries(topicList.map(t => [t, 0]));
  
  while (selected.length < 10 && topicList.some(t => indices[t] < byTopic[t].length)) {
    for (const topic of topicList) {
      if (selected.length >= 10) break;
      if (indices[topic] < byTopic[topic].length) {
        selected.push(byTopic[topic][indices[topic]++]);
      }
    }
  }
  
  return selected.slice(0, 10);
}

export default function PracticeModeSelection({ questions }) {
  const navigate = useNavigate();
  const { currentUser, userProfile, loadUserProfile } = useAuth();
  const { t, tf } = useLanguage();
  const [selectedMode, setSelectedMode] = useState(null);
  const [questionCount, setQuestionCount] = useState(10);
  const [showCustom, setShowCustom] = useState(false);
  const [showUpdateTopics, setShowUpdateTopics] = useState(false);
  const [loadingMistakes, setLoadingMistakes] = useState(false);

  // Timer settings for each mode
  const [timedModeTimer, setTimedModeTimer] = useState(true);
  const [timedModeIsTimed, setTimedModeIsTimed] = useState(true);
  const [marathonModeTimer, setMarathonModeTimer] = useState(true);
  const [marathonModeIsTimed, setMarathonModeIsTimed] = useState(false);

  // Custom mode state
  const [selectedTopics, setSelectedTopics] = useState([]);
  const [selectedSubtopics, setSelectedSubtopics] = useState([]);
  const [customCount, setCustomCount] = useState(10);
  const [customTimerEnabled, setCustomTimerEnabled] = useState(false);
  const [customIsTimed, setCustomIsTimed] = useState(false);

  // Quick update topics state
  const [tempLearnedUpTo, setTempLearnedUpTo] = useState(userProfile?.learnedUpTo || '');
  const [tempExceptions, setTempExceptions] = useState(userProfile?.topicExceptions || []);
  const [updating, setUpdating] = useState(false);

  const MAX_QUESTIONS = 40;

  // Get all unique topics from questions
  const allTopics = useMemo(() => {
    return [...new Set(questions.map(q => q.Topic))]
      .filter(t => t && t !== "Uncategorized")
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
  }, [questions]);

  // Get available topics based on user's learned progress
  const availableTopics = useMemo(() => {
    const learnedUpTo = userProfile?.learnedUpTo;
    const exceptions = userProfile?.topicExceptions || [];
    
    if (!learnedUpTo) return [];
    
    return allTopics.filter(topic => {
      const topicNum = topic.match(/^\d+/)?.[0];
      return topicNum && topicNum <= learnedUpTo && !exceptions.includes(topic);
    });
  }, [allTopics, userProfile]);

  // For custom mode: determine which topics can be selected
  const customTopics = useMemo(() => {
    return allTopics.map(topic => {
      const isAvailable = availableTopics.includes(topic);
      return {
        name: topic,
        available: isAvailable
      };
    });
  }, [allTopics, availableTopics]);

  const availableSubtopics = useMemo(() => {
    if (selectedTopics.length === 0) return [];
    return [...new Set(questions
      .filter(q => selectedTopics.includes(q.Topic))
      .map(q => q.Subtopic))]
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
  }, [selectedTopics, questions]);

  const toggleTopic = (topic) => {
    setSelectedTopics(prev => 
      prev.includes(topic) ? prev.filter(t => t !== topic) : [...prev, topic]
    );
    setSelectedSubtopics([]);
  };

  const toggleSubtopic = (sub) => {
    setSelectedSubtopics(prev => 
      prev.includes(sub) ? prev.filter(s => s !== sub) : [...prev, sub]
    );
  };

  const handleUpdateTopics = async () => {
    setUpdating(true);
    try {
      const userRef = doc(db, 'users', currentUser.uid);
      await updateDoc(userRef, {
        learnedUpTo: tempLearnedUpTo,
        topicExceptions: tempExceptions,
        updatedAt: new Date().toISOString()
      });
      await loadUserProfile(currentUser.uid);
      setShowUpdateTopics(false);
      alert(t('practiceMode.topicsUpdated'));
    } catch (error) {
      console.error('Error updating topics:', error);
      alert(t('practiceMode.failedUpdate'));
    }
    setUpdating(false);
  };

  const handleModeSelect = (mode, count, timerEnabled = false, isTimed = false) => {
    if (mode === 'mistakes') {
      navigate('/notebook');
      return;
    }

    if (mode === 'ai-daily') {
      handleAIDailyMission();
      return;
    }

    if (availableTopics.length === 0) {
      alert(t('practice.pleaseSetTopics'));
      navigate('/profile');
      return;
    }

    setSelectedMode(mode);
    setQuestionCount(count);
    
    if (mode === 'custom') {
      setShowCustom(true);
    } else {
      const filtered = questions.filter(q => availableTopics.includes(q.Topic));
      const shuffled = [...filtered].sort(() => 0.5 - Math.random());
      const finalSelection = shuffled.slice(0, Math.min(count, MAX_QUESTIONS, shuffled.length));
      
      startQuiz(finalSelection, mode, timerEnabled, isTimed);
    }
  };

  const handleAIDailyMission = async () => {
    setLoadingMistakes(true);
    try {
      // Load user's mistakes
      const attempts = await quizService.getUserAttempts(currentUser.uid, 100);
      const incorrectMap = new Map();
      const improvementData = JSON.parse(
        localStorage.getItem('mistake_improvements') || '{}'
      );
      const recentTopics = JSON.parse(localStorage.getItem('recent_quiz_topics') || '[]');
      const MASTERY_THRESHOLD = 3;
      
      attempts.forEach((attempt) => {
        if (!attempt.answers || !attempt.questions) return;
        attempt.questions.forEach((question) => {
          const userAnswer = attempt.answers[question.ID];
          const isCorrect = userAnswer && userAnswer === question.CorrectOption;
          
          if (isCorrect && improvementData[question.ID]) {
            improvementData[question.ID].correctCount =
              (improvementData[question.ID].correctCount || 0) + 1;
            improvementData[question.ID].lastCorrect = attempt.timestamp;
          }
          
          if (userAnswer && userAnswer !== question.CorrectOption) {
            const improveCount = improvementData[question.ID]?.correctCount || 0;
            if (improveCount >= MASTERY_THRESHOLD) return;
            
            if (!incorrectMap.has(question.ID)) {
              incorrectMap.set(question.ID, {
                ...question,
                attemptCount: 1,
                lastAttempted: attempt.timestamp,
                userAnswer,
                improvementCount: improveCount,
              });
            } else {
              const existing = incorrectMap.get(question.ID);
              existing.attemptCount += 1;
              existing.improvementCount = improveCount;
              if (new Date(attempt.timestamp) > new Date(existing.lastAttempted)) {
                existing.lastAttempted = attempt.timestamp;
                existing.userAnswer = userAnswer;
              }
            }
          }
        });
      });

      const mistakes = Array.from(incorrectMap.values());
      
      if (mistakes.length < 10) {
        alert(tf('notebook.needMoreQuestions', { count: mistakes.length }));
        setLoadingMistakes(false);
        return;
      }

      // Use AI selection
      const selected = selectAIDailyMission(mistakes, recentTopics);
      startQuiz(selected, 'ai-daily', true, true);
    } catch (error) {
      console.error('Error loading mistakes for AI Daily Mission:', error);
      alert('Failed to load mistakes. Please try again.');
    }
    setLoadingMistakes(false);
  };

  const handleCustomStart = () => {
    let pool = questions.filter(q => selectedTopics.includes(q.Topic));
    
    if (selectedSubtopics.length > 0) {
      pool = pool.filter(q => selectedSubtopics.includes(q.Subtopic));
    }
    
    const shuffled = [...pool].sort(() => 0.5 - Math.random());
    const requestedCount = customCount === 'All' ? pool.length : parseInt(customCount);
    const finalCount = Math.min(requestedCount, MAX_QUESTIONS);
    const finalSelection = shuffled.slice(0, finalCount);
    
    if (finalSelection.length === 0) {
      alert(t('notebook.noQuestionsFound'));
      return;
    }

    if (requestedCount > MAX_QUESTIONS) {
      alert(tf('notebook.sessionLimited', { max: MAX_QUESTIONS }));
    }

    startQuiz(finalSelection, 'custom', customTimerEnabled, customIsTimed);
  };

  const startQuiz = (selectedQuestions, mode, timerEnabled, isTimed) => {
    quizStorage.clearQuizData();
    quizStorage.saveSelectedQuestions(selectedQuestions);
    
    localStorage.setItem('quiz_mode', mode);
    localStorage.setItem('quiz_timer_enabled', timerEnabled.toString());
    localStorage.setItem('quiz_is_timed_mode', isTimed.toString());
    
    navigate('/quiz');
  };

  // Quick update topics modal
  if (showUpdateTopics) {
    const learnedRangeTopics = allTopics.filter(topic => {
      const topicNum = topic.match(/^\d+/)?.[0];
      return topicNum && topicNum <= tempLearnedUpTo;
    });

    return (
      <div className="max-w-4xl mx-auto space-y-6">
        <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
          <div className="bg-lab-blue p-6 text-white flex justify-between items-center">
            <h2 className="text-2xl font-bold">
              {t('practiceMode.updateYourTopics')}
            </h2>
            <button
              onClick={() => setShowUpdateTopics(false)}
              className="text-white hover:text-blue-100 font-bold"
            >
              ‚úï
            </button>
          </div>

          <div className="p-6 space-y-6">
            <div>
              <label className="block text-sm font-bold text-slate-700 mb-3">
                {t('practiceMode.learnedUpTo')}
              </label>
              <div className="grid grid-cols-6 md:grid-cols-8 gap-2">
                {allTopics.map((topic) => {
                  const topicNum = topic.match(/^\d+/)?.[0];
                  return (
                    <button
                      key={topic}
                      onClick={() => setTempLearnedUpTo(topicNum)}
                      className={`py-2 rounded-lg border-2 font-bold transition-all ${
                        tempLearnedUpTo === topicNum
                          ? 'border-chemistry-green bg-green-50 text-chemistry-green'
                          : 'border-slate-200 text-slate-600 hover:border-slate-300'
                      }`}
                    >
                      {topicNum}
                    </button>
                  );
                })}
              </div>
            </div>

            {tempLearnedUpTo && learnedRangeTopics.length > 0 && (
              <div>
                <label className="block text-sm font-bold text-slate-700 mb-3">
                  {t('practiceMode.exceptions')}
                </label>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                  {learnedRangeTopics.map((topic) => {
                    const isException = tempExceptions.includes(topic);
                    return (
                      <button
                        key={topic}
                        onClick={() => setTempExceptions(prev =>
                          prev.includes(topic) ? prev.filter(t => t !== topic) : [...prev, topic]
                        )}
                        className={`flex items-center justify-between p-3 rounded-xl border-2 transition-all ${
                          isException
                            ? 'border-red-300 bg-red-50 text-red-700'
                            : 'border-green-200 bg-green-50 text-green-700'
                        }`}
                      >
                        <span className="text-sm font-semibold">{topic}</span>
                        {isException ? <Lock size={16} /> : <Check size={16} />}
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            <div className="flex gap-3">
              <button
                onClick={handleUpdateTopics}
                disabled={updating}
                className="flex-1 py-3 bg-chemistry-green text-white rounded-xl font-bold hover:opacity-90 disabled:bg-slate-300 transition-all"
              >
                {updating ? t('practiceMode.updating') : t('practiceMode.saveChanges')}
              </button>
              <button
                onClick={() => setShowUpdateTopics(false)}
                className="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-300 transition-all"
              >
                {t('common.cancel')}
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Custom mode configuration
  if (showCustom) {
    return (
      <div className="max-w-4xl mx-auto space-y-6 animate-in fade-in duration-500">
        <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
          <div className="bg-slate-50 p-6 border-b flex justify-between items-center">
            <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800">
              <Settings size={20} className="text-lab-blue" />
              {t('practiceMode.configureCustomSession')}
            </h2>
            <button
              onClick={() => setShowCustom(false)}
              className="text-sm text-slate-600 hover:text-slate-800 hover:underline font-semibold"
            >
              ‚Üê {t('practiceMode.back')}
            </button>
          </div>

          <div className="p-8 space-y-8">
            <div>
              <label className="block text-sm font-black text-slate-500 uppercase tracking-widest mb-4">
                {t('practiceMode.selectTopics')}
              </label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                {customTopics.map(({ name, available }) => (
                  <button
                    key={name}
                    onClick={() => available && toggleTopic(name)}
                    disabled={!available}
                    className={`flex items-center justify-between p-3 rounded-xl border-2 transition-all ${
                      !available
                        ? 'border-slate-200 bg-slate-50 text-slate-400 cursor-not-allowed opacity-50'
                        : selectedTopics.includes(name)
                        ? 'border-lab-blue bg-blue-50 text-lab-blue shadow-sm'
                        : 'border-slate-100 text-slate-600 hover:border-slate-200'
                    }`}
                  >
                    <span className="text-sm font-semibold flex items-center gap-2">
                      {!available && <Lock size={14} />}
                      {name}
                    </span>
                    {selectedTopics.includes(name) && <Check size={16} />}
                  </button>
                ))}
              </div>
              {customTopics.some(t => !t.available) && (
                <p className="text-xs text-amber-600 mt-2 flex items-center gap-1">
                  <Lock size={12} />
                  {t('practiceMode.lockedTopicsNotLearned')}
                </p>
              )}
            </div>

            {selectedTopics.length > 0 && availableSubtopics.length > 0 && (
              <div className="animate-in slide-in-from-top-4">
                <label className="block text-sm font-black text-slate-500 mb-4 uppercase tracking-widest">
                  {t('practiceMode.focusSubtopics')}
                </label>
                <div className="flex flex-wrap gap-2">
                  {availableSubtopics.map(sub => (
                    <button
                      key={sub}
                      onClick={() => toggleSubtopic(sub)}
                      className={`px-4 py-2 rounded-full text-xs font-bold border-2 transition-all ${
                        selectedSubtopics.includes(sub)
                        ? 'bg-lab-blue border-lab-blue text-white'
                        : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'
                      }`}
                    >
                      {sub}
                    </button>
                  ))}
                </div>
              </div>
            )}

            <div>
              <label className="block text-sm font-black text-slate-500 mb-4 uppercase tracking-widest">
                {t('practiceMode.sessionLength')}
              </label>
              <div className="grid grid-cols-3 md:grid-cols-6 gap-3">
                {['5', '10', '20', '36'].map(num => (
                  <button
                    key={num}
                    onClick={() => setCustomCount(num)}
                    className={`py-3 rounded-xl border-2 font-bold transition-all ${
                      customCount === num ? 'border-lab-blue bg-blue-50 text-lab-blue' : 'border-slate-100 text-slate-400'
                    }`}
                  >
                    {num}
                  </button>
                ))}
              </div>
            </div>

            {/* Timer Settings for Custom Mode */}
            <div className="space-y-4">
              <div className="bg-slate-50 rounded-xl p-4 border-2 border-slate-200">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <Clock size={20} className="text-lab-blue" />
                    <div>
                      <h3 className="font-bold text-slate-800">{t('quiz.enableTimer')}</h3>
                      <p className="text-xs text-slate-500">{t('quiz.trackTimeSpent')}</p>
                    </div>
                  </div>
                  <button
                    onClick={() => setCustomTimerEnabled(!customTimerEnabled)}
                    className={`relative w-14 h-8 rounded-full transition-all ${
                      customTimerEnabled ? 'bg-chemistry-green' : 'bg-slate-300'
                    }`}
                  >
                    <div className={`absolute top-1 left-1 w-6 h-6 bg-white rounded-full transition-transform ${
                      customTimerEnabled ? 'translate-x-6' : 'translate-x-0'
                    }`} />
                  </button>
                </div>
              </div>

              {customTimerEnabled && (
                <div className="bg-amber-50 rounded-xl p-4 border-2 border-amber-200 animate-in fade-in">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <Zap size={20} className="text-amber-600" />
                      <div>
                        <h3 className="font-bold text-amber-900">{t('quiz.timedMode')}</h3>
                        <p className="text-xs text-amber-700">{t('quiz.countdownTimer')}</p>
                      </div>
                    </div>
                    <button
                      onClick={() => setCustomIsTimed(!customIsTimed)}
                      className={`relative w-14 h-8 rounded-full transition-all ${
                        customIsTimed ? 'bg-amber-600' : 'bg-slate-300'
                      }`}
                    >
                      <div className={`absolute top-1 left-1 w-6 h-6 bg-white rounded-full transition-transform ${
                        customIsTimed ? 'translate-x-6' : 'translate-x-0'
                      }`} />
                    </button>
                  </div>
                </div>
              )}
            </div>

            <button 
              disabled={selectedTopics.length === 0}
              onClick={handleCustomStart}
              className="w-full py-5 bg-lab-blue text-white rounded-2xl font-black text-lg shadow-lg hover:bg-blue-800 disabled:bg-slate-200 transition-all flex items-center justify-center gap-2 active:scale-95"
            >
              <Play fill="currentColor" size={18} />
              {t('practiceMode.startPractice')}
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Main mode selection screen
  return (
    <div className="max-w-6xl mx-auto space-y-6 animate-in fade-in duration-500">
      <div className="text-center mb-8">
        <h1 className="text-4xl font-black text-academic-charcoal mb-2">
          {t('practice.selectMode')}
        </h1>
        <p className="text-academic-light-slate text-lg">
          {t('practice.chooseHowPractice')}
        </p>
      </div>

      {/* Available Topics Info + Update Button */}
      {availableTopics.length > 0 ? (
        <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
          <div className="flex justify-between items-start mb-2">
            <div>
              <h3 className="font-bold text-blue-900 flex items-center gap-2">
                <BookOpen size={16} />
                {t('practice.yourAvailableTopics')} ({availableTopics.length})
              </h3>
              <div className="flex flex-wrap gap-2 mt-2">
                {availableTopics.slice(0, 8).map((topic) => (
                  <span key={topic} className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-bold">
                    {topic}
                  </span>
                ))}
                {availableTopics.length > 8 && (
                  <span className="px-2 py-1 text-blue-700 text-xs font-bold">
                    +{availableTopics.length - 8} {t('practice.more')}
                  </span>
                )}
              </div>
            </div>
            <button
              onClick={() => setShowUpdateTopics(true)}
              className="px-4 py-2 bg-lab-blue text-white rounded-lg font-bold text-sm hover:bg-blue-700 transition-all whitespace-nowrap"
            >
              {t('practice.updateTopics')}
            </button>
          </div>
        </div>
      ) : (
        <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-4">
          <div className="flex items-start gap-3">
            <AlertCircle className="text-amber-600 flex-shrink-0 mt-0.5" size={20} />
            <div className="flex-1">
              <p className="text-amber-900 font-bold mb-2">
                {t('practice.noTopicsConfigured')}
              </p>
              <p className="text-amber-800 text-sm mb-3">
                {t('practice.pleaseSetTopics')}
              </p>
              <button
                onClick={() => navigate('/profile')}
                className="px-4 py-2 bg-amber-600 text-white rounded-lg font-bold hover:bg-amber-700 transition-all"
              >
                {t('practice.goToProfile')}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Mode Selection Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {/* AI DAILY MISSION */}
        <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden lg:col-span-3">
          <div className="bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 p-6 text-white">
            <div className="flex items-center gap-3 mb-2">
              <Sparkles size={32} strokeWidth={3} />
              <h3 className="text-2xl font-black">
                {t('notebook.aiDailyMission')}
              </h3>
              <div className="ml-auto">
                <div className="bg-white/20 rounded-full px-3 py-1 text-xs font-bold">
                  10 {t('practice.questions')}
                </div>
              </div>
            </div>
            <p className="text-purple-100 text-sm">
              {t('notebook.interleavedPractice')}
            </p>
          </div>
          
          <div className="p-6">
            <div className="mb-4">
              <h4 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                <Brain size={18} className="text-purple-600" />
                How AI Optimizes Your Learning
              </h4>
              <div className="space-y-2 text-sm text-slate-600">
                <div className="flex items-start gap-2">
                  <div className="w-2 h-2 bg-purple-500 rounded-full mt-1.5 flex-shrink-0" />
                  <p><strong>Spaced Repetition:</strong> Questions you haven't seen in a while are prioritized to strengthen long-term retention</p>
                </div>
                <div className="flex items-start gap-2">
                  <div className="w-2 h-2 bg-indigo-500 rounded-full mt-1.5 flex-shrink-0" />
                  <p><strong>Difficulty Balancing:</strong> Mixes questions at your current mastery level with challenging ones to optimize learning</p>
                </div>
                <div className="flex items-start gap-2">
                  <div className="w-2 h-2 bg-blue-500 rounded-full mt-1.5 flex-shrink-0" />
                  <p><strong>Topic Interleaving:</strong> Alternates between topics to improve concept retention and prevent cramming</p>
                </div>
                <div className="flex items-start gap-2">
                  <div className="w-2 h-2 bg-purple-500 rounded-full mt-1.5 flex-shrink-0" />
                  <p><strong>Adaptive Focus:</strong> Emphasizes topics from your recent quizzes while maintaining a balanced review</p>
                </div>
              </div>
            </div>
            
            <button
              onClick={() => handleModeSelect('ai-daily', 10)}
              disabled={loadingMistakes}
              className="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-black text-lg hover:from-purple-700 hover:to-indigo-700 disabled:from-slate-300 disabled:to-slate-400 transition-all flex items-center justify-center gap-2 shadow-lg"
            >
              {loadingMistakes ? (
                <>
                  <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white" />
                  Loading...
                </>
              ) : (
                <>
                  <Sparkles size={20} />
                  Start AI Daily Mission
                </>
              )}
            </button>
          </div>
        </div>

        {/* TIMED MODE */}
        <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
          <div className="bg-red-500 p-6 text-white">
            <div className="flex items-center gap-3 mb-2">
              <Clock size={32} strokeWidth={3} />
              <h3 className="text-2xl font-black">
                {t('practice.timed')}
              </h3>
            </div>
            <p className="text-red-100 text-sm">
              1.25 {t('practice.perQuestion')}
            </p>
          </div>
          
          <div className="p-6 space-y-4">
            <p className="text-sm text-slate-600">
              {t('practice.perfectForExam')}
            </p>

            {/* Timer Settings */}
            <div className="space-y-2 text-xs">
              <div className="flex items-center justify-between p-2 bg-slate-50 rounded">
                <span className="text-slate-700">{t('quiz.showTimer')}</span>
                <button
                  onClick={() => setTimedModeTimer(!timedModeTimer)}
                  className={`w-10 h-5 rounded-full transition-all ${timedModeTimer ? 'bg-green-500' : 'bg-slate-300'}`}
                >
                  <div className={`w-4 h-4 bg-white rounded-full transition-transform ${timedModeTimer ? 'translate-x-5' : 'translate-x-0.5'}`} />
                </button>
              </div>
              <div className="flex items-center justify-between p-2 bg-slate-50 rounded">
                <span className="text-slate-700">{t('quiz.countdown')}</span>
                <button
                  onClick={() => setTimedModeIsTimed(!timedModeIsTimed)}
                  className={`w-10 h-5 rounded-full transition-all ${timedModeIsTimed ? 'bg-red-500' : 'bg-slate-300'}`}
                >
                  <div className={`w-4 h-4 bg-white rounded-full transition-transform ${timedModeIsTimed ? 'translate-x-5' : 'translate-x-0.5'}`} />
                </button>
              </div>
            </div>
            
            <div>
              <label className="block text-xs font-bold text-slate-500 mb-2 uppercase">
                {t('practice.questions')}
              </label>
              <div className="grid grid-cols-2 gap-2">
                {[5, 10, 20, 36].map(num => (
                  <button
                    key={num}
                    onClick={() => handleModeSelect('timed', num, timedModeTimer, timedModeIsTimed)}
                    disabled={availableTopics.length === 0}
                    className="py-2 bg-red-50 border-2 border-red-200 text-red-700 rounded-lg font-bold hover:bg-red-100 disabled:bg-slate-100 disabled:text-slate-400 disabled:border-slate-200 transition-all"
                  >
                    {num}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* MARATHON MODE */}
        <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
          <div className="bg-purple-600 p-6 text-white">
            <div className="flex items-center gap-3 mb-2">
              <Infinity size={32} strokeWidth={3} />
              <h3 className="text-2xl font-black">
                {t('practice.marathon')}
              </h3>
            </div>
            <p className="text-purple-100 text-sm">
              {t('practice.marathonDesc').split(' - ')[0]}
            </p>
          </div>
          
          <div className="p-6 space-y-4">
            <p className="text-sm text-slate-600">
              {t('practice.takeYourTime')}
            </p>

            {/* Timer Settings */}
            <div className="space-y-2 text-xs">
              <div className="flex items-center justify-between p-2 bg-slate-50 rounded">
                <span className="text-slate-700">{t('quiz.showTimer')}</span>
                <button
                  onClick={() => setMarathonModeTimer(!marathonModeTimer)}
                  className={`w-10 h-5 rounded-full transition-all ${marathonModeTimer ? 'bg-green-500' : 'bg-slate-300'}`}
                >
                  <div className={`w-4 h-4 bg-white rounded-full transition-transform ${marathonModeTimer ? 'translate-x-5' : 'translate-x-0.5'}`} />
                </button>
              </div>
              <div className="flex items-center justify-between p-2 bg-slate-50 rounded">
                <span className="text-slate-700">{t('quiz.countdown')}</span>
                <button
                  onClick={() => setMarathonModeIsTimed(!marathonModeIsTimed)}
                  className={`w-10 h-5 rounded-full transition-all ${marathonModeIsTimed ? 'bg-purple-500' : 'bg-slate-300'}`}
                >
                  <div className={`w-4 h-4 bg-white rounded-full transition-transform ${marathonModeIsTimed ? 'translate-x-5' : 'translate-x-0.5'}`} />
                </button>
              </div>
            </div>
            
            <div>
              <label className="block text-xs font-bold text-slate-500 mb-2 uppercase">
                {t('practice.questions')}
              </label>
              <div className="grid grid-cols-2 gap-2">
                {[5, 10, 20, 36].map(num => (
                  <button
                    key={num}
                    onClick={() => handleModeSelect('marathon', num, marathonModeTimer, marathonModeIsTimed)}
                    disabled={availableTopics.length === 0}
                    className="py-2 bg-purple-50 border-2 border-purple-200 text-purple-700 rounded-lg font-bold hover:bg-purple-100 disabled:bg-slate-100 disabled:text-slate-400 disabled:border-slate-200 transition-all"
                  >
                    {num}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* CUSTOM MODE */}
        <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
          <div className="bg-lab-blue p-6 text-white">
            <div className="flex items-center gap-3 mb-2">
              <Settings size={32} strokeWidth={3} />
              <h3 className="text-2xl font-black">
                {t('practice.custom')}
              </h3>
            </div>
            <p className="text-blue-100 text-sm">
              {t('practice.customDesc').split(' - ')[0]}
            </p>
          </div>
          
          <div className="p-6 space-y-4">
            <p className="text-sm text-slate-600">
              {t('practice.chooseSpecificTopics')}
            </p>
            
            <button
              onClick={() => handleModeSelect('custom', 10)}
              disabled={availableTopics.length === 0}
              className="w-full py-3 bg-lab-blue text-white rounded-xl font-bold hover:bg-blue-700 disabled:bg-slate-300 transition-all"
            >
              {t('practice.configure')}
            </button>
          </div>
        </div>

        {/* MISTAKE NOTEBOOK MODE */}
        <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden lg:col-span-3">
          <div className="bg-rose-500 p-6 text-white">
            <div className="flex items-center gap-3 mb-2">
              <Heart size={32} strokeWidth={3} />
              <h3 className="text-2xl font-black">
                {t('notebook.title')}
              </h3>
            </div>
            <p className="text-rose-100 text-sm">
              {t('notebook.reviewMaster')}
            </p>
          </div>
          
          <div className="p-6">
            <p className="text-sm text-slate-600 mb-4">
              {t('notebook.practiceUntilMaster')}
            </p>
            
            <button
              onClick={() => handleModeSelect('mistakes', 0)}
              className="w-full py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 transition-all"
            >
              {t('notebook.review')}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ========== src/pages/ProfilePage.jsx ==========

import React, { useState, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { updateProfile } from 'firebase/auth';
import { doc, updateDoc } from 'firebase/firestore';
import { db } from '../firebase/config';
import { User, GraduationCap, Mail, Calendar, Save, ArrowLeft, Trophy, Target, BookOpen, Lock, Unlock } from 'lucide-react';
import { useQuizData } from '../hooks/useQuizData';

const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTK36yaUN-NMCkQNT-DAHgc6FMZPjUc0Yv3nYEK4TA9W2qE9V1TqVD10Tq98-wXQoAvKOZlwGWRSDkU/pub?gid=1182550140&single=true&output=csv';

export default function ProfilePage() {
  const { currentUser, userProfile, loadUserProfile } = useAuth();
  const { t } = useLanguage();
  const navigate = useNavigate();
  const { questions, loading: questionsLoading } = useQuizData(SHEET_URL);
  
  const [displayName, setDisplayName] = useState(currentUser?.displayName || '');
  const [level, setLevel] = useState(userProfile?.level || 'S5');
  const [learnedUpTo, setLearnedUpTo] = useState(userProfile?.learnedUpTo || '');
  const [topicExceptions, setTopicExceptions] = useState(userProfile?.topicExceptions || []);
  const [saving, setSaving] = useState(false);
  const [message, setMessage] = useState({ type: '', text: '' });

  // Extract all unique topics from questions
  const allTopics = useMemo(() => {
    if (!questions || questions.length === 0) return [];
    return [...new Set(questions.map(q => q.Topic))]
      .filter(t => t && t !== "Uncategorized")
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
  }, [questions]);

  // Get currently available topics based on learnedUpTo and exceptions
  const availableTopics = useMemo(() => {
    if (!learnedUpTo) return [];
    
    const available = [];
    for (const topic of allTopics) {
      const topicNum = topic.match(/^\d+/)?.[0];
      if (topicNum && topicNum <= learnedUpTo && !topicExceptions.includes(topic)) {
        available.push(topic);
      }
    }
    return available;
  }, [allTopics, learnedUpTo, topicExceptions]);

  // Get topics that are within learned range (for exceptions UI)
  const learnedRangeTopics = useMemo(() => {
    if (!learnedUpTo) return [];
    
    return allTopics.filter(topic => {
      const topicNum = topic.match(/^\d+/)?.[0];
      return topicNum && topicNum <= learnedUpTo;
    });
  }, [allTopics, learnedUpTo]);

  const toggleTopicException = (topic) => {
    setTopicExceptions(prev => 
      prev.includes(topic) 
        ? prev.filter(t => t !== topic)
        : [...prev, topic]
    );
  };

  async function handleSave(e) {
    e.preventDefault();
    setSaving(true);
    setMessage({ type: '', text: '' });

    try {
      // Update Firebase Auth profile
      await updateProfile(currentUser, {
        displayName: displayName
      });

      // Update Firestore user document
      const userRef = doc(db, 'users', currentUser.uid);
      await updateDoc(userRef, {
        displayName: displayName,
        level: level,
        learnedUpTo: learnedUpTo,
        topicExceptions: topicExceptions,
        updatedAt: new Date().toISOString()
      });

      // Reload user profile
      await loadUserProfile(currentUser.uid);

      setMessage({ 
        type: 'success', 
        text: t('profile.profileUpdated')
      });
    } catch (error) {
      console.error('Error updating profile:', error);
      setMessage({ 
        type: 'error', 
        text: t('profile.failedUpdate')
      });
    }

    setSaving(false);
  }

  const formatDate = (isoString) => {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    return date.toLocaleDateString('en-GB', { 
      day: '2-digit', 
      month: 'short', 
      year: 'numeric'
    });
  };

  const overallAccuracy = userProfile?.totalQuestions > 0
    ? Math.round((userProfile.totalCorrect / userProfile.totalQuestions) * 100)
    : 0;

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={() => navigate('/dashboard')}
          className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all"
        >
          <ArrowLeft size={20} />
        </button>
        
        <div className="flex-1 bg-gradient-to-r from-lab-blue to-blue-700 rounded-2xl shadow-xl p-6 text-white">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <User size={32} />
            {t('profile.profileSettings')}
          </h1>
          <p className="text-blue-100 mt-1">
            {t('profile.manageAccount')}
          </p>
        </div>
      </div>

      {/* Stats Summary */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-slate-50 p-4 border-b">
          <h2 className="text-lg font-bold text-slate-800">
            {t('profile.yourStatistics')}
          </h2>
        </div>
        
        <div className="p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
            <div className="flex items-center gap-2 mb-2">
              <Trophy className="text-lab-blue" size={20} />
              <span className="text-sm font-semibold text-slate-600">
                {t('profile.totalAttempts')}
              </span>
            </div>
            <div className="text-3xl font-black text-lab-blue">
              {userProfile?.totalAttempts || 0}
            </div>
          </div>

          <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
            <div className="flex items-center gap-2 mb-2">
              <Target className="text-chemistry-green" size={20} />
              <span className="text-sm font-semibold text-slate-600">
                {t('profile.overallAccuracy')}
              </span>
            </div>
            <div className="text-3xl font-black text-chemistry-green">
              {overallAccuracy}%
            </div>
          </div>

          <div className="bg-purple-50 rounded-xl p-4 border-2 border-purple-200">
            <div className="flex items-center gap-2 mb-2">
              <GraduationCap className="text-purple-600" size={20} />
              <span className="text-sm font-semibold text-slate-600">
                {t('profile.questionsSolved')}
              </span>
            </div>
            <div className="text-3xl font-black text-purple-600">
              {userProfile?.totalQuestions || 0}
            </div>
          </div>
        </div>
      </div>

      {/* Profile Form */}
      <form onSubmit={handleSave} className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-slate-50 p-4 border-b">
          <h2 className="text-lg font-bold text-slate-800">
            {t('profile.accountInformation')}
          </h2>
        </div>

        <div className="p-6 space-y-6">
          {/* Success/Error Message */}
          {message.text && (
            <div className={`p-4 rounded-lg border-2 ${
              message.type === 'success' 
                ? 'bg-green-50 border-green-200 text-green-800' 
                : 'bg-red-50 border-red-200 text-red-800'
            }`}>
              <p className="font-semibold">{message.text}</p>
            </div>
          )}

          {/* Display Name */}
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <User size={16} />
              {t('profile.displayName')}
            </label>
            <input
              type="text"
              value={displayName}
              onChange={(e) => setDisplayName(e.target.value)}
              required
              className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-lab-blue focus:ring-2 focus:ring-blue-100 outline-none transition-all"
              placeholder={t('profile.enterYourName')}
            />
          </div>

          {/* Email (Read-only) */}
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <Mail size={16} />
              {t('profile.email')}
            </label>
            <input
              type="email"
              value={currentUser?.email || ''}
              disabled
              className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg bg-slate-50 text-slate-500 cursor-not-allowed"
            />
            <p className="text-xs text-slate-500 mt-1">
              {t('profile.emailCannotChange')}
            </p>
          </div>

          {/* School Level */}
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <GraduationCap size={16} />
              {t('profile.schoolLevel')}
            </label>
            <div className="grid grid-cols-3 gap-3">
              {['S4', 'S5', 'S6'].map((lvl) => (
                <button
                  key={lvl}
                  type="button"
                  onClick={() => setLevel(lvl)}
                  className={`py-3 rounded-xl border-2 font-bold transition-all ${
                    level === lvl
                      ? 'border-lab-blue bg-blue-50 text-lab-blue'
                      : 'border-slate-200 text-slate-600 hover:border-slate-300'
                  }`}
                >
                  {lvl}
                </button>
              ))}
            </div>
            <p className="text-xs text-slate-500 mt-2">
              {t('profile.selectCurrentForm')}
            </p>
          </div>

          {/* LEARNED UP TO SELECTOR */}
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <BookOpen size={16} />
              {t('profile.topicsLearnedUpTo')}
            </label>
            <p className="text-xs text-slate-500 mb-3">
              {t('profile.selectHighestTopic')}
            </p>
            <div className="grid grid-cols-6 md:grid-cols-8 gap-2">
              {allTopics.map((topic) => {
                const topicNum = topic.match(/^\d+/)?.[0];
                return (
                  <button
                    key={topic}
                    type="button"
                    onClick={() => setLearnedUpTo(topicNum)}
                    className={`py-2 rounded-lg border-2 font-bold transition-all text-sm ${
                      learnedUpTo === topicNum
                        ? 'border-chemistry-green bg-green-50 text-chemistry-green'
                        : 'border-slate-200 text-slate-600 hover:border-slate-300'
                    }`}
                    title={topic}
                  >
                    {topicNum}
                  </button>
                );
              })}
            </div>
          </div>

          {/* TOPIC EXCEPTIONS */}
          {learnedUpTo && learnedRangeTopics.length > 0 && (
            <div className="border-t-2 border-slate-100 pt-6">
              <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                <Lock size={16} />
                {t('profile.topicExceptionsLabel')}
              </label>
              <p className="text-xs text-slate-500 mb-3">
                {t('profile.clickToExclude')}
              </p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                {learnedRangeTopics.map((topic) => {
                  const isException = topicExceptions.includes(topic);
                  return (
                    <button
                      key={topic}
                      type="button"
                      onClick={() => toggleTopicException(topic)}
                      className={`flex items-center justify-between p-3 rounded-xl border-2 transition-all ${
                        isException
                          ? 'border-red-300 bg-red-50 text-red-700'
                          : 'border-green-200 bg-green-50 text-green-700'
                      }`}
                    >
                      <span className="text-sm font-semibold">{topic}</span>
                      {isException ? (
                        <Lock size={16} className="text-red-600" />
                      ) : (
                        <Unlock size={16} className="text-green-600" />
                      )}
                    </button>
                  );
                })}
              </div>
            </div>
          )}

          {/* Available Topics Preview */}
          {availableTopics.length > 0 && (
            <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
              <h3 className="font-bold text-blue-900 mb-2 flex items-center gap-2">
                <BookOpen size={16} />
                {t('profile.yourAvailableTopicsCount')} ({availableTopics.length})
              </h3>
              <div className="flex flex-wrap gap-2">
                {availableTopics.map((topic) => (
                  <span
                    key={topic}
                    className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold"
                  >
                    {topic}
                  </span>
                ))}
              </div>
              <p className="text-xs text-blue-700 mt-2">
                {t('profile.theseTopicsWillAppear')}
              </p>
            </div>
          )}

          {/* Account Created Date */}
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <Calendar size={16} />
              {t('profile.memberSince')}
            </label>
            <div className="px-4 py-3 border-2 border-slate-200 rounded-lg bg-slate-50 text-slate-700 font-semibold">
              {formatDate(userProfile?.createdAt)}
            </div>
          </div>

          {/* Save Button */}
          <button
            type="submit"
            disabled={saving || questionsLoading}
            className="w-full py-4 bg-lab-blue text-white rounded-xl font-bold text-lg shadow-lg hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2 active:scale-95"
          >
            {saving ? (
              <>
                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                {t('profile.saving')}
              </>
            ) : (
              <>
                <Save size={20} />
                {t('profile.saveChanges')}
              </>
            )}
          </button>
        </div>
      </form>
    </div>
  );
}

// ========== src/pages/QuizPage.jsx ==========

import React, { useState, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { useLanguage } from '../contexts/LanguageContext';
import QuestionCard from '../components/QuestionCard';
import { ChevronLeft, ChevronRight, Send, Timer, FlaskConical, Flag, Clock, X, Home, Menu } from 'lucide-react';
import { quizStorage } from '../utils/quizStorage';

export default function QuizPage() {
  const navigate = useNavigate();
  const { t } = useLanguage();
  
  const questions = quizStorage.getSelectedQuestions();
  const practiceMode = localStorage.getItem('quiz_mode') || 'timed'; // timed, marathon, custom, mistakes
  
  useEffect(() => {
    if (!questions || questions.length === 0) {
      navigate('/');
    }
  }, [questions, navigate]);

  const [currentIndex, setCurrentIndex] = useState(() => quizStorage.getCurrentIndex());
  const [answers, setAnswers] = useState(() => quizStorage.getUserAnswers());
  const [flagged, setFlagged] = useState(() => quizStorage.getFlagged());
  const [showPeriodicTable, setShowPeriodicTable] = useState(false);
  const [showQuestionPanel, setShowQuestionPanel] = useState(false);
  const [showMobileMenu, setShowMobileMenu] = useState(false);
  const [timerEnabled, setTimerEnabled] = useState(() => {
    const saved = localStorage.getItem('quiz_timer_enabled');
    return saved === 'true';
  });
  const [isTimedMode, setIsTimedMode] = useState(() => {
    const saved = localStorage.getItem('quiz_is_timed_mode');
    return saved === 'true';
  });
  const [questionTimes, setQuestionTimes] = useState(() => quizStorage.getQuestionTimes());
  const [currentQuestionStartTime, setCurrentQuestionStartTime] = useState(null);
  const [currentTime, setCurrentTime] = useState(Date.now());
  const [sessionStartTime, setSessionStartTime] = useState(() => quizStorage.getSessionStart());

  // Calculate time limit for timed mode (questions √ó 1.25 minutes in milliseconds)
  const timeLimit = isTimedMode ? questions.length * 1.25 * 60 * 1000 : 0;

  // Prevent accidental navigation away
  useEffect(() => {
    const handleBeforeUnload = (e) => {
      e.preventDefault();
      e.returnValue = '';
      return '';
    };
    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, []);

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e) => {
      const activeElement = document.activeElement;
      if (
        activeElement &&
        (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')
      ) return;
      if (showPeriodicTable || showMobileMenu) return;
      if (!questions || questions.length === 0) return;

      const currentQuestion = questions[currentIndex];
      const key = e.key.toUpperCase();

      if (['A', 'B', 'C', 'D'].includes(key)) {
        e.preventDefault();
        const currentAnswer = answers[currentQuestion.ID];
        if (currentAnswer === key) {
          setAnswers(prev => ({ ...prev, [currentQuestion.ID]: null }));
        } else {
          setAnswers(prev => ({ ...prev, [currentQuestion.ID]: key }));
        }
        return;
      }

      if (e.key === 'Enter') {
        e.preventDefault();
        if (currentIndex < questions.length - 1) {
          nextQuestion();
        } else if (allAnswered) {
          handleComplete();
        }
        return;
      }

      if (e.key === 'ArrowRight' && currentIndex < questions.length - 1) {
        e.preventDefault();
        nextQuestion();
        return;
      }
      if (e.key === 'ArrowLeft' && currentIndex > 0) {
        e.preventDefault();
        prevQuestion();
        return;
      }

      if (key === 'F') {
        e.preventDefault();
        toggleFlag();
        return;
      }

      if (key === 'O') {
        e.preventDefault();
        setShowQuestionPanel(prev => !prev);
        return;
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [currentIndex, answers, showPeriodicTable, showQuestionPanel, showMobileMenu, questions]);

  // Persist state to localStorage
  useEffect(() => { quizStorage.saveCurrentIndex(currentIndex); }, [currentIndex]);
  useEffect(() => { quizStorage.saveUserAnswers(answers); }, [answers]);
  useEffect(() => { quizStorage.saveFlagged(flagged); }, [flagged]);
  useEffect(() => { quizStorage.saveQuestionTimes(questionTimes); }, [questionTimes]);
  useEffect(() => { if (sessionStartTime !== null) quizStorage.saveSessionStart(sessionStartTime); }, [sessionStartTime]);

  if (!questions || questions.length === 0) return null;

  const currentQuestion = questions[currentIndex];
  const totalQuestions = questions.length;
  const progress = ((currentIndex + 1) / totalQuestions) * 100;
  const allAnswered = questions.every(q => answers[q.ID]);

  // Initialize timer on mount
  useEffect(() => {
    if (timerEnabled && !sessionStartTime) {
      const now = Date.now();
      setCurrentQuestionStartTime(now);
      setSessionStartTime(now);
    }
  }, []);

  useEffect(() => {
    if (!timerEnabled) return;
    const interval = setInterval(() => setCurrentTime(Date.now()), 1000);
    return () => clearInterval(interval);
  }, [timerEnabled]);

  useEffect(() => {
    if (timerEnabled && currentQuestion) setCurrentQuestionStartTime(Date.now());
  }, [currentIndex, timerEnabled]);

  const recordQuestionTime = () => {
    if (timerEnabled && currentQuestionStartTime) {
      const timeSpent = Date.now() - currentQuestionStartTime;
      setQuestionTimes(prev => ({
        ...prev,
        [currentQuestion.ID]: (prev[currentQuestion.ID] || 0) + timeSpent
      }));
    }
  };

  const handleOptionSelect = (option) => {
    setAnswers(prev => ({ ...prev, [currentQuestion.ID]: option }));
  };

  const toggleFlag = () => {
    const questionId = currentQuestion.ID;
    setFlagged(prev => {
      const newSet = new Set(prev);
      if (newSet.has(questionId)) newSet.delete(questionId);
      else newSet.add(questionId);
      return newSet;
    });
  };

  const nextQuestion = () => {
    recordQuestionTime();
    if (currentIndex < totalQuestions - 1) setCurrentIndex(currentIndex + 1);
  };

  const prevQuestion = () => {
    recordQuestionTime();
    if (currentIndex > 0) setCurrentIndex(currentIndex - 1);
  };

  const jumpToQuestion = (index) => {
    recordQuestionTime();
    setCurrentIndex(index);
    setShowQuestionPanel(false);
  };

  const handleBackToTopics = () => {
    const confirmed = window.confirm(t('quiz.confirmBackToTopics'));
    if (confirmed) {
      quizStorage.clearQuizData();
      localStorage.removeItem('quiz_mode');
      localStorage.removeItem('quiz_timer_enabled');
      localStorage.removeItem('quiz_is_timed_mode');
      navigate('/');
    }
  };

  const handleComplete = () => {
    recordQuestionTime();
    quizStorage.saveUserAnswers(answers);
    quizStorage.saveQuestionTimes(questionTimes);
    navigate('/results');
  };

  const isLastQuestion = currentIndex === totalQuestions - 1;

  const getTotalTimeSpent = () => {
    const accumulated = Object.values(questionTimes).reduce((sum, t) => sum + t, 0);
    if (timerEnabled && currentQuestionStartTime) {
      return accumulated + (currentTime - currentQuestionStartTime);
    }
    return accumulated;
  };

  const getCurrentQuestionTime = () => {
    const accumulated = questionTimes[currentQuestion.ID] || 0;
    if (timerEnabled && currentQuestionStartTime) {
      return accumulated + (currentTime - currentQuestionStartTime);
    }
    return accumulated;
  };

  const getSessionTime = () => {
    if (timerEnabled && sessionStartTime) return currentTime - sessionStartTime;
    return 0;
  };

  const getTimeRemaining = () => {
    if (!isTimedMode || !sessionStartTime) return 0;
    const elapsed = currentTime - sessionStartTime;
    const remaining = timeLimit - elapsed;
    return Math.max(0, remaining);
  };

  const formatTime = (ms) => {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hrs = Math.floor(minutes / 60);
    if (hrs > 0) return `${hrs}:${String(minutes % 60).padStart(2, '0')}:${String(seconds % 60).padStart(2, '0')}`;
    return `${minutes}:${String(seconds % 60).padStart(2, '0')}`;
  };

  const getQuestionStatus = (q) => {
    if (answers[q.ID]) return 'answered';
    if (flagged.has(q.ID)) return 'flagged';
    return 'skipped';
  };

  const totalTimeSpent = getTotalTimeSpent();
  const currentQuestionTime = getCurrentQuestionTime();
  const sessionTime = getSessionTime();
  const timeRemaining = getTimeRemaining();

  // Check if time's up in timed mode
  useEffect(() => {
    if (isTimedMode && timeRemaining === 0 && sessionStartTime) {
      alert(t('quiz.timeUp'));
      handleComplete();
    }
  }, [timeRemaining, isTimedMode]);

  return (
    <div className="relative min-h-screen pb-32 md:pb-6">
      {/* Keyboard shortcut hint (desktop only) */}
      <div className="hidden md:flex fixed top-20 left-1/2 -translate-x-1/2 z-20 items-center gap-3 bg-white/90 backdrop-blur border border-slate-200 rounded-full px-4 py-1.5 shadow-sm text-xs text-slate-500">
        <span>{t('quiz.type')} <kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">A</kbd> <kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">B</kbd> <kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">C</kbd> <kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">D</kbd> {t('quiz.toSelect')}</span>
        <span className="text-slate-300">|</span>
        <span><kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">Enter</kbd> / <kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">‚Üí</kbd> {t('quiz.next')}</span>
        <span className="text-slate-300">|</span>
        <span><kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">F</kbd> {t('quiz.flag')}</span>
        <span className="text-slate-300">|</span>
        <span><kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">O</kbd> {t('quiz.overview')}</span>
      </div>

      {/* Mobile Tools */}
      <button
        onClick={() => setShowMobileMenu(!showMobileMenu)}
        className="md:hidden fixed top-20 right-4 z-40 flex items-center gap-2 px-4 py-2 bg-lab-blue text-white rounded-lg font-bold shadow-lg"
      >
        <Menu size={18} />{t('quiz.tools')}
      </button>

      {showMobileMenu && (
        <>
          <div className="md:hidden fixed inset-0 bg-black bg-opacity-25 z-40" onClick={() => setShowMobileMenu(false)} />
          <div className="md:hidden fixed top-32 right-4 bg-white rounded-xl shadow-2xl border-2 border-slate-200 z-50 overflow-hidden min-w-[200px]">
            <button onClick={() => { handleBackToTopics(); setShowMobileMenu(false); }}
              className="w-full flex items-center gap-2 px-4 py-3 hover:bg-slate-50 transition-all text-left border-b">
              <Home size={18} className="text-red-500" />
              <span className="font-semibold text-red-600">{t('quiz.backToTopics')}</span>
            </button>
            <button onClick={() => { setShowPeriodicTable(true); setShowMobileMenu(false); }}
              className="w-full flex items-center gap-2 px-4 py-3 hover:bg-slate-50 transition-all text-left border-b">
              <FlaskConical size={18} className="text-purple-600" />
              <span className="font-semibold text-slate-700">{t('quiz.periodicTable')}</span>
            </button>
            <button onClick={() => { setShowQuestionPanel(true); setShowMobileMenu(false); }}
              className="w-full flex items-center gap-2 px-4 py-3 hover:bg-slate-50 transition-all text-left border-b">
              <Flag size={18} className="text-slate-700" />
              <span className="font-semibold text-slate-700">{t('quiz.overview')}</span>
            </button>
            <button onClick={() => { toggleFlag(); setShowMobileMenu(false); }}
              className={`w-full flex items-center gap-2 px-4 py-3 hover:bg-slate-50 transition-all text-left ${flagged.has(currentQuestion?.ID) ? 'bg-amber-50' : ''}`}>
              <Flag size={18} className="text-amber-500" fill={flagged.has(currentQuestion?.ID) ? 'currentColor' : 'none'} />
              <span className="font-semibold text-slate-700">{flagged.has(currentQuestion?.ID) ? t('quiz.unflagQuestion') : t('quiz.flagQuestion')}</span>
            </button>
          </div>
        </>
      )}

      {/* Desktop Back Button */}
      <button onClick={handleBackToTopics}
        className="hidden md:flex fixed left-8 top-24 z-30 items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition-all shadow-lg hover:scale-105 active:scale-95">
        <Home size={18} /><span>{t('quiz.backToTopics')}</span>
      </button>

      {/* Desktop Left Sidebar */}
      <div className="hidden md:flex fixed left-8 top-40 flex-col gap-4 z-30 h-[calc(100vh-12rem)]">
        {timerEnabled && (
          <div className="bg-white rounded-2xl shadow-xl border-2 border-lab-blue p-6 w-48">
            <div className="text-center">
              <div className="flex items-center justify-center gap-2 mb-2">
                <Timer className="text-lab-blue" size={24} />
                <span className="text-sm font-bold text-slate-600">{t('quiz.totalTime')}</span>
              </div>
              <div className="text-4xl font-black text-lab-blue mb-4 font-mono">{formatTime(sessionTime)}</div>
              
              {isTimedMode && (
                <div className="mb-4 pb-4 border-b border-slate-200">
                  <div className="text-xs text-slate-500 mb-1">{t('quiz.timeRemaining')}</div>
                  <div className={`text-2xl font-black font-mono ${timeRemaining < 60000 ? 'text-red-600' : 'text-amber-600'}`}>
                    {formatTime(timeRemaining)}
                  </div>
                </div>
              )}
              
              <div className="text-xs text-slate-500 space-y-2">
                <div className="flex justify-between pt-2 border-t">
                  <span>{t('quiz.thisQuestion')}</span>
                  <span className="font-bold text-lab-blue">{formatTime(currentQuestionTime)}</span>
                </div>
              </div>
            </div>
          </div>
        )}
        <button onClick={() => setShowPeriodicTable(true)}
          className="flex items-center gap-2 px-6 py-4 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition-all shadow-lg hover:scale-105 active:scale-95">
          <FlaskConical size={20} /><span>{t('quiz.periodicTable')}</span>
        </button>
        <button onClick={() => setShowQuestionPanel(!showQuestionPanel)}
          className="flex items-center gap-2 px-6 py-4 bg-slate-700 text-white rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg hover:scale-105 active:scale-95">
          <Flag size={20} /><span>{t('quiz.overview')}</span>
        </button>
        <div className="flex-1" />
        <button onClick={prevQuestion} disabled={currentIndex === 0}
          className="flex items-center justify-center w-16 h-16 bg-lab-blue text-white rounded-full font-bold hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all shadow-lg hover:scale-110 active:scale-95">
          <ChevronLeft size={32} />
        </button>
      </div>

      {/* Desktop Right Sidebar */}
      <div className="hidden md:flex fixed right-8 top-40 flex-col gap-4 z-30 h-[calc(100vh-12rem)]">
        <button onClick={toggleFlag}
          className={`w-16 h-16 rounded-full flex items-center justify-center transition-all shadow-lg hover:scale-110 active:scale-95 ${flagged.has(currentQuestion?.ID) ? 'bg-amber-500 text-white hover:bg-amber-600' : 'bg-white text-amber-500 border-2 border-amber-500 hover:bg-amber-50'}`}
          title={flagged.has(currentQuestion?.ID) ? t('quiz.unflagQuestion') : t('quiz.flagQuestion')}>
          <Flag size={28} fill={flagged.has(currentQuestion?.ID) ? 'currentColor' : 'none'} />
        </button>
        <div className="flex-1" />
        {!isLastQuestion ? (
          <button onClick={nextQuestion}
            className="flex items-center justify-center w-16 h-16 bg-lab-blue text-white rounded-full font-bold hover:bg-blue-800 transition-all shadow-lg hover:scale-110 active:scale-95">
            <ChevronRight size={32} />
          </button>
        ) : (
          <button onClick={handleComplete} disabled={!allAnswered}
            className={`flex items-center justify-center w-16 h-16 rounded-full font-bold transition-all shadow-lg hover:scale-110 active:scale-95 ${allAnswered ? 'bg-chemistry-green text-white hover:opacity-90' : 'bg-slate-300 text-slate-500 cursor-not-allowed'}`}
            title={t('quiz.finishSubmit')}>
            <Send size={28} />
          </button>
        )}
      </div>

      {/* Question Overview Panel - No blur, just transparent */}
      {showQuestionPanel && (
        <>
          <div className="fixed inset-0 z-40" onClick={() => setShowQuestionPanel(false)} />
          <div className="fixed left-0 top-0 h-full w-80 max-w-[90vw] bg-white/95 shadow-2xl z-50 overflow-y-auto animate-in slide-in-from-left duration-300 border-r-2 border-slate-200">
            <div className="sticky top-0 bg-white/95 border-b p-6 flex justify-between items-center">
              <h3 className="text-lg font-bold text-slate-800">{t('quiz.questionOverview')}</h3>
              <button onClick={() => setShowQuestionPanel(false)} className="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100">
                <X size={20} />
              </button>
            </div>
            <div className="p-6">
              <div className="flex flex-col gap-3 mb-6 text-sm">
                <div className="flex items-center gap-2"><div className="w-6 h-6 rounded bg-chemistry-green" /><span>{t('quiz.answered')} ({Object.keys(answers).filter(k => answers[k]).length})</span></div>
                <div className="flex items-center gap-2"><div className="w-6 h-6 rounded bg-amber-500" /><span>{t('quiz.flagged')} ({flagged.size})</span></div>
                <div className="flex items-center gap-2"><div className="w-6 h-6 rounded bg-slate-200" /><span>{t('quiz.skipped')} ({totalQuestions - Object.keys(answers).filter(k => answers[k]).length})</span></div>
              </div>
              <div className="grid grid-cols-4 gap-3">
                {questions.map((q, idx) => {
                  const status = getQuestionStatus(q);
                  const qTime = questionTimes[q.ID] || 0;
                  return (
                    <button key={q.ID} onClick={() => jumpToQuestion(idx)}
                      className={`aspect-square rounded-xl font-bold text-base transition-all border-2 flex flex-col items-center justify-center ${idx === currentIndex ? 'border-lab-blue ring-2 ring-lab-blue ring-offset-2' : 'border-transparent'} ${status === 'answered' ? 'bg-chemistry-green text-white hover:opacity-80' : status === 'flagged' ? 'bg-amber-500 text-white hover:opacity-80' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}
                      title={timerEnabled && qTime > 0 ? formatTime(qTime) : ''}>
                      <span>{idx + 1}</span>
                      {timerEnabled && qTime > 0 && (
                        <span className="text-[8px] opacity-75 mt-0.5">{formatTime(qTime)}</span>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        </>
      )}

      {/* Periodic Table Modal */}
      {showPeriodicTable && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPeriodicTable(false)}>
          <div className="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-auto" onClick={e => e.stopPropagation()}>
            <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
              <h3 className="text-xl font-bold text-slate-800">{t('quiz.periodicTableOfElements')}</h3>
              <button onClick={() => setShowPeriodicTable(false)} className="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100"><X size={24} /></button>
            </div>
            <div className="p-4">
              <img src="https://upload.wikimedia.org/wikipedia/commons/2/2e/Simple_Periodic_Table_Chart-en.svg" alt="Periodic Table" className="w-full h-auto" />
            </div>
          </div>
        </div>
      )}

      {/* Main Content */}
      <div className="max-w-5xl mx-auto px-4 pt-6 pb-6">
        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
          <div className="flex justify-between items-center mb-2">
            <div className="flex items-baseline gap-3">
              <span className="text-3xl font-black text-lab-blue">Q{currentIndex + 1}</span>
              <span className="text-sm font-medium text-slate-500">{t('quiz.of')} {totalQuestions}</span>
            </div>
            <span className="text-xl font-bold text-lab-blue">{Math.round(progress)}%</span>
          </div>
          <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
            <div className="bg-lab-blue h-full transition-all duration-300" style={{ width: `${progress}%` }} />
          </div>
        </div>

        {timerEnabled && (
          <div className="md:hidden bg-white p-3 rounded-lg shadow-sm border border-slate-200 mb-4">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2"><Timer className="text-lab-blue" size={18} /><span className="text-sm font-bold text-slate-600">{t('quiz.totalTime')}</span></div>
              <div className="text-xl font-black text-lab-blue font-mono">{formatTime(sessionTime)}</div>
            </div>
            {isTimedMode && (
              <div className="flex justify-between text-xs text-slate-500 pb-2 border-b mb-2">
                <span>{t('quiz.timeRemaining')}</span>
                <span className={`font-bold ${timeRemaining < 60000 ? 'text-red-600' : 'text-amber-600'}`}>{formatTime(timeRemaining)}</span>
              </div>
            )}
            <div className="flex justify-between text-xs text-slate-500">
              <span>{t('quiz.thisQuestion')}</span>
              <span className="font-bold text-lab-blue">{formatTime(currentQuestionTime)}</span>
            </div>
          </div>
        )}

        <div className="mb-4">
          <QuestionCard
            question={currentQuestion}
            selectedOption={answers[currentQuestion.ID]}
            onSelect={handleOptionSelect}
          />
        </div>

        <div className="flex justify-center gap-1 py-2">
          {questions.slice(0, Math.min(30, totalQuestions)).map((_, idx) => (
            <div key={idx} className={`w-2 h-2 rounded-full transition-all ${idx === currentIndex ? 'bg-lab-blue w-6' : answers[questions[idx].ID] ? 'bg-chemistry-green' : flagged.has(questions[idx].ID) ? 'bg-amber-500' : 'bg-slate-200'}`} />
          ))}
          {totalQuestions > 30 && <span className="text-slate-400 text-xs">...</span>}
        </div>

        <div className="text-center text-sm mt-2 space-y-1">
          <p className="text-slate-500 hidden md:block">
            üí° <span className="font-semibold">{t('quiz.tip')}</span> {t('quiz.press')} <kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono">A</kbd>‚Äì<kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono">D</kbd> {t('quiz.toSelect')} ¬∑ <kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono">Enter</kbd> / <kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono">‚Üí</kbd> {t('quiz.next')} ¬∑ <kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono">F</kbd> {t('quiz.flag')} ¬∑ <kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono">O</kbd> {t('quiz.overview')}
          </p>
          {!allAnswered && isLastQuestion && (
            <p className="text-amber-600 font-medium">
              {t('quiz.pleaseAnswerAll')}
            </p>
          )}
        </div>
      </div>

      {/* Mobile Nav Bar */}
      <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t-2 border-slate-200 shadow-2xl z-30">
        <div className="grid grid-cols-3 gap-2 p-3">
          <button onClick={prevQuestion} disabled={currentIndex === 0}
            className="flex flex-col items-center justify-center py-3 px-2 bg-slate-100 rounded-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95">
            <ChevronLeft size={24} className={currentIndex === 0 ? 'text-slate-400' : 'text-lab-blue'} />
            <span className={`text-xs mt-1 ${currentIndex === 0 ? 'text-slate-400' : 'text-lab-blue'}`}>{t('quiz.previous')}</span>
          </button>
          <div className="flex flex-col items-center justify-center py-3 px-2 bg-slate-100 rounded-lg">
            <div className="text-2xl font-black text-lab-blue">{currentIndex + 1}/{totalQuestions}</div>
            <div className="text-xs text-slate-500 mt-1">{t('quiz.question')}</div>
          </div>
          {!isLastQuestion ? (
            <button onClick={nextQuestion}
              className="flex flex-col items-center justify-center py-3 px-2 bg-lab-blue rounded-lg font-bold transition-all active:scale-95">
              <ChevronRight size={24} className="text-white" />
              <span className="text-xs text-white mt-1">{t('quiz.next')}</span>
            </button>
          ) : (
            <button onClick={handleComplete} disabled={!allAnswered}
              className={`flex flex-col items-center justify-center py-3 px-2 rounded-lg font-bold transition-all active:scale-95 ${allAnswered ? 'bg-chemistry-green' : 'bg-slate-300 cursor-not-allowed'}`}>
              <Send size={24} className="text-white" />
              <span className="text-xs text-white mt-1">{t('quiz.submit')}</span>
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

// ========== src/pages/RegisterPage.jsx ==========

import React, { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { Beaker, Mail, Lock, User, UserPlus, AlertCircle, Sparkles, Languages } from 'lucide-react';

export default function RegisterPage() {
  const [displayName, setDisplayName] = useState('');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const { signup } = useAuth();
  const { t, toggleLanguage } = useLanguage();
  const navigate = useNavigate();

  async function handleSubmit(e) {
    e.preventDefault();

    // Validation
    if (password !== confirmPassword) {
      return setError(t('auth.passwordsNoMatch'));
    }

    if (password.length < 6) {
      return setError(t('auth.passwordMinLength'));
    }

    if (displayName.trim().length < 2) {
      return setError(t('auth.enterFullName'));
    }

    try {
      setError('');
      setLoading(true);
      await signup(email, password, displayName);
      navigate('/');
    } catch (err) {
      console.error(err);
      if (err.code === 'auth/email-already-in-use') {
        setError(t('auth.emailAlreadyInUse'));
      } else if (err.code === 'auth/invalid-email') {
        setError(t('auth.invalidEmail'));
      } else if (err.code === 'auth/weak-password') {
        setError(t('auth.weakPassword'));
      } else {
        setError(t('auth.failedCreateAccount'));
      }
    }
    setLoading(false);
  }

  return (
    <div className="min-h-screen w-full flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-emerald-900 via-green-900 to-teal-900 p-4">
      {/* Language Toggle - Top Right */}
      <button
        onClick={toggleLanguage}
        className="fixed top-6 right-6 z-50 flex items-center gap-2 px-4 py-2 bg-white/10 backdrop-blur-md border-2 border-white/20 rounded-xl font-bold text-white hover:bg-white/20 transition-all shadow-lg"
        title={t('auth.switchToChinese')}
      >
        <Languages size={20} strokeWidth={3} />
        <span className="text-sm">{t('auth.switchToEnglish')}</span>
      </button>

      {/* Animated Background Elements */}
      <div className="absolute inset-0 overflow-hidden">
        <div className="absolute top-20 left-10 w-72 h-72 bg-green-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob"></div>
        <div className="absolute top-40 right-10 w-72 h-72 bg-emerald-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-2000"></div>
        <div className="absolute -bottom-8 left-20 w-72 h-72 bg-teal-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-4000"></div>
      </div>

      {/* Floating Chemistry Icons */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-1/4 left-1/4 text-6xl opacity-10 animate-float">‚öõÔ∏è</div>
        <div className="absolute top-1/3 right-1/4 text-5xl opacity-10 animate-float animation-delay-1000">üß™</div>
        <div className="absolute bottom-1/4 left-1/3 text-7xl opacity-10 animate-float animation-delay-2000">üî¨</div>
        <div className="absolute top-1/2 right-1/3 text-4xl opacity-10 animate-float animation-delay-3000">‚öóÔ∏è</div>
      </div>

      <div className="max-w-md w-full relative z-10">
        {/* Logo Header */}
        <div className="text-center mb-8 animate-in fade-in slide-in-from-top duration-700">
          <div className="flex justify-center mb-6">
            <div className="relative">
              <div className="absolute inset-0 bg-gradient-to-r from-green-600 to-emerald-600 rounded-2xl blur-xl opacity-75 animate-pulse"></div>
              <div className="relative bg-gradient-to-r from-green-500 to-emerald-600 p-5 rounded-2xl shadow-2xl transform hover:scale-110 transition-transform duration-300">
                <Beaker className="text-white" size={56} strokeWidth={2.5} />
              </div>
            </div>
          </div>
          <h1 className="text-4xl font-black text-white mb-2 tracking-tight">
            ChemLeung
          </h1>
          <p className="text-emerald-200 text-lg font-medium">
            {t('tagline')}
          </p>
          <div className="flex items-center justify-center gap-2 mt-3 text-emerald-300 text-sm">
            <Sparkles size={16} />
            <span>{t('auth.joinCommunity')}</span>
          </div>
        </div>

        {/* Register Form */}
        <div className="bg-white/10 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 overflow-hidden animate-in fade-in slide-in-from-bottom duration-700">
          <div className="bg-gradient-to-r from-green-600 to-emerald-600 p-6 text-center">
            <h2 className="text-2xl font-bold text-white flex items-center justify-center gap-2">
              <UserPlus size={24} />
              {t('auth.register')}
            </h2>
            <p className="text-green-100 text-sm mt-1">
              {t('auth.joinCommunity')}
            </p>
          </div>

          <form onSubmit={handleSubmit} className="p-8 space-y-6">
            {error && (
              <div className="bg-red-500/20 backdrop-blur border-2 border-red-400/50 rounded-xl p-4 flex items-start gap-3 animate-in shake">
                <AlertCircle className="text-red-300 flex-shrink-0 mt-0.5" size={20} />
                <p className="text-red-100 text-sm font-medium">{error}</p>
              </div>
            )}

            {/* Display Name Field */}
            <div className="space-y-2">
              <label className="block text-sm font-bold text-white/90 ml-1">
                {t('auth.fullName')}
              </label>
              <div className="relative group">
                <User className="absolute left-4 top-1/2 transform -translate-y-1/2 text-green-300 group-focus-within:text-green-400 transition-colors" size={20} />
                <input
                  type="text"
                  value={displayName}
                  onChange={(e) => setDisplayName(e.target.value)}
                  required
                  className="w-full pl-12 pr-4 py-4 bg-white/10 backdrop-blur border-2 border-white/20 rounded-xl focus:border-green-400 focus:ring-4 focus:ring-green-500/20 outline-none transition-all text-white placeholder-white/50 font-medium"
                  placeholder="John Doe"
                />
              </div>
            </div>

            {/* Email Field */}
            <div className="space-y-2">
              <label className="block text-sm font-bold text-white/90 ml-1">
                {t('auth.email')}
              </label>
              <div className="relative group">
                <Mail className="absolute left-4 top-1/2 transform -translate-y-1/2 text-green-300 group-focus-within:text-green-400 transition-colors" size={20} />
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="w-full pl-12 pr-4 py-4 bg-white/10 backdrop-blur border-2 border-white/20 rounded-xl focus:border-green-400 focus:ring-4 focus:ring-green-500/20 outline-none transition-all text-white placeholder-white/50 font-medium"
                  placeholder="your.email@example.com"
                />
              </div>
            </div>

            {/* Password Field */}
            <div className="space-y-2">
              <label className="block text-sm font-bold text-white/90 ml-1">
                {t('auth.password')}
              </label>
              <div className="relative group">
                <Lock className="absolute left-4 top-1/2 transform -translate-y-1/2 text-green-300 group-focus-within:text-green-400 transition-colors" size={20} />
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  className="w-full pl-12 pr-4 py-4 bg-white/10 backdrop-blur border-2 border-white/20 rounded-xl focus:border-green-400 focus:ring-4 focus:ring-green-500/20 outline-none transition-all text-white placeholder-white/50 font-medium"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
              </div>
              <p className="text-xs text-green-200 ml-1">
                {t('auth.minimumCharacters')}
              </p>
            </div>

            {/* Confirm Password Field */}
            <div className="space-y-2">
              <label className="block text-sm font-bold text-white/90 ml-1">
                {t('auth.confirmPassword')}
              </label>
              <div className="relative group">
                <Lock className="absolute left-4 top-1/2 transform -translate-y-1/2 text-green-300 group-focus-within:text-green-400 transition-colors" size={20} />
                <input
                  type="password"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  required
                  className="w-full pl-12 pr-4 py-4 bg-white/10 backdrop-blur border-2 border-white/20 rounded-xl focus:border-green-400 focus:ring-4 focus:ring-green-500/20 outline-none transition-all text-white placeholder-white/50 font-medium"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
              </div>
            </div>

            {/* Submit Button */}
            <button
              type="submit"
              disabled={loading}
              className="relative w-full py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold text-lg shadow-2xl hover:shadow-green-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-all overflow-hidden group"
            >
              <div className="relative flex items-center justify-center gap-2">
                {loading ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    <span>{t('auth.creatingAccount')}</span>
                  </>
                ) : (
                  <>
                    <UserPlus size={20} />
                    <span>{t('auth.createAccount')}</span>
                  </>
                )}
              </div>
            </button>
          </form>

          {/* Login Link */}
          <div className="bg-white/5 px-8 py-6 border-t border-white/10 text-center">
            <p className="text-white/70 text-sm">
              {t('auth.alreadyHaveAccount')}{' '}
              <Link 
                to="/login" 
                className="text-green-300 font-bold hover:text-green-200 transition-colors hover:underline"
              >
                {t('auth.loginHere')}
              </Link>
            </p>
          </div>
        </div>

        {/* Footer Note */}
        <p className="text-center text-white/50 text-xs mt-6 animate-in fade-in duration-1000">
          {t('auth.secureRegistration')}
        </p>
      </div>

      {/* Custom CSS for animations */}
      <style jsx>{`
        @keyframes blob {
          0%, 100% { transform: translate(0, 0) scale(1); }
          33% { transform: translate(30px, -50px) scale(1.1); }
          66% { transform: translate(-20px, 20px) scale(0.9); }
        }
        @keyframes float {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(-20px); }
        }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
          20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-blob {
          animation: blob 7s infinite;
        }
        .animate-float {
          animation: float 3s ease-in-out infinite;
        }
        .animation-delay-1000 {
          animation-delay: 1s;
        }
        .animation-delay-2000 {
          animation-delay: 2s;
        }
        .animation-delay-3000 {
          animation-delay: 3s;
        }
        .animation-delay-4000 {
          animation-delay: 4s;
        }
        .animate-in {
          animation: fadeIn 0.5s ease-out;
        }
        .shake {
          animation: shake 0.5s;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
      `}</style>
    </div>
  );
}

// ========== src/pages/ResultsPage_Updated_Fixed.jsx ==========

import React, { useEffect, useState, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import ResultsSummary from '../components/ResultsSummary';
import { quizStorage } from '../utils/quizStorage';
import { quizService } from '../services/quizService';

export default function ResultsPage() {
  const navigate = useNavigate();
  const { currentUser } = useAuth();
  const { t } = useLanguage();
  const [saving, setSaving] = useState(false);
  const [saved, setSaved] = useState(false);
  const hasSavedRef = useRef(false);

  // Load data from storage
  const questions = quizStorage.getSelectedQuestions();
  const userAnswers = quizStorage.getUserAnswers();
  const questionTimes = quizStorage.getQuestionTimes();

  // Redirect if no data
  useEffect(() => {
    if (!questions || questions.length === 0 || Object.keys(userAnswers).length === 0) {
      navigate('/');
    }
  }, []); // eslint-disable-line react-hooks/exhaustive-deps

  // Save attempt to Firebase - only once
  useEffect(() => {
    async function saveAttemptToFirebase() {
      if (hasSavedRef.current) return;
      if (!currentUser || !questions || questions.length === 0) return;
      if (Object.keys(userAnswers).length === 0) return;

      hasSavedRef.current = true;
      setSaving(true);

      try {
        const totalQuestions = questions.length;
        const correctAnswers = questions.reduce((acc, q) => {
          return acc + (userAnswers[q.ID] === q.CorrectOption ? 1 : 0);
        }, 0);
        const percentage = Math.round((correctAnswers / totalQuestions) * 100);
        const topics = [...new Set(questions.map(q => q.Topic))].filter(Boolean);
        const timeSpent = questionTimes
          ? Object.values(questionTimes).reduce((sum, time) => sum + time, 0)
          : null;

        const attemptData = {
          score: percentage,
          totalQuestions,
          correctAnswers,
          percentage,
          topics,
          timeSpent,
          questionTimes,
          answers: userAnswers,
          questions, // For Mistake Notebook
        };

        await quizService.saveAttempt(currentUser.uid, attemptData);
        setSaved(true);
        console.log('‚úÖ Attempt saved (once).');
      } catch (error) {
        console.error('‚ùå Error saving attempt:', error);
        hasSavedRef.current = false;
      } finally {
        setSaving(false);
      }
    }

    saveAttemptToFirebase();
  }, [currentUser]);

  if (!questions || questions.length === 0) return null;

  const handleRestart = () => {
    quizStorage.clearQuizData();
    navigate('/');
  };

  return (
    <div className="relative">
      {saving && (
        <div className="fixed top-20 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-in fade-in">
          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
          <span className="font-semibold">
            {t('results.savingToProfile')}
          </span>
        </div>
      )}
      {saved && (
        <div className="fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-in fade-in">
          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
          </svg>
          <span className="font-semibold">
            {t('results.savedToProfile')}
          </span>
        </div>
      )}
      <ResultsSummary
        questions={questions}
        userAnswers={userAnswers}
        questionTimes={questionTimes}
        onRestart={handleRestart}
      />
    </div>
  );
}

// ========== src/pages/TopicSelectionPage_Updated.jsx ==========

import React from 'react';
import { useNavigate } from 'react-router-dom';
import FilterScreen from '../components/FilterScreen';
import { quizStorage } from '../utils/quizStorage';

export default function TopicSelectionPage({ questions }) {
  const navigate = useNavigate();

  const handleStart = (selectedQuestions) => {
    // Clear any previous quiz data
    quizStorage.clearQuizData();
    
    // Save selected questions
    quizStorage.saveSelectedQuestions(selectedQuestions);
    
    // Navigate to quiz page
    navigate('/quiz');
  };

  return <FilterScreen questions={questions} onStart={handleStart} />;
}

// ========== src/services/forumService.js ==========

import { 
  collection, addDoc, updateDoc, deleteDoc, doc, query,
  where, orderBy, getDocs, getDoc, increment, onSnapshot
} from 'firebase/firestore';
import { db } from '../firebase/config';

// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const EDIT_WINDOW_MS = 15 * 60 * 1000; // 15 minutes

export const canEditComment = (createdAt) => {
  const ageMs = Date.now() - new Date(createdAt).getTime();
  return ageMs <= EDIT_WINDOW_MS;
};

export const editTimeRemaining = (createdAt) => {
  const ageMs = Date.now() - new Date(createdAt).getTime();
  const remaining = EDIT_WINDOW_MS - ageMs;
  if (remaining <= 0) return null;
  const mins = Math.floor(remaining / 60000);
  const secs = Math.floor((remaining % 60000) / 1000);
  return `${mins}:${String(secs).padStart(2, '0')}`;
};

export const forumService = {
  // ‚îÄ‚îÄ MCQ Comments ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async addComment(questionId, userId, userDisplayName, commentText) {
    try {
      if (!questionId || !userId || !commentText) throw new Error('Missing required fields');
      const commentData = {
        questionId: String(questionId),
        userId: String(userId),
        userDisplayName: userDisplayName || 'Anonymous',
        text: commentText.trim(),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        edited: false,
        likes: 0,
        likedBy: []
      };
      const ref = await addDoc(collection(db, 'comments'), commentData);
      return ref.id;
    } catch (error) {
      if (error.code === 'permission-denied') throw new Error('Permission denied. Please check Firebase rules.');
      throw new Error(`Failed to add comment: ${error.message}`);
    }
  },

  async getQuestionComments(questionId) {
    try {
      const q = query(
        collection(db, 'comments'),
        where('questionId', '==', String(questionId)),
        orderBy('createdAt', 'desc')
      );
      const snapshot = await getDocs(q);
      return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (error) {
      if (error.code === 'failed-precondition') return [];
      throw error;
    }
  },

  // Edit only allowed within 15 minutes
  async updateComment(commentId, newText) {
    try {
      const ref = doc(db, 'comments', commentId);
      const snap = await getDoc(ref);
      if (!snap.exists()) throw new Error('Comment not found');
      if (!canEditComment(snap.data().createdAt)) {
        throw new Error('EDIT_EXPIRED');
      }
      await updateDoc(ref, {
        text: newText.trim(),
        updatedAt: new Date().toISOString(),
        edited: true
      });
    } catch (error) {
      if (error.message === 'EDIT_EXPIRED') throw error;
      if (error.code === 'permission-denied') throw new Error('You can only edit your own comments.');
      throw error;
    }
  },

  async deleteComment(commentId) {
    try {
      await deleteDoc(doc(db, 'comments', commentId));
    } catch (error) {
      if (error.code === 'permission-denied') throw new Error('You can only delete your own comments.');
      throw error;
    }
  },

  async toggleLike(commentId, userId) {
    try {
      const ref = doc(db, 'comments', commentId);
      const snap = await getDoc(ref);
      if (!snap.exists()) throw new Error('Comment not found');
      const data = snap.data();
      const likedBy = data.likedBy || [];
      const hasLiked = likedBy.includes(userId);
      
      if (hasLiked) {
        await updateDoc(ref, { likes: increment(-1), likedBy: likedBy.filter(id => id !== userId) });
      } else {
        await updateDoc(ref, { likes: increment(1), likedBy: [...likedBy, userId] });
        // Create notification for comment author
        if (data.userId && data.userId !== userId) {
          await forumService.createNotification({
            recipientId: data.userId,
            senderId: userId,
            type: 'like',
            commentId,
            questionId: data.questionId,
            postId: data.postId || null,
            previewText: data.text?.substring(0, 80) || '',
          });
        }
      }
    } catch (error) {
      throw error;
    }
  },

  async getQuestionsWithComments() {
    try {
      const snapshot = await getDocs(collection(db, 'comments'));
      const map = new Map();
      snapshot.forEach(d => {
        const data = d.data();
        if (!data.questionId) return;
        if (!map.has(data.questionId)) {
          map.set(data.questionId, { questionId: data.questionId, commentCount: 1, lastActivity: data.createdAt });
        } else {
          const ex = map.get(data.questionId);
          ex.commentCount++;
          if (data.createdAt > ex.lastActivity) ex.lastActivity = data.createdAt;
        }
      });
      return Array.from(map.values()).sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity));
    } catch (error) {
      throw error;
    }
  },

  // ‚îÄ‚îÄ General Forum Posts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async createPost(userId, userDisplayName, { title, content, category = 'general' }) {
    if (!userId || !title?.trim() || !content?.trim()) throw new Error('Missing required fields');
    const data = {
      userId, userDisplayName: userDisplayName || 'Anonymous',
      title: title.trim(), content: content.trim(),
      category, // 'general' | 'question' | 'announcement'
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      edited: false, replyCount: 0, likes: 0, likedBy: [], pinned: false
    };
    const ref = await addDoc(collection(db, 'forum_posts'), data);
    return ref.id;
  },

  async getPosts({ category = null, limit: lim = 30 } = {}) {
    try {
      let q;
      if (category) {
        q = query(collection(db, 'forum_posts'), where('category', '==', category), orderBy('createdAt', 'desc'));
      } else {
        q = query(collection(db, 'forum_posts'), orderBy('createdAt', 'desc'));
      }
      const snapshot = await getDocs(q);
      const posts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      return posts.slice(0, lim);
    } catch (error) {
      if (error.code === 'failed-precondition') {
        const snapshot = await getDocs(collection(db, 'forum_posts'));
        return snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, lim);
      }
      throw error;
    }
  },

  async getPost(postId) {
    const snap = await getDoc(doc(db, 'forum_posts', postId));
    if (!snap.exists()) throw new Error('Post not found');
    return { id: snap.id, ...snap.data() };
  },

  async updatePost(postId, userId, newContent, newTitle = null) {
    const ref = doc(db, 'forum_posts', postId);
    const snap = await getDoc(ref);
    if (!snap.exists()) throw new Error('Post not found');
    if (!canEditComment(snap.data().createdAt)) throw new Error('EDIT_EXPIRED');
    const updates = { content: newContent.trim(), updatedAt: new Date().toISOString(), edited: true };
    if (newTitle) updates.title = newTitle.trim();
    await updateDoc(ref, updates);
  },

  async deletePost(postId) {
    await deleteDoc(doc(db, 'forum_posts', postId));
  },

  async togglePostLike(postId, userId) {
    const ref = doc(db, 'forum_posts', postId);
    const snap = await getDoc(ref);
    if (!snap.exists()) throw new Error('Post not found');
    const data = snap.data();
    const likedBy = data.likedBy || [];
    const hasLiked = likedBy.includes(userId);
    if (hasLiked) {
      await updateDoc(ref, { likes: increment(-1), likedBy: likedBy.filter(id => id !== userId) });
    } else {
      await updateDoc(ref, { likes: increment(1), likedBy: [...likedBy, userId] });
      if (data.userId && data.userId !== userId) {
        await forumService.createNotification({
          recipientId: data.userId, senderId: userId,
          type: 'post_like', postId,
          previewText: data.title?.substring(0, 80) || '',
        });
      }
    }
  },

  // ‚îÄ‚îÄ Post Replies ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async addReply(postId, userId, userDisplayName, text) {
    if (!postId || !userId || !text?.trim()) throw new Error('Missing required fields');
    const data = {
      postId, userId, userDisplayName: userDisplayName || 'Anonymous',
      text: text.trim(), createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(), edited: false, likes: 0, likedBy: []
    };
    const ref = await addDoc(collection(db, 'forum_replies'), data);
    // Increment reply count on post
    await updateDoc(doc(db, 'forum_posts', postId), { replyCount: increment(1) });
    // Notify post author
    const postSnap = await getDoc(doc(db, 'forum_posts', postId));
    if (postSnap.exists() && postSnap.data().userId !== userId) {
      await forumService.createNotification({
        recipientId: postSnap.data().userId, senderId: userId,
        type: 'reply', postId,
        previewText: text.substring(0, 80),
        postTitle: postSnap.data().title?.substring(0, 60) || '',
      });
    }
    return ref.id;
  },

  async getReplies(postId) {
    try {
      const q = query(
        collection(db, 'forum_replies'),
        where('postId', '==', postId),
        orderBy('createdAt', 'asc')
      );
      const snapshot = await getDocs(q);
      return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (error) {
      if (error.code === 'failed-precondition') {
        const snapshot = await getDocs(collection(db, 'forum_replies'));
        return snapshot.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(r => r.postId === postId)
          .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
      }
      throw error;
    }
  },

  async updateReply(replyId, newText) {
    const ref = doc(db, 'forum_replies', replyId);
    const snap = await getDoc(ref);
    if (!snap.exists()) throw new Error('Reply not found');
    if (!canEditComment(snap.data().createdAt)) throw new Error('EDIT_EXPIRED');
    await updateDoc(ref, { text: newText.trim(), updatedAt: new Date().toISOString(), edited: true });
  },

  async deleteReply(replyId) {
    const snap = await getDoc(doc(db, 'forum_replies', replyId));
    if (snap.exists()) {
      const postId = snap.data().postId;
      await deleteDoc(doc(db, 'forum_replies', replyId));
      await updateDoc(doc(db, 'forum_posts', postId), { replyCount: increment(-1) });
    }
  },

  async toggleReplyLike(replyId, userId) {
    const ref = doc(db, 'forum_replies', replyId);
    const snap = await getDoc(ref);
    if (!snap.exists()) throw new Error('Reply not found');
    const data = snap.data();
    const likedBy = data.likedBy || [];
    const hasLiked = likedBy.includes(userId);
    if (hasLiked) {
      await updateDoc(ref, { likes: increment(-1), likedBy: likedBy.filter(id => id !== userId) });
    } else {
      await updateDoc(ref, { likes: increment(1), likedBy: [...likedBy, userId] });
      if (data.userId && data.userId !== userId) {
        await forumService.createNotification({
          recipientId: data.userId, senderId: userId,
          type: 'reply_like', replyId, postId: data.postId,
          previewText: data.text?.substring(0, 80) || '',
        });
      }
    }
  },

  // ‚îÄ‚îÄ Notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async createNotification({ recipientId, senderId, type, commentId, postId, replyId, questionId, previewText, postTitle }) {
    if (!recipientId || recipientId === senderId) return;
    await addDoc(collection(db, 'notifications'), {
      recipientId, senderId, type,
      commentId: commentId || null,
      postId: postId || null,
      replyId: replyId || null,
      questionId: questionId || null,
      previewText: previewText || '',
      postTitle: postTitle || '',
      read: false,
      createdAt: new Date().toISOString()
    });
  },

  async getNotifications(userId, limitCount = 20) {
    try {
      const q = query(
        collection(db, 'notifications'),
        where('recipientId', '==', userId),
        orderBy('createdAt', 'desc')
      );
      const snapshot = await getDocs(q);
      return snapshot.docs.map(d => ({ id: d.id, ...d.data() })).slice(0, limitCount);
    } catch (error) {
      if (error.code === 'failed-precondition') {
        const snapshot = await getDocs(collection(db, 'notifications'));
        return snapshot.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(n => n.recipientId === userId)
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, limitCount);
      }
      return [];
    }
  },

  async markNotificationRead(notifId) {
    await updateDoc(doc(db, 'notifications', notifId), { read: true });
  },

  async markAllNotificationsRead(userId) {
    const notifs = await forumService.getNotifications(userId, 50);
    const unread = notifs.filter(n => !n.read);
    await Promise.all(unread.map(n => forumService.markNotificationRead(n.id)));
  },

  subscribeToNotifications(userId, callback) {
    const q = query(
      collection(db, 'notifications'),
      where('recipientId', '==', userId),
      orderBy('createdAt', 'desc')
    );
    return onSnapshot(q, (snapshot) => {
      const notifs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      callback(notifs);
    }, () => { /* ignore snapshot errors */ });
  }
};

// ========== src/services/quizService.js ==========

import { doc, setDoc, collection, addDoc, updateDoc, increment, query, where, orderBy, limit, getDocs, getDoc } from 'firebase/firestore';
import { db } from '../firebase/config';

export const quizService = {
  // Save a quiz attempt WITH questions data for Mistake Notebook
  async saveAttempt(userId, attemptData) {
    try {
      const attemptRef = await addDoc(collection(db, 'attempts'), {
        userId: userId,
        timestamp: new Date().toISOString(),
        date: new Date().toISOString().split('T')[0],
        score: attemptData.score,
        totalQuestions: attemptData.totalQuestions,
        correctAnswers: attemptData.correctAnswers,
        percentage: attemptData.percentage,
        topics: attemptData.topics,
        timeSpent: attemptData.timeSpent || null,
        questionTimes: attemptData.questionTimes || null,
        answers: attemptData.answers || null,
        questions: attemptData.questions || null,
      });

      const userRef = doc(db, 'users', userId);
      await updateDoc(userRef, {
        totalAttempts: increment(1),
        totalQuestions: increment(attemptData.totalQuestions),
        totalCorrect: increment(attemptData.correctAnswers),
        lastAttemptDate: new Date().toISOString(),
      });

      return attemptRef.id;
    } catch (error) {
      console.error('Error saving attempt:', error);
      throw error;
    }
  },

  // Get user's attempt history
  async getUserAttempts(userId, limitCount = 20) {
    try {
      const q = query(
        collection(db, 'attempts'),
        where('userId', '==', userId),
        orderBy('timestamp', 'desc'),
        limit(limitCount),
      );
      const querySnapshot = await getDocs(q);
      const attempts = [];
      querySnapshot.forEach((doc) => attempts.push({ id: doc.id, ...doc.data() }));
      return attempts;
    } catch (error) {
      console.error('Error getting user attempts:', error);
      throw error;
    }
  },

  // ‚îÄ‚îÄ‚îÄ Helper: compute streak for a user given their attempts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _computeStreak(attempts) {
    if (!attempts.length) return 0;
    const uniqueDates = [...new Set(attempts.map(a => new Date(a.timestamp).toDateString()))]
      .sort((a, b) => new Date(b) - new Date(a));
    const today = new Date().toDateString();
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    if (uniqueDates[0] !== today && uniqueDates[0] !== yesterday) return 0;
    let streak = 1;
    for (let i = 1; i < uniqueDates.length; i++) {
      const diff = Math.floor((new Date(uniqueDates[i - 1]) - new Date(uniqueDates[i])) / 86400000);
      if (diff === 1) streak++; else break;
    }
    return streak;
  },

  // ‚îÄ‚îÄ‚îÄ Shared leaderboard builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async _buildLeaderboard(attemptsQuery, limitCount, sortField = 'averageScore') {
    const querySnapshot = await getDocs(attemptsQuery);

    // Group by user
    const userMap = new Map();
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const uid = data.userId;
      if (!userMap.has(uid)) {
        userMap.set(uid, { userId: uid, attempts: [], totalScore: 0, totalQuestions: 0, totalCorrect: 0 });
      }
      const u = userMap.get(uid);
      u.attempts.push(data);
      u.totalScore += data.percentage;
      u.totalQuestions += data.totalQuestions;
      u.totalCorrect += data.correctAnswers;
    });

    // Fetch user profiles + compute streaks
    const leaderboard = await Promise.all(
      Array.from(userMap.values()).map(async (u) => {
        const userDoc = await getDoc(doc(db, 'users', u.userId));
        const userData = userDoc.data() || {};

        // Streak: fetch all-time attempts for streak calculation
        let streak = 0;
        try {
          const allQ = query(
            collection(db, 'attempts'),
            where('userId', '==', u.userId),
            orderBy('timestamp', 'desc'),
            limit(100),
          );
          const allSnap = await getDocs(allQ);
          const allAttempts = [];
          allSnap.forEach(d => allAttempts.push(d.data()));
          streak = this._computeStreak(allAttempts);
        } catch (_) { /* streak stays 0 */ }

        return {
          userId: u.userId,
          displayName: userData.displayName || 'Unknown',
          level: userData.level || null,          // S4 / S5 / S6
          attemptCount: u.attempts.length,
          averageScore: Math.round(u.totalScore / u.attempts.length),
          totalQuestions: u.totalQuestions,
          totalCorrect: u.totalCorrect,
          overallPercentage: Math.round((u.totalCorrect / u.totalQuestions) * 100),
          streak,
        };
      })
    );

    leaderboard.sort((a, b) => b[sortField] - a[sortField]);
    return leaderboard.slice(0, limitCount);
  },

  // Get weekly leaderboard
  async getWeeklyLeaderboard(limitCount = 10) {
    try {
      const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
      const q = query(
        collection(db, 'attempts'),
        where('timestamp', '>=', weekAgo.toISOString()),
        orderBy('timestamp', 'desc'),
      );
      return await this._buildLeaderboard(q, limitCount, 'averageScore');
    } catch (error) {
      console.error('Error getting weekly leaderboard:', error);
      throw error;
    }
  },

  // Get monthly leaderboard
  async getMonthlyLeaderboard(limitCount = 10) {
    try {
      const monthAgo = new Date(); monthAgo.setMonth(monthAgo.getMonth() - 1);
      const q = query(
        collection(db, 'attempts'),
        where('timestamp', '>=', monthAgo.toISOString()),
        orderBy('timestamp', 'desc'),
      );
      return await this._buildLeaderboard(q, limitCount, 'averageScore');
    } catch (error) {
      console.error('Error getting monthly leaderboard:', error);
      throw error;
    }
  },

  // Get all-time leaderboard
  async getAllTimeLeaderboard(limitCount = 10) {
    try {
      const usersQuery = query(collection(db, 'users'));
      const usersSnapshot = await getDocs(usersQuery);

      const users = [];
      const streakPromises = [];

      usersSnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data.totalAttempts > 0) {
          const entry = {
            userId: docSnap.id,
            displayName: data.displayName || 'Unknown',
            level: data.level || null,
            totalAttempts: data.totalAttempts || 0,
            totalQuestions: data.totalQuestions || 0,
            totalCorrect: data.totalCorrect || 0,
            overallPercentage: data.totalQuestions > 0
              ? Math.round((data.totalCorrect / data.totalQuestions) * 100)
              : 0,
            streak: 0,
          };
          users.push(entry);

          // Queue streak fetch
          streakPromises.push(
            (async () => {
              try {
                const q = query(
                  collection(db, 'attempts'),
                  where('userId', '==', docSnap.id),
                  orderBy('timestamp', 'desc'),
                  limit(100),
                );
                const snap = await getDocs(q);
                const arr = []; snap.forEach(d => arr.push(d.data()));
                entry.streak = this._computeStreak(arr);
              } catch (_) {}
            })()
          );
        }
      });

      await Promise.all(streakPromises);
      users.sort((a, b) => b.overallPercentage - a.overallPercentage);
      return users.slice(0, limitCount);
    } catch (error) {
      console.error('Error getting all-time leaderboard:', error);
      throw error;
    }
  },
};

// ========== src/services/rewardLogic.js ==========

// ============================================================================
// REWARD LOGIC - Token Awards with Anti-Cheat
// ============================================================================

import { awardTokens, canClaimReward, recordRewardClaim } from './tokenService';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// REWARD TIERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const REWARDS = {
  // MCQ Completion Rewards (based on percentage)
  MCQ_PERFECT: 10,      // 100%
  MCQ_EXCELLENT: 5,     // 80-99%
  MCQ_GOOD: 2,          // 60-79%
  MCQ_COMPLETE: 1,      // < 60% (participation)

  // Mistake Book Rewards
  MISTAKE_CLEARED: 1,   // Per unique question (24h cooldown)

  // Leaderboard Rewards (Weekly)
  LEADERBOARD_GOLD_WEEKLY: 60,
  LEADERBOARD_SILVER_WEEKLY: 40,
  LEADERBOARD_BRONZE_WEEKLY: 20,

  // Leaderboard Rewards (Daily - via Weekly/7)
  LEADERBOARD_GOLD_DAILY: 10,
  LEADERBOARD_SILVER_DAILY: 6,
  LEADERBOARD_BRONZE_DAILY: 3,

  // Streak Bonuses
  STREAK_WEEK: 15,      // 7-day streak
  STREAK_MONTH: 50,     // 30-day streak

  // Special Events
  FIRST_QUIZ: 20,       // First quiz completion
  FORUM_POST: 2,        // Per helpful post (manual approval)
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MCQ COMPLETION REWARDS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Award tokens for MCQ quiz completion
 */
export async function rewardMCQCompletion(userId, attemptData) {
  try {
    const { percentage, totalQuestions, correctAnswers, topics, attemptId } = attemptData;

    let tokensAwarded = 0;
    let rewardTier = '';

    // Determine reward tier
    if (percentage === 100) {
      tokensAwarded = REWARDS.MCQ_PERFECT;
      rewardTier = 'Perfect Score! üèÜ';
    } else if (percentage >= 80) {
      tokensAwarded = REWARDS.MCQ_EXCELLENT;
      rewardTier = 'Excellent! ‚≠ê';
    } else if (percentage >= 60) {
      tokensAwarded = REWARDS.MCQ_GOOD;
      rewardTier = 'Good Work! üëç';
    } else {
      tokensAwarded = REWARDS.MCQ_COMPLETE;
      rewardTier = 'Keep Practicing! üí™';
    }

    // Bonus for completing many questions
    if (totalQuestions >= 40) {
      tokensAwarded += 3;
      rewardTier += ' +3 Marathon Bonus';
    } else if (totalQuestions >= 20) {
      tokensAwarded += 1;
      rewardTier += ' +1 Length Bonus';
    }

    const reason = `MCQ Completed (${percentage}%) - ${rewardTier}`;
    
    await awardTokens(userId, tokensAwarded, reason, {
      category: 'mcq_completion',
      percentage,
      totalQuestions,
      correctAnswers,
      topics,
      attemptId
    });

    return {
      success: true,
      tokensAwarded,
      message: `+${tokensAwarded} tokens! ${rewardTier}`
    };
  } catch (error) {
    console.error('Error rewarding MCQ completion:', error);
    return { success: false, tokensAwarded: 0 };
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MISTAKE NOTEBOOK REWARDS (with Anti-Cheat)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Reward clearing a mistake (once per question per 24h)
 */
export async function rewardMistakeCleared(userId, questionId) {
  try {
    const rewardKey = `mistake_${questionId}`;
    
    // Anti-cheat: Check cooldown
    const { canClaim, hoursRemaining } = await canClaimReward(userId, rewardKey);
    
    if (!canClaim) {
      return {
        success: false,
        message: `You can claim this reward again in ${hoursRemaining}h`,
        tokensAwarded: 0
      };
    }

    // Award token
    const tokensAwarded = REWARDS.MISTAKE_CLEARED;
    const reason = `Mistake Cleared: Question ${questionId.substring(0, 8)}`;

    await awardTokens(userId, tokensAwarded, reason, {
      category: 'mistake_cleared',
      questionId
    });

    // Record cooldown
    await recordRewardClaim(userId, rewardKey, 24);

    return {
      success: true,
      tokensAwarded,
      message: `+${tokensAwarded} token for mastering this question!`
    };
  } catch (error) {
    console.error('Error rewarding mistake cleared:', error);
    return { success: false, tokensAwarded: 0 };
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LEADERBOARD REWARDS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Award tokens for leaderboard placement
 */
export async function rewardLeaderboardPlacement(userId, rank, period = 'weekly') {
  try {
    let tokensAwarded = 0;
    let medal = '';

    if (period === 'weekly') {
      if (rank === 1) {
        tokensAwarded = REWARDS.LEADERBOARD_GOLD_WEEKLY;
        medal = 'ü•á Weekly Gold';
      } else if (rank === 2) {
        tokensAwarded = REWARDS.LEADERBOARD_SILVER_WEEKLY;
        medal = 'ü•à Weekly Silver';
      } else if (rank === 3) {
        tokensAwarded = REWARDS.LEADERBOARD_BRONZE_WEEKLY;
        medal = 'ü•â Weekly Bronze';
      }
    } else if (period === 'daily') {
      if (rank === 1) {
        tokensAwarded = REWARDS.LEADERBOARD_GOLD_DAILY;
        medal = 'ü•á Daily Gold';
      } else if (rank === 2) {
        tokensAwarded = REWARDS.LEADERBOARD_SILVER_DAILY;
        medal = 'ü•à Daily Silver';
      } else if (rank === 3) {
        tokensAwarded = REWARDS.LEADERBOARD_BRONZE_DAILY;
        medal = 'ü•â Daily Bronze';
      }
    }

    if (tokensAwarded === 0) {
      return { success: false, tokensAwarded: 0 };
    }

    const reason = `Leaderboard Reward: ${medal}`;

    await awardTokens(userId, tokensAwarded, reason, {
      category: 'leaderboard',
      rank,
      period
    });

    return {
      success: true,
      tokensAwarded,
      message: `${medal} - +${tokensAwarded} tokens!`
    };
  } catch (error) {
    console.error('Error rewarding leaderboard placement:', error);
    return { success: false, tokensAwarded: 0 };
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STREAK REWARDS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Award tokens for study streaks
 */
export async function rewardStreak(userId, streakDays) {
  try {
    let tokensAwarded = 0;
    let milestone = '';

    if (streakDays === 7) {
      tokensAwarded = REWARDS.STREAK_WEEK;
      milestone = '7-Day Streak! üî•';
    } else if (streakDays === 30) {
      tokensAwarded = REWARDS.STREAK_MONTH;
      milestone = '30-Day Streak! üî•üî•üî•';
    } else if (streakDays % 7 === 0 && streakDays > 7) {
      // Bonus for every week after first
      tokensAwarded = Math.floor(REWARDS.STREAK_WEEK * 1.5);
      milestone = `${streakDays}-Day Streak! üî•`;
    }

    if (tokensAwarded === 0) {
      return { success: false, tokensAwarded: 0 };
    }

    const rewardKey = `streak_${streakDays}`;
    
    // Check if already claimed
    const { canClaim } = await canClaimReward(userId, rewardKey);
    if (!canClaim) {
      return { success: false, message: 'Streak reward already claimed' };
    }

    const reason = `Study Streak: ${milestone}`;

    await awardTokens(userId, tokensAwarded, reason, {
      category: 'streak',
      streakDays
    });

    // Record to prevent duplicate claims
    await recordRewardClaim(userId, rewardKey, 720); // 30 days

    return {
      success: true,
      tokensAwarded,
      message: `${milestone} - +${tokensAwarded} tokens!`
    };
  } catch (error) {
    console.error('Error rewarding streak:', error);
    return { success: false, tokensAwarded: 0 };
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SPECIAL MILESTONE REWARDS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Award first-time achievement bonuses
 */
export async function rewardFirstTimeAchievement(userId, achievementType) {
  try {
    const rewardKey = `first_${achievementType}`;
    
    const { canClaim } = await canClaimReward(userId, rewardKey);
    if (!canClaim) {
      return { success: false, message: 'Achievement already unlocked' };
    }

    let tokensAwarded = 0;
    let message = '';

    switch (achievementType) {
      case 'quiz':
        tokensAwarded = REWARDS.FIRST_QUIZ;
        message = 'First Quiz Completed! üéâ';
        break;
      case 'forum_post':
        tokensAwarded = REWARDS.FORUM_POST;
        message = 'Forum Contributor! üí¨';
        break;
      default:
        return { success: false };
    }

    const reason = `First Time: ${message}`;

    await awardTokens(userId, tokensAwarded, reason, {
      category: 'first_time',
      achievementType
    });

    await recordRewardClaim(userId, rewardKey, 99999); // Never reset

    return {
      success: true,
      tokensAwarded,
      message: `${message} - +${tokensAwarded} tokens!`
    };
  } catch (error) {
    console.error('Error rewarding first-time achievement:', error);
    return { success: false, tokensAwarded: 0 };
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EXPORTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export const REWARD_AMOUNTS = REWARDS;

export default {
  rewardMCQCompletion,
  rewardMistakeCleared,
  rewardLeaderboardPlacement,
  rewardStreak,
  rewardFirstTimeAchievement,
  REWARDS
};

// ========== src/services/tokenService.js ==========

// ============================================================================
// TOKEN SERVICE - Real-Time Token Economy with Anti-Cheat
// ============================================================================

import { 
  doc, getDoc, setDoc, updateDoc, collection, addDoc, 
  query, orderBy, limit, getDocs, runTransaction, serverTimestamp,
  onSnapshot, increment
} from 'firebase/firestore';
import { db } from '../firebase/config';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TRANSACTION-SAFE TOKEN OPERATIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Award tokens to a user with transaction safety
 * Creates entry in tokenHistory sub-collection
 */
export async function awardTokens(userId, amount, reason, metadata = {}) {
  try {
    const userRef = doc(db, 'users', userId);
    
    await runTransaction(db, async (transaction) => {
      const userDoc = await transaction.get(userRef);
      
      if (!userDoc.exists()) {
        throw new Error('User not found');
      }

      const currentTokens = userDoc.data().tokens || 0;
      const newTokens = currentTokens + amount;

      // Update user tokens
      transaction.update(userRef, {
        tokens: newTokens,
        updatedAt: serverTimestamp()
      });

      // Create history entry
      const historyRef = doc(collection(db, 'users', userId, 'tokenHistory'));
      transaction.set(historyRef, {
        amount,
        reason,
        type: 'gain',
        timestamp: serverTimestamp(),
        balanceAfter: newTokens,
        metadata
      });
    });

    return { success: true, message: `Awarded ${amount} tokens` };
  } catch (error) {
    console.error('Error awarding tokens:', error);
    throw error;
  }
}

/**
 * Deduct tokens with transaction safety (prevents double-spending)
 */
export async function deductTokens(userId, amount, reason, metadata = {}) {
  try {
    const userRef = doc(db, 'users', userId);
    
    const result = await runTransaction(db, async (transaction) => {
      const userDoc = await transaction.get(userRef);
      
      if (!userDoc.exists()) {
        throw new Error('User not found');
      }

      const currentTokens = userDoc.data().tokens || 0;
      
      // Anti-cheat: Verify sufficient funds
      if (currentTokens < amount) {
        throw new Error('INSUFFICIENT_TOKENS');
      }

      const newTokens = currentTokens - amount;

      // Update user tokens
      transaction.update(userRef, {
        tokens: newTokens,
        updatedAt: serverTimestamp()
      });

      // Create history entry
      const historyRef = doc(collection(db, 'users', userId, 'tokenHistory'));
      transaction.set(historyRef, {
        amount: -amount,
        reason,
        type: 'spend',
        timestamp: serverTimestamp(),
        balanceAfter: newTokens,
        metadata
      });

      return { newBalance: newTokens };
    });

    return { success: true, newBalance: result.newBalance };
  } catch (error) {
    if (error.message === 'INSUFFICIENT_TOKENS') {
      return { success: false, error: 'Not enough tokens' };
    }
    console.error('Error deducting tokens:', error);
    throw error;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STORE OPERATIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Purchase an item from the store
 */
export async function purchaseItem(userId, itemId, price) {
  try {
    const userRef = doc(db, 'users', userId);
    
    const result = await runTransaction(db, async (transaction) => {
      const userDoc = await transaction.get(userRef);
      
      if (!userDoc.exists()) {
        throw new Error('User not found');
      }

      const currentTokens = userDoc.data().tokens || 0;
      const inventory = userDoc.data().inventory || [];

      // Check if already owned
      if (inventory.includes(itemId)) {
        throw new Error('ALREADY_OWNED');
      }

      // Verify funds
      if (currentTokens < price) {
        throw new Error('INSUFFICIENT_TOKENS');
      }

      const newTokens = currentTokens - price;

      // Update user
      transaction.update(userRef, {
        tokens: newTokens,
        inventory: [...inventory, itemId],
        updatedAt: serverTimestamp()
      });

      // Log transaction
      const historyRef = doc(collection(db, 'users', userId, 'tokenHistory'));
      transaction.set(historyRef, {
        amount: -price,
        reason: `Purchased: ${itemId}`,
        type: 'spend',
        timestamp: serverTimestamp(),
        balanceAfter: newTokens,
        metadata: { itemId, category: 'store_purchase' }
      });

      return { newBalance: newTokens, newInventory: [...inventory, itemId] };
    });

    return { success: true, ...result };
  } catch (error) {
    if (error.message === 'ALREADY_OWNED') {
      return { success: false, error: 'You already own this item' };
    }
    if (error.message === 'INSUFFICIENT_TOKENS') {
      return { success: false, error: 'Not enough tokens' };
    }
    console.error('Error purchasing item:', error);
    throw error;
  }
}

/**
 * Equip an item (set as active profile picture, etc.)
 */
export async function equipItem(userId, itemId, slot = 'profilePic') {
  try {
    const userRef = doc(db, 'users', userId);
    const userDoc = await getDoc(userRef);

    if (!userDoc.exists()) {
      throw new Error('User not found');
    }

    const inventory = userDoc.data().inventory || [];
    
    if (!inventory.includes(itemId)) {
      return { success: false, error: 'Item not owned' };
    }

    // Update equipped item
    await updateDoc(userRef, {
      [`equipped.${slot}`]: itemId,
      updatedAt: serverTimestamp()
    });

    return { success: true };
  } catch (error) {
    console.error('Error equipping item:', error);
    throw error;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TOKEN HISTORY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Get user's token transaction history
 */
export async function getTokenHistory(userId, limitCount = 50) {
  try {
    const historyRef = collection(db, 'users', userId, 'tokenHistory');
    const q = query(historyRef, orderBy('timestamp', 'desc'), limit(limitCount));
    
    const snapshot = await getDocs(q);
    const history = [];
    
    snapshot.forEach(doc => {
      history.push({
        id: doc.id,
        ...doc.data()
      });
    });

    return history;
  } catch (error) {
    console.error('Error fetching token history:', error);
    return [];
  }
}

/**
 * Subscribe to real-time token updates
 */
export function subscribeToTokens(userId, callback) {
  const userRef = doc(db, 'users', userId);
  
  return onSnapshot(userRef, (doc) => {
    if (doc.exists()) {
      const data = doc.data();
      callback({
        tokens: data.tokens || 0,
        inventory: data.inventory || [],
        equipped: data.equipped || {}
      });
    }
  }, (error) => {
    console.error('Error in token subscription:', error);
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ANTI-CHEAT UTILITIES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Check if user can claim a reward (prevents spam/abuse)
 */
export async function canClaimReward(userId, rewardKey) {
  try {
    const cooldownRef = doc(db, 'users', userId, 'rewardCooldowns', rewardKey);
    const cooldownDoc = await getDoc(cooldownRef);

    if (!cooldownDoc.exists()) {
      return { canClaim: true };
    }

    const lastClaimed = cooldownDoc.data().lastClaimed?.toDate();
    const cooldownHours = cooldownDoc.data().cooldownHours || 24;
    
    if (!lastClaimed) {
      return { canClaim: true };
    }

    const hoursSince = (Date.now() - lastClaimed.getTime()) / (1000 * 60 * 60);
    
    if (hoursSince >= cooldownHours) {
      return { canClaim: true };
    }

    const hoursRemaining = Math.ceil(cooldownHours - hoursSince);
    return { 
      canClaim: false, 
      hoursRemaining,
      message: `Please wait ${hoursRemaining}h before claiming again`
    };
  } catch (error) {
    console.error('Error checking reward cooldown:', error);
    return { canClaim: true }; // Fail open
  }
}

/**
 * Record a reward claim with cooldown
 */
export async function recordRewardClaim(userId, rewardKey, cooldownHours = 24) {
  try {
    const cooldownRef = doc(db, 'users', userId, 'rewardCooldowns', rewardKey);
    await setDoc(cooldownRef, {
      lastClaimed: serverTimestamp(),
      cooldownHours,
      updatedAt: serverTimestamp()
    });
  } catch (error) {
    console.error('Error recording reward claim:', error);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INITIALIZATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Initialize token system for new user
 */
export async function initializeUserTokens(userId, initialTokens = 100) {
  try {
    const userRef = doc(db, 'users', userId);
    
    await updateDoc(userRef, {
      tokens: initialTokens,
      inventory: [],
      equipped: {},
      updatedAt: serverTimestamp()
    });

    // Create welcome token entry
    const historyRef = doc(collection(db, 'users', userId, 'tokenHistory'));
    await setDoc(historyRef, {
      amount: initialTokens,
      reason: 'Welcome to ChemLeung! üéâ',
      type: 'gain',
      timestamp: serverTimestamp(),
      balanceAfter: initialTokens,
      metadata: { category: 'welcome_bonus' }
    });

    return { success: true };
  } catch (error) {
    console.error('Error initializing tokens:', error);
    throw error;
  }
}

// ========== src/theme/colors.js ==========

// Premium Academic Color Scheme for ChemLeung HKDSE MCQ Platform

export const colors = {
  // Primary Academic Colors
  primary: {
    charcoal: '#2C3E50',      // Deep charcoal for headers
    slate: '#34495E',          // Slate for backgrounds
    lightSlate: '#5D6D7E',     // Light slate for secondary text
    paleSlate: '#ECF0F1',      // Very light slate for cards
  },
  
  // Academic Gold Accent
  gold: {
    main: '#D4AF37',           // Classic academic gold
    light: '#F4E4C1',          // Light gold for highlights
    dark: '#B8941F',           // Dark gold for active states
  },
  
  // Semantic Colors
  success: '#27AE60',          // Green for correct answers
  error: '#E74C3C',            // Red for incorrect
  warning: '#F39C12',          // Orange for flagged
  info: '#3498DB',             // Blue for information
  
  // Neutral Palette
  neutral: {
    white: '#FFFFFF',
    lightGray: '#F8F9FA',
    gray: '#BDC3C7',
    darkGray: '#7F8C8D',
    black: '#2C3E50',
  },
  
  // Text Colors (ensuring contrast)
  text: {
    primary: '#2C3E50',        // Dark charcoal - excellent contrast
    secondary: '#5D6D7E',      // Light slate
    inverse: '#FFFFFF',        // White text on dark backgrounds
    gold: '#B8941F',           // Dark gold for emphasis
  },
  
  // Background Colors
  background: {
    page: '#F5F7FA',           // Very light gray-blue
    card: '#FFFFFF',           // White cards
    cardAlt: '#ECF0F1',        // Pale slate alternative
    dark: '#2C3E50',           // Dark backgrounds
  }
};

// Tailwind CSS extension
export const tailwindColors = {
  'academic-charcoal': colors.primary.charcoal,
  'academic-slate': colors.primary.slate,
  'academic-light-slate': colors.primary.lightSlate,
  'academic-pale-slate': colors.primary.paleSlate,
  'academic-gold': colors.gold.main,
  'academic-gold-light': colors.gold.light,
  'academic-gold-dark': colors.gold.dark,
};

// ========== src/utils/masteryHelper.js ==========

/**
 * Mastery Helper Utilities
 * Includes ISRS priority algorithm and Rule of 3 mastery calculations
 */

/**
 * Calculate multi-weighted ISRS (Integrated Spaced Repetition System) priority score
 * Score = (U √ó 0.4) + (D √ó 0.4) + (R √ó 0.2)
 * where U = Urgency (Ebbinghaus curve), D = Difficulty, R = Recency/Context boost
 */
export function calculateMasteryPriority(mistake, recentTopics = []) {
  // 1. URGENCY: Ebbinghaus Forgetting Curve
  const now = Date.now();
  const lastAttemptTime = new Date(mistake.lastAttempted).getTime();
  const daysSinceLastAttempt = Math.max(0, (now - lastAttemptTime) / (1000 * 60 * 60 * 24));

  // U = 2^(days/7) exponential curve
  const U = Math.pow(2, daysSinceLastAttempt / 7);

  // 2. DIFFICULTY: Based on attempt count (max 1.0 at 3+ attempts)
  const D = Math.min(1.0, (mistake.attemptCount || 1) / 3);

  // 3. RECENCY/CONTEXT: Boost if matches recent quiz topics
  let R = 0.5; // Baseline
  if (recentTopics.length > 0 && recentTopics.includes(mistake.Topic)) {
    R = 1.5; // 1.5x boost for contextual relevance
  }

  return (U * 0.4) + (D * 0.4) + (R * 0.2);
}

/**
 * Get mastery state based on Rule of 3 (3 correct answers)
 */
export function getMasteryState(correctCount = 0) {
  if (correctCount >= 3) {
    return { state: 3, label: 'Mastered', color: 'green', bgClass: 'bg-green-50/60', borderClass: 'border-green-300', badgeClass: 'bg-green-100 text-green-700', dotClass: 'bg-green-500' };
  }
  if (correctCount === 2) {
    return { state: 2, label: 'Consolidating', color: 'amber', bgClass: 'bg-amber-50/60', borderClass: 'border-amber-300', badgeClass: 'bg-amber-100 text-amber-700', dotClass: 'bg-amber-400' };
  }
  if (correctCount === 1) {
    return { state: 1, label: 'Improving', color: 'amber', bgClass: 'bg-amber-50/60', borderClass: 'border-amber-300', badgeClass: 'bg-amber-100 text-amber-700', dotClass: 'bg-amber-400' };
  }
  return { state: 0, label: 'New', color: 'red', bgClass: 'bg-white', borderClass: 'border-red-200', badgeClass: 'bg-red-100 text-red-700', dotClass: 'bg-red-500' };
}

/**
 * Load mistakes from localStorage (from MistakeNotebookPage format)
 */
export function loadMistakesFromStorage() {
  try {
    const improvements = JSON.parse(localStorage.getItem('mistake_improvements') || '{}');
    const mistakes = [];

    Object.entries(improvements).forEach(([questionId, data]) => {
      mistakes.push({
        questionId,
        Topic: data.Topic || 'Unknown',
        Question: data.Question || '',
        lastAttempted: data.lastAttempted || new Date().toISOString(),
        attemptCount: data.attemptCount || 0,
        correctCount: data.correctCount || 0,
        lastCorrect: data.lastCorrect || null,
        errorType: data.errorType || 'conceptual', ...data
      });
    });

    return mistakes;
  } catch (error) {
    console.error('Error loading mistakes:', error);
    return [];
  }
}

/**
 * Calculate mastery statistics across all topics
 */
export function calculateMasteryStats(userProfile, mistakes = []) {
  const stats = {
    unseenCount: 0,
    inProgressCount: 0,
    masteredCount: 0,
    totalTopicsMastered: 0,
    topicStats: {},
  };

  // Collect all mistakes by topic
  mistakes.forEach((mistake) => {
    const topic = mistake.Topic || 'Unknown';
    if (!stats.topicStats[topic]) {
      stats.topicStats[topic] = { unseen: 0, inProgress: 0, mastered: 0 };
    }

    const state = getMasteryState(mistake.correctCount);
    if (state.state === 3) {
      stats.masteredCount++;
      stats.topicStats[topic].mastered++;
    } else if (state.state > 0) {
      stats.inProgressCount++;
      stats.topicStats[topic].inProgress++;
    } else {
      stats.unseenCount++;
      stats.topicStats[topic].unseen++;
    }
  });

  // Count topics with mastery
  stats.totalTopicsMastered = Object.values(stats.topicStats).filter(
    (topic) => topic.mastered > 0 && topic.inProgress === 0 && topic.unseen === 0
  ).length;

  return stats;
}

/**
 * Get top N mistakes by ISRS priority score
 */
export function getTopMistakesByPriority(mistakes, recentTopics = [], limit = 3) {
  return mistakes
    .map((m) => ({
      ...m,
      masteryPriority: calculateMasteryPriority(m, recentTopics),
    }))
    .sort((a, b) => b.masteryPriority - a.masteryPriority)
    .slice(0, limit);
}

/**
 * Find the closest topic to mastery
 */
export function findClosestToMastery(mistakes) {
  const topicProgress = {};

  mistakes.forEach((m) => {
    const topic = m.Topic || 'Unknown';
    if (!topicProgress[topic]) {
      topicProgress[topic] = { mastered: 0, total: 0 };
    }
    topicProgress[topic].total++;
    if (getMasteryState(m.correctCount).state === 3) {
      topicProgress[topic].mastered++;
    }
  });

  let closest = null;
  let maxProgress = -1;

  Object.entries(topicProgress).forEach(([topic, data]) => {
    if (data.total > 0) {
      const progress = data.mastered / data.total;
      const questionsUntilMastery = Math.max(0, Math.ceil((data.total - data.mastered) * 3));
      if (progress > maxProgress && progress < 1.0) {
        maxProgress = progress;
        closest = { topic, ...data, questionsUntilMastery };
      }
    }
  });

  return closest;
}


// ========== src/utils/quizStorage.js ==========

// localStorage utility for managing quiz state across pages

const STORAGE_KEYS = {
  SELECTED_QUESTIONS: 'quiz_selected_questions',
  USER_ANSWERS: 'quiz_user_answers',
  QUESTION_TIMES: 'quiz_question_times',
  FLAGGED: 'quiz_flagged',
  CURRENT_INDEX: 'quiz_current_index',
  TIMER_ENABLED: 'quiz_timer_enabled',
  SESSION_START: 'quiz_session_start'
};

export const quizStorage = {
  // Save selected questions for the quiz
  saveSelectedQuestions: (questions) => {
    localStorage.setItem(STORAGE_KEYS.SELECTED_QUESTIONS, JSON.stringify(questions));
  },

  getSelectedQuestions: () => {
    const data = localStorage.getItem(STORAGE_KEYS.SELECTED_QUESTIONS);
    return data ? JSON.parse(data) : null;
  },

  // Save user answers
  saveUserAnswers: (answers) => {
    localStorage.setItem(STORAGE_KEYS.USER_ANSWERS, JSON.stringify(answers));
  },

  getUserAnswers: () => {
    const data = localStorage.getItem(STORAGE_KEYS.USER_ANSWERS);
    return data ? JSON.parse(data) : {};
  },

  // Save question times
  saveQuestionTimes: (times) => {
    localStorage.setItem(STORAGE_KEYS.QUESTION_TIMES, JSON.stringify(times));
  },

  getQuestionTimes: () => {
    const data = localStorage.getItem(STORAGE_KEYS.QUESTION_TIMES);
    return data ? JSON.parse(data) : {};
  },

  // Save flagged questions
  saveFlagged: (flaggedSet) => {
    localStorage.setItem(STORAGE_KEYS.FLAGGED, JSON.stringify(Array.from(flaggedSet)));
  },

  getFlagged: () => {
    const data = localStorage.getItem(STORAGE_KEYS.FLAGGED);
    return data ? new Set(JSON.parse(data)) : new Set();
  },

  // Save current question index
  saveCurrentIndex: (index) => {
    localStorage.setItem(STORAGE_KEYS.CURRENT_INDEX, index.toString());
  },

  getCurrentIndex: () => {
    const data = localStorage.getItem(STORAGE_KEYS.CURRENT_INDEX);
    return data ? parseInt(data) : 0;
  },

  // Save timer settings
  saveTimerEnabled: (enabled) => {
    localStorage.setItem(STORAGE_KEYS.TIMER_ENABLED, JSON.stringify(enabled));
  },

  getTimerEnabled: () => {
    const data = localStorage.getItem(STORAGE_KEYS.TIMER_ENABLED);
    return data ? JSON.parse(data) : null;
  },

  saveSessionStart: (timestamp) => {
    localStorage.setItem(STORAGE_KEYS.SESSION_START, timestamp.toString());
  },

  getSessionStart: () => {
    const data = localStorage.getItem(STORAGE_KEYS.SESSION_START);
    return data ? parseInt(data) : null;
  },

  // Clear all quiz data (use when starting new quiz)
  clearQuizData: () => {
    Object.values(STORAGE_KEYS).forEach(key => {
      localStorage.removeItem(key);
    });
  },

  // Clear only progress data (keep selected questions)
  clearProgressData: () => {
    localStorage.removeItem(STORAGE_KEYS.USER_ANSWERS);
    localStorage.removeItem(STORAGE_KEYS.QUESTION_TIMES);
    localStorage.removeItem(STORAGE_KEYS.FLAGGED);
    localStorage.removeItem(STORAGE_KEYS.CURRENT_INDEX);
    localStorage.removeItem(STORAGE_KEYS.TIMER_ENABLED);
    localStorage.removeItem(STORAGE_KEYS.SESSION_START);
  }
};

// ========== src/utils/storeItems.js ==========

// ============================================================================
// STORE ITEMS - ChemStore Catalog
// ============================================================================

export const STORE_ITEMS = {
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PROFILE PICTURES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  profilePics: [
    {
      id: 'flask_blue',
      name: 'Blue Flask',
      description: 'Classic chemistry icon',
      price: 0,
      icon: 'üß™',
      rarity: 'common',
      category: 'profilePic'
    },
    {
      id: 'atom_green',
      name: 'Green Atom',
      description: 'Atomic structure design',
      price: 50,
      icon: '‚öõÔ∏è',
      rarity: 'common',
      category: 'profilePic'
    },
    {
      id: 'molecule',
      name: 'Molecule Master',
      description: 'For molecular enthusiasts',
      price: 100,
      icon: 'üî¨',
      rarity: 'uncommon',
      category: 'profilePic'
    },
    {
      id: 'fire',
      name: 'Combustion King',
      description: 'Exothermic reactions only',
      price: 150,
      icon: 'üî•',
      rarity: 'uncommon',
      category: 'profilePic'
    },
    {
      id: 'lightning',
      name: 'Electrochemist',
      description: 'Charged with energy',
      price: 200,
      icon: '‚ö°',
      rarity: 'rare',
      category: 'profilePic'
    },
    {
      id: 'crystal',
      name: 'Crystal Scholar',
      description: 'Perfectly structured',
      price: 250,
      icon: 'üíé',
      rarity: 'rare',
      category: 'profilePic'
    },
    {
      id: 'explosion',
      name: 'Reaction Expert',
      description: 'Explosive personality',
      price: 300,
      icon: 'üí•',
      rarity: 'epic',
      category: 'profilePic'
    },
    {
      id: 'star',
      name: 'Chemistry Star',
      description: 'Shine bright like neon',
      price: 400,
      icon: '‚≠ê',
      rarity: 'epic',
      category: 'profilePic'
    },
    {
      id: 'crown',
      name: 'Noble Gas King',
      description: 'Unreactive royalty',
      price: 500,
      icon: 'üëë',
      rarity: 'legendary',
      category: 'profilePic'
    },
    {
      id: 'trophy',
      name: 'Grand Master',
      description: 'Ultimate achievement',
      price: 1000,
      icon: 'üèÜ',
      rarity: 'legendary',
      category: 'profilePic'
    }
  ],

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  badges: [
    {
      id: 'beginner',
      name: 'Beginner Badge',
      description: 'Your first steps',
      price: 0,
      icon: 'üéñÔ∏è',
      rarity: 'common',
      category: 'badge'
    },
    {
      id: 'scholar',
      name: 'Scholar Badge',
      description: '100 questions solved',
      price: 200,
      icon: 'üìö',
      rarity: 'uncommon',
      category: 'badge'
    },
    {
      id: 'expert',
      name: 'Expert Badge',
      description: '500 questions mastered',
      price: 500,
      icon: 'üéì',
      rarity: 'rare',
      category: 'badge'
    }
  ],

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ THEMES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  themes: [
    {
      id: 'default',
      name: 'Classic Blue',
      description: 'Original ChemLeung theme',
      price: 0,
      preview: 'linear-gradient(135deg, #2563eb, #1e40af)',
      rarity: 'common',
      category: 'theme'
    },
    {
      id: 'forest',
      name: 'Forest Green',
      description: 'Organic chemistry vibes',
      price: 150,
      preview: 'linear-gradient(135deg, #10b981, #059669)',
      rarity: 'uncommon',
      category: 'theme'
    },
    {
      id: 'sunset',
      name: 'Sunset Orange',
      description: 'Warm combustion colors',
      price: 200,
      preview: 'linear-gradient(135deg, #f97316, #ea580c)',
      rarity: 'rare',
      category: 'theme'
    },
    {
      id: 'royal',
      name: 'Royal Purple',
      description: 'Permanganate elegance',
      price: 300,
      preview: 'linear-gradient(135deg, #9333ea, #7e22ce)',
      rarity: 'epic',
      category: 'theme'
    }
  ]
};

// Flatten all items for easy lookup
export const ALL_ITEMS = [
  ...STORE_ITEMS.profilePics,
  ...STORE_ITEMS.badges,
  ...STORE_ITEMS.themes
];

// Get item by ID
export function getItemById(itemId) {
  return ALL_ITEMS.find(item => item.id === itemId);
}

// Rarity colors
export const RARITY_COLORS = {
  common: 'from-slate-400 to-slate-500',
  uncommon: 'from-green-400 to-green-600',
  rare: 'from-blue-400 to-blue-600',
  epic: 'from-purple-400 to-purple-600',
  legendary: 'from-amber-400 to-amber-600'
};

export const RARITY_BORDER = {
  common: 'border-slate-300',
  uncommon: 'border-green-300',
  rare: 'border-blue-300',
  epic: 'border-purple-300',
  legendary: 'border-amber-300'
};

export const RARITY_LABELS = {
  common: 'Common',
  uncommon: 'Uncommon',
  rare: 'Rare',
  epic: 'Epic',
  legendary: 'Legendary'
};

// ========== vite.config.js ==========

import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import tailwindcss from '@tailwindcss/vite';

export default defineConfig({
  plugins: [react(), tailwindcss()],
});

